<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Mythic RPG v6</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet"></script>
    <style>
        body { margin:0; background:#000; color:#fff; font-family:monospace; overflow:hidden; }
        #game-ui { display:flex; flex-direction:column; height:100vh; }
        
        /* カメラ表示エリア */
        .camera-container { position:relative; flex:1; background:#222; display:flex; justify-content:center; align-items:center; }
        video { width:100%; height:100%; object-fit:cover; display:none; }
        
        /* ステータスバー */
        .status-bar { padding:10px; background:rgba(0,0,0,0.8); border-bottom:2px solid #444; }
        .hp-bar { width:100%; height:10px; background:#444; margin-top:5px; position:relative; }
        .hp-fill { height:100%; background:#0f0; transition:0.3s; width:100%; }

        /* メッセージ・操作エリア */
        .msg-area { height:80px; padding:10px; background:#111; border-top:2px solid #444; overflow-y:auto; font-size:0.9rem; }
        .controls { display:grid; grid-template-columns:1fr 1fr; gap:5px; padding:10px; background:#000; }
        button { padding:15px; background:#333; color:#fff; border:1px solid #666; font-size:1rem; cursor:pointer; }
        button:disabled { opacity:0.3; }
        button:active { background:#666; }

        /* オーバーレイ */
        .overlay { position:fixed; inset:0; background:rgba(0,0,0,0.9); display:flex; flex-direction:column; justify-content:center; align-items:center; z-index:100; text-align:center; padding:20px; }
        .hidden { display:none !important; }
        
        /* シェイクアニメーション */
        @keyframes shake { 0%{transform:translate(0,0)} 25%{transform:translate(5px,5px)} 50%{transform:translate(-5px,0)} 75%{transform:translate(0,-5px)} 100%{transform:translate(0,0)} }
        .shake { animation: shake 0.2s ease-in-out 2; }
    </style>
</head>
<body>

<div id="game-ui">
    <div class="status-bar">
        <div>PLAYER Lv.<span id="p-lv">1</span> HP: <span id="p-hp-cur">1000</span>/<span id="p-hp-max">1000</span></div>
        <div class="hp-bar"><div id="p-fill" class="hp-fill"></div></div>
        <div style="margin-top:5px; color:#ff4444;">ENEMY HP: <span id="e-hp-cur">0</span>/<span id="e-hp-max">0</span></div>
        <div class="hp-bar"><div id="e-fill" class="hp-fill" style="background:#f00; width:0%;"></div></div>
    </div>

    <div class="camera-container">
        <video id="webcam" autoplay playsinline muted></video>
        <canvas id="offscreen-canvas" style="display:none;"></canvas>
    </div>

    <div id="msg" class="msg-area">SYSTEM INITIALIZING...</div>

    <div class="controls">
        <button id="scan-btn" onclick="startScan()" disabled>WEAPON SCAN</button>
        <button id="atk-btn" onclick="handleAttack()" disabled>ATTACK</button>
        <button id="magic-btn" onclick="openMagic()" disabled>MAGIC</button>
        <button id="lib-btn" onclick="openLibrary()">LIBRARY</button>
    </div>
</div>

<div id="init-overlay" class="overlay">
    <h1 style="color:#0ff;">AI MYTHIC RPG</h1>
    <p id="init-msg">LOADING AI MODELS...</p>
    <button id="start-btn" onclick="startGame()" class="hidden" style="background:#004400; padding:20px 40px; border-color:#0f0;">START GAME</button>
</div>

<script>
// --- ゲーム変数 ---
let lv=1, exp=0, pMax=1000, php=1000;
let ehp=0, eMax=0, eatk=100, pdef=100;
let mode = "W"; // W:Weapon, E:Enemy, B:Battle, I:Item
let net, stream;
let inventory = [];
let library = JSON.parse(localStorage.getItem('myth_v6_lib')) || { W: {}, E: {}, I: {} };
let magicLv = { H:1, F:0, L:0 }; 

// --- 初期化 ---
window.onload = async () => {
    try {
        // AIロード
        net = await mobilenet.load();
        document.getElementById('init-msg').innerText = "AI SYSTEM READY";
        document.getElementById('start-btn').classList.remove('hidden');
        
        // セーブデータ復元
        const saved = JSON.parse(localStorage.getItem('myth_v6_save'));
        if(saved) {
            lv=saved.lv; exp=saved.exp; pMax=saved.pMax; php=pMax;
            inventory=saved.inventory; magicLv=saved.magicLv;
        }
        updateUI();
    } catch(e) {
        document.getElementById('init-msg').innerText = "ERROR: Internet Required";
    }
};

async function startGame() {
    document.getElementById('init-overlay').classList.add('hidden');
    await initCamera();
    mode = "W";
    document.getElementById('scan-btn').disabled = false;
    log("武器をスキャンしてください");
}

async function initCamera() {
    const video = document.getElementById('webcam');
    stream = await navigator.mediaDevices.getUserMedia({video: {facingMode: "environment"}, audio:false});
    video.srcObject = stream;
    video.style.display = "block";
}

// --- スキャン処理 ---
async function startScan() {
    const btn = document.getElementById('scan-btn');
    btn.disabled = true;
    log("スキャン中...");
    
    // 画像解析
    const video = document.getElementById('webcam');
    const result = await net.classify(video);
    const label = result[0].className;
    
    if (mode === "W") {
        log(`武器を検知: ${label}`);
        mode = "E";
        btn.innerText = "ENEMY SCAN";
        btn.disabled = false;
    } else if (mode === "E") {
        eMax = 500 + (lv * 200);
        ehp = eMax;
        log(`敵が出現: ${label.split(',')[0]}!`);
        mode = "B";
        btn.innerText = "BATTLE MODE";
        document.getElementById('atk-btn').disabled = false;
        document.getElementById('magic-btn').disabled = false;
    } else if (mode === "I") {
        getBonusItem(label);
    }
    updateUI();
}

// --- バトルロジック ---
function handleAttack() {
    let dmg = 100 + (lv * 20);
    ehp = Math.max(0, ehp - dmg);
    applyShake();
    log(`攻撃！ ${dmg}ダメージ！`);
    
    if(ehp <= 0) {
        win();
    } else {
        setTimeout(enemyTurn, 800);
    }
    updateUI();
}

function enemyTurn() {
    let dmg = 50 + (lv * 10);
    php = Math.max(0, php - dmg);
    log(`敵の攻撃！ ${dmg}ダメージ！`);
    if(php <= 0) {
        alert("敗北しました...");
        location.reload();
    }
    updateUI();
}

function win() {
    log("勝利！アイテムをスキャンしてください");
    mode = "I";
    document.getElementById('scan-btn').innerText = "ITEM SCAN";
    document.getElementById('scan-btn').disabled = false;
    document.getElementById('atk-btn').disabled = true;
    document.getElementById('magic-btn').disabled = true;
    exp += 50;
    save();
}

// --- システム ---
function log(m) {
    const el = document.getElementById('msg');
    el.innerText = m;
    // 収集率追記
    const total = 10; // 仮
    const collected = Object.keys(library.I || {}).length;
    el.innerText += `\n(収集率: ${Math.floor(collected/total*100)}%)`;
}

function updateUI() {
    document.getElementById('p-lv').innerText = lv;
    document.getElementById('p-hp-cur').innerText = php;
    document.getElementById('p-hp-max').innerText = pMax;
    document.getElementById('p-fill').style.width = (php/pMax*100) + "%";
    document.getElementById('e-hp-cur').innerText = ehp;
    document.getElementById('e-hp-max').innerText = eMax;
    document.getElementById('e-fill').style.width = (ehp/eMax*100) + "%";
}

function save() {
    localStorage.setItem('myth_v6_save', JSON.stringify({lv, exp, pMax, magicLv, inventory}));
    localStorage.setItem('myth_v6_lib', JSON.stringify(library));
}

function applyShake() {
    document.body.classList.add('shake');
    setTimeout(() => document.body.classList.remove('shake'), 200);
}

function openLibrary() {
    alert("図鑑機能: 開発中\n獲得したアイテムは内部で保存されています。");
}

function getBonusItem(label) {
    const id = Date.now();
    library.I[id] = { name: label };
    alert(`アイテム獲得: ${label}`);
    save();
    location.reload(); // 最初から（武器スキャン）に戻る
}

</script>
</body>
</html>
