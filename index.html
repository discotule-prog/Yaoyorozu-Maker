<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MYTH SCANNER 4.36 - COLLECTION DETAIL</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet"></script>
    <link href="https://fonts.googleapis.com/css2?family=DotGothic16&display=swap" rel="stylesheet">
    <style>
        :root { --p-color: #00f2ff; --e-color: #ff3c00; }
        body { font-family: 'DotGothic16', sans-serif; background: #000; color: #fff; margin: 0; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }
        #header { height: 40px; background: #222; display: flex; align-items: center; justify-content: space-around; border-bottom: 2px solid #444; }
        .char-area { height: 32%; display: flex; border-bottom: 1px solid #333; padding: 10px; box-sizing: border-box; }
        .cam-frame { width: 90px; height: 90px; border: 2px solid #333; background: #111; overflow: hidden; position: relative; border-radius: 8px; }
        video { width: 100%; height: 100%; object-fit: cover; display: none; }
        .cam-active { border: 2px solid #0f0; box-shadow: 0 0 10px #0f0; }
        .cam-active video { display: block; }
        .info-part { flex: 1; padding-left: 10px; display: flex; flex-direction: column; justify-content: center; }
        .visual-card { width: 100%; height: 80px; border: 2px solid #fff; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #111; position: relative; }
        #mid-ui { flex-grow: 1; background: #111; border-top: 2px solid #444; display: flex; flex-direction: column; align-items: center; padding: 5px; }
        #msg { font-size: 0.8rem; color: #0f0; height: 45px; text-align: center; display: flex; align-items: center; }
        .btn-row { display: flex; gap: 5px; width: 95%; margin-bottom: 5px; }
        button { flex: 1; height: 40px; font-family: 'DotGothic16'; background: #444; color: #fff; border: 2px solid #fff; cursor: pointer; }
        button:disabled { opacity: 0.3; }
        
        /* „Ç≥„É¨„ÇØ„Ç∑„Éß„É≥„Éª„Éù„ÉÉ„Éó„Ç¢„ÉÉ„ÉóÁî® */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; display: none; flex-direction: column; align-items: center; padding: 20px; box-sizing: border-box; }
        .lib-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; width: 100%; overflow-y: auto; }
        .lib-slot { height: 60px; background: #222; border: 1px solid #444; font-size: 0.5rem; display: flex; align-items: center; justify-content: center; text-align: center; cursor: pointer; }
        .found { color: var(--p-color); border-color: var(--p-color); }
        .detail-card { background: #222; border: 2px solid #fff; padding: 20px; width: 80%; text-align: center; }
    </style>
</head>
<body>

<div id="header">
    <button onclick="showLib()" style="height:25px; font-size:0.6rem;">COLLECTION</button>
    <button onclick="resetGame()" style="height:25px; font-size:0.6rem;">RESET</button>
</div>

<div class="char-area" id="p-area">
    <div class="cam-frame" id="pf"><video id="pv" autoplay playsinline muted></video></div>
    <div class="info-part">
        <div class="visual-card">
            <div id="p-sym" style="font-size:3rem;">?</div>
            <div id="p-name" style="font-size:0.6rem; position:absolute; bottom:2px;">READY</div>
        </div>
        <div style="font-size:0.7rem;">HP: <span id="php">1000</span></div>
    </div>
</div>

<div id="mid-ui">
    <div id="msg">AI BOOTING...</div>
    <div class="btn-row">
        <button id="scan-btn" onclick="doScan()" style="background:#0044cc;">SCAN</button>
        <button id="atk-btn" onclick="doAtk()" disabled style="background:#880000;">ATTACK</button>
    </div>
</div>

<div class="char-area" id="e-area">
    <div class="cam-frame" id="ef"><video id="ev" autoplay playsinline muted></video></div>
    <div class="info-part">
        <div class="visual-card">
            <div id="e-sym" style="font-size:3rem;">?</div>
            <div id="e-name" style="font-size:0.6rem; position:absolute; bottom:2px;">???</div>
        </div>
        <div style="font-size:0.7rem;">HP: <span id="ehp">0</span></div>
    </div>
</div>

<div id="lib-ui" class="overlay">
    <h2>COLLECTION</h2>
    <div id="lib-grid" class="lib-grid"></div>
    <button onclick="closeOverlay('lib-ui')" style="margin-top:20px; width:100%;">CLOSE</button>
</div>

<div id="detail-ui" class="overlay" style="justify-content:center;">
    <div class="detail-card">
        <h3 id="det-name" style="color:var(--p-color);">NAME</h3>
        <p id="det-type" style="font-size:0.7rem;">TYPE</p>
        <hr>
        <p id="det-stat" style="font-size:0.9rem;">ATK: 0</p>
        <p id="det-desc" style="font-size:0.6rem; color:#aaa;">FLAVOR TEXT...</p>
        <button onclick="closeOverlay('detail-ui')" style="width:100%;">OK</button>
    </div>
</div>

<script>
    const W_DB = ["Áü≠Ââ£","Èï∑Ââ£","Êñß","Êùñ","Âºì","Êßç"];
    const M_DB = ["„Çπ„É©„Ç§„É†","„Ç¥„Éñ„É™„É≥","„Éâ„É©„Ç≠„Éº","„Çæ„É≥„Éì","„Ç™„Éº„ÇØ","„Ç¥„Éº„É¨„É†"];
    
    let net, mode="W", stream, busy=false;
    let php=1000, pmx=1000, patk=0;
    let ehp=0, emx=0, eatk=0;
    
    // Âõ≥Èëë„Éá„Éº„ÇøÔºà„É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Å´‰øùÂ≠òÂèØËÉΩÔºâ
    let collection = JSON.parse(localStorage.getItem('myth_col')) || [];

    async function init() {
        net = await mobilenet.load();
        resetGame();
    }

    async function cam(t) {
        if(stream) stream.getTracks().forEach(s=>s.stop());
        if(t==='OFF') return;
        try {
            stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
            const id = t==='W'?'pv':'ev';
            document.getElementById(id).srcObject = stream;
            document.getElementById(t==='W'?'pf':'ef').classList.add('cam-active');
        } catch(e) { alert("CAM ERROR"); }
    }

    async function doScan() {
        if(busy) return;
        busy = true;
        document.getElementById('msg').innerText = "SCANNING...";
        const vid = mode==="W"?document.getElementById('pv'):document.getElementById('ev');
        const res = await net.classify(vid);
        const id = Math.floor(res[0].probability * 100);
        const aiName = res[0].className.split(',')[0].toUpperCase();

        if(mode==="W") {
            const name = aiName + "„ÅÆ" + W_DB[id % W_DB.length];
            patk = 100 + id;
            document.getElementById('p-name').innerText = name;
            document.getElementById('p-sym').innerText = "‚öîÔ∏è";
            saveToCol(name, "WEAPON", `ATK: ${patk}`, "„Çπ„Ç≠„É£„É≥„Å´„Çà„Å£„Å¶ÂÖ∑ÁèæÂåñ„Åï„Çå„ÅüÊ≠¶Âô®„ÄÇ");
            
            mode = "M";
            document.getElementById('msg').innerText = "„Çø„Éº„Ç≤„ÉÉ„Éà„ÇíÊçïÊçâ„Åõ„Çà";
            await cam('OFF');
            setTimeout(()=> { cam('M'); busy=false; }, 1000);
        } else {
            const name = aiName + "„ÅÆ" + M_DB[id % M_DB.length];
            emx = 500 + (id * 10); ehp = emx; eatk = 50 + id;
            document.getElementById('e-name').innerText = name;
            document.getElementById('e-sym').innerText = "üëæ";
            saveToCol(name, "MONSTER", `HP: ${emx} / ATK: ${eatk}`, "„Åì„ÅÆ„Ç®„É™„Ç¢„Å´ÁîüÊÅØ„Åô„ÇãÊú™Áü•„ÅÆÂÄã‰Ωì„ÄÇ");

            document.getElementById('msg').innerText = "BATTLE START!";
            document.getElementById('scan-btn').disabled = true;
            document.getElementById('atk-btn').disabled = false;
            await cam('OFF');
            busy = false;
        }
    }

    function saveToCol(name, type, stat, desc) {
        if(!collection.find(i => i.name === name)) {
            collection.push({name, type, stat, desc});
            localStorage.setItem('myth_col', JSON.stringify(collection));
        }
    }

    function showLib() {
        const grid = document.getElementById('lib-grid');
        grid.innerHTML = "";
        collection.forEach(item => {
            const slot = document.createElement('div');
            slot.className = "lib-slot found";
            slot.innerText = item.name;
            slot.onclick = () => showDetail(item);
            grid.appendChild(slot);
        });
        document.getElementById('lib-ui').style.display = 'flex';
    }

    function showDetail(item) {
        document.getElementById('det-name').innerText = item.name;
        document.getElementById('det-type').innerText = `[ ${item.type} ]`;
        document.getElementById('det-stat').innerText = item.stat;
        document.getElementById('det-desc').innerText = item.desc;
        document.getElementById('detail-ui').style.display = 'flex';
    }

    function closeOverlay(id) { document.getElementById(id).style.display = 'none'; }

    function doAtk() {
        const d = Math.floor(patk * (0.8 + Math.random()*0.4));
        ehp -= d;
        document.getElementById('msg').innerText = d + " „ÉÄ„É°„Éº„Ç∏ÔºÅ";
        if(ehp <= 0) { alert("WIN!"); resetGame(); } else { setTimeout(eTurn, 800); }
        updateUI();
    }

    function eTurn() {
        const d = Math.floor(eatk * (0.8 + Math.random()*0.4));
        php -= d;
        document.getElementById('msg').innerText = "Êïµ„ÅÆÊîªÊíÉÔºÅ " + d + "„ÉÄ„É°„Éº„Ç∏";
        if(php <= 0) { alert("LOSE..."); resetGame(); }
        updateUI();
    }

    function resetGame() {
        mode = "W"; busy = false; php = 1000; ehp = 0;
        document.getElementById('scan-btn').disabled = false;
        document.getElementById('atk-btn').disabled = true;
        document.getElementById('msg').innerText = "Ê≠¶Âô®„Çí„Çπ„Ç≠„É£„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ";
        cam('W'); updateUI();
    }

    function updateUI() {
        document.getElementById('php').innerText = Math.max(0, Math.floor(php));
        document.getElementById('ehp').innerText = Math.max(0, Math.floor(ehp));
    }

    window.onload = init;
</script>
</body>
</html>
