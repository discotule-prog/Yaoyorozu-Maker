<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MYTH SCANNER AI</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet"></script>
    <link href="https://fonts.googleapis.com/css2?family=DotGothic16&display=swap" rel="stylesheet">
    <style>
        :root { --p-color: #00f2ff; --e-color: #ff3c00; }
        body { font-family: 'DotGothic16', sans-serif; background: #000; color: #fff; margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        #header { height: 40px; background: #222; display: flex; justify-content: space-around; align-items: center; font-size: 0.75rem; border-bottom: 2px solid #444; }
        .char-area { height: 32%; display: flex; border-bottom: 1px solid #333; padding: 5px; box-sizing: border-box; }
        .cam-part { width: 40%; display: flex; align-items: center; justify-content: center; }
        .cam-frame { width: 100px; height: 100px; border: 2px solid #555; background: #111; overflow: hidden; position: relative; border-radius: 4px; }
        video { width: 100%; height: 100%; object-fit: cover; display: none; }
        .cam-active video { display: block; border-color: #0f0; }
        .info-part { width: 60%; display: flex; flex-direction: column; padding-left: 10px; justify-content: center; }
        .visual-card { width: 100%; height: 80px; border: 2px solid #fff; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #111; position: relative; }
        .stat-text { font-size: 0.7rem; color: #ccc; margin-top: 3px; line-height: 1.2; }
        .hp-bar-bg { width: 100%; height: 8px; background: #333; border: 1px solid #fff; margin-top: 3px; }
        .hp-bar-fill { height: 100%; transition: width 0.3s; }
        #mid-ui { height: 140px; background: #111; border-top: 2px solid #444; display: flex; flex-direction: column; align-items: center; padding: 5px; }
        #msg { font-size: 0.7rem; color: #0f0; height: 35px; text-align: center; display: flex; align-items: center; padding: 0 10px; }
        .btn-row { display: flex; gap: 6px; width: 100%; flex-wrap: wrap; justify-content: center; }
        button { flex: 1; max-width: 100px; height: 38px; font-family: 'DotGothic16'; border: 2px solid #fff; color: #fff; background: #444; font-size: 0.75rem; cursor: pointer; }
        button:disabled { opacity: 0.3; cursor: default; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 100; flex-direction: column; align-items: center; padding: 10px; box-sizing: border-box; overflow-y: auto; }
        #item-container { width: 100%; display: flex; flex-direction: column; gap: 5px; margin-bottom: 10px; }
        .item-list-btn { width: 100%; background: #222; border: 1px solid #555; color: #fff; padding: 8px 12px; text-align: left; font-family: 'DotGothic16'; font-size: 0.75rem; min-height: 40px; }
        .item-list-btn.selected { border-color: gold; background: #443300; }
        .close-btn-small { width: 100px !important; height: 28px !important; min-height: 28px !important; background: #444 !important; margin: 5px auto !important; font-size: 0.7rem !important; flex: none !important; border: 1px solid #fff !important; }
        .shake { animation: s 0.2s; }
        @keyframes s { 0%,100%{transform:translateX(0)} 25%{transform:translateX(5px)} 75%{transform:translateX(-5px)} }
        .elem-badge { position: absolute; bottom: 2px; right: 2px; font-size: 1rem; }
    </style>
</head>
<body>

<div id="header">
    <span>LV: <b id="p-lv">1</b> EXP: <b id="p-exp">0</b></span>
    <button onclick="alert('STATS\nLV:'+lv+'\nHP:'+pMax+'\nATK:'+patk)" style="width:80px; height:25px; flex:none;">STATS</button>
</div>

<div class="char-area" id="p-area">
    <div class="cam-part" id="p-cam-box"><div class="cam-frame"><video id="pv" autoplay playsinline muted></video></div></div>
    <div class="info-part">
        <div id="p-card" class="visual-card">
            <div id="p-rare" style="position:absolute; top:0; right:0; font-size:0.5rem; background:#fff; color:#000; padding:1px 4px;">-</div>
            <div id="p-sym" style="font-size:2rem;">â“</div>
            <div id="p-name" style="font-size:0.6rem; text-align:center;">READY</div>
            <div id="p-elem" class="elem-badge"></div>
        </div>
        <div class="stat-text">HP: <span id="p-hp-cur">1000</span>/<span id="p-hp-max">1000</span><br>ATK: <span id="p-atk-val">0</span> DEF: <span id="p-def-val">0</span></div>
        <div class="hp-bar-bg"><div id="p-fill" class="hp-bar-fill" style="background:var(--p-color); width:100%"></div></div>
    </div>
</div>

<div id="mid-ui">
    <div id="msg">æ­¦å™¨ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ãã ã•ã„</div>
    <div class="btn-row">
        <button id="scan-btn" onclick="handleScan()" style="background:#0044cc">SCAN AI</button>
        <button id="atk-btn" onclick="handleAttack()" disabled style="background:#aa0000">ATTACK</button>
        <button id="item-open-btn" onclick="openItemMenu()" disabled style="background:#008844">ITEM</button>
    </div>
    <div id="inv-count" style="font-size:0.65rem; color:yellow; margin-top:8px;">INV: 0 / 5</div>
</div>

<div class="char-area" id="e-area">
    <div class="cam-part" id="e-cam-box"><div class="cam-frame"><video id="ev" autoplay playsinline muted></video></div></div>
    <div class="info-part">
        <div id="e-card" class="visual-card">
            <div id="e-rare" style="position:absolute; top:0; right:0; font-size:0.5rem; background:#fff; color:#000; padding:1px 4px;">-</div>
            <div id="e-sym" style="font-size:2rem;">â“</div>
            <div id="e-name" style="font-size:0.6rem; text-align:center;">???</div>
            <div id="e-elem" class="elem-badge"></div>
        </div>
        <div class="stat-text">HP: <span id="e-hp-cur">0</span>/<span id="e-hp-max">0</span><br>ATK: <span id="e-atk-val">0</span> DEF: <span id="e-def-val">0</span></div>
        <div class="hp-bar-bg"><div id="e-fill" class="hp-bar-fill" style="background:var(--e-color); width:0%"></div></div>
    </div>
</div>

<div id="item-menu" class="overlay">
    <h2 id="item-menu-title" style="color:#0f0; margin-bottom:10px;">ITEMS</h2>
    <div id="item-container"></div>
    <div style="display:flex; gap:10px;">
        <button id="craft-mode-btn" class="close-btn-small" style="background:gold !important; color:#000 !important; width:120px !important;" onclick="toggleCraftMode()">CRAFT MODE</button>
        <button class="close-btn-small" onclick="closeItemMenu()">CLOSE</button>
    </div>
</div>
<div id="bonus-screen" class="overlay"><h2 style="color:gold;">BONUS SCAN</h2><div class="cam-frame" style="width:160px; height:160px;" id="b-cam-box"><video id="bv" autoplay playsinline muted></video></div><button id="bonus-btn" onclick="getBonusItem()" style="background:#0044cc; width:180px; margin-top:20px;">AI GET ITEM</button></div>
<div id="res-screen" class="overlay" style="justify-content:center;"><h1 id="res-title"></h1><p id="res-msg" style="text-align:center; white-space: pre-wrap; margin:20px 0;"></p><button onclick="closeResult()" style="width:200px; height:50px; background:#0044cc;">NEXT</button></div>

<script>
    let net, mode = "W", lv = 1, exp = 0, nextExp = 100, php = 1000, pMax = 1000, ehp = 0, eMax = 0;
    let patk=0, pdef=0, eatk=0, edef=0, stream = null, pElem = "âšª", eElem = "âšª"; 
    let buffAtk = 0, buffDef = 0, buffEAtkMul = 1.0, buffEDefMul = 1.0;
    let shieldActive = false, doubleAtkActive = false, isCraftMode = false, craftSelection = [];

    let inventory = JSON.parse(localStorage.getItem('myth_inv_v13')) || [];

    // AIã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‹ã‚‰å±æ€§ã‚’æ¨æ¸¬ã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯
    function analyzeElement(className) {
        const text = className.toLowerCase();
        if (text.match(/fire|candle|lighter|lamp|red|orange|electric|power/)) return "ğŸ”¥";
        if (text.match(/water|bottle|blue|cup|ice|sea|liquid/)) return "ğŸ’§";
        if (text.match(/plant|leaf|tree|grass|green|wood|food|fruit/)) return "ğŸŒ¿";
        return "âšª";
    }

    async function init() { net = await mobilenet.load(); switchCamera('P'); updateUI(); }
    async function stopCamera() { if(stream) { stream.getTracks().forEach(t => t.stop()); stream = null; } ['p-cam-box','e-cam-box','b-cam-box'].forEach(b=>document.getElementById(b).classList.remove('cam-active')); }
    async function switchCamera(target) { await stopCamera(); try { stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}}); const vId = {P:'pv', E:'ev', B:'bv'}[target]; const bId = {P:'p-cam-box', E:'e-cam-box', B:'b-cam-box'}[target]; document.getElementById(vId).srcObject = stream; document.getElementById(bId).classList.add('cam-active'); } catch(e) {} }

    async function handleScan() {
        const vid = mode === "W" ? document.getElementById('pv') : document.getElementById('ev');
        const results = await net.classify(vid);
        const topResult = results[0];
        const aiName = topResult.className.split(',')[0].toUpperCase();
        const prob = topResult.probability;
        const seed = Math.floor(prob * 1000);
        
        const rareIdx = prob > 0.6 ? 3 : prob > 0.4 ? 2 : prob > 0.15 ? 1 : 0;
        const rarity = ["COMMON","RARE","SUPER","MYTHIC"][rareIdx];
        const pLevelBoost = 1 + (lv - 1) * 0.05;

        if (mode === "W") {
            patk = Math.floor(((rareIdx + 1) * 120 + (seed % 50)) * pLevelBoost);
            pdef = Math.floor(((rareIdx + 1) * 60 + (seed % 30)) * pLevelBoost);
            pElem = analyzeElement(aiName);
            php = Math.min(pMax, php + Math.floor(pMax * 0.5));
            updateCard('p', rarity, "âš”ï¸", `${rarity}\n${aiName}`, "#444");
            document.getElementById('p-elem').innerText = pElem;
            mode = "M"; switchCamera('E');
            document.getElementById('msg').innerText = aiName + " ã‚’è£…å‚™ï¼æ¬¡ã€æ•µã‚’ã‚¹ã‚­ãƒ£ãƒ³ï¼";
        } else {
            eMax = Math.floor((800 + (rareIdx * 600)) * pLevelBoost); ehp = eMax;
            eatk = Math.floor((120 + (rareIdx * 100)) * pLevelBoost); edef = Math.floor((60 + (rareIdx * 50)) * pLevelBoost);
            eElem = analyzeElement(aiName);
            updateCard('e', rarity, "ğŸ‘¾", `${rarity}\n${aiName}`, "#a11");
            document.getElementById('e-elem').innerText = eElem;
            await stopCamera();
            document.getElementById('atk-btn').disabled = false;
            document.getElementById('item-open-btn').disabled = false;
            document.getElementById('scan-btn').disabled = true;
            document.getElementById('msg').innerText = aiName + " ãŒç¾ã‚ŒãŸï¼";
        }
        updateUI();
    }

    async function getBonusItem() {
        const results = await net.classify(document.getElementById('bv'));
        const top = results[0];
        const aiName = top.className.toLowerCase();
        
        // AIåˆ¤æ–­ã«åŸºã¥ãã‚¢ã‚¤ãƒ†ãƒ ç”Ÿæˆ
        let type = "ORB"; 
        if (aiName.includes("bottle") || aiName.includes("cup")) type = "HE";
        else if (aiName.includes("phone") || aiName.includes("remote")) type = "DOUBLE";
        else if (aiName.includes("sharp") || aiName.includes("pen") || aiName.includes("knife")) type = "KILL";
        else {
            // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒãªã„å ´åˆã¯ãƒ©ãƒ³ãƒ€ãƒ 
            const types = ["HE","DM","AT","DF","SHIELD","DOUBLE","WEAK","BREAK","KILL","ORB"];
            type = types[Math.floor(Math.random()*types.length)];
        }

        const itmNames = {HE:"ãƒãƒ¼ã‚·ãƒ§ãƒ³", DM:"çˆ†å¼¾", AT:"åŠ›ã®è–¬", DF:"å®ˆã‚Šã®è–¬", SHIELD:"è–ãªã‚‹ç›¾", DOUBLE:"ç–¾é¢¨ã®é´", WEAK:"å¼±ä½“åŒ–ã®å‘ªæ–‡", BREAK:"ç ´ç”²ã®çŸ¢", KILL:"ãƒ‡ãƒƒãƒ‰ãƒªãƒ¼ã‚·ãƒ§ãƒƒãƒˆ", ORB:"ã‚ªãƒ¼ãƒ–"};
        const itm = { n: itmNames[type], t: type, i: "ğŸ“¦", e: "âšª" };
        const icons = {HE:"ğŸ§ª", DM:"ğŸ’¥", SHIELD:"ğŸ›¡ï¸", DOUBLE:"ğŸ‘Ÿ", KILL:"ğŸ’€", ORB:"ğŸ”®"};
        itm.i = icons[type] || "ğŸ”®";

        if (inventory.length < getMaxInv()) {
            inventory.push(itm);
        } else {
            pendingItem = itm; showSwapMenu(); return;
        }
        completeBonus();
    }

    // --- ä»¥é™ã®ãƒãƒˆãƒ«ãƒ»åˆæˆãƒ»ãƒ¬ãƒ™ãƒ«ç®¡ç†ãƒ­ã‚¸ãƒƒã‚¯ã¯ä»¥å‰ã®é«˜æ€§èƒ½ç‰ˆã‚’ç¶™æ‰¿ ---

    function getMaxInv() { return 5 + Math.floor(lv / 5); }

    function handleAttack() {
        const attack = () => {
            document.getElementById('e-area').classList.add('shake');
            let d = Math.max(30, (patk + buffAtk) - Math.floor((edef * buffEDefMul)/2)) * getElementBonus(pElem, eElem);
            if(Math.random() < 0.10) d *= 2;
            ehp -= Math.floor(d); updateUI();
            setTimeout(() => document.getElementById('e-area').classList.remove('shake'), 200);
        };
        attack(); document.getElementById('msg').innerText = "æ”»æ’ƒï¼";
        if (doubleAtkActive) { setTimeout(() => { if (ehp > 0) { attack(); document.getElementById('msg').innerText = "2å›é€£ç¶šæ”»æ’ƒï¼"; checkPostAtk(); } else checkPostAtk(); }, 400); }
        else setTimeout(checkPostAtk, 400);
    }
    function checkPostAtk() { if(ehp <= 0) showBonus(); else enemyTurn(); }
    function getElementBonus(a, d) { if (a === "âšª" || d === "âšª") return 1.0; if ((a === "ğŸ”¥" && d === "ğŸŒ¿") || (a === "ğŸ’§" && d === "ğŸ”¥") || (a === "ğŸŒ¿" && d === "ğŸ’§")) return 1.5; if ((a === "ğŸ”¥" && d === "ğŸ’§") || (a === "ğŸ’§" && d === "ğŸŒ¿") || (a === "ğŸŒ¿" && d === "ğŸ”¥")) return 0.7; return 1.0; }

    function enemyTurn() {
        document.getElementById('p-area').classList.add('shake');
        if (shieldActive) { 
            let mirr = shieldActive === "mirror";
            document.getElementById('msg').innerText = "ç„¡åŠ¹åŒ–ï¼" + (mirr?"åå°„ï¼":"");
            if(mirr) ehp -= eMax * 0.1; shieldActive = false; 
        } else { php -= Math.floor(Math.max(20, (eatk * buffEAtkMul) - Math.floor((pdef + buffDef)/2)) * getElementBonus(eElem, pElem)); }
        updateUI(); setTimeout(() => { document.getElementById('p-area').classList.remove('shake'); if(php <= 0) finish(false); }, 200);
    }

    function showBonus() { document.getElementById('bonus-screen').style.display = "flex"; switchCamera('B'); }
    function showSwapMenu() {
        const c = document.getElementById('item-container'); c.innerHTML = "<p>ãƒãƒƒã‚°æº€æ¯ã€‚ã©ã‚Œã¨æ›¿ãˆã‚‹ï¼Ÿ</p>";
        inventory.forEach((itm, i) => { const b = document.createElement('button'); b.className = "item-list-btn"; b.innerHTML = `æ›¿: ${itm.i} ${itm.n}`; b.onclick = () => { inventory[i] = pendingItem; completeBonus(); }; c.appendChild(b); });
        document.getElementById('item-menu').style.display = "flex";
    }
    async function completeBonus() { pendingItem = null; await stopCamera(); document.getElementById('item-menu').style.display = "none"; document.getElementById('bonus-screen').style.display = "none"; finish(true); }

    function openItemMenu() { isCraftMode = false; craftSelection = []; renderItemList(); document.getElementById('item-menu').style.display = "flex"; }
    function toggleCraftMode() { isCraftMode = !isCraftMode; craftSelection = []; document.getElementById('craft-mode-btn').innerText = isCraftMode ? "CANCEL" : "CRAFT MODE"; renderItemList(); }
    function renderItemList() {
        const c = document.getElementById('item-container'); c.innerHTML = isCraftMode ? "<p style='color:gold;'>2ã¤é¸ã‚“ã§åˆæˆï¼</p>" : "";
        inventory.forEach((itm, i) => {
            const b = document.createElement('button'); b.className = "item-list-btn" + (craftSelection.includes(i) ? " selected" : "");
            b.innerHTML = `${itm.i} ${itm.n}`; b.onclick = () => isCraftMode ? selectForCraft(i) : useItem(i); c.appendChild(b);
        });
    }

    function selectForCraft(i) {
        if (craftSelection.includes(i)) craftSelection = craftSelection.filter(idx => idx !== i);
        else if (craftSelection.length < 2) craftSelection.push(i);
        if (craftSelection.length === 2) {
            const types = [inventory[craftSelection[0]].t, inventory[craftSelection[1]].t];
            let res = { n:"å¤±æ•—ã®ç²‰", t:"DM", i:"ğŸŒ«ï¸" };
            if (types.includes("HE") && types.includes("ORB")) res = { n:"ã‚¨ãƒªã‚¯ã‚µãƒ¼", t:"ELIXIR", i:"ğŸ’" };
            else if (types.includes("DM") && types.includes("ORB")) res = { n:"å±æ€§å´©å£Šå¼¾", t:"NUKE", i:"â˜¢ï¸" };
            else if (types.includes("SHIELD") && types.includes("ORB")) res = { n:"ãƒŸãƒ©ãƒ¼ã‚·ãƒ¼ãƒ«ãƒ‰", t:"MIRROR", i:"ğŸª" };
            else if (types.includes("AT") && types.includes("DF")) res = { n:"è‹±é›„ã®è–¬", t:"HERO", i:"ğŸ‘‘" };
            const h = Math.max(...craftSelection), l = Math.min(...craftSelection);
            inventory.splice(h, 1); inventory.splice(l, 1); inventory.push(res);
            isCraftMode = false; craftSelection = []; document.getElementById('msg').innerText = "åˆæˆæˆåŠŸï¼"; renderItemList();
        } else renderItemList();
    }

    function useItem(i) {
        const itm = inventory[i];
        if(itm.t === "ORB") { showOrbMenu(i); return; }
        if(itm.t === "HE") php = Math.min(pMax, php + pMax*0.5);
        else if(itm.t === "DM") ehp -= eMax*0.3;
        else if(itm.t === "SHIELD") shieldActive = true;
        else if(itm.t === "MIRROR") shieldActive = "mirror";
        else if(itm.t === "DOUBLE") doubleAtkActive = true;
        else if(itm.t === "WEAK") buffEAtkMul = 0.5;
        else if(itm.t === "BREAK") buffEDefMul = 0;
        else if(itm.t === "KILL") ehp = 0;
        else if(itm.t === "ELIXIR") { php = pMax; buffAtk += 100; }
        else if(itm.t === "NUKE") { ehp -= eMax*0.4; buffEDefMul = 0.5; }
        else if(itm.t === "HERO") { buffAtk += 150; buffDef += 150; }
        document.getElementById('msg').innerText = itm.n + "ä½¿ç”¨ï¼";
        inventory.splice(i, 1); closeItemMenu(); updateUI(); if(ehp <= 0) setTimeout(showBonus, 600);
    }

    function showOrbMenu(idx) {
        const c = document.getElementById('item-container'); document.getElementById('item-menu-title').innerText = "SELECT ELEMENT"; c.innerHTML = "";
        [{s:"ğŸ”¥",n:"ç«"},{s:"ğŸ’§",n:"æ°´"},{s:"ğŸŒ¿",n:"è‰"},{s:"âšª",n:"ç„¡"}].forEach(el => {
            const b = document.createElement('button'); b.className = "item-list-btn"; b.innerHTML = el.s+"å±æ€§";
            b.onclick = () => { pElem = el.s; document.getElementById('p-elem').innerText = pElem; inventory.splice(idx, 1); closeItemMenu(); updateUI(); }; c.appendChild(b);
        });
    }

    function closeItemMenu() { document.getElementById('item-menu').style.display = 'none'; }
    function finish(win) {
        document.getElementById('res-screen').style.display = "flex";
        if(win) { exp += 50; if(exp >= nextExp) { lv++; exp=0; nextExp+=50; pMax=Math.floor(1000*(1+(lv-1)*0.1)); } document.getElementById('res-title').innerText = "VICTORY"; }
        else { lv = Math.max(1, lv-1); inventory = []; pMax=Math.floor(1000*(1+(lv-1)*0.1)); php=pMax; document.getElementById('res-title').innerText = "DEFEAT"; }
        localStorage.setItem('myth_inv_v13', JSON.stringify(inventory));
    }
    function closeResult() { document.getElementById('res-screen').style.display = "none"; mode = "W"; buffAtk = 0; buffDef = 0; buffEAtkMul = 1.0; buffEDefMul = 1.0; shieldActive = false; doubleAtkActive = false; updateCard('p', "-", "â“", "READY", "reset"); updateCard('e', "-", "â“", "???", "reset"); document.getElementById('atk-btn').disabled = true; document.getElementById('item-open-btn').disabled = true; document.getElementById('scan-btn').disabled = false; switchCamera('P'); updateUI(); }
    
    function updateUI() {
        document.getElementById('p-fill').style.width = (php / pMax * 100) + "%"; document.getElementById('p-hp-cur').innerText = Math.max(0, Math.floor(php)); document.getElementById('p-hp-max').innerText = pMax;
        document.getElementById('p-atk-val').innerText = patk + buffAtk; document.getElementById('p-def-val').innerText = pdef + buffDef; document.getElementById('p-lv').innerText = lv; document.getElementById('p-exp').innerText = exp;
        document.getElementById('e-fill').style.width = (eMax > 0 ? (ehp / eMax * 100) : 0) + "%"; document.getElementById('e-hp-cur').innerText = Math.max(0, Math.floor(ehp)); document.getElementById('e-hp-max').innerText = eMax;
        document.getElementById('e-atk-val').innerText = Math.floor(eatk * buffEAtkMul); document.getElementById('e-def-val').innerText = Math.floor(edef * buffEDefMul);
        document.getElementById('inv-count').innerText = `INV: ${inventory.length} / ${getMaxInv()}`;
    }
    init();
</script>
</body>
</html>
