<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MYTH SCANNER 4.21 - FULL</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet"></script>
    <link href="https://fonts.googleapis.com/css2?family=DotGothic16&display=swap" rel="stylesheet">
    <style>
        /* åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ«ã¯ãƒ™ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ç¶­æŒ */
        :root { --p-color: #00f2ff; --e-color: #ff3c00; --exp-color: #32ff32; --gold: #ffd700; }
        body { font-family: 'DotGothic16', sans-serif; background: #000; color: #fff; margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        #header { height: 40px; background: #222; display: flex; justify-content: center; align-items: center; border-bottom: 2px solid #444; flex-shrink: 0; }
        .lib-btn { width: 50%; font-size: 0.6rem; height: 24px; background: #555; border: 1px solid #fff; color: #fff; cursor: pointer; }
        .char-area { height: 32%; display: flex; border-bottom: 1px solid #333; padding: 10px; box-sizing: border-box; }
        .cam-part { width: 35%; display: flex; align-items: center; justify-content: center; }
        .cam-frame { width: 90px; height: 90px; border: 2px solid #555; background: #111; overflow: hidden; position: relative; border-radius: 8px; }
        video { width: 100%; height: 100%; object-fit: cover; display: none; }
        .cam-active video { display: block !important; border-color: #0f0; }
        .info-part { width: 65%; display: flex; flex-direction: column; padding-left: 10px; justify-content: center; }
        .visual-card { width: 100%; height: 80px; border: 2px solid #fff; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #111; position: relative; border-radius: 4px; overflow: hidden; }
        
        /* ã‚¢ã‚¤ã‚³ãƒ³ç”»åƒç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .visual-card img { width: 60px; height: 60px; object-fit: contain; }
        
        .stat-text { font-size: 0.65rem; color: #ccc; margin-top: 2px; line-height: 1.2; }
        .bar-container { width: 100%; margin-top: 4px; }
        .bar-bg { width: 100%; height: 8px; background: #222; border: 1px solid #666; position: relative; overflow: hidden; }
        .bar-fill { height: 100%; width: 0%; transition: width 0.4s ease-out; }
        .rarity-tag { position: absolute; top: 2px; right: 2px; font-size: 0.5rem; padding: 1px 3px; background: #fff; color: #000; font-weight: bold; }
        .elem-tag { position: absolute; top: 2px; left: 2px; font-size: 0.7rem; }
        #mid-ui { height: 140px; background: #111; border-top: 2px solid #444; display: flex; flex-direction: column; align-items: center; padding: 5px; flex-shrink: 0; }
        #msg { font-size: 0.8rem; color: #0f0; height: 45px; text-align: center; display: flex; align-items: center; padding: 0 10px; line-height: 1.2; white-space: pre-wrap; }
        .btn-row { display: flex; gap: 5px; width: 95%; justify-content: center; margin-bottom: 5px; }
        button { flex: 1; height: 40px; font-family: 'DotGothic16'; border: 2px solid #fff; color: #fff; background: #444; font-size: 0.75rem; cursor: pointer; }
        button:disabled { opacity: 0.3; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 100; display: none; flex-direction: column; align-items: center; padding: 15px; box-sizing: border-box; }
        .lib-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; width: 100%; max-height: 60vh; overflow-y: auto; padding: 10px; box-sizing: border-box; }
        .lib-slot { min-height: 65px; background: #222; border: 1px solid #444; border-radius: 4px; display: flex; align-items: center; justify-content: center; padding: 5px; text-align: center; position: relative; cursor: pointer; }
        .slot-content { font-size: 0.55rem; color: #555; word-break: break-all; pointer-events: none; }
        .lib-slot.found { border-color: var(--p-color); background: #333; }
        .lib-slot.found .slot-content { color: #fff; }
        .lib-rare-dot { position: absolute; top: 2px; right: 2px; font-size: 0.5rem; font-weight: bold; color: var(--gold); }
        .detail-pop { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #222; border: 3px solid var(--gold); padding: 20px; z-index: 200; width: 80%; text-align: center; display: none; border-radius: 10px; }
        .shake { animation: s 0.2s; }
        @keyframes s { 0%,100%{transform:translateX(0)} 25%{transform:translateX(5px)} 75%{transform:translateX(-5px)} }
        .q-mark { font-size: 3rem; color: #333; animation: blink 2s infinite; }
        @keyframes blink { 0%,100% {opacity:1} 50% {opacity:0.3} }
        .small-close { width: 120px !important; height: 35px !important; margin-top: 15px; flex: none; }
    </style>
</head>
<body>

<div id="header"><button onclick="openLibrary()" class="lib-btn">COLLECTION / RESET</button></div>

<div class="char-area" id="p-area">
    <div class="cam-part"><div class="cam-frame"><video id="pv" autoplay playsinline muted></video></div></div>
    <div class="info-part">
        <div id="p-card" class="visual-card">
            <div id="p-rare" class="rarity-tag">-</div>
            <div id="p-elem" class="elem-tag"></div>
            <div id="p-sym" class="q-mark">?</div>
            <div id="p-name" style="font-size:0.6rem; text-align:center;">SCANNER READY</div>
        </div>
        <div class="stat-text">LV:<span id="p-lv">1</span> HP:<span id="p-hp-cur">1000</span>/<span id="p-hp-max">1000</span><br>ATK:<span id="p-atk-val">0</span> DEF:<span id="p-def-val">50</span></div>
        <div class="bar-container"><div class="bar-bg"><div id="p-fill" class="bar-fill" style="background:var(--p-color); width:100%"></div></div></div>
        <div class="bar-container">
            <div style="display:flex; justify-content:space-between; font-size:0.5rem; color:var(--exp-color);"><span>EXP</span><span id="exp-text">0 / 30</span></div>
            <div class="bar-bg" style="height:5px;"><div id="exp-fill" class="bar-fill" style="background:var(--exp-color);"></div></div>
        </div>
    </div>
</div>

<div id="mid-ui">
    <div id="msg">INITIALIZING AI...</div>
    <div class="btn-row">
        <button id="scan-btn" onclick="handleScan()" disabled style="background:#0044cc">LOADING...</button>
        <button id="atk-btn" onclick="handleAttack()" disabled style="background:#aa0000">ATTACK</button>
        <button id="item-open-btn" onclick="openItemMenu()" disabled style="background:#008844">ITEM</button>
    </div>
    <div id="bag-status" style="font-size:0.65rem; color:#aaa;">BAG: 0/5</div>
</div>

<div class="char-area" id="e-area">
    <div class="cam-part"><div class="cam-frame"><video id="ev" autoplay playsinline muted></video></div></div>
    <div class="info-part">
        <div id="e-card" class="visual-card">
            <div id="e-rare" class="rarity-tag">-</div>
            <div id="e-elem" class="elem-tag"></div>
            <div id="e-sym" class="q-mark">?</div>
            <div id="e-name" style="font-size:0.6rem; text-align:center;">???</div>
        </div>
        <div class="stat-text">HP:<span id="e-hp-cur">0</span>/<span id="e-hp-max">0</span><br>ATK:<span id="e-atk-val">0</span> DEF:<span id="e-def-val">0</span></div>
        <div class="bar-container"><div class="bar-bg"><div id="e-fill" class="bar-fill" style="background:var(--e-color);"></div></div></div>
    </div>
</div>

<div id="res-screen" class="overlay" style="justify-content:center;"><h1 id="res-title" style="font-size:3rem; margin:0;"></h1><div id="res-stats" style="background:#222; padding:15px; border:2px solid #fff; margin:10px 0; width:85%; font-size:0.8rem; line-height:1.6; text-align:center;"></div><button onclick="closeResult()" style="width:200px; height:50px; background:#0044cc;">NEXT BATTLE</button></div>
<div id="lib-overlay" class="overlay"><h2>COLLECTION</h2><div style="display:flex; gap:5px; margin-bottom:10px;"><button onclick="renderLib('W')">WEAPON</button><button onclick="renderLib('M')">MONSTER</button><button onclick="renderLib('I')">ITEM</button></div><div id="lib-grid" class="lib-grid"></div><button onclick="fullReset()" style="margin-top:15px; background:#aa0000; font-size:0.6rem;">SAVE DATA RESET</button><button onclick="closeOverlay('lib-overlay')" class="small-close">CLOSE</button></div>
<div id="bonus-overlay" class="overlay"><h2 style="color:var(--gold);">ITEM SCAN</h2><div class="cam-frame" style="width:150px; height:150px;"><video id="bv" autoplay playsinline muted></video></div><button id="bonus-get-btn" onclick="getBonusItem()" style="background:#0044cc; width:100%; margin-top:20px; height:50px;">GET ITEM</button></div>
<div id="item-overlay" class="overlay"><h2>BAG</h2><div id="item-list" style="width:100%;"></div><button onclick="closeOverlay('item-overlay')" class="small-close">CLOSE</button></div>
<div id="detail-pop" class="detail-pop"><h3 id="det-name"></h3><p id="det-desc" style="white-space: pre-wrap; font-size:0.8rem;"></p><button onclick="closeDetail()" class="small-close">CLOSE</button></div>

<script>
    // --- ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ ---
    const DB_WEAPON = ["éŒ†ã³ãŸçŸ­å‰£","æ£’åˆ‡ã‚Œ","é‰„ã®ãƒ¤ã‚¹ãƒª","ç·´ç¿’ç”¨ã®å‰£","çš®ã®ãƒ ãƒ","çŸ³ã®ç¤«","ç²—æœ«ãªå¼“","é‰„ã®æ£’","è–ªå‰²ã‚Šæ–§","ç©´ã®ç©ºã„ãŸç›¾","ãƒ–ãƒ­ãƒ³ã‚ºãƒŠã‚¤ãƒ•","é‰„ã®çˆª","ãƒ©ãƒ³ã‚¹","è­¦æ£’","æœ¨åˆ€","çŸ³ã®ãƒ¡ã‚¤ã‚¹","æŠ•ã’ãƒŠã‚¤ãƒ•","é‰„ã®é‡","å…µå£«ã®å‰£","å¤ã„ãƒãƒ«ãƒãƒ¼ãƒ‰","é‹¼é‰„ã®é•·å‰£","å‡¦åˆ‘äººã®æ–§","éŠ€ã®ãƒ¬ã‚¤ãƒ”ã‚¢","å‰›å¼“","æ¼†é»’ã®çŸ­åˆ€","ç†Ÿç·´ã®æˆ¦æ§Œ","çŒ›ç£ã®ç‰™","æŠœåˆ€æ–ã®åˆ€","æš—æ®ºè€…ã®é‡","é–ƒå…‰ã®ãƒ€ã‚¬ãƒ¼","å®ˆè­·è€…ã®å¤§ç›¾","ã‚¹ãƒŠã‚¤ãƒ‘ãƒ¼ãƒ©ã‚¤ãƒ•ãƒ«","é¨å£«ã®ãƒ©ãƒ³ã‚¹","åå­—æ§","ä¸‰ç¯€æ£","ãƒ•ãƒ©ãƒ³ãƒ™ãƒ«ã‚¸ãƒ¥","é­”æ³•ã®æ–","ä¸‰å‰çŸ›","é»„é‡‘ã®æ§Œ","ã‚«ãƒˆãƒ©ã‚¹","ãƒã‚¹ã‚¿ãƒ¼ã‚½ãƒ¼ãƒ‰","ãƒŸã‚¹ãƒªãƒ«ã®å°å¤ªåˆ€","å‡çµã®é­”å¼“","çˆ†ç‚ã®æ–§","ç¨²å¦»ã®åˆºå‰£","ç«œæ®ºã—ã®å¤ªåˆ€","å¹»å½±ã®åŒå‰£","å²©æ–­ã¡ã®å·¨æ–§","ç²¾éœŠã®æ–","ç ´é‚ªã®å¼“","å®ˆè­·ç¥ã®æ§","æ¯’è›‡ã®å°¾","å¸è¡€ã®ç‰™","æ˜Ÿå±‘ã®ãƒ¡ã‚¤ã‚¹","éœ‡å‹•ã®ãƒãƒ³ãƒãƒ¼","è’¼å¤©ã®å‰£","çƒˆé¢¨ã®éŒ","æ–­ç½ªã®é–","è³¢è€…ã®è¾å…¸","æ·±æµ·ã®ãƒãƒ³ãƒˆ","ãƒ•ãƒ¬ã‚¤ãƒ ã‚¿ãƒ³","ãƒŸãƒ§ãƒ«ãƒ‹ãƒ«","ãƒˆãƒ©ã‚¤ãƒ‡ãƒ³ãƒˆ","ã‚¬ã‚¤ã‚¢ãƒãƒ³ãƒãƒ¼","å††æœˆåˆ€","ã‚¯ãƒ¬ã‚¤ãƒ¢ã‚¢","å·¨äººã®é‰„çƒ","ãƒ•ãƒ¬ã‚¤ãƒ«","ç´°å‰£","é­”æ§","è–é¨å£«ã®ç›¾","é»’é‡‘ã®æ£æ£’","å‘ªã„ã®å‘ªç¬¦","ç…‰ç„ã®éŒ","æ¥µå…‰ã®çŸ¢","ç¥é€Ÿã®ãƒ€ã‚¬ãƒ¼","ä¸å£Šã®ç± æ‰‹","é£›é¾ã®é­”ç¬›","æ··æ²Œã®æ–","è™šç©ºã®é¡","é­”å‰£ã‚°ãƒ©ãƒ ","è–å‰£ã‚¨ã‚¯ã‚¹ã‚«ãƒªãƒãƒ¼","ç«œæ§ã‚²ã‚¤ãƒœãƒ«ã‚°","è–æ§ãƒ­ãƒ³ã‚®ãƒŒã‚¹","å¤©ç¾½ã€…æ–¬","æ‘æ­£","ç¥å¼“ã‚¢ãƒ«ãƒ†ãƒŸã‚¹","ãƒ¢ãƒ¼ãƒ‹ãƒ³ã‚°ã‚¹ã‚¿ãƒ¼","ã‚¢ãƒ­ãƒ³ãƒ€ã‚¤ãƒˆ","ãƒ‡ãƒ¥ãƒ©ãƒ³ãƒ€ãƒ«","å¦–åˆ€æ­£å®—","éœŠåˆ€ä¸ƒæ”¯åˆ€","é­”å°æ›¸ã‚¢ãƒ«ãƒãƒ‡ãƒ«","ç ´æ»…ã®çˆª","çµ¶å½±","ç©¶æ¥µç¥å‰£ã‚¼ãƒã‚¹","æ™‚ç©ºè²«é€šç¥æ§","çœŸç†ã®é­”å°æ ¸","å¤©åœ°å´©å£Šã®çµ‚æ§Œ","é»™ç¤ºéŒ²ã®ç¥ç›¾"];
    const DB_MONSTER = ["ã‚¹ãƒ©ã‚¤ãƒ ","ã‚´ãƒ–ãƒªãƒ³","ã‚¹ã‚±ãƒ«ãƒˆãƒ³","é‡è‰¯çŠ¬","å·¨å¤§ã‚¯ãƒ¢","ã‚¦ã‚£ã‚¹ãƒ—","ã‚³ãƒãƒ«ãƒˆ","å¤§ãƒã‚ºãƒŸ","ã‚¾ãƒ³ãƒ“","ãƒãƒƒãƒˆ","æ³¥äººå½¢","å‡¶æš´ãªé¶","è¿·ã„é­‚","å¯„ç”Ÿè™«","å½±","æµ®éŠã™ã‚‹ç›®ç‰","æ¯’èœ‚","è…ã£ãŸæ¨¹æœ¨","çŸ³ã®ãƒˆã‚«ã‚²","ã¯ãã‚Œãƒ¡ã‚¿ãƒ«","ã‚ªãƒ¼ã‚¯","ãƒ‡ã‚¹ãƒŠã‚¤ãƒˆ","ã‚±ãƒ«ãƒ™ãƒ­ã‚¹","ã‚­ãƒã‚¤ãƒ©","ãƒŸãƒŸãƒƒã‚¯","ã‚¬ãƒ¼ã‚´ã‚¤ãƒ«","ãƒªãƒ“ãƒ³ã‚°ã‚¢ãƒ¼ãƒãƒ¼","ã‚¦ã‚§ã‚¢ã‚¦ãƒ«ãƒ•","ãƒãƒ³ã‚·ãƒ¼","ã‚°ãƒ¼ãƒ«","ã‚µã‚­ãƒ¥ãƒã‚¹","ã‚¤ãƒ³ãƒ—","ãƒãƒ¼ãƒ”ãƒ¼","ãƒ©ãƒŸã‚¢","ã‚±ãƒ³ã‚¿ã‚¦ãƒ­ã‚¹","ãƒŸãƒã‚¿ã‚¦ãƒ­ã‚¹","ãƒãƒ³ãƒ†ã‚£ã‚³ã‚¢","ã‚³ã‚«ãƒˆãƒªã‚¹","ã‚µãƒ©ãƒãƒ³ãƒ€ãƒ¼","ã‚¦ãƒ³ãƒ‡ã‚£ãƒ¼ãƒ","ãƒ¬ãƒƒãƒ‰ãƒ‰ãƒ©ã‚´ãƒ³","ãƒ´ã‚¡ãƒ³ãƒ‘ã‚¤ã‚¢","é¦–ãªã—é¨å£«","ãƒ‡ãƒ¼ãƒ¢ãƒ³","ã‚´ãƒ¼ãƒ¬ãƒ ","ã‚°ãƒªãƒ•ã‚©ãƒ³","ãƒã‚¸ãƒªã‚¹ã‚¯","ãƒ’ãƒ¥ãƒ‰ãƒ©","ã‚¯ãƒ©ãƒ¼ã‚±ãƒ³","ãƒ•ã‚§ãƒ‹ãƒƒã‚¯ã‚¹","å·¨å¤§ãªç™¾è¶³","å‘ªã„ã®éºå½±","ç ‚æ¼ ã®é­”äºº","é›ªå¥³","é›·ç£","é—‡ã®å¸ç¥­","æ­»éœŠä½¿ã„","æ²¼ã®æ€ªç‰©","è¿·å®®ã®ç•ªäºº","å²©çŸ³å·¨äºº","å¤é¾","ç½å„ã®åŒ–èº«","ã‚¢ãƒ¼ã‚¯ãƒ‡ãƒ¼ãƒ¢ãƒ³","å •å¤©ä½¿","ãƒªãƒƒãƒ","ãƒ‡ãƒ¼ãƒ¢ãƒ³ãƒ­ãƒ¼ãƒ‰","åŒé ­ã®å·¨ç£","ãƒ¤ãƒã‚¿ãƒã‚ªãƒ­ãƒ","ã‚¤ãƒ•ãƒªãƒ¼ãƒˆ","ã‚·ãƒ´ã‚¡","ãƒ©ãƒ ã‚¦","ã‚¿ã‚¤ã‚¿ãƒ³","ã‚¬ãƒ«ãƒ¼ãƒ€","ãƒªãƒ´ã‚¡ã‚¤ã‚¢ã‚µãƒ³","ã‚«ã‚ªã‚¹","ãƒ¡ãƒ‰ã‚¥ãƒ¼ã‚µ","ã‚­ãƒ¥ã‚¯ãƒ­ãƒ—ã‚¹","ãƒ™ãƒ’ãƒ¼ãƒ¢ã‚¹","ã‚¹ãƒ•ã‚£ãƒ³ã‚¯ã‚¹","å®ˆè­·åƒ","ç¥ç«œ","å‰µä¸–ã®å·¨ç¥","ç†¾å¤©ä½¿","å†¥ç‹ãƒãƒ‡ã‚¹","ç ´å£Šç¥ã‚·ãƒ´ã‚¡","å¤§å¤©ä½¿ãƒŸã‚«ã‚¨ãƒ«","å¦–ç‹ç‰è—»å‰","å…«å’«çƒ","éº’éºŸ","é³³å‡°","ç™½è™","ç„æ­¦","æœ±é›€","é’é¾","é­”ç‹ã‚µã‚¿ãƒ³","å¥ˆè½ã®æ”¯é…è€…","çµ‚ç„‰ã‚’å–°ã‚‰ã†è€…","è™šç„¡ã®ç‰¹ç•°ç‚¹","é»™ç¤ºéŒ²ã®é»’ç«œ","å‰µä¸–ã®çˆ¶"];
    const DB_ITEM = ["æ³¥æ°´","é›‘è‰","è‹”","æ¨¹æ¶²","éœ²ç‰","è‘‰ã£ã±","æ¹§ãæ°´","é£´ç‰","è»Ÿè†","è–¬æ¹¯","è–¬è‰","ãƒãƒ¼ã‚·ãƒ§ãƒ³","è’¸ç•™æ°´","ãŠå®ˆã‚Š","ç²‰è–¬","ç´…èŒ¶","æ „é¤Šå‰¤","ãƒ“ã‚¹ã‚±ãƒƒãƒˆ","ç§˜è–¬","è–æ¯","ç ¥çŸ³","çˆª","ç‰™","ç«è–¬","é‡ã„çŸ³","é‡˜","æ","ã‚¤ãƒ³ã‚´ãƒƒãƒˆ","ç´‹ç« ","ç‹¼ã®è¡€","å‹‡æ°—ã®è¨¼","ç¡çŸ³","çŸ¢å°»","æŒ‡è¼ª","é±—","æ¿€æ˜‚ã®è§’","éš•çŸ³","é›·ã®é­”çŸ³","ãŸã¦ãŒã¿","ç‹‚ä¹±ã®ãƒ™ãƒ«ã‚»ãƒ«ã‚¯","è…æ•—æ¶²","æ¯’ã‚­ãƒã‚³","é‡","ç²‰æœ«","ç—ºã‚Œè‰","èœ‚ã®é‡","æŠœã‘æ®»","æ¯’æ¶²","è…é£Ÿå‰¤","æ€¨å¿µã®éœ§","èœ˜è››ã®ç³¸","åŠ‡è–¬","ç˜´æ°—","é—‡ã®é›«","æ­»ç¥ã®åæ¯","å†¥ç•Œã®é…’","æ»…ã³ã®åˆ»å°","å‘ªã„ç¬¦","ç…‰ç„ã®ç‚","çµ‚ç„‰ã®å®£å‘Š","ãƒ¤ã‚¹ãƒª","æ³¥å›£å­","è™«é£Ÿã„çš®","æ°´æ™¶","å‘ªæ–‡","é‡åŠ›ç ‚","ç²˜ç€æ¶²","æº¶è§£æ¶²","ç ´ç”²æ§Œ","è„†åŒ–ç²‰","äº€è£‚çŸ³","æ‹˜æŸé–","è„±åŠ›éœ§","é˜²å£å´©ã—æ§","è™šç„¡çœ¼","ç‹æ°´","è£‚ãçˆª","æµ¸é£Ÿé‡‘","é­‚ã®æª»","å› æœã®æ–­çµ¶","ç«ç‚ç‰","ç„”å¿ƒ","æº¶å²©æ»´","æ°´æ™¶ç‰","æ°·æ²³æ¶™","çœŸç ","é›·é›»çƒ","å°¾ç¾½","å¸¯é›»è§’","å¤§åœ°ç¨®","æ¨¹æœ¨è¨˜æ†¶","æ£®æ—ç ","ç¼ç†±çŸ³","æ¸…æµçŸ³","é³´ç¥çŸ³","é¢¨ç¥ç€","æ˜æ˜ŸçŸ³","å®µé—‡çŸ³","æ··æ²Œç ","å‰µä¸–ã®ãƒ—ãƒªã‚ºãƒ "];
    const ELEMENTS = { "ğŸ”¥": "ğŸŒ¿", "ğŸŒ¿": "âš¡", "âš¡": "ğŸ’§", "ğŸ’§": "ğŸ”¥" };

    // --- ã‚¢ã‚¤ã‚³ãƒ³åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ ---
    const ICON_POOL = {
        W: {
            "å‰£": "https://via.placeholder.com/100/ff3300/ffffff?text=SWORD",
            "ç›¾": "https://via.placeholder.com/100/ccaa00/ffffff?text=SHIELD",
            "æ–": "https://via.placeholder.com/100/ff00ff/ffffff?text=WAND",
            "å¼“": "https://via.placeholder.com/100/66cc33/ffffff?text=BOW"
        },
        M: {
            "ã‚¹ãƒ©ã‚¤ãƒ ": "https://via.placeholder.com/100/44ccff/ffffff?text=SLIME",
            "ãƒ‰ãƒ©ã‚´ãƒ³": "https://via.placeholder.com/100/333333/ffffff?text=DRAGON",
            "ã‚¾ãƒ³ãƒ“": "https://via.placeholder.com/100/9900cc/ffffff?text=UNDEAD",
            "é³¥": "https://via.placeholder.com/100/3366ff/ffffff?text=BIRD"
        }
    };

    function getAutoIcon(type, name) {
        const pool = ICON_POOL[type];
        if (type === 'W') {
            if (/å‰£|ãƒ–ãƒ¬ãƒ¼ãƒ‰|ã‚½ãƒ¼ãƒ‰|åˆ€/.test(name)) return `<img src="${pool["å‰£"]}">`;
            if (/ç›¾|ã‚¬ãƒ¼ãƒ‰/.test(name)) return `<img src="${pool["ç›¾"]}">`;
            if (/æ–|ã‚¹ãƒ†ãƒƒã‚­|æ›¸/.test(name)) return `<img src="${pool["æ–"]}">`;
            if (/å¼“/.test(name)) return `<img src="${pool["å¼“"]}">`;
            return "âš”ï¸"; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
        } else {
            if (/ã‚¹ãƒ©ã‚¤ãƒ /.test(name)) return `<img src="${pool["ã‚¹ãƒ©ã‚¤ãƒ "]}">`;
            if (/ãƒ‰ãƒ©ã‚´ãƒ³|ç«œ/.test(name)) return `<img src="${pool["ãƒ‰ãƒ©ã‚´ãƒ³"]}">`;
            if (/ã‚¾ãƒ³ãƒ“|ã‚¹ã‚±ãƒ«ãƒˆãƒ³|äº¡è€…/.test(name)) return `<img src="${pool["ã‚¾ãƒ³ãƒ“"]}">`;
            if (/é³¥|ãƒãƒ”/.test(name)) return `<img src="${pool["é³¥"]}">`;
            return "ğŸ‘¾"; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
        }
    }

    // --- ã‚²ãƒ¼ãƒ ç®¡ç†å¤‰æ•° ---
    let net, mode="W", lv=1, exp=0, php=1000, pMax=1000, patk=0, pdefBase=50, pdef=50, ehp=0, eMax=0, eatk=0, edef=0, pelem="", eelem="", stream=null, atkBoostMult=1, currentEnemyRank=1, pAtkBonus=1.0, pDefBonus=1.0, inventory = [];
    let library = JSON.parse(localStorage.getItem('myth_v4_final')) || { W: {}, M: {}, I: {}, stats: {lv:1, exp:0, pMax:1000, pAtkBonus:1.0, pDefBonus:1.0} };

    if(library.stats) { lv=library.stats.lv; exp=library.stats.exp; pMax=library.stats.pMax; pAtkBonus=library.stats.pAtkBonus; pDefBonus=library.stats.pDefBonus; php=pMax; pdef=Math.floor(pdefBase*pDefBonus); }

    // --- èµ·å‹• & ã‚«ãƒ¡ãƒ©ç®¡ç† ---
    async function init() {
        try { 
            net = await mobilenet.load(); 
            document.getElementById('scan-btn').disabled = false; 
            document.getElementById('scan-btn').innerText = "SCAN"; 
            document.getElementById('msg').innerText = "æ­¦å™¨ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ãã ã•ã„"; 
            await switchCamera('P'); 
        }
        catch (e) { document.getElementById('msg').innerText = "AI ERROR: " + e.message; }
        updateUI();
    }

    async function switchCamera(target) {
        if(stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }
        if(target === 'OFF') { document.querySelectorAll('.cam-frame').forEach(f=>f.classList.remove('cam-active')); return; }
        
        const vId = {P:'pv', E:'ev', B:'bv'}[target];
        const videoElement = document.getElementById(vId);
        
        try {
            stream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: "environment", width: { ideal: 480 }, height: { ideal: 480 } },
                audio: false
            });
            videoElement.srcObject = stream;
            // iOS Safari & Chromeå¯¾ç­–: æ˜ç¤ºçš„ã«playã‚’å‘¼ã¶
            videoElement.onloadedmetadata = () => {
                videoElement.play();
                document.querySelectorAll('.cam-frame').forEach(f=>f.classList.remove('cam-active'));
                videoElement.parentElement.classList.add('cam-active');
            };
        } catch(e) { 
            document.getElementById('msg').innerText = "CAMERA ERROR\næ¨©é™ã‚’ç¢ºèªã—ã¦ãã ã•ã„";
        }
    }

    // --- ã‚¹ã‚­ãƒ£ãƒ³å‡¦ç† ---
    async function handleScan() {
        const vid = mode==="W" ? document.getElementById('pv') : document.getElementById('ev');
        let id, aiName = "UNKNOWN";
        try { const r = await net.classify(vid); aiName = r[0].className.split(',')[0].toUpperCase(); id = Math.floor(r[0].probability * 100); }
        catch (e) { id = Math.floor(Math.random() * 100); }
        
        const rareLabel = id >= 95 ? "MYTH" : id >= 80 ? "LEGEND" : id >= 40 ? "ELITE" : "NORMAL";
        
        if(mode==="W") {
            let base = DB_WEAPON[id] || DB_WEAPON[0]; pelem = ["ğŸ”¥", "ğŸ’§", "âš¡", "ğŸŒ¿"][id % 4];
            let rarityMult = (id >= 95) ? 6.0 : (id >= 80) ? 4.0 : (id >= 40) ? 2.2 : 1.2;
            let individualMult = 0.85 + Math.random() * 0.3;
            let type = id % 3;
            let bAtk = type === 0 ? 130 : type === 1 ? 70 : 100;
            let bDef = type === 0 ? 10 : type === 1 ? 80 : 40;
            
            patk = Math.floor(bAtk * rarityMult * individualMult * pAtkBonus);
            let wDef = Math.floor(bDef * rarityMult * individualMult);
            pdef = Math.floor((pdefBase * pDefBonus) + wDef);

            updateCardUI('p', rareLabel, getAutoIcon('W', base), `${aiName}ã®${base}`, pelem);
            library.W[id] = {t: base, e: pelem, r: rareLabel, atk: patk, def: wDef};
            mode="M"; await switchCamera('E'); 
            document.getElementById('msg').innerText = `ATK:${patk} DEF:${pdef} ã‚’è£…å‚™ï¼\næ¬¡ã¯ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã‚’ã‚¹ã‚­ãƒ£ãƒ³ï¼`;
        } else {
            let base = DB_MONSTER[id] || DB_MONSTER[0]; eelem = ["ğŸ”¥", "ğŸ’§", "âš¡", "ğŸŒ¿"][id % 4];
            let rarityMult = (id >= 95) ? 7.0 : (id >= 80) ? 4.5 : (id >= 40) ? 2.5 : 1.6;
            currentEnemyRank = rarityMult * (0.8 + Math.random() * 0.4); 
            let lvFactor = (1 + (lv-1)*0.1); 
            eMax = Math.floor(800 * currentEnemyRank * lvFactor); ehp = eMax; 
            eatk = Math.floor(75 * currentEnemyRank * lvFactor);
            edef = Math.floor(35 * currentEnemyRank * lvFactor);
            
            updateCardUI('e', rareLabel === "NORMAL" ? "NORMAL" : "BOSS", getAutoIcon('M', base), `${aiName}ã®${base}`, eelem);
            library.M[id+100] = {t: base, e: eelem, r: rareLabel};
            await switchCamera('OFF'); 
            document.getElementById('atk-btn').disabled = false; document.getElementById('item-open-btn').disabled = false;
            document.getElementById('scan-btn').disabled = true; 
            document.getElementById('msg').innerText = `é‡ç”Ÿã® ${base} ãŒç¾ã‚ŒãŸï¼\nBATTLE START!`;
        }
        save(); updateUI();
    }

    // --- ä»¥é™ã€ãƒãƒˆãƒ«ãƒ­ã‚¸ãƒƒã‚¯ç­‰ã¯ãƒ™ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã¨åŒä¸€ ---
    function handleAttack() {
        document.getElementById('atk-btn').disabled = true;
        let mult = (ELEMENTS[pelem] === eelem) ? 1.5 : (ELEMENTS[eelem] === pelem) ? 0.6 : 1.0;
        let dmg = Math.floor(Math.max(30, (patk * mult * atkBoostMult) - edef/3));
        ehp -= dmg; 
        document.getElementById('msg').innerText = `${dmg} ãƒ€ãƒ¡ãƒ¼ã‚¸ä¸ãˆãŸï¼` + (mult > 1 ? "\nåŠ¹æœã¯æŠœç¾¤ã ï¼" : "");
        atkBoostMult = 1; updateUI();
        document.getElementById('e-area').classList.add('shake');
        setTimeout(() => {
            document.getElementById('e-area').classList.remove('shake');
            if(ehp <= 0) { document.getElementById('msg').innerText = "æ•µã‚’å€’ã—ãŸï¼"; showBonus(); } else { enemyTurn(); }
        }, 800);
    }

    function enemyTurn() {
        document.getElementById('msg').innerText = "æ•µã®æ”»æ’ƒã‚¿ãƒ¼ãƒ³ï¼";
        setTimeout(() => {
            let mult = (ELEMENTS[eelem] === pelem) ? 1.4 : (ELEMENTS[pelem] === eelem) ? 0.7 : 1.0;
            let dmg = Math.floor(Math.max(20, (eatk * mult) - pdef/2));
            php -= dmg; document.getElementById('msg').innerText = `${dmg} ãƒ€ãƒ¡ãƒ¼ã‚¸å—ã‘ãŸï¼`;
            updateUI(); document.getElementById('p-area').classList.add('shake');
            setTimeout(() => {
                document.getElementById('p-area').classList.remove('shake');
                if(php <= 0) { finish(false); } else { document.getElementById('msg').innerText = "ã‚ãªãŸã®ã‚¿ãƒ¼ãƒ³ã§ã™ï¼"; document.getElementById('atk-btn').disabled = false; }
            }, 800);
        }, 1000);
    }

    function showBonus() { document.getElementById('bonus-overlay').style.display='flex'; switchCamera('B'); }
    async function getBonusItem() {
        const btn = document.getElementById('bonus-get-btn');
        btn.disabled = true; btn.innerText = "SCANNING...";
        let id; try { const r = await net.classify(document.getElementById('bv')); id = Math.floor(r[0].probability * 100); }
        catch(e) { id = Math.floor(Math.random()*100); }
        let typeArr = ["HE", "AT", "PO", "WE", "ORB"];
        let type = typeArr[Math.floor(id / 20)];
        let val = (0.1 + (id % 20 / 20) * 0.8);
        const name = DB_ITEM[id] || DB_ITEM[0];
        if(inventory.length < 5) inventory.push({ n: name, t: type, v: val });
        library.I[id+200] = {t: name, et: type, r: id >= 95 ? "MYTH" : "NORMAL"};
        save(); await switchCamera('OFF'); document.getElementById('bonus-overlay').style.display='none';
        btn.disabled = false; btn.innerText = "GET ITEM";
        finish(true);
    }

    function finish(win) {
        document.getElementById('res-screen').style.display='flex';
        const resSts = document.getElementById('res-stats');
        if(win) {
            document.getElementById('res-title').innerText = "WIN!";
            let nextReq = Math.floor(30 * Math.pow(lv, 1.5));
            let baseGained = Math.floor(nextReq * 0.2); 
            let gained = Math.floor(baseGained * currentEnemyRank); 
            exp += gained;
            let healAmt = Math.floor(pMax * 0.5); 
            php = Math.min(pMax, php + healAmt);
            let resultHtml = `æ•µã‚’æ’ƒç ´ï¼<br><span style="color:var(--exp-color); font-size:1.2rem;">EXP +${gained}</span><br>HPãŒ ${healAmt} å›å¾©ï¼`;
            let levelUpCount = 0;
            while (exp >= Math.floor(30 * Math.pow(lv, 1.5))) { exp -= Math.floor(30 * Math.pow(lv, 1.5)); lv++; levelUpCount++; pMax = Math.floor(pMax * 1.1); pAtkBonus += 0.05; pDefBonus += 0.05; }
            if(levelUpCount > 0){ php = pMax; pdef = Math.floor(pdefBase * pDefBonus); resultHtml = `<span style="color:var(--gold); font-size:1.5rem;">LEVEL UP! (x${levelUpCount})</span><br>èƒ½åŠ›ãŒä¸Šæ˜‡ï¼`; }
            resSts.innerHTML = resultHtml;
        } else {
            document.getElementById('res-title').innerText = "LOSE...";
            lv = Math.max(1, lv - 1); exp = 0; php = pMax;
            resSts.innerText = "æ•—åŒ—... ãƒ¬ãƒ™ãƒ«ãŒä½ä¸‹ã€‚";
        }
        save(); updateUI();
    }

    function closeResult() {
        document.getElementById('res-screen').style.display = 'none';
        mode = "W"; ehp = 0; eMax = 0; eatk = 0; edef = 0;
        document.getElementById('scan-btn').disabled = false;
        document.getElementById('atk-btn').disabled = true;
        document.getElementById('item-open-btn').disabled = true;
        document.getElementById('msg').innerText = "æ­¦å™¨ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ãã ã•ã„";
        resetCardUI('e'); updateUI(); switchCamera('P');
    }

    function resetCardUI(side) {
        document.getElementById(`${side}-rare`).innerText = "-";
        const s = document.getElementById(`${side}-sym`);
        s.innerHTML = "?"; s.className = "q-mark"; s.style.fontSize = "3rem";
        document.getElementById(`${side}-name`).innerText = side === 'p' ? "SCANNER READY" : "???";
        document.getElementById(`${side}-elem`).innerText = "";
    }

    function updateUI() {
        document.getElementById('p-lv').innerText = lv;
        document.getElementById('p-hp-cur').innerText = Math.max(0, Math.floor(php));
        document.getElementById('p-hp-max').innerText = Math.floor(pMax);
        document.getElementById('p-fill').style.width = (php/pMax*100) + "%";
        document.getElementById('exp-text').innerText = `${exp} / ${Math.floor(30 * Math.pow(lv, 1.5))}`;
        document.getElementById('exp-fill').style.width = (exp/Math.floor(30 * Math.pow(lv, 1.5))*100) + "%";
        document.getElementById('e-hp-cur').innerText = Math.max(0, Math.floor(ehp));
        document.getElementById('e-hp-max').innerText = Math.floor(eMax);
        document.getElementById('e-fill').style.width = (eMax>0 ? (ehp/eMax*100) : 0) + "%";
        document.getElementById('p-atk-val').innerText = Math.floor(patk);
        document.getElementById('p-def-val').innerText = Math.floor(pdef);
        document.getElementById('e-atk-val').innerText = Math.floor(eatk);
        document.getElementById('e-def-val').innerText = Math.floor(edef);
        document.getElementById('bag-status').innerText = `BAG: ${inventory.length}/5`;
    }

    function updateCardUI(side, rare, symHtml, name, elem) {
        document.getElementById(`${side}-rare`).innerText = rare;
        const s = document.getElementById(`${side}-sym`); 
        s.innerHTML = symHtml; s.className = ""; s.style.fontSize = "2rem";
        document.getElementById(`${side}-name`).innerText = name;
        document.getElementById(`${side}-elem`).innerText = elem;
    }

    // --- å›³é‘‘ & ã‚»ãƒ¼ãƒ– ---
    function renderLib(type) {
        const grid = document.getElementById('lib-grid'); grid.innerHTML = "";
        const offset = {W:0, M:100, I:200}[type];
        const dataSrc = {W:DB_WEAPON, M:DB_MONSTER, I:DB_ITEM}[type];
        for(let i=0; i<dataSrc.length; i++) {
            const id = offset + i; const data = library[type][id];
            const slot = document.createElement('div');
            slot.className = "lib-slot" + (data ? " found" : "");
            if(data) {
                slot.onclick = () => {
                    document.getElementById('det-name').innerText = data.t;
                    let desc = (type === 'W') ? `ATK: ${data.atk} / DEF: ${data.def}\nå±æ€§: ${data.e}\nå¸Œå°‘åº¦: ${data.r}` :
                               (type === 'M') ? `å±æ€§: ${data.e}\nå¸Œå°‘åº¦: ${data.r}` : `å¸Œå°‘åº¦: ${data.r}\n\nåŠ¹æœ: ã‚¢ã‚¤ãƒ†ãƒ `;
                    document.getElementById('det-desc').innerText = desc;
                    document.getElementById('detail-pop').style.display = 'block';
                };
            }
            const content = document.createElement('div'); content.className = "slot-content"; content.innerText = data ? data.t : `No.${id}`;
            if(data && data.r && data.r !== "NORMAL") { const dot = document.createElement('div'); dot.className = "lib-rare-dot"; dot.innerText = data.r[0]; slot.appendChild(dot); }
            slot.appendChild(content); grid.appendChild(slot);
        }
    }

    function openItemMenu() {
        const list = document.getElementById('item-list'); list.innerHTML = "";
        if(inventory.length === 0) list.innerHTML = "<p style='font-size:0.7rem; color:#666;'>ãƒãƒƒã‚°ã¯ç©ºã§ã™</p>";
        inventory.forEach((itm, i) => { const b = document.createElement('button'); b.style.width = "100%"; b.style.marginBottom = "5px"; b.innerHTML = `${itm.n}`; b.onclick = () => useItem(itm, i); list.appendChild(b); });
        document.getElementById('item-overlay').style.display='flex';
    }

    function useItem(itm, idx) {
        if(itm.t === "HE") php = Math.min(pMax, php + pMax * itm.v);
        else if(itm.t === "AT") atkBoostMult = 1.5 + itm.v;
        else if(itm.t === "PO") ehp -= Math.floor(ehp * itm.v);
        else if(itm.t === "WE") edef = Math.floor(edef * (1 - itm.v));
        inventory.splice(idx, 1); closeOverlay('item-overlay'); updateUI();
    }

    function save() { library.stats = {lv, exp, pMax, pAtkBonus, pDefBonus}; localStorage.setItem('myth_v4_final', JSON.stringify(library)); }
    function fullReset() { if(confirm("å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ")) { localStorage.clear(); location.reload(); } }
    function openLibrary() { renderLib('W'); document.getElementById('lib-overlay').style.display='flex'; }
    function closeOverlay(id) { document.getElementById(id).style.display='none'; }
    function closeDetail() { document.getElementById('detail-pop').style.display = 'none'; }
    
    window.onload = init;
</script>
</body>
</html>
