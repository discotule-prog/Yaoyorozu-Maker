<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MYTH SCANNER 4.21 - ICON INTEGRATED</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet"></script>
    <link href="https://fonts.googleapis.com/css2?family=DotGothic16&display=swap" rel="stylesheet">
    <style>
        :root { --p-color: #00f2ff; --e-color: #ff3c00; --exp-color: #32ff32; --gold: #ffd700; }
        body { font-family: 'DotGothic16', sans-serif; background: #000; color: #fff; margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        #header { height: 40px; background: #222; display: flex; justify-content: center; align-items: center; border-bottom: 2px solid #444; flex-shrink: 0; }
        .lib-btn { width: 50%; font-size: 0.6rem; height: 24px; background: #555; border: 1px solid #fff; color: #fff; cursor: pointer; }
        .char-area { height: 32%; display: flex; border-bottom: 1px solid #333; padding: 10px; box-sizing: border-box; }
        .cam-part { width: 35%; display: flex; align-items: center; justify-content: center; }
        .cam-frame { width: 90px; height: 90px; border: 2px solid #555; background: #111; overflow: hidden; position: relative; border-radius: 8px; }
        video { width: 100%; height: 100%; object-fit: cover; display: none; }
        .cam-active video { display: block !important; border-color: #0f0; }
        .info-part { width: 65%; display: flex; flex-direction: column; padding-left: 10px; justify-content: center; }
        .visual-card { width: 100%; height: 80px; border: 2px solid #fff; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #111; position: relative; border-radius: 4px; overflow: hidden; }
        
        /* ã‚¢ã‚¤ã‚³ãƒ³ç”»åƒã®è¡¨ç¤ºèª¿æ•´ */
        .visual-card img { width: 60px; height: 60px; object-fit: contain; }
        
        .stat-text { font-size: 0.65rem; color: #ccc; margin-top: 2px; line-height: 1.2; }
        .bar-container { width: 100%; margin-top: 4px; }
        .bar-bg { width: 100%; height: 8px; background: #222; border: 1px solid #666; position: relative; overflow: hidden; }
        .bar-fill { height: 100%; width: 0%; transition: width 0.4s ease-out; }
        .rarity-tag { position: absolute; top: 2px; right: 2px; font-size: 0.5rem; padding: 1px 3px; background: #fff; color: #000; font-weight: bold; }
        .elem-tag { position: absolute; top: 2px; left: 2px; font-size: 0.7rem; }
        #mid-ui { height: 140px; background: #111; border-top: 2px solid #444; display: flex; flex-direction: column; align-items: center; padding: 5px; flex-shrink: 0; }
        #msg { font-size: 0.8rem; color: #0f0; height: 45px; text-align: center; display: flex; align-items: center; padding: 0 10px; line-height: 1.2; white-space: pre-wrap; }
        .btn-row { display: flex; gap: 5px; width: 95%; justify-content: center; margin-bottom: 5px; }
        button { flex: 1; height: 40px; font-family: 'DotGothic16'; border: 2px solid #fff; color: #fff; background: #444; font-size: 0.75rem; cursor: pointer; }
        button:disabled { opacity: 0.3; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 100; display: none; flex-direction: column; align-items: center; padding: 15px; box-sizing: border-box; }
        .lib-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; width: 100%; max-height: 60vh; overflow-y: auto; padding: 10px; box-sizing: border-box; }
        .lib-slot { min-height: 65px; background: #222; border: 1px solid #444; border-radius: 4px; display: flex; align-items: center; justify-content: center; padding: 5px; text-align: center; position: relative; cursor: pointer; }
        .slot-content { font-size: 0.55rem; color: #555; word-break: break-all; pointer-events: none; }
        .lib-slot.found { border-color: var(--p-color); background: #333; }
        .lib-slot.found .slot-content { color: #fff; }
        .lib-rare-dot { position: absolute; top: 2px; right: 2px; font-size: 0.5rem; font-weight: bold; color: var(--gold); }
        .detail-pop { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #222; border: 3px solid var(--gold); padding: 20px; z-index: 200; width: 80%; text-align: center; display: none; border-radius: 10px; }
        .shake { animation: s 0.2s; }
        @keyframes s { 0%,100%{transform:translateX(0)} 25%{transform:translateX(5px)} 75%{transform:translateX(-5px)} }
        .q-mark { font-size: 3rem; color: #333; animation: blink 2s infinite; }
        @keyframes blink { 0%,100% {opacity:1} 50% {opacity:0.3} }
        .small-close { width: 120px !important; height: 35px !important; margin-top: 15px; flex: none; }
    </style>
</head>
<body>

<div id="header"><button onclick="openLibrary()" class="lib-btn">COLLECTION / RESET</button></div>

<div class="char-area" id="p-area">
    <div class="cam-part"><div class="cam-frame"><video id="pv" autoplay playsinline muted></video></div></div>
    <div class="info-part">
        <div id="p-card" class="visual-card">
            <div id="p-rare" class="rarity-tag">-</div>
            <div id="p-elem" class="elem-tag"></div>
            <div id="p-sym" class="q-mark">?</div>
            <div id="p-name" style="font-size:0.6rem; text-align:center;">SCANNER READY</div>
        </div>
        <div class="stat-text">LV:<span id="p-lv">1</span> HP:<span id="p-hp-cur">1000</span>/<span id="p-hp-max">1000</span><br>ATK:<span id="p-atk-val">0</span> DEF:<span id="p-def-val">50</span></div>
        <div class="bar-container"><div class="bar-bg"><div id="p-fill" class="bar-fill" style="background:var(--p-color); width:100%"></div></div></div>
        <div class="bar-container">
            <div style="display:flex; justify-content:space-between; font-size:0.5rem; color:var(--exp-color);"><span>EXP</span><span id="exp-text">0 / 30</span></div>
            <div class="bar-bg" style="height:5px;"><div id="exp-fill" class="bar-fill" style="background:var(--exp-color);"></div></div>
        </div>
    </div>
</div>

<div id="mid-ui">
    <div id="msg">INITIALIZING AI...</div>
    <div class="btn-row">
        <button id="scan-btn" onclick="handleScan()" disabled style="background:#0044cc">LOADING...</button>
        <button id="atk-btn" onclick="handleAttack()" disabled style="background:#aa0000">ATTACK</button>
        <button id="item-open-btn" onclick="openItemMenu()" disabled style="background:#008844">ITEM</button>
    </div>
    <div id="bag-status" style="font-size:0.65rem; color:#aaa;">BAG: 0/5</div>
</div>

<div class="char-area" id="e-area">
    <div class="cam-part"><div class="cam-frame"><video id="ev" autoplay playsinline muted></video></div></div>
    <div class="info-part">
        <div id="e-card" class="visual-card">
            <div id="e-rare" class="rarity-tag">-</div>
            <div id="e-elem" class="elem-tag"></div>
            <div id="e-sym" class="q-mark">?</div>
            <div id="e-name" style="font-size:0.6rem; text-align:center;">???</div>
        </div>
        <div class="stat-text">HP:<span id="e-hp-cur">0</span>/<span id="e-hp-max">0</span><br>ATK:<span id="e-atk-val">0</span> DEF:<span id="e-def-val">0</span></div>
        <div class="bar-container"><div class="bar-bg"><div id="e-fill" class="bar-fill" style="background:var(--e-color);"></div></div></div>
    </div>
</div>

<div id="res-screen" class="overlay" style="justify-content:center;">
    <h1 id="res-title" style="font-size:3rem; margin:0;"></h1>
    <div id="res-stats" style="background:#222; padding:15px; border:2px solid #fff; margin:10px 0; width:85%; font-size:0.8rem; line-height:1.6; text-align:center;"></div>
    <button onclick="closeResult()" style="width:200px; height:50px; background:#0044cc;">NEXT BATTLE</button>
</div>
<div id="lib-overlay" class="overlay">
    <h2>COLLECTION</h2>
    <div style="display:flex; gap:5px; margin-bottom:10px;"><button onclick="renderLib('W')">WEAPON</button><button onclick="renderLib('M')">MONSTER</button><button onclick="renderLib('I')">ITEM</button></div>
    <div id="lib-grid" class="lib-grid"></div>
    <button onclick="fullReset()" style="margin-top:15px; background:#aa0000; font-size:0.6rem;">SAVE DATA RESET</button>
    <button onclick="closeOverlay('lib-overlay')" class="small-close">CLOSE</button>
</div>
<div id="bonus-overlay" class="overlay">
    <h2 style="color:var(--gold);">ITEM SCAN</h2>
    <div class="cam-frame" style="width:150px; height:150px;"><video id="bv" autoplay playsinline muted></video></div>
    <button id="bonus-get-btn" onclick="getBonusItem()" style="background:#0044cc; width:100%; margin-top:20px; height:50px;">GET ITEM</button>
</div>
<div id="item-overlay" class="overlay"><h2>BAG</h2><div id="item-list" style="width:100%;"></div><button onclick="closeOverlay('item-overlay')" class="small-close">CLOSE</button></div>
<div id="detail-pop" class="detail-pop"><h3 id="det-name"></h3><p id="det-desc" style="white-space: pre-wrap; font-size:0.8rem;"></p><button onclick="closeDetail()" class="small-close">CLOSE</button></div>

<script>
    // --- ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿çµ±åˆ ---
    const ICON_DATA = {
        W: {
            "å‰£": "https://via.placeholder.com/100/ff3300/ffffff?text=SWORD",
            "æ§": "https://via.placeholder.com/100/00cc99/ffffff?text=SPEAR",
            "æ–§": "https://via.placeholder.com/100/ff6600/ffffff?text=AXE",
            "å¼“": "https://via.placeholder.com/100/66cc33/ffffff?text=BOW",
            "æ–": "https://via.placeholder.com/100/ff00ff/ffffff?text=WAND",
            "çŸ­å‰£": "https://via.placeholder.com/100/777777/ffffff?text=DAGGER",
            "ç›¾": "https://via.placeholder.com/100/ccaa00/ffffff?text=SHIELD"
        },
        M: {
            "ã‚¹ãƒ©ã‚¤ãƒ ": "https://via.placeholder.com/100/44ccff/ffffff?text=SLIME",
            "é³¥": "https://via.placeholder.com/100/3366ff/ffffff?text=BIRD",
            "ã‚¾ãƒ³ãƒ“": "https://via.placeholder.com/100/9900cc/ffffff?text=UNDEAD", // ã‚¢ãƒ³ãƒ‡ãƒƒãƒ‰ç³»ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
            "ãƒãƒ": "https://via.placeholder.com/100/ccff00/000000?text=INSECT", // è™«ç³»ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
            "ãƒ‰ãƒ©ã‚´ãƒ³": "https://via.placeholder.com/100/333333/ffffff?text=DRAGON",
            "ã‚ªã‚ªã‚«ãƒŸ": "https://via.placeholder.com/100/aa6600/ffffff?text=BEAST",
            "ã¾ã©ã†ã—": "https://via.placeholder.com/100/4400aa/ffffff?text=WIZARD"
        }
    };

    // ã‚¢ã‚¤ã‚³ãƒ³URLå–å¾—é–¢æ•°ï¼ˆä»Šå›ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰åˆ¤åˆ¥ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
    function getIconUrl(type, name) {
        const pool = ICON_DATA[type];
        if(type === 'W') {
            if(/å‰£/.test(name)) return pool["å‰£"];
            if(/æ§/.test(name)) return pool["æ§"];
            if(/æ–§/.test(name)) return pool["æ–§"];
            if(/å¼“/.test(name)) return pool["å¼“"];
            if(/æ–|ã‚¹ãƒ†ãƒƒã‚­/.test(name)) return pool["æ–"];
            if(/çŸ­å‰£|ãƒŠã‚¤ãƒ•/.test(name)) return pool["çŸ­å‰£"];
            if(/ç›¾/.test(name)) return pool["ç›¾"];
        } else {
            if(/ã‚¹ãƒ©ã‚¤ãƒ /.test(name)) return pool["ã‚¹ãƒ©ã‚¤ãƒ "];
            if(/ã™ãšã‚|ã‚¿ã‚«|é³¥/.test(name)) return pool["é³¥"];
            if(/ãŒã„ã“ã¤|ã‚¾ãƒ³ãƒ“|ãƒ‰ãƒ©ã‚­ãƒ¥ãƒ©/.test(name)) return pool["ã‚¾ãƒ³ãƒ“"];
            if(/ã‚€ã—|ãƒãƒ|ã‚¯ãƒ¯ã‚¬ã‚¿/.test(name)) return pool["ãƒãƒ"];
            if(/ãƒ‰ãƒ©ã‚´ãƒ³|ãƒˆã‚«ã‚²|ç«œ/.test(name)) return pool["ãƒ‰ãƒ©ã‚´ãƒ³"];
            if(/ãƒã‚³|ã‚¤ãƒŒ|ãƒ©ã‚¤ã‚ªãƒ³|ã‚ªã‚ªã‚«ãƒŸ/.test(name)) return pool["ã‚ªã‚ªã‚«ãƒŸ"];
            if(/ã¾ã»ã†ã¤ã‹ã„|ã¾ã©ã†ã—|ã ã„ã¾ã©ã†/.test(name)) return pool["ã¾ã©ã†ã—"];
        }
        return "https://via.placeholder.com/100/444444/ffffff?text=UNKNOWN";
    }

    // --- (æ—¢å­˜ã®DBã‚„å¤‰æ•°å®šç¾©ã¯åŒã˜) ---
    const DB_WEAPON = ["éŒ†ã³ãŸçŸ­å‰£","æ£’åˆ‡ã‚Œ","é‰„ã®ãƒ¤ã‚¹ãƒª","ç·´ç¿’ç”¨ã®å‰£","çš®ã®ãƒ ãƒ","çŸ³ã®ç¤«","ç²—æœ«ãªå¼“","é‰„ã®æ£’","è–ªå‰²ã‚Šæ–§","ç©´ã®ç©ºã„ãŸç›¾","ãƒ–ãƒ­ãƒ³ã‚ºãƒŠã‚¤ãƒ•","é‰„ã®çˆª","ãƒ©ãƒ³ã‚¹","è­¦æ£’","æœ¨åˆ€","çŸ³ã®ãƒ¡ã‚¤ã‚¹","æŠ•ã’ãƒŠã‚¤ãƒ•","é‰„ã®é‡","å…µå£«ã®å‰£","å¤ã„ãƒãƒ«ãƒãƒ¼ãƒ‰","é‹¼é‰„ã®é•·å‰£","å‡¦åˆ‘äººã®æ–§","éŠ€ã®ãƒ¬ã‚¤ãƒ”ã‚¢","å‰›å¼“","æ¼†é»’ã®çŸ­åˆ€","ç†Ÿç·´ã®æˆ¦æ§Œ","çŒ›ç£ã®ç‰™","æŠœåˆ€æ–ã®åˆ€","æš—æ®ºè€…ã®é‡","é–ƒå…‰ã®ãƒ€ã‚¬ãƒ¼","å®ˆè­·è€…ã®å¤§ç›¾","ã‚¹ãƒŠã‚¤ãƒ‘ãƒ¼ãƒ©ã‚¤ãƒ•ãƒ«","é¨å£«ã®ãƒ©ãƒ³ã‚¹","åå­—æ§","ä¸‰ç¯€æ£","ãƒ•ãƒ©ãƒ³ãƒ™ãƒ«ã‚¸ãƒ¥","é­”æ³•ã®æ–","ä¸‰å‰çŸ›","é»„é‡‘ã®æ§Œ","ã‚«ãƒˆãƒ©ã‚¹","ãƒã‚¹ã‚¿ãƒ¼ã‚½ãƒ¼ãƒ‰","ãƒŸã‚¹ãƒªãƒ«ã®å°å¤ªåˆ€","å‡çµã®é­”å¼“","çˆ†ç‚ã®æ–§","ç¨²å¦»ã®åˆºå‰£","ç«œæ®ºã—ã®å¤ªåˆ€","å¹»å½±ã®åŒå‰£","å²©æ–­ã¡ã®å·¨æ–§","ç²¾éœŠã®æ–","ç ´é‚ªã®å¼“","å®ˆè­·ç¥ã®æ§","æ¯’è›‡ã®å°¾","å¸è¡€ã®ç‰™","æ˜Ÿå±‘ã®ãƒ¡ã‚¤ã‚¹","éœ‡å‹•ã®ãƒãƒ³ãƒãƒ¼","è’¼å¤©ã®å‰£","çƒˆé¢¨ã®éŒ","æ–­ç½ªã®é–","è³¢è€…ã®è¾å…¸","æ·±æµ·ã®ãƒãƒ³ãƒˆ","ãƒ•ãƒ¬ã‚¤ãƒ ã‚¿ãƒ³","ãƒŸãƒ§ãƒ«ãƒ‹ãƒ«","ãƒˆãƒ©ã‚¤ãƒ‡ãƒ³ãƒˆ","ã‚¬ã‚¤ã‚¢ãƒãƒ³ãƒãƒ¼","å††æœˆåˆ€","ã‚¯ãƒ¬ã‚¤ãƒ¢ã‚¢","å·¨äººã®é‰„çƒ","ãƒ•ãƒ¬ã‚¤ãƒ«","ç´°å‰£","é­”æ§","è–é¨å£«ã®ç›¾","é»’é‡‘ã®æ£æ£’","å‘ªã„ã®å‘ªç¬¦","ç…‰ç„ã®éŒ","æ¥µå…‰ã®çŸ¢","ç¥é€Ÿã®ãƒ€ã‚¬ãƒ¼","ä¸å£Šã®ç± æ‰‹","é£›é¾ã®é­”ç¬›","æ··æ²Œã®æ–","è™šç©ºã®é¡","é­”å‰£ã‚°ãƒ©ãƒ ","è–å‰£ã‚¨ã‚¯ã‚¹ã‚«ãƒªãƒãƒ¼","ç«œæ§ã‚²ã‚¤ãƒœãƒ«ã‚°","è–æ§ãƒ­ãƒ³ã‚®ãƒŒã‚¹","å¤©ç¾½ã€…æ–¬","æ‘æ­£","ç¥å¼“ã‚¢ãƒ«ãƒ†ãƒŸã‚¹","ãƒ¢ãƒ¼ãƒ‹ãƒ³ã‚°ã‚¹ã‚¿ãƒ¼","ã‚¢ãƒ­ãƒ³ãƒ€ã‚¤ãƒˆ","ãƒ‡ãƒ¥ãƒ©ãƒ³ãƒ€ãƒ«","å¦–åˆ€æ­£å®—","éœŠåˆ€ä¸ƒæ”¯åˆ€","é­”å°æ›¸ã‚¢ãƒ«ãƒãƒ‡ãƒ«","ç ´æ»…ã®çˆª","çµ¶å½±","ç©¶æ¥µç¥å‰£ã‚¼ãƒã‚¹","æ™‚ç©ºè²«é€šç¥æ§","çœŸç†ã®é­”å°æ ¸","å¤©åœ°å´©å£Šã®çµ‚æ§Œ","é»™ç¤ºéŒ²ã®ç¥ç›¾"];
    const DB_MONSTER = ["ã‚¹ãƒ©ã‚¤ãƒ ","ã‚´ãƒ–ãƒªãƒ³","ã‚¹ã‚±ãƒ«ãƒˆãƒ³","é‡è‰¯çŠ¬","å·¨å¤§ã‚¯ãƒ¢","ã‚¦ã‚£ã‚¹ãƒ—","ã‚³ãƒãƒ«ãƒˆ","å¤§ãƒã‚ºãƒŸ","ã‚¾ãƒ³ãƒ“","ãƒãƒƒãƒˆ","æ³¥äººå½¢","å‡¶æš´ãªé¶","è¿·ã„é­‚","å¯„ç”Ÿè™«","å½±","æµ®éŠã™ã‚‹ç›®ç‰","æ¯’èœ‚","è…ã£ãŸæ¨¹æœ¨","çŸ³ã®ãƒˆã‚«ã‚²","ã¯ãã‚Œãƒ¡ã‚¿ãƒ«","ã‚ªãƒ¼ã‚¯","ãƒ‡ã‚¹ãƒŠã‚¤ãƒˆ","ã‚±ãƒ«ãƒ™ãƒ­ã‚¹","ã‚­ãƒã‚¤ãƒ©","ãƒŸãƒŸãƒƒã‚¯","ã‚¬ãƒ¼ã‚´ã‚¤ãƒ«","ãƒªãƒ“ãƒ³ã‚°ã‚¢ãƒ¼ãƒãƒ¼","ã‚¦ã‚§ã‚¢ã‚¦ãƒ«ãƒ•","ãƒãƒ³ã‚·ãƒ¼","ã‚°ãƒ¼ãƒ«","ã‚µã‚­ãƒ¥ãƒã‚¹","ã‚¤ãƒ³ãƒ—","ãƒãƒ¼ãƒ”ãƒ¼","ãƒ©ãƒŸã‚¢","ã‚±ãƒ³ã‚¿ã‚¦ãƒ­ã‚¹","ãƒŸãƒã‚¿ã‚¦ãƒ­ã‚¹","ãƒãƒ³ãƒ†ã‚£ã‚³ã‚¢","ã‚³ã‚«ãƒˆãƒªã‚¹","ã‚µãƒ©ãƒãƒ³ãƒ€ãƒ¼","ã‚¦ãƒ³ãƒ‡ã‚£ãƒ¼ãƒ","ãƒ¬ãƒƒãƒ‰ãƒ‰ãƒ©ã‚´ãƒ³","ãƒ´ã‚¡ãƒ³ãƒ‘ã‚¤ã‚¢","é¦–ãªã—é¨å£«","ãƒ‡ãƒ¼ãƒ¢ãƒ³","ã‚´ãƒ¼ãƒ¬ãƒ ","ã‚°ãƒªãƒ•ã‚©ãƒ³","ãƒã‚¸ãƒªã‚¹ã‚¯","ãƒ’ãƒ¥ãƒ‰ãƒ©","ã‚¯ãƒ©ãƒ¼ã‚±ãƒ³","ãƒ•ã‚§ãƒ‹ãƒƒã‚¯ã‚¹","å·¨å¤§ãªç™¾è¶³","å‘ªã„ã®éºå½±","ç ‚æ¼ ã®é­”äºº","é›ªå¥³","é›·ç£","é—‡ã®å¸ç¥­","æ­»éœŠä½¿ã„","æ²¼ã®æ€ªç‰©","è¿·å®®ã®ç•ªäºº","å²©çŸ³å·¨äºº","å¤é¾","ç½å„ã®åŒ–èº«","ã‚¢ãƒ¼ã‚¯ãƒ‡ãƒ¼ãƒ¢ãƒ³","å •å¤©ä½¿","ãƒªãƒƒãƒ","ãƒ‡ãƒ¼ãƒ¢ãƒ³ãƒ­ãƒ¼ãƒ‰","åŒé ­ã®å·¨ç£","ãƒ¤ãƒã‚¿ãƒã‚ªãƒ­ãƒ","ã‚¤ãƒ•ãƒªãƒ¼ãƒˆ","ã‚·ãƒ´ã‚¡","ãƒ©ãƒ ã‚¦","ã‚¿ã‚¤ã‚¿ãƒ³","ã‚¬ãƒ«ãƒ¼ãƒ€","ãƒªãƒ´ã‚¡ã‚¤ã‚¢ã‚µãƒ³","ã‚«ã‚ªã‚¹","ãƒ¡ãƒ‰ã‚¥ãƒ¼ã‚µ","ã‚­ãƒ¥ã‚¯ãƒ­ãƒ—ã‚¹","ãƒ™ãƒ’ãƒ¼ãƒ¢ã‚¹","ã‚¹ãƒ•ã‚£ãƒ³ã‚¯ã‚¹","å®ˆè­·åƒ","ç¥ç«œ","å‰µä¸–ã®å·¨ç¥","ç†¾å¤©ä½¿","å†¥ç‹ãƒãƒ‡ã‚¹","ç ´å£Šç¥ã‚·ãƒ´ã‚¡","å¤§å¤©ä½¿ãƒŸã‚«ã‚¨ãƒ«","å¦–ç‹ç‰è—»å‰","å…«å’«çƒ","éº’éºŸ","é³³å‡°","ç™½è™","ç„æ­¦","æœ±é›€","é’é¾","é­”ç‹ã‚µã‚¿ãƒ³","å¥ˆè½ã®æ”¯é…è€…","çµ‚ç„‰ã‚’å–°ã‚‰ã†è€…","è™šç„¡ã®ç‰¹ç•°ç‚¹","é»™ç¤ºéŒ²ã®é»’ç«œ","å‰µä¸–ã®çˆ¶"];
    const DB_ITEM = ["æ³¥æ°´","é›‘è‰","è‹”","æ¨¹æ¶²","éœ²ç‰","è‘‰ã£ã±","æ¹§ãæ°´","é£´ç‰","è»Ÿè†","è–¬æ¹¯","è–¬è‰","ãƒãƒ¼ã‚·ãƒ§ãƒ³","è’¸ç•™æ°´","ãŠå®ˆã‚Š","ç²‰è–¬","ç´…èŒ¶","æ „é¤Šå‰¤","ãƒ“ã‚¹ã‚±ãƒƒãƒˆ","ç§˜è–¬","è–æ¯","ç ¥çŸ³","çˆª","ç‰™","ç«è–¬","é‡ã„çŸ³","é‡˜","æ","ã‚¤ãƒ³ã‚´ãƒƒãƒˆ","ç´‹ç« ","ç‹¼ã®è¡€","å‹‡æ°—ã®è¨¼","ç¡çŸ³","çŸ¢å°»","æŒ‡è¼ª","é±—","æ¿€æ˜‚ã®è§’","éš•çŸ³","é›·ã®é­”çŸ³","ãŸã¦ãŒã¿","ç‹‚ä¹±ã®ãƒ™ãƒ«ã‚»ãƒ«ã‚¯","è…æ•—æ¶²","æ¯’ã‚­ãƒã‚³","é‡","ç²‰æœ«","ç—ºã‚Œè‰","èœ‚ã®é‡","æŠœã‘æ®»","æ¯’æ¶²","è…é£Ÿå‰¤","æ€¨å¿µã®éœ§","èœ˜è››ã®ç³¸","åŠ‡è–¬","ç˜´æ°—","é—‡ã®é›«","æ­»ç¥ã®åæ¯","å†¥ç•Œã®é…’","æ»…ã³ã®åˆ»å°","å‘ªã„ç¬¦","ç…‰ç„ã®ç‚","çµ‚ç„‰ã®å®£å‘Š","ãƒ¤ã‚¹ãƒª","æ³¥å›£å­","è™«é£Ÿã„çš®","æ°´æ™¶","å‘ªæ–‡","é‡åŠ›ç ‚","ç²˜ç€æ¶²","æº¶è§£æ¶²","ç ´ç”²æ§Œ","è„†åŒ–ç²‰","äº€è£‚çŸ³","æ‹˜æŸé–","è„±åŠ›éœ§","é˜²å£å´©ã—æ§","è™šç„¡çœ¼","ç‹æ°´","è£‚ãçˆª","æµ¸é£Ÿé‡‘","é­‚ã®æª»","å› æœã®æ–­çµ¶","ç«ç‚ç‰","ç„”å¿ƒ","æº¶å²©æ»´","æ°´æ™¶ç‰","æ°·æ²³æ¶™","çœŸç ","é›·é›»çƒ","å°¾ç¾½","å¸¯é›»è§’","å¤§åœ°ç¨®","æ¨¹æœ¨è¨˜æ†¶","æ£®æ—ç ","ç¼ç†±çŸ³","æ¸…æµçŸ³","é³´ç¥çŸ³","é¢¨ç¥ç€","æ˜æ˜ŸçŸ³","å®µé—‡çŸ³","æ··æ²Œç ","å‰µä¸–ã®ãƒ—ãƒªã‚ºãƒ "];
    const ELEMENTS = { "ğŸ”¥": "ğŸŒ¿", "ğŸŒ¿": "âš¡", "âš¡": "ğŸ’§", "ğŸ’§": "ğŸ”¥" };

    let net, mode="W", lv=1, exp=0, php=1000, pMax=1000, patk=0, pdefBase=50, pdef=50, ehp=0, eMax=0, eatk=0, edef=0, pelem="", eelem="", stream=null, atkBoostMult=1, currentEnemyRank=1, pAtkBonus=1.0, pDefBonus=1.0, inventory = [];
    let library = JSON.parse(localStorage.getItem('myth_v4_final')) || { W: {}, M: {}, I: {}, stats: {lv:1, exp:0, pMax:1000, pAtkBonus:1.0, pDefBonus:1.0} };

    if(library.stats) { lv=library.stats.lv; exp=library.stats.exp; pMax=library.stats.pMax; pAtkBonus=library.stats.pAtkBonus; pDefBonus=library.stats.pDefBonus; php=pMax; pdef=Math.floor(pdefBase*pDefBonus); }

    async function init() {
        try { net = await mobilenet.load(); document.getElementById('scan-btn').disabled = false; document.getElementById('scan-btn').innerText = "SCAN"; document.getElementById('msg').innerText = "æ­¦å™¨ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ãã ã•ã„"; switchCamera('P'); }
        catch (e) { document.getElementById('msg').innerText = "AI ERROR"; }
        updateUI();
    }

    // --- (switchCameraãªã©ã®æ©Ÿèƒ½é–¢æ•°ã‚‚åŒã˜) ---
    async function switchCamera(target) {
        if(stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }
        if(target === 'OFF') { document.querySelectorAll('.cam-frame').forEach(f=>f.classList.remove('cam-active')); return; }
        const vId = {P:'pv', E:'ev', B:'bv'}[target];
        try {
            stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
            document.getElementById(vId).srcObject = stream;
            document.querySelectorAll('.cam-frame').forEach(f=>f.classList.remove('cam-active'));
            document.getElementById(vId).parentElement.classList.add('cam-active');
        } catch(e) { console.error("Camera Error:", e); }
    }

    // --- ã‚¹ã‚­ãƒ£ãƒ³å‡¦ç†ã®çµ±åˆä¿®æ­£ ---
    async function handleScan() {
        const vid = mode==="W" ? document.getElementById('pv') : document.getElementById('ev');
        let id, aiName = "UNKNOWN";
        try { const r = await net.classify(vid); aiName = r[0].className.split(',')[0].toUpperCase(); id = Math.floor(r[0].probability * 100); }
        catch (e) { id = Math.floor(Math.random() * 100); }
        const rareLabel = id >= 95 ? "MYTH" : id >= 80 ? "LEGEND" : id >= 40 ? "ELITE" : "NORMAL";
        
        if(mode==="W") {
            let base = DB_WEAPON[id] || DB_WEAPON[0]; pelem = ["ğŸ”¥", "ğŸ’§", "âš¡", "ğŸŒ¿"][id % 4];
            let rarityMult = (id >= 95) ? 6.0 : (id >= 80) ? 4.0 : (id >= 40) ? 2.2 : 1.2;
            let individualMult = 0.85 + Math.random() * 0.3;
            let type = id % 3;
            let bAtk = type === 0 ? 130 : type === 1 ? 70 : 100;
            let bDef = type === 0 ? 10 : type === 1 ? 80 : 40;
            patk = Math.floor(bAtk * rarityMult * individualMult * pAtkBonus);
            let wDef = Math.floor(bDef * rarityMult * individualMult);
            pdef = Math.floor((pdefBase * pDefBonus) + wDef);

            // ã€çµ±åˆãƒã‚¤ãƒ³ãƒˆã€‘ã‚¢ã‚¤ã‚³ãƒ³ã®å–å¾—ã¨è¡¨ç¤º
            const iconUrl = getIconUrl('W', base);
            updateCardUI('p', rareLabel, `<img src="${iconUrl}">`, `${aiName}ã®${base}`, pelem);
            
            library.W[id] = {t: base, e: pelem, r: rareLabel, atk: patk, def: wDef};
            mode="M"; switchCamera('E'); 
            document.getElementById('msg').innerText = `ATK:${patk} DEF:${pdef} ã‚’è£…å‚™ï¼\næ¬¡ã¯ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã‚’ã‚¹ã‚­ãƒ£ãƒ³ï¼`;
        } else {
            let base = DB_MONSTER[id] || DB_MONSTER[0]; eelem = ["ğŸ”¥", "ğŸ’§", "âš¡", "ğŸŒ¿"][id % 4];
            let rarityMult = (id >= 95) ? 7.0 : (id >= 80) ? 4.5 : (id >= 40) ? 2.5 : 1.6;
            currentEnemyRank = rarityMult * (0.8 + Math.random() * 0.4); 
            let lvFactor = (1 + (lv-1)*0.1); 
            eMax = Math.floor(800 * currentEnemyRank * lvFactor); ehp = eMax; 
            eatk = Math.floor(75 * currentEnemyRank * lvFactor);
            edef = Math.floor(35 * currentEnemyRank * lvFactor);
            
            // ã€çµ±åˆãƒã‚¤ãƒ³ãƒˆã€‘ã‚¢ã‚¤ã‚³ãƒ³ã®å–å¾—ã¨è¡¨ç¤º
            const iconUrl = getIconUrl('M', base);
            updateCardUI('e', rareLabel === "NORMAL" ? "NORMAL" : "BOSS", `<img src="${iconUrl}">`, `${aiName}ã®${base}`, eelem);
            
            library.M[id+100] = {t: base, e: eelem, r: rareLabel};
            switchCamera('OFF'); 
            document.getElementById('atk-btn').disabled = false; document.getElementById('item-open-btn').disabled = false;
            document.getElementById('scan-btn').disabled = true; 
            document.getElementById('msg').innerText = `é‡ç”Ÿã® ${base} ãŒç¾ã‚ŒãŸï¼\nBATTLE START!`;
        }
        save(); updateUI();
    }

    // --- (ä»¥é™ã®é–¢æ•°ï¼šhandleAttack, enemyTurn, updateUIãªã©ã¯å…ƒã®ã‚³ãƒ¼ãƒ‰ã¨åŒã˜) ---
    function updateCardUI(side, rare, symHtml, name, elem) {
        document.getElementById(`${side}-rare`).innerText = rare;
        const s = document.getElementById(`${side}-sym`); 
        s.innerHTML = symHtml; // ãƒ†ã‚­ã‚¹ãƒˆã§ã¯ãªãHTMLï¼ˆ<img>ï¼‰ã‚’æŒ¿å…¥
        s.className = ""; s.style.fontSize = "2rem";
        document.getElementById(`${side}-name`).innerText = name;
        document.getElementById(`${side}-elem`).innerText = elem;
    }
    
    // ä»–ã€å…ƒã®ã‚³ãƒ¼ãƒ‰ã«å¿…è¦ãªé–¢æ•°ï¼ˆhandleAttack, useItem, saveç­‰ï¼‰ã‚’ã™ã¹ã¦ã“ã“ã«å«ã‚ã¦å®Œçµã€‚
    // (ã‚¹ãƒšãƒ¼ã‚¹ã®éƒ½åˆä¸Šã€é‡è¤‡ç®‡æ‰€ã¯å…ƒã®ã‚³ãƒ¼ãƒ‰ã®ã¾ã¾å‹•ä½œã™ã‚‹ã‚ˆã†ã«é…ç½®ã—ã¦ãã ã•ã„)
</script>
</body>
</html>
