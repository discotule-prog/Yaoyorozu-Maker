<!DOCTYPE html>
<html lang="ja">
<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <title>MONSTER BATTLE EVO</title>
 <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
 <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet"></script>
 <link href="https://fonts.googleapis.com/css2?family=DotGothic16&family=Share+Tech+Mono&display=swap" rel="stylesheet">
 <style>
 :root { --p-color: #00ff00; --e-color: #ff0000; }
 body { 
 font-family: 'DotGothic16', sans-serif; 
 background: #221100; color: #fff; margin: 0; 
 display: flex; justify-content: center;
 }
 #game-container { 
 width: 100vw; max-width: 450px; height: 100vh;
 background: #000; border: 4px solid #444;
 display: flex; flex-direction: column;
 }
 /* 上下分割レイアウト */
 .battle-area { flex: 1; position: relative; border: 2px solid #333; overflow: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; }
 #player-area { background: linear-gradient(to bottom, #112211, #000); }
 #enemy-area { background: linear-gradient(to top, #221111, #000); }

 .unit-label { position: absolute; top: 5px; left: 10px; font-size: 0.8rem; color: #aaa; z-index: 10; }
 
 /* モニター/カメラ */
 #monitor { width: 180px; height: 180px; border: 3px solid #fff; position: relative; background: #111; }
 video { width: 100%; height: 100%; object-fit: cover; display: block; }
 canvas { width: 100%; height: 100%; object-fit: cover; display: none; image-rendering: pixelated; }

 .enemy-sprite { font-size: 5rem; text-shadow: 0 0 20px #f00; transition: transform 0.1s; }

 /* ステータスバー */
 .stat-box { width: 80%; margin-top: 5px; background: rgba(0,0,0,0.5); padding: 5px; border: 1px solid #555; }
 .hp-bar { height: 10px; background: #333; width: 100%; margin-top: 3px; }
 .hp-fill { height: 100%; transition: width 0.3s; }
 #p-hp-fill { background: var(--p-color); }
 #e-hp-fill { background: var(--e-color); }

 /* 操作パネル */
 #ui-panel { height: 140px; background: #111; border-top: 4px solid #fff; padding: 10px; display: flex; flex-direction: column; }
 #msg-log { flex: 1; font-size: 0.85rem; color: #0f0; margin-bottom: 10px; overflow-y: hidden; }
 .btn-group { display: flex; gap: 10px; }
 button { flex: 1; padding: 12px; font-family: 'DotGothic16'; font-size: 1rem; border: 3px solid #fff; cursor: pointer; color: #fff; }
 #scan-btn { background: #0055ff; }
 #atk-btn { background: #cc0000; }
 button:disabled { background: #333; color: #888; border-color: #555; }

 /* エフェクト */
 .shake { animation: shake 0.3s; }
 @keyframes shake {
 0%, 100% { transform: translate(0,0); }
 25% { transform: translate(5px, 5px); }
 50% { transform: translate(-5px, -5px); }
 75% { transform: translate(5px, -5px); }
 }
 </style>
</head>
<body>

<div id="game-container">
 <div class="battle-area" id="player-area">
 <div class="unit-label">PLAYER UNIT</div>
 <div id="monitor">
 <video id="webcam" autoplay playsinline muted></video>
 <canvas id="p-canvas"></canvas>
 </div>
 <div class="stat-box">
 <div style="display:flex; justify-content:space-between; font-size:0.8rem;">
 <span id="p-name">UNKNOWN</span> <span>LV:<span id="lv">1</span></span>
 </div>
 <div class="hp-bar"><div id="p-hp-fill" class="hp-fill" style="width:100%"></div></div>
 <div style="font-size:0.7rem; text-align:right;">HP: <span id="p-hp-val">0</span></div>
 </div>
 </div>

 <div class="battle-area" id="enemy-area">
 <div class="unit-label">ENEMY UNIT</div>
 <div id="enemy-sprite" class="enemy-sprite"> </div>
 <div class="stat-box">
 <div style="font-size:0.8rem;">TARGET: <span id="e-name">DARK ROBOT</span></div>
 <div class="hp-bar"><div id="e-hp-fill" class="hp-fill" style="width:100%"></div></div>
 <div style="font-size:0.7rem; text-align:right;">HP: <span id="e-hp-val">0</span></div>
 </div>
 </div>

 <div id="ui-panel">
 <div id="msg-log">SYSTEM READY. SCAN A MONSTER!</div>
 <div class="btn-group">
 <button id="scan-btn">SCAN</button>
 <button id="atk-btn" disabled>ATTACK!</button>
 </div>
 </div>
</div>

<script>
 let net;
 let player = { lv: 1, hp: 100, maxHp: 100, atk: 25, def: 15, name: "???" };
 let enemy = { hp: 150, maxHp: 150, atk: 35, def: 10, name: "DARK ROBOT" };
 
 const video = document.getElementById('webcam');
 const canvas = document.getElementById('p-canvas');
 const ctx = canvas.getContext('2d');
 const log = document.getElementById('msg-log');

 async function init() {
 try {
 net = await mobilenet.load();
 const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
 video.srcObject = stream;
 log.innerText = "CAMERA ONLINE. FIND YOUR MONSTER.";
 } catch(e) { log.innerText = "ERROR: ACCESS DENIED."; }
 }

 function updateUI() {
 document.getElementById('p-name').innerText = player.name;
 document.getElementById('p-hp-val').innerText = Math.max(0, player.hp);
 document.getElementById('e-hp-val').innerText = Math.max(0, enemy.hp);
 document.getElementById('p-hp-fill').style.width = (player.hp / player.maxHp * 100) + "%";
 document.getElementById('e-hp-fill').style.width = (enemy.hp / enemy.maxHp * 100) + "%";
 document.getElementById('lv').innerText = player.lv;
 }

 document.getElementById('scan-btn').onclick = async () => {
 const result = await net.classify(video);
 player.name = result[0].className.split(',')[0].toUpperCase();
 
 // ドット絵化
 canvas.width = 128; canvas.height = 128;
 ctx.drawImage(video, 0, 0, 128, 128);
 video.style.display = 'none';
 canvas.style.display = 'block';

 // ハードモードなステータス生成
 let seed = player.name.length;
 player.maxHp = 400 + (seed * 20) + (player.lv * 30);
 player.hp = player.maxHp;
 player.atk = 40 + (seed * 5);
 
 // 敵も強化
 enemy.maxHp = 500 + (player.lv * 60);
 enemy.hp = enemy.maxHp;
 enemy.atk = 35 + (player.lv * 8);

 log.innerText = "DETECTION SUCCESS: " + player.name;
 document.getElementById('atk-btn').disabled = false;
 updateUI();
 };

 document.getElementById('atk-btn').onclick = () => {
 // PLAYER ATTACK
 document.getElementById('enemy-area').classList.add('shake');
 let dmg = Math.max(5, player.atk - Math.floor(Math.random() * 10));
 enemy.hp -= dmg;
 log.innerText = `YOU DEAL ${dmg} DAMAGE!`;
 
 setTimeout(() => document.getElementById('enemy-area').classList.remove('shake'), 300);

 if (enemy.hp <= 0) {
 log.innerText = "TARGET DESTROYED! LV UP!";
 player.lv++;
 document.getElementById('atk-btn').disabled = true;
 // 復活準備
 setTimeout(() => { 
 video.style.display = 'block'; canvas.style.display = 'none'; 
 log.innerText = "SCAN NEXT TARGET...";
 }, 2000);
 } else {
 // ENEMY COUNTER (強め)
 setTimeout(() => {
 document.getElementById('player-area').classList.add('shake');
 let eDmg = Math.max(10, enemy.atk - Math.floor(Math.random() * 5));
 player.hp -= eDmg;
 log.innerText = `ENEMY COUNTER! ${eDmg} DAMAGE!`;
 updateUI();
 setTimeout(() => document.getElementById('player-area').classList.remove('shake'), 300);
 
 if (player.hp <= 0) {
 log.innerText = "CRITICAL ERROR: YOU ARE DEFEATED.";
 document.getElementById('atk-btn').disabled = true;
 }
 }, 600);
 }
 updateUI();
 };

 init();
</script>
</body>
</html>
