<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MYTH SCANNER ULTIMATE</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet"></script>
    <link href="https://fonts.googleapis.com/css2?family=DotGothic16&display=swap" rel="stylesheet">
    <style>
        :root { --p-color: #00f2ff; --e-color: #ff3c00; }
        body { font-family: 'DotGothic16', sans-serif; background: #000; color: #fff; margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        #header { height: 40px; background: #222; display: flex; justify-content: space-around; align-items: center; font-size: 0.75rem; border-bottom: 2px solid #444; }
        .char-area { height: 32%; display: flex; border-bottom: 1px solid #333; padding: 5px; box-sizing: border-box; }
        .cam-part { width: 40%; display: flex; align-items: center; justify-content: center; }
        .cam-frame { width: 100px; height: 100px; border: 2px solid #555; background: #111; overflow: hidden; position: relative; border-radius: 4px; }
        video { width: 100%; height: 100%; object-fit: cover; display: none; }
        .cam-active video { display: block; border-color: #0f0; }
        .info-part { width: 60%; display: flex; flex-direction: column; padding-left: 10px; justify-content: center; }
        .visual-card { width: 100%; height: 80px; border: 2px solid #fff; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #111; position: relative; box-shadow: inset 0 0 15px rgba(255,255,255,0.1); }
        .rarity-tag { position: absolute; top: 0; right: 0; font-size: 0.5rem; background: #fff; color: #000; padding: 1px 4px; z-index: 3; }
        .stat-text { font-size: 0.7rem; color: #ccc; margin-top: 3px; line-height: 1.2; }
        .hp-bar-bg { width: 100%; height: 8px; background: #333; border: 1px solid #fff; margin-top: 3px; }
        .hp-bar-fill { height: 100%; transition: width 0.3s; }
        #mid-ui { height: 140px; background: #111; border-top: 2px solid #444; display: flex; flex-direction: column; align-items: center; padding: 5px; }
        #msg { font-size: 0.75rem; color: #0f0; height: 35px; text-align: center; display: flex; align-items: center; padding: 0 10px; line-height: 1.3; }
        .btn-row { display: flex; gap: 6px; width: 100%; flex-wrap: wrap; justify-content: center; }
        button { flex: 1; max-width: 100px; height: 38px; font-family: 'DotGothic16'; border: 2px solid #fff; color: #fff; background: #444; font-size: 0.75rem; cursor: pointer; }
        button:disabled { opacity: 0.3; cursor: not-allowed; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 100; display: none; flex-direction: column; align-items: center; padding: 20px; box-sizing: border-box; }
        .coll-box { width: 100%; flex: 1; overflow-y: auto; background: #111; border: 1px solid #444; padding: 8px; font-size: 0.65rem; margin-bottom: 5px; line-height: 1.6; }
        .shake { animation: s 0.2s; }
        @keyframes s { 0%,100%{transform:translateX(0)} 25%{transform:translateX(5px)} 75%{transform:translateX(-5px)} }
    </style>
</head>
<body>

<div id="header">
    <span>LV: <b id="p-lv">1</b> (+<b id="stat-boost">0</b>%)</span>
    <button onclick="showColl()" style="width:80px; height:25px;">LIBRARY</button>
</div>

<div class="char-area" id="p-area">
    <div class="cam-part" id="p-cam-box"><div class="cam-frame"><video id="pv" autoplay playsinline muted></video></div></div>
    <div class="info-part">
        <div id="p-card" class="visual-card">
            <div id="p-rare" class="rarity-tag">-</div>
            <div id="p-sym" style="font-size:2rem;">‚ùì</div>
            <div id="p-name" style="font-size:0.6rem; text-align:center;">READY</div>
        </div>
        <div class="stat-text">HP: <span id="p-hp-cur">1000</span>/<span id="p-hp-max">1000</span><br>ATK: <span id="p-atk-val">0</span> DEF: <span id="p-def-val">0</span></div>
        <div class="hp-bar-bg"><div id="p-fill" class="hp-bar-fill" style="background:var(--p-color); width:100%"></div></div>
    </div>
</div>

<div id="mid-ui">
    <div id="msg">Ê≠¶Âô®„Çí„Çπ„Ç≠„É£„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>
    <div class="btn-row">
        <button id="scan-btn" onclick="handleScan()" style="background:#0044cc">SCAN</button>
        <button id="atk-btn" onclick="handleAttack()" disabled style="background:#aa0000">ATTACK</button>
        <button id="item-btn" onclick="useItem()" disabled style="background:#008844">ITEM</button>
    </div>
    <div id="inventory-label" style="font-size:0.65rem; color:yellow; margin-top:8px;">ITEM: „Å™„Åó</div>
</div>

<div class="char-area" id="e-area">
    <div class="cam-part" id="e-cam-box"><div class="cam-frame"><video id="ev" autoplay playsinline muted></video></div></div>
    <div class="info-part">
        <div id="e-card" class="visual-card">
            <div id="e-rare" class="rarity-tag">-</div>
            <div id="e-sym" style="font-size:2rem;">‚ùì</div>
            <div id="e-name" style="font-size:0.6rem; text-align:center;">???</div>
        </div>
        <div class="stat-text">HP: <span id="e-hp-cur">1000</span>/<span id="e-hp-max">1000</span><br>ATK: <span id="e-atk-val">0</span> DEF: <span id="e-def-val">0</span></div>
        <div class="hp-bar-bg"><div id="e-fill" class="hp-bar-fill" style="background:var(--e-color); width:100%"></div></div>
    </div>
</div>

<div id="bonus-screen" class="overlay">
    <h2 style="color:gold;">VICTORY! BONUS SCAN</h2>
    <div class="cam-frame" style="width:160px; height:160px;" id="b-cam-box"><video id="bv" autoplay playsinline muted></video></div>
    <p style="text-align:center; font-size:0.8rem; margin:10px;">‰Ωï„Åã„Çí„Çπ„Ç≠„É£„É≥„Åó„Å¶„Ç¢„Ç§„ÉÜ„É†Áç≤ÂæóÔºÅ</p>
    <button id="bonus-btn" onclick="getBonusItem()" style="background:#0044cc; width:180px;">GET ITEM</button>
</div>

<div id="res-screen" class="overlay" style="justify-content:center;">
    <h1 id="res-title" style="margin:0;"></h1>
    <p id="res-msg" style="text-align:center; white-space: pre-wrap; margin:20px 0;"></p>
    <button onclick="closeResult()" style="width:200px; height:50px; background:#0044cc">NEXT</button>
</div>

<div id="coll-screen" class="overlay">
    <h2 style="color:yellow; font-size:1rem; margin:5px 0;">LIBRARY (No.001-100)</h2>
    <div id="w-coll" class="coll-box"></div>
    <div id="m-coll" class="coll-box"></div>
    <div id="i-coll" class="coll-box"></div>
    <button onclick="document.getElementById('coll-screen').style.display='none'">CLOSE</button>
</div>

<script>
    let net, mode = "W", lv = 1, exp = 0, nextExp = 100, php = 1000, pMax = 1000, ehp = 1000, eMax = 1000;
    let patk=0, pdef=0, eatk=0, edef=0, stream = null, inventory = null, currentMData = null;
    let buffAtk = 0, buffDef = 0;
    let coll = JSON.parse(localStorage.getItem('myth_v_final_logic')) || { weapons: {}, monsters: {}, items: {} };

    const naming = {
        W1: ["ÈâÑ","Èãº","Ëºù","È≠î","Èæç","Ê∞∑","ÁÇé","Èõ∑","ËÅñ","Á•û"],
        W2: ["„ÅÆÂâ£","„ÅÆÊñß","„ÅÆÊßç","„ÅÆÊùñ","„ÅÆÂºì","„ÅÆÈéå","„ÅÆÊßå","„ÅÆÂàÄ","„ÅÆÂ§ßÂâ£","„ÅÆÁü≠Ââ£"],
        M1: ["ÊØí","ÁÅ´","Ê∞¥","ÂΩ±","Á©∫","Ê£Æ","Èúä","Âè§","Áúü","ÊªÖ"],
        M2: ["„Çπ„É©„Ç§„É†","„Ç¶„É´„Éï","„Éâ„É©„Ç¥„É≥","„Çæ„É≥„Éì","„Ç¥„Éº„É¨„É†","„Éê„Éº„Éâ","„Éá„Éº„É¢„É≥","È®éÂ£´","Áéã","Á•û"],
        I: ["„Éù„Éº„Ç∑„Éß„É≥","ÁàÜÂºæ","Âäõ„ÅÆËñ¨","ÂÆà„Çä„ÅÆËñ¨","‰∏çÊÄùË≠∞„Å™Á≤â","Âè§„Å≥„ÅüÁì∂","ËÅñÊ∞¥","È≠îÂäõÁü≥","Âπ∏ÈÅã„ÅÆ„Ç≥„Ç§„É≥","„ÅäÂÆà„Çä"]
    };

    async function init() {
        net = await mobilenet.load();
        switchCamera('P');
    }

    async function stopCamera() {
        if(stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }
        ['p-cam-box','e-cam-box','b-cam-box'].forEach(b=>document.getElementById(b).classList.remove('cam-active'));
    }

    async function switchCamera(target) {
        await stopCamera();
        try {
            stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
            const vidId = {P:'pv', E:'ev', B:'bv'}[target];
            const boxId = {P:'p-cam-box', E:'e-cam-box', B:'b-cam-box'}[target];
            document.getElementById(vidId).srcObject = stream;
            document.getElementById(boxId).classList.add('cam-active');
        } catch(e) { console.error(e); }
    }

    async function handleScan() {
        const vid = mode === "W" ? document.getElementById('pv') : document.getElementById('ev');
        const r = await net.classify(vid);
        const seed = Math.floor((r[0].className.length * Date.now() * r[0].probability) % 1000);
        const rareIdx = seed % 100 < 70 ? 0 : seed % 100 < 90 ? 1 : seed % 100 < 98 ? 2 : 3;
        const rarity = ["COMMON","RARE","SUPER","MYTHIC"][rareIdx];
        const no = (seed % 100) + 1;
        const boost = 1 + (lv - 1) * 0.03;

        if (mode === "W") {
            const name = naming.W1[Math.floor((no-1)/10)] + naming.W2[(no-1)%10];
            patk = Math.floor(((rareIdx + 1) * 120 + (seed % 50)) * boost);
            pdef = Math.floor(((rareIdx + 1) * 60 + (seed % 30)) * boost);
            php = Math.min(pMax, php + Math.floor(pMax * 0.5));
            updateCard('p', rarity, "‚öîÔ∏è", `No.${no} ${rarity} ${name}`, "#444");
            coll.weapons[no] = {n:`${rarity} ${name}`, i:"‚öîÔ∏è"};
            mode = "M"; switchCamera('E');
            document.getElementById('msg').innerText = "„É¢„É≥„Çπ„Çø„Éº„Çí„Çπ„Ç≠„É£„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ";
        } else {
            const name = naming.M1[Math.floor((no-1)/10)] + naming.M2[(no-1)%10];
            eMax = Math.floor((800 + (rareIdx * 600) + (lv * 150))); ehp = eMax;
            eatk = Math.floor((rareIdx + 1) * 100 + (lv * 10)); edef = (rareIdx + 1) * 50;
            updateCard('e', rarity, "üëæ", `No.${no} ${rarity} ${name}`, "#a11");
            currentMData = {no, n:`${rarity} ${name}`, i:"üëæ"};
            await stopCamera();
            document.getElementById('atk-btn').disabled = false;
            document.getElementById('item-btn').disabled = !inventory;
            document.getElementById('scan-btn').disabled = true;
            document.getElementById('msg').innerText = "BATTLE START!";
        }
        save(); updateUI();
    }

    function updateCard(side, rare, sym, name, color) {
        const card = document.getElementById(`${side}-card`);
        card.style.background = `radial-gradient(circle, ${color}ee, #000)`;
        document.getElementById(`${side}-rare`).innerText = rare;
        document.getElementById(`${side}-sym`).innerText = sym;
        document.getElementById(`${side}-name`).innerText = name;
    }

    function handleAttack() {
        document.getElementById('e-area').classList.add('shake');
        const d = Math.max(30, (patk + buffAtk) - Math.floor(edef/2));
        ehp -= d;
        setTimeout(() => {
            document.getElementById('e-area').classList.remove('shake');
            if(ehp <= 0) return showBonus();
            enemyTurn();
        }, 400);
        updateUI();
    }

    function enemyTurn() {
        document.getElementById('p-area').classList.add('shake');
        const ed = Math.max(20, eatk - Math.floor((pdef + buffDef)/2));
        php -= ed; updateUI();
        setTimeout(() => {
            document.getElementById('p-area').classList.remove('shake');
            if(php <= 0) finish(false);
        }, 200);
    }

    function showBonus() { document.getElementById('bonus-screen').style.display = "flex"; switchCamera('B'); }

    async function getBonusItem() {
        const r = await net.classify(document.getElementById('bv'));
        const seed = Math.floor((Date.now() * r[0].probability) % 100);
        const no = seed + 1;
        const baseName = naming.I[Math.floor((no-1)/10)];
        let item = { n: baseName, t: "TR", i: "üì¶", v: 0 };
        
        if (no <= 25) { // ÂõûÂæ© (30-100%)
            const val = Math.floor(Math.random() * 71) + 30;
            item = { n: `${baseName}(ÂõûÂæ©${val}%)`, t: "HE", i: "üß™", v: val };
        } else if (no <= 50) { // „ÉÄ„É°„Éº„Ç∏ (10-40%)
            const val = Math.floor(Math.random() * 31) + 10;
            item = { n: `${baseName}(${val}% DMG)`, t: "DM", i: "üí•", v: val };
        } else if (no <= 60) { // ATK„Éê„Éï (20-60%)
            const val = Math.floor(Math.random() * 41) + 20;
            item = { n: `${baseName}(+${val}% ATK)`, t: "AT", i: "üíä", v: val };
        } else if (no <= 70) { // DEF„Éê„Éï (20-60%)
            const val = Math.floor(Math.random() * 41) + 20;
            item = { n: `${baseName}(+${val}% DEF)`, t: "DF", i: "üõ°Ô∏è", v: val };
        } else {
            item = { n: baseName + (no >= 98 ? " (ÁßòÂÆù)":""), t: "TR", i: "üíé", v: 0 };
        }

        inventory = item;
        coll.items[no] = item;
        save(); await stopCamera();
        document.getElementById('bonus-screen').style.display = "none";
        finish(true);
    }

    function useItem() {
        if(!inventory) return;
        let log = "";
        if(inventory.t === "HE") {
            const h = Math.floor(pMax * (inventory.v / 100)); php = Math.min(pMax, php + h); log = `${h}ÂõûÂæ©ÔºÅ`;
        } else if(inventory.t === "DM") {
            const d = Math.floor(eMax * (inventory.v / 100)); ehp -= d; log = `${d}„ÉÄ„É°ÔºÅ`;
        } else if(inventory.t === "AT") {
            const u = Math.floor(patk * (inventory.v / 100)); buffAtk += u; log = `ATK+${u}ÔºÅ`;
        } else if(inventory.t === "DF") {
            const u = Math.floor(pdef * (inventory.v / 100)); buffDef += u; log = `DEF+${u}ÔºÅ`;
        }
        document.getElementById('msg').innerText = `${inventory.n}‰ΩøÁî®Ôºö${log}`;
        inventory = null; updateUI();
        document.getElementById('item-btn').disabled = true;
        if(ehp <= 0) setTimeout(showBonus, 600); else setTimeout(enemyTurn, 800);
    }

    function finish(win) {
        const screen = document.getElementById('res-screen');
        screen.style.display = "flex";
        if(win) {
            document.getElementById('res-title').innerText = "VICTORY";
            if(currentMData) coll.monsters[currentMData.no] = currentMData;
            exp += 50;
            let lvLog = "ÁµåÈ®ìÂÄ§Áç≤ÂæóÔºÅ";
            if(exp >= nextExp) {
                lv++; exp = 0; nextExp += 50;
                const boost = (lv - 1) * 3;
                pMax = Math.floor(1000 * (1 + (lv - 1) * 0.1)); php = pMax;
                lvLog = `LEVEL UP! [LV:${lv}]\nÂÖ®„Çπ„ÉÜË£úÊ≠£: +${boost}%\nÊúÄÂ§ßHP: ${pMax}„Å´‰∏äÊòáÔºÅ`;
            }
            document.getElementById('res-msg').innerText = `„É¢„É≥„Çπ„Çø„Éº„ÇíË®òÈå≤„Åó„Åæ„Åó„Åü„ÄÇ\n${lvLog}`;
        } else {
            document.getElementById('res-title').innerText = "DEFEAT";
            const old = lv; lv = Math.max(1, lv - 5);
            pMax = Math.floor(1000 * (1 + (lv - 1) * 0.1)); php = pMax;
            document.getElementById('res-msg').innerText = `ÊïóÂåó... LV„Åå${old}„Åã„Çâ${lv}„Å´‰Ωé‰∏ã„ÄÇ\nË£úÊ≠£: +${(lv-1)*3}%`;
        }
        save(); updateUI();
    }

    function closeResult() {
        document.getElementById('res-screen').style.display = "none";
        mode = "W"; buffAtk = 0; buffDef = 0; currentMData = null;
        document.getElementById('atk-btn').disabled = true;
        document.getElementById('item-btn').disabled = true;
        document.getElementById('scan-btn').disabled = false;
        document.getElementById('msg').innerText = "Ê≠¶Âô®„Çí„Çπ„Ç≠„É£„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ";
        switchCamera('P');
        updateUI();
    }

    function updateUI() {
        document.getElementById('p-fill').style.width = (php / pMax * 100) + "%";
        document.getElementById('e-fill').style.width = (ehp / eMax * 100) + "%";
        document.getElementById('p-hp-cur').innerText = Math.max(0, Math.floor(php));
        document.getElementById('p-hp-max').innerText = pMax;
        document.getElementById('e-hp-cur').innerText = Math.max(0, Math.floor(ehp));
        document.getElementById('e-hp-max').innerText = eMax;
        document.getElementById('p-lv').innerText = lv;
        document.getElementById('p-atk-val').innerText = patk + buffAtk;
        document.getElementById('p-def-val').innerText = pdef + buffDef;
        document.getElementById('stat-boost').innerText = ((lv-1)*3);
        document.getElementById('inventory-label').innerText = `ITEM: ${inventory ? inventory.i + inventory.n : "„Å™„Åó"}`;
    }

    function save() { localStorage.setItem('myth_v_final_logic', JSON.stringify(coll)); }

    function showColl() {
        const render = (id, data, title) => {
            const el = document.getElementById(id);
            el.innerHTML = `<b>${title} (${Object.keys(data).length}/100)</b><br>`;
            Object.keys(data).sort((a,b)=>a-b).forEach(k => {
                el.innerHTML += `No.${k.padStart(3,'0')} ${data[k].i}${data[k].n}<br>`;
            });
        };
        render('w-coll', coll.weapons, "WEAPONS");
        render('m-coll', coll.monsters, "MONSTERS");
        render('i-coll', coll.items, "ITEMS");
        document.getElementById('coll-screen').style.display = "flex";
    }

    init();
</script>
</body>
</html>
