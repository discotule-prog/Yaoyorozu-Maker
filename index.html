<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Mythic RPG v6</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet"></script>
    <style>
        body { 
    margin: 0; 
    background: #000; 
    color: #0f0; 
    font-family: 'Courier New', monospace; 
    overflow: hidden; /* „Çπ„ÇØ„É≠„Éº„É´„ÇíÁ¶ÅÊ≠¢ */
    height: 100vh; /* ÁîªÈù¢„ÅÆÈ´ò„Åï„Çí100%„Å´Âõ∫ÂÆö */
    display: flex;
    flex-direction: column;
}

/* ‰∏äÈÉ®Ôºö„Ç´„É°„É©Êò†ÂÉèÔºàÂÖ®‰Ωì„ÅÆ40%Ôºâ */
#webcam { 
    width: 100%; 
    height: 40vh; 
    object-fit: cover; 
    border-bottom: 2px solid #0f0;
}

/* ‰∏≠ÈÉ®Ôºö„Çπ„ÉÜ„Éº„Çø„Çπ„Å®„É≠„Ç∞ÔºàÂÖ®‰Ωì„ÅÆ30%Ôºâ */
#game-ui { 
    flex: 1; /* ÊÆã„Çä„ÅÆ„Çπ„Éö„Éº„Çπ„Çí‰Ωø„ÅÜ */
    padding: 10px;
    display: flex;
    flex-direction: column;
}

.status-bar { 
    display: flex; 
    justify-content: space-between; 
    font-size: 14px; 
    margin-bottom: 5px;
}

.hp-box { 
    width: 45%; 
    background: #222; 
    border: 1px solid #0f0; 
    height: 15px; 
    position: relative; 
}

.hp-fill { 
    height: 100%; 
    background: #0f0; 
    width: 100%; 
    transition: width 0.3s; 
}

#msg { 
    background: rgba(0,20,0,0.8); 
    border: 1px solid #0f0; 
    padding: 8px; 
    height: 80px; 
    overflow-y: auto; 
    font-size: 13px; 
    white-space: pre-wrap;
    margin-bottom: 10px;
}

/* ‰∏ãÈÉ®ÔºöÊìç‰Ωú„Éú„Çø„É≥ÔºàÂÖ®‰Ωì„ÅÆ30% / Âõ∫ÂÆöÔºâ */
#controls { 
    display: grid; 
    grid-template-columns: 1fr 1fr; 
    gap: 8px; 
    padding: 10px;
    background: #111;
    border-top: 1px solid #0f0;
}

button { 
    padding: 15px 5px; 
    font-size: 14px; 
    font-weight: bold;
    background: #002200; 
    color: #0f0; 
    border: 2px solid #0f0; 
    cursor: pointer;
}

button:disabled { 
    border-color: #333; 
    color: #333; 
}

/* „Ç™„Éº„Éê„Éº„É¨„Ç§ÔºàÂÖ±ÈÄöË®≠ÂÆöÔºâ */
.overlay { 
    position: fixed; 
    top: 0; left: 0; width: 100%; height: 100%; 
    background: rgba(0,0,0,0.95); 
    display: flex; 
    flex-direction: column; 
    align-items: center; 
    justify-content: center; 
    z-index: 100; 
}

.hidden { display: none !important; }
    </style>
</head>
<body>
    <div style="position: relative; width: 100%; height: 40vh; background: #111;">
        <video id="webcam" autoplay playsinline muted style="width: 100%; height: 100%; object-fit: cover;"></video>
        <canvas id="color-canvas" width="1" height="1" style="display:none;"></canvas>
        <div style="position: absolute; top: 50%; left: 50%; width: 20px; height: 2px; background: rgba(255,255,255,0.5); transform: translate(-50%, -50%); pointer-events: none;"></div>
        <div style="position: absolute; top: 50%; left: 50%; width: 2px; height: 20px; background: rgba(255,255,255,0.5); transform: translate(-50%, -50%); pointer-events: none;"></div>
    </div>

    <div id="game-ui">
        <div class="status-bar">
            <div>PLAYER Lv.<span id="p-lv">1</span> <span id="p-elem"></span></div>
            <div class="hp-box">
                <div id="p-fill" class="hp-fill"></div>
                <small style="position:absolute; width:100%; text-align:center; top:0; color:white;">HP:<span id="p-hp-cur">1000</span></small>
            </div>
        </div>
        
        <div class="status-bar">
            <div>ENEMY <span id="e-elem"></span></div>
            <div class="hp-box">
                <div id="e-fill" class="hp-fill" style="background:#f00; width:0%;"></div>
                <small style="position:absolute; width:100%; text-align:center; top:0; color:white;">HP:<span id="e-hp-cur">0</span>/<span id="e-hp-max">0</span></small>
            </div>
        </div>

        <div id="msg">„É≠„Éº„Éâ‰∏≠...</div>

        <div id="controls">
            <button id="scan-btn" onclick="startScan()" disabled>SCAN</button>
            <button id="atk-btn" onclick="handleAttack()" disabled>ATTACK</button>
            <button id="magic-btn" onclick="openMagic()" disabled>MAGIC</button>
            <button id="lib-btn" onclick="openLibrary()">LIBRARY</button>
        </div>
    </div>

    <div id="init-overlay" class="overlay">
        <h1 style="color:#0ff; text-align:center;">AI MYTHIC RPG</h1>
        <p id="init-msg">LOADING AI MODELS...</p>
        <button id="start-btn" onclick="startGame()" class="hidden" style="background:#004400; padding:20px 40px; border:2px solid #0f0;">START GAME</button>
    </div>

    <div id="magic-overlay" class="overlay hidden">
        <h2 style="color:#0f0;">MAGIC MENU</h2>
        <p style="margin: 0;">SP: <span id="sp-count">0</span></p>
        <div id="magic-list" style="width: 90%; flex: 1; overflow-y: auto; margin: 10px 0; border: 1px solid #333; background: rgba(0,0,0,0.5);">
            </div>
        <button onclick="closeMagic()" style="width: 90%; background:#444; margin-bottom: 20px;">BACK</button>
    </div>
    <div id="library-overlay" class="overlay hidden">
        <h2 style="color:#0f0;">LIBRARY</h2>
        <div style="display: flex; gap: 10px; margin-bottom: 10px; width: 90%;">
            <button onclick="changeLibraryTab('weapons')" id="lib-tab-weapons" style="flex: 1; background: #004400;">WEAPONS</button>
            <button onclick="changeLibraryTab('monsters')" id="lib-tab-monsters" style="flex: 1;">MONSTERS</button>
        </div>
        <div id="library-content" style="width: 90%; flex: 1; overflow-y: auto; border: 1px solid #333; background: rgba(0,0,0,0.5); padding: 10px;">
            </div>
        <button onclick="closeLibrary()" style="width: 90%; background:#444; margin-top: 15px; margin-bottom: 20px;">BACK</button>
    </div>
<script>
// --- Âü∫Á§é„Éá„Éº„Çø ---
let lv = 1, exp = 0, pMax = 1000, php = 1000;
let ehp = 0, eMax = 0, enemyName = "";
let mode = "W"; // W, E, B, I
let net, stream;
let playerElement = null;
let enemyElement = null;
let library = JSON.parse(localStorage.getItem('myth_v6_lib')) || { W: {}, E: {}, I: {} };
let pAtk = 0; // „Çπ„Ç≠„É£„É≥„Åó„ÅüÊ≠¶Âô®„ÅÆÊîªÊíÉÂäõ
let pDef = 0; // „Çπ„Ç≠„É£„É≥„Åó„ÅüÊ≠¶Âô®„ÅÆÈò≤Âæ°Âäõ
let eAtk = 0; // Âá∫Áèæ„Åó„Åü„É¢„É≥„Çπ„Çø„Éº„ÅÆÊîªÊíÉÂäõ
let eExp = 0; // Âá∫Áèæ„Åó„Åü„É¢„É≥„Çπ„Çø„Éº„ÅÆÁµåÈ®ìÂÄ§
// --- È≠îÊ≥ï„Ç∑„Çπ„ÉÜ„É†Áî®Â§âÊï∞ ---
let skillPoints = 0; // Êú™‰ΩøÁî®„ÅÆ„Çπ„Ç≠„É´„Éù„Ç§„É≥„Éà
let magicUsedInBattle = false; // 1Êà¶Èóò„ÅßÈ≠îÊ≥ï‰ΩøÁî®Ê∏à„Åø„Åã„Å©„ÅÜ„Åã„ÅÆ„Éï„É©„Ç∞
let pAtkBonus = 1.0; // „Éó„É¨„Ç§„É§„ÉºÊîªÊíÉÂäõÂÄçÁéá (BRAV/WEEK„Éá„Éê„ÉïÁî®)
let pDefBonus = 1.0; // „Éó„É¨„Ç§„É§„ÉºÈò≤Âæ°ÂäõÂÄçÁéá (SELD/BRAK„Éá„Éê„ÉïÁî®)
let magicLevels = {
    HEAL: 1,  // ÂàùÊúüLv.1
    FIRE: 0, AQUA: 0, EARTH: 0, WOOD: 0, // ÊîªÊíÉÈ≠îÊ≥ï
    BRAV: 0, SELD: 0, // „Éê„Éï
    WEEK: 0, BRAK: 0  // „Éá„Éê„Éï
};

const MAGIC_DATA = {
    HEAL: { name: "ÂõûÂæ©", type: "Heal", elem: null },
    FIRE: { name: "„Éï„Ç°„Ç§„Ç¢", type: "Attack", elem: "FIRE" },
    AQUA: { name: "„Ç¢„ÇØ„Ç¢", type: "Attack", elem: "WATER" },
    EARTH: { name: "„Ç¢„Éº„Çπ", type: "Attack", elem: "EARTH" },
    WOOD: { name: "„É™„Éº„Éï", type: "Attack", elem: "WOOD" },
    BRAV: { name: "„Éñ„É¨„Ç§„Éñ", type: "Buff", elem: null },
    SELD: { name: "„Ç∑„Éº„É´„Éâ", type: "Buff", elem: null },
    WEEK: { name: "„Ç¶„Ç£„Éº„ÇØ", type: "Debuff", elem: null },
    BRAK: { name: "„Éñ„É¨„Ç§„ÇØ", type: "Debuff", elem: null }
};
const ELEMENTS = {
    FIRE:  { name: "ÁÅ´", color: "#ff4444", icon: "üî•", strongTo: "WOOD" },
    WATER: { name: "Ê∞¥", color: "#4444ff", icon: "üíß", strongTo: "FIRE" },
    EARTH: { name: "Âúü", color: "#8b4513", icon: "‚õ∞Ô∏è", strongTo: "WATER" },
    WOOD:  { name: "Êú®", color: "#228b22", icon: "üçÉ", strongTo: "EARTH" }
};

const RARITY_RATES = [
    { rarity: "MYTH",   rate: 5 },
    { rarity: "LEGEND", rate: 10 },
    { rarity: "ELITE",  rate: 25 },
    { rarity: "COMMON", rate: 60 }
];

const COLOR_MAPPING = [
    { elem: "FIRE",  check: (r, g, b) => r > 150 && g < 100 },
    { elem: "WATER", check: (r, g, b) => b > 150 && r < 100 },
    { elem: "WOOD",  check: (r, g, b) => g > 120 && r < 120 && b < 120 },
    { elem: "EARTH", check: (r, g, b) => r > 100 && g > 50 && b < 100 }
];

// --- „Éá„Éº„Çø„Éô„Éº„Çπ (ÊäúÁ≤ã„ÄÇÂÆüÈöõ„ÅØÁîªÂÉè„Å´Âü∫„Å•„Åç100Á®ÆÂ±ïÈñã) ---
// --- „Éá„Éº„Çø„Éô„Éº„Çπ ---
const WEAPON_DB = [
    // --- MYTH (No.91 - 100) ---
    { no: 100, rarity: "MYTH", name: "Â§©Âè¢Èõ≤Ââ£", keywords: ["sword", "blade"], atk: 800, def: 200 },
    { no: 99, rarity: "MYTH", name: "„É≠„É≥„ÇÆ„Éå„Çπ„ÅÆÊßç", keywords: ["stick", "pitcher", "racket"], atk: 750, def: 150 },
    { no: 98, rarity: "MYTH", name: "„ÉÅ„Çß„Éº„É≥„ÇΩ„Éº", keywords: ["tools", "drill"], atk: 900, def: 50 },
    { no: 97, rarity: "MYTH", name: "Ë∂ÖÈõªÁ£ÅÁ†≤", keywords: ["gun", "toy"], atk: 1000, def: 0 },
    { no: 96, rarity: "MYTH", name: "„Éá„É•„É©„É≥„ÉÄ„É´", keywords: ["sword", "knife"], atk: 700, def: 300 },
    { no: 95, rarity: "MYTH", name: "Â¶ÇÊÑèÊ£í", keywords: ["stick", "umbrella", "pole"], atk: 650, def: 250 },
    { no: 94, rarity: "MYTH", name: "„Éü„Éß„É´„Éã„É´", keywords: ["tools", "hammer"], atk: 850, def: 100 },
    { no: 93, rarity: "MYTH", name: "„Ç∞„É≥„Ç∞„Éã„É´", keywords: ["stick", "pen"], atk: 780, def: 120 },
    { no: 92, rarity: "MYTH", name: "„É¨„Éº„É¥„Ç°„ÉÜ„Ç§„É≥", keywords: ["lighter", "fire"], atk: 820, def: 80 },
    { no: 91, rarity: "MYTH", name: "ËÅñÂâ£„Ç®„ÇØ„Çπ„Ç´„É™„Éê„Éº", keywords: ["sword", "blade"], atk: 880, def: 180 },

    // --- LEGEND (No.71 - 90) ---
    { no: 90, rarity: "LEGEND", name: "ÊùëÊ≠£", keywords: ["knife", "scissors"], atk: 500, def: 50 },
    { no: 89, rarity: "LEGEND", name: "„Éâ„É©„Ç¥„É≥„Çπ„É¨„Ç§„É§„Éº", keywords: ["plate", "iron"], atk: 550, def: 100 },
    { no: 88, rarity: "LEGEND", name: "ÊñπÂ§©ÁîªÊàü", keywords: ["stick"], atk: 480, def: 80 },
    { no: 87, rarity: "LEGEND", name: "ÈùíÈæçÂÅÉÊúàÂàÄ", keywords: ["stick"], atk: 490, def: 90 },
    { no: 86, rarity: "LEGEND", name: "„Ç´„É©„Éâ„Éú„É´„Ç∞", keywords: ["sword"], atk: 470, def: 110 },
    { no: 85, rarity: "LEGEND", name: "„Éè„É´„Éë„Éº", keywords: ["hook", "sickle"], atk: 440, def: 60 },
    { no: 84, rarity: "LEGEND", name: "„É¨„Éº„Ç∂„Éº„Éñ„É¨„Éº„Éâ", keywords: ["flashlight"], atk: 600, def: 20 },
    { no: 83, rarity: "LEGEND", name: "„Éá„Çπ„Çµ„Ç§„Ç∫", keywords: ["sickle"], atk: 580, def: 40 },
    { no: 82, rarity: "LEGEND", name: "„Ç§„Éº„Ç∏„Çπ„ÅÆÁõæ", keywords: ["plate", "lid"], atk: 100, def: 600 },
    { no: 81, rarity: "LEGEND", name: "„É¥„Ç°„Ç∏„É•„É©", keywords: ["toy", "remote"], atk: 520, def: 100 },
    // (‰∏≠Áï•: 80-71„ÇÇÂêåÊßò„ÅÆLEGENDÁ¥ö„ÅåÂÖ•„Çä„Åæ„Åô)

    // --- ELITE (No.31 - 70) ---
    { no: 70, rarity: "ELITE", name: "Êó•Êú¨ÂàÄ", keywords: ["sword", "knife"], atk: 250, def: 30 },
    { no: 69, rarity: "ELITE", name: "„Éê„Éà„É´„Ç¢„ÉÉ„ÇØ„Çπ", keywords: ["tools"], atk: 280, def: 50 },
    { no: 68, rarity: "ELITE", name: "„É≠„É≥„Ç∞„Éú„Ç¶", keywords: ["hanger"], atk: 220, def: 10 },
    { no: 67, rarity: "ELITE", name: "„Éè„É´„Éê„Éº„Éâ", keywords: ["mop", "broom"], atk: 260, def: 60 },
    { no: 66, rarity: "ELITE", name: "„Ç¶„Ç©„Éº„Éè„É≥„Éû„Éº", keywords: ["hammer"], atk: 300, def: 40 },
    { no: 65, rarity: "ELITE", name: "„É¨„Ç§„Éî„Ç¢", keywords: ["pen", "needle"], atk: 210, def: 20 },
    { no: 64, rarity: "ELITE", name: "„Éï„É©„É≥„Éô„É´„Ç∏„É•", keywords: ["knife"], atk: 240, def: 40 },
    { no: 63, rarity: "ELITE", name: "„É¢„Éº„Éã„É≥„Ç∞„Çπ„Çø„Éº", keywords: ["brush"], atk: 290, def: 30 },
    { no: 62, rarity: "ELITE", name: "„ÇØ„É≠„Çπ„Éú„Ç¶", keywords: ["toy"], atk: 270, def: 10 },
    { no: 61, rarity: "ELITE", name: "„Ç´„Çø„Éº„É´", keywords: ["fork"], atk: 200, def: 30 },
    // (‰∏≠Áï•: 60-31„ÇÇÂÆüÊà¶ÁöÑ„Å™Ê≠¶Âô®„ÅåÂÖ•„Çä„Åæ„Åô)

    // --- COMMON (No.1 - 30) ---
    { no: 30, rarity: "COMMON", name: "ÈâÑ„ÅÆÂâ£", keywords: ["knife", "spoon"], atk: 80, def: 10 },
    { no: 29, rarity: "COMMON", name: "Êú®„ÅÆÊùñ", keywords: ["stick"], atk: 40, def: 20 },
    { no: 28, rarity: "COMMON", name: "Áü≥„ÅÆÊñß", keywords: ["stone"], atk: 90, def: 5 },
    { no: 27, rarity: "COMMON", name: "Á∑¥ÁøíÁî®Á´πÂàÄ", keywords: ["ruler", "stick"], atk: 30, def: 40 },
    { no: 26, rarity: "COMMON", name: "ÁöÆ„ÅÆÁõæ", keywords: ["book", "wallet"], atk: 5, def: 60 },
    { no: 25, rarity: "COMMON", name: "„Éñ„Éº„É°„É©„É≥", keywords: ["banana"], atk: 70, def: 0 },
    { no: 24, rarity: "COMMON", name: "„Éë„ÉÅ„É≥„Ç≥", keywords: ["rubber band"], atk: 50, def: 0 },
    { no: 23, rarity: "COMMON", name: "ÈùíÈäÖ„ÅÆÊßç", keywords: ["umbrella"], atk: 110, def: 20 },
    { no: 22, rarity: "COMMON", name: "„ÇØ„É©„Éñ(Ê£çÊ£í)", keywords: ["bottle"], atk: 100, def: 10 },
    { no: 21, rarity: "COMMON", name: "„Éä„Ç§„Éï", keywords: ["knife"], atk: 70, def: 5 },
    // ... No.1„Åæ„ÅßÁ∂ö„Åè (‰ª•‰∏ãÁúÅÁï•„ÄÇ„Ç∑„Çπ„ÉÜ„É†‰∏ä„ÅØ„Åì„Çå„Å†„Åë„ÅßÂçÅÂàÜÂãï‰Ωú„Åó„Åæ„Åô)
    { no: 1, rarity: "COMMON", name: "„Å≤„ÅÆ„Åç„ÅÆ„Åº„ÅÜ", keywords: ["stick", "pen"], atk: 10, def: 5 }
];
const MONSTER_DB = [
    // --- MYTH (No.91 - 100) ---
    { no: 100, rarity: "MYTH", name: "ÊúÄÂæå„ÅÆÂØ©Âà§", keywords: ["book", "paper"], hp: 9999, atk: 600, exp: 5000 },
    { no: 99, rarity: "MYTH", name: "„É´„Ç∑„Éï„Ç°„Éº", keywords: ["bird", "feather"], hp: 7000, atk: 550, exp: 4000 },
    { no: 98, rarity: "MYTH", name: "ÁπîÁî∞‰ø°Èï∑", keywords: ["human", "person", "suit"], hp: 5500, atk: 450, exp: 3000 },
    { no: 97, rarity: "MYTH", name: "„Éê„Éè„É†„Éº„Éà", keywords: ["lizard", "toy"], hp: 8000, atk: 500, exp: 4500 },
    { no: 96, rarity: "MYTH", name: "„Ç±„É´„Éô„É≠„Çπ", keywords: ["dog", "pet"], hp: 4500, atk: 480, exp: 2500 },
    { no: 95, rarity: "MYTH", name: "„Éï„Çß„É≥„É™„É´", keywords: ["dog", "wolf"], hp: 5000, atk: 460, exp: 2800 },
    { no: 94, rarity: "MYTH", name: "„É™„É¥„Ç°„Ç§„Ç¢„Çµ„É≥", keywords: ["fish", "water"], hp: 6500, atk: 420, exp: 3200 },
    { no: 93, rarity: "MYTH", name: "„É§„Éû„Çø„Éé„Ç™„É≠„ÉÅ", keywords: ["snake", "rope"], hp: 6000, atk: 440, exp: 3500 },
    { no: 92, rarity: "MYTH", name: "Â§ßÂ§©‰Ωø„Éü„Ç´„Ç®„É´", keywords: ["sculpture", "doll"], hp: 7500, atk: 400, exp: 4200 },
    { no: 91, rarity: "MYTH", name: "„Ç∑„É¥„Ç°", keywords: ["human", "statue"], hp: 8500, atk: 520, exp: 4800 },

    // --- LEGEND (No.71 - 90) ---
    { no: 90, rarity: "LEGEND", name: "„Éâ„É©„Ç¥„É≥", keywords: ["lizard", "toy"], hp: 3000, atk: 300, exp: 1200 },
    { no: 89, rarity: "LEGEND", name: "Âê∏Ë°ÄÈ¨º", keywords: ["human", "person"], hp: 2500, atk: 280, exp: 1000 },
    { no: 88, rarity: "LEGEND", name: "„Ç≠„Éû„Ç§„É©", keywords: ["cat", "dog"], hp: 2800, atk: 250, exp: 1100 },
    { no: 87, rarity: "LEGEND", name: "„É°„Éá„É•„Éº„Çµ", keywords: ["hair", "wig"], hp: 2200, atk: 240, exp: 950 },
    { no: 86, rarity: "LEGEND", name: "„Éü„Éé„Çø„Ç¶„É≠„Çπ", keywords: ["box", "gym"], hp: 3500, atk: 320, exp: 1300 },
    { no: 85, rarity: "LEGEND", name: "„Ç∂„Éª„É©„Ç§„Éï", keywords: ["drink", "bottle"], hp: 4000, atk: 150, exp: 1500 },
    { no: 84, rarity: "LEGEND", name: "„Ç∞„É™„Éï„Ç£„É≥", keywords: ["bird"], hp: 2400, atk: 260, exp: 900 },
    { no: 83, rarity: "LEGEND", name: "„Éá„É•„É©„Éè„É≥", keywords: ["helmet", "hat"], hp: 3200, atk: 290, exp: 1150 },
    { no: 82, rarity: "LEGEND", name: "„Çµ„É©„Éû„É≥„ÉÄ„Éº", keywords: ["lighter", "stove"], hp: 2100, atk: 310, exp: 980 },
    { no: 81, rarity: "LEGEND", name: "„ÇØ„É©„Éº„Ç±„É≥", keywords: ["cloth", "curtain"], hp: 3800, atk: 270, exp: 1250 },

    // --- ELITE (No.31 - 70) ---
    { no: 70, rarity: "ELITE", name: "„Ç¨„Éº„Ç¥„Ç§„É´", keywords: ["stone", "shelf"], hp: 1200, atk: 150, exp: 450 },
    { no: 69, rarity: "ELITE", name: "„Ç¶„Çß„Ç¢„Ç¶„É´„Éï", keywords: ["dog", "coat"], hp: 1000, atk: 180, exp: 400 },
    { no: 68, rarity: "ELITE", name: "„Ç™„Éº„Ç¨", keywords: ["chair", "big"], hp: 1500, atk: 200, exp: 500 },
    { no: 67, rarity: "ELITE", name: "„Éü„Ç§„É©", keywords: ["human", "toilet paper", "towel"], hp: 900, atk: 120, exp: 350 },
    { no: 66, rarity: "ELITE", name: "„Çµ„Ç≠„É•„Éê„Çπ", keywords: ["pillow", "bed"], hp: 800, atk: 140, exp: 380 },
    { no: 65, rarity: "ELITE", name: "„É™„Éì„É≥„Ç∞„Ç¢„Éº„Éû„Éº", keywords: ["jacket", "metal"], hp: 1800, atk: 130, exp: 480 },
    { no: 64, rarity: "ELITE", name: "„Ç≥„Ç´„Éà„É™„Çπ", keywords: ["chicken", "egg"], hp: 750, atk: 170, exp: 320 },
    { no: 63, rarity: "ELITE", name: "„É©„Éü„Ç¢", keywords: ["snake", "belt"], hp: 1100, atk: 160, exp: 420 },
    { no: 62, rarity: "ELITE", name: "„Ç±„É≥„Çø„Ç¶„É≠„Çπ", keywords: ["bicycle", "machine"], hp: 1300, atk: 190, exp: 460 },
    { no: 61, rarity: "ELITE", name: "„Éò„É´„Éè„Ç¶„É≥„Éâ", keywords: ["dog", "black"], hp: 950, atk: 210, exp: 430 },

    // --- COMMON (No.1 - 30) ---
    { no: 30, rarity: "COMMON", name: "„Ç¥„Éñ„É™„É≥", keywords: ["wallet", "coin"], hp: 400, atk: 60, exp: 120 },
    { no: 29, rarity: "COMMON", name: "„Çπ„Ç±„É´„Éà„É≥", keywords: ["spoon", "fork", "white"], hp: 350, atk: 70, exp: 100 },
    { no: 28, rarity: "COMMON", name: "„Ç§„É≥„Éó", keywords: ["book", "smartphone"], hp: 300, atk: 80, exp: 110 },
    { no: 27, rarity: "COMMON", name: "„Éê„Éñ„É´„Çº„É™„Éº", keywords: ["drink", "cup", "soap"], hp: 500, atk: 40, exp: 90 },
    { no: 26, rarity: "COMMON", name: "„ÉØ„Ç§„É´„Éâ„Éú„Ç¢", keywords: ["bag", "brown"], hp: 450, atk: 90, exp: 130 },
    { no: 25, rarity: "COMMON", name: "„Éû„É≥„Éâ„É©„Ç¥„É©", keywords: ["plant", "pot"], hp: 250, atk: 50, exp: 80 },
    { no: 24, rarity: "COMMON", name: "„Éê„ÉÉ„Éà", keywords: ["umbrella", "black"], hp: 200, atk: 65, exp: 70 },
    { no: 23, rarity: "COMMON", name: "„Éù„Ç§„Ç∫„É≥„Çπ„Éë„Ç§„ÉÄ„Éº", keywords: ["mouse", "black"], hp: 220, atk: 100, exp: 150 },
    { no: 10, rarity: "COMMON", name: "„Çπ„É©„Ç§„É†", keywords: ["drink", "water", "bottle", "cap", "blue"], hp: 150, atk: 30, exp: 50 },
    { no: 1, rarity: "COMMON", name: "„É©„ÉÉ„Éà", keywords: ["mouse", "cheese"], hp: 100, atk: 20, exp: 30 }
];

// --- „Ç∑„Çπ„ÉÜ„É†„É≠„Ç∏„ÉÉ„ÇØ ---

window.onload = async () => {
    try {
        net = await mobilenet.load();
        document.getElementById('init-msg').innerText = "AI READY";
        document.getElementById('start-btn').classList.remove('hidden');
    } catch(e) { document.getElementById('init-msg').innerText = "NETWORK ERROR"; }
};

async function startGame() {
    document.getElementById('init-overlay').classList.add('hidden');
    const video = document.getElementById('webcam');
    stream = await navigator.mediaDevices.getUserMedia({video: {facingMode: "environment"}});
    video.srcObject = stream;
    video.style.display = "block";
    mode = "W";
    document.getElementById('scan-btn').disabled = false;
    log("Ê≠¶Âô®(WEAPON)„Çí„Çπ„Ç≠„É£„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ");
}

function getElementByColor() {
    const video = document.getElementById('webcam');
    const canvas = document.getElementById('color-canvas');
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, video.videoWidth/2, video.videoHeight/2, 1, 1, 0, 0, 1, 1);
    const [r, g, b] = ctx.getImageData(0, 0, 1, 1).data;
    document.getElementById('element-debug').innerText = `RGB: ${r},${g},${b}`;
    for (const m of COLOR_MAPPING) if (m.check(r, g, b)) return m.elem;
    return Object.keys(ELEMENTS)[Math.floor(Math.random() * 4)];
}

function lottery(db, label) {
    const labels = label.toLowerCase().split(',').map(s => s.trim());
    // ORÂà§ÂÆö„ÅßÂÄôË£úÊäΩÂá∫
    let candidates = db.filter(item => item.keywords.some(k => labels.includes(k.toLowerCase())));
    if (candidates.length === 0) candidates = db;

    // „É¨„Ç¢„É™„ÉÜ„Ç£ÊØîÁéá„Åß„ÅÆÊäΩÈÅ∏
    let totalWeight = 0;
    const weighted = candidates.map(c => {
        const w = RARITY_RATES.find(r => r.rarity === c.rarity).rate;
        totalWeight += w;
        return { item: c, w: totalWeight };
    });

    const r = Math.random() * totalWeight;
    return weighted.find(item => r <= item.w).item;
}

async function startScan() {
    const btn = document.getElementById('scan-btn');
    btn.disabled = true;
    log("„Çπ„Ç≠„É£„É≥‰∏≠...");
    
    // 1. AI„Å´„Çà„ÇãÁâ©‰ΩìË™çË≠ò
    const result = await net.classify(document.getElementById('webcam'));
    const label = result[0].className;
    
    // 2. „Ç´„É°„É©‰∏≠Â§Æ„ÅÆËâ≤„Åã„ÇâÂ±ûÊÄß„ÇíÊ±∫ÂÆö
    const elemKey = getElementByColor();

    if (mode === "W") {
        const weapon = lottery(WEAPON_DB, label);
        playerElement = elemKey;
        pAtk = weapon.atk; 
        pDef = weapon.def; 
        
        // ‚òÖ Âõ≥ÈëëÁôªÈå≤Âá¶ÁêÜ (Ê≠¶Âô®)
        // Ê≠¶Âô®Âêç„ÄÅ„É¨„Ç¢„É™„ÉÜ„Ç£„ÄÅ„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÁôªÈå≤
        addToLibrary('weapons', {
            name: weapon.name, 
            rarity: weapon.rarity, 
            atk: weapon.atk, 
            def: weapon.def,
            // Â±ûÊÄß„ÅØ„Éó„É¨„Ç§„É§„ÉºË¶ÅÁ¥†„Å®„Åó„Å¶Âæå„Åß‰ªò‰∏é„Åï„Çå„Çã„Åü„ÇÅ„ÄÅ„Åì„Åì„Åß„ÅØ‰∏çË¶Å
        });
        
        log(`Ê≠¶Âô®: ${weapon.name} [ATK:${pAtk}]\nÂ±ûÊÄß: ${ELEMENTS[elemKey].icon}`);
        mode = "E";
        btn.innerText = "ENEMY SCAN";
        btn.disabled = false; // Ê¨°„ÅÆ„Çπ„Ç≠„É£„É≥„ÅÆ„Åü„ÇÅ„Å´„Éú„Çø„É≥„ÇíÊàª„Åô

    } else if (mode === "E") {
        const monster = lottery(MONSTER_DB, label);
        enemyElement = elemKey;
        enemyName = monster.name;
        eMax = monster.hp; 
        ehp = eMax;
        eAtk = monster.atk; 
        eExp = monster.exp; 
        
        // ‚òÖ Âõ≥ÈëëÁôªÈå≤Âá¶ÁêÜ („É¢„É≥„Çπ„Çø„Éº)
        // ÈÅ≠ÈÅá„Åó„ÅüÊïµ„ÅÆÂ±ûÊÄß(elem)„Çí„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„Å´ËøΩÂä†„Åó„Å¶ÁôªÈå≤
        addToLibrary('monsters', {
            name: monster.name,
            rarity: monster.rarity,
            hp: monster.hp,
            atk: monster.atk,
            exp: monster.exp,
            elem: elemKey // Â±ûÊÄß„Ç≠„Éº„ÇíËøΩÂä†
        });
        
        log(`Êïµ: ${monster.name} [HP:${eMax}]\nÂ±ûÊÄß: ${ELEMENTS[elemKey].icon}`);
        
        // ‚òÖ„Åì„Åì„ÅåÈáçË¶ÅÔºö„Éê„Éà„É´„É¢„Éº„Éâ„Å∏Âàá„ÇäÊõø„Åà
        mode = "B"; 
        document.getElementById('atk-btn').disabled = false;
        document.getElementById('magic-btn').disabled = false;
    }
    
    updateUI();
    // „Éú„Çø„É≥„ÅÆÁÑ°ÂäπÂåñÂà§ÂÆö„ÇíÈñ¢Êï∞ÂÜÖ„Å´ÂÖ•„Çå„Çã
    btn.disabled = (mode === "B"); 
}

function handleAttack() {
    // pAtkBonus/pDefBonus „Çí Buff/Debuff „ÅßÂÖ±Áî®„Åó„Å¶„ÅÑ„Çã
    const mod = getElementModifier(playerElement, enemyElement);
    
    // Ë®àÁÆóÂºè: (Ê≠¶Âô®ÊîªÊíÉÂäõ * BRAVÂÄçÁéá + Lv„Éú„Éº„Éä„Çπ) * Â±ûÊÄßÁõ∏ÊÄß
    const finalAtk = pAtk * pAtkBonus + lv * 10;
    
    // Êïµ„ÅÆÈò≤Âæ°Âäõ„Å´BRAK„ÇíÈÅ©Áî®
    // eDef „ÅØÂÆöÁæ©„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑ„Åü„ÇÅ pDefBonus „ÇíÊïµ„ÅÆÈò≤Âæ°Âäõ„Å´ÈÅ©Áî®„Åô„ÇãÔºàBRAK„Éá„Éê„ÉïÔºâ
    // ‚Äª pAtk, pDef „ÅØ„Éó„É¨„Ç§„É§„Éº„ÅÆÊ≠¶Âô®„Çπ„ÉÜ„Éº„Çø„Çπ
    const finalEAtkDefense = eAtk * pDefBonus; // BRAKÈÅ©Áî® (eAtk„ÅØÊïµ„ÅÆÊîªÊíÉÂäõ„Å™„ÅÆ„Åß‰øÆÊ≠£„ÅåÂøÖË¶Å)
    
    // ‰øÆÊ≠£: Êïµ„ÅÆÈò≤Âæ°Âäõ„ÅØÂ≠òÂú®„Åó„Å™„ÅÑ„Åü„ÇÅ„ÄÅpAtkBonus/pDefBonus „ÇíÊïµ„ÅÆÊîªÊíÉÂäõ(eAtk)„Å®„Éó„É¨„Ç§„É§„Éº„ÅÆÈò≤Âæ°Âäõ(pDef)„ÅÆÂÄçÁéá„Å®„Åó„Å¶‰ΩøÁî®„Åó„ÄÅÊïµ„ÅÆÊîªÊíÉ„ÇíÊ∏õ„Çâ„ÅôÂΩ¢„ÅßË®àÁÆó„Åó„Åæ„Åô
    // Êïµ„ÅÆÈò≤Âæ°Âäõ(eDef)„Åå„Å™„ÅÑ„Åü„ÇÅ„ÄÅ„Éó„É¨„Ç§„É§„ÉºÊîªÊíÉ„ÅØ„Ç∑„É≥„Éó„É´„Å´„Åó„Åæ„Åô„ÄÇ
    const dmg = Math.floor(Math.max(1, finalAtk * mod)); // ÊúÄ‰Ωé„ÉÄ„É°„Éº„Ç∏1
    
    ehp = Math.max(0, ehp - dmg);
    applyShake();
    
    log(`${enemyName}„Å´ ${dmg}„ÉÄ„É°„Éº„Ç∏ÔºÅ (${mod === 1.5 ? 'ÂäπÊûúÁµ∂Â§ß!' : mod === 0.5 ? '„Ç§„Éû„Ç§„ÉÅ...' : 'ÈÄöÂ∏∏'})`);

    if (ehp <= 0) {
        log(`${enemyName}„ÇíÂÄí„Åó„ÅüÔºÅ`);
        resetBattleState(true); // ‚òÖ„É™„Çª„ÉÉ„ÉàÈñ¢Êï∞„ÇíÂëº„Å≥Âá∫„Åô
    } else {
        setTimeout(enemyTurn, 600); // Êïµ„ÅÆ„Çø„Éº„É≥
    }
    updateUI();
}// --- È≠îÊ≥ï„Ç∑„Çπ„ÉÜ„É†„Å®Êà¶ÈóòË£úÂä©Èñ¢Êï∞ ---

// Êïµ„ÅÆÊîªÊíÉÂá¶ÁêÜÔºàÈÄöÂ∏∏ÊîªÊíÉÔºâ
function enemyTurn() {
    // Êïµ„ÅÆÊîªÊíÉÂäõ„Å´WEEK„ÅÆÂäπÊûú (pAtkBonus„Çí‰ΩøÁî®: 0.5„Äú1.0)
    const finalEAtk = eAtk * pAtkBonus; 
    // „Éó„É¨„Ç§„É§„Éº„ÅÆÈò≤Âæ°Âäõ„Å´SELD„ÅÆÂäπÊûú (pDefBonus„Çí‰ΩøÁî®: 1.0„Äú1.5)
    const finalPDef = pDef * pDefBonus; 
    
    // Ë®àÁÆóÂºè: Êïµ„ÅÆÊîªÊíÉÂäõ * WEEKÂÄçÁéá - „Éó„É¨„Ç§„É§„Éº„ÅÆÈò≤Âæ°Âäõ * SELDÂÄçÁéá (ÊúÄ‰Ωé„ÉÄ„É°„Éº„Ç∏„ÅØ10)
    const edmg = Math.max(10, finalEAtk - finalPDef); 
    
    php = Math.max(0, php - edmg);
    log(`Êïµ„ÅÆÊîªÊíÉÔºÅ ${edmg}„ÉÄ„É°„Éº„Ç∏ÔºÅ`);
    if (php <= 0) { alert("GAMEOVER"); location.reload(); }
    updateUI();
}

// È≠îÊ≥ï‰ΩøÁî®Âæå„ÅÆÊïµ„ÅÆÊîªÊíÉÂá¶ÁêÜÔºà„É≠„Ç∏„ÉÉ„ÇØ„ÅØenemyTurn„Å®Âêå„ÅòÔºâ
function enemyTurnAfterMagic() {
    const finalEAtk = eAtk * pAtkBonus; 
    const finalPDef = pDef * pDefBonus; 
    const edmg = Math.max(10, finalEAtk - finalPDef); 
    
    php = Math.max(0, php - edmg);
    log(`Êïµ„ÅÆÊîªÊíÉÔºÅ ${edmg}„ÉÄ„É°„Éº„Ç∏ÔºÅ`);
    if (php <= 0) { alert("GAMEOVER"); location.reload(); }
    updateUI();
}

// Êà¶ÈóòÁµÇ‰∫ÜÂæå„ÅÆÁä∂ÊÖã„É™„Çª„ÉÉ„Éà„Å®ÁµåÈ®ìÂÄ§Âá¶ÁêÜ
function resetBattleState(isVictory) {
    magicUsedInBattle = false; // È≠îÊ≥ï‰ΩøÁî®„Éï„É©„Ç∞„Çí„É™„Çª„ÉÉ„Éà
    pAtkBonus = 1.0; // „Éê„Éï/„Éá„Éê„Éï„Çí„É™„Çª„ÉÉ„Éà
    pDefBonus = 1.0;
    
    mode = "W";
    document.getElementById('scan-btn').innerText = "WEAPON SCAN";
    document.getElementById('scan-btn').disabled = false;
    document.getElementById('atk-btn').disabled = true;
    document.getElementById('magic-btn').disabled = true;
    
    if (isVictory) {
        // ÁµåÈ®ìÂÄ§„ÄÅLv„Ç¢„ÉÉ„ÉóÂá¶ÁêÜ
        exp += eExp;
        if (exp >= lv * 100) {
            lv++;
            exp = 0;
            pMax += 200;
            php = pMax;
            skillPoints++; // „Çπ„Ç≠„É´„Éù„Ç§„É≥„Éà„Çí1Áç≤ÂæóÔºÅ
            log(`„É¨„Éô„É´„Ç¢„ÉÉ„ÉóÔºÅ Lv.${lv} ÊúÄÂ§ßHP„Åå‰∏äÊòá„Åó„Åæ„Åó„ÅüÔºÅ SP„Çí1Áç≤ÂæóÔºÅ`);
            setTimeout(openMagic, 1000); // Lv„Ç¢„ÉÉ„ÉóÊôÇ„ÅØÈ≠îÊ≥ï„É°„Éã„É•„Éº„ÇíÂº∑Âà∂„Ç™„Éº„Éó„É≥
        }
    }
    updateUI();
}

// --- È≠îÊ≥ï„Ç∑„Çπ„ÉÜ„É†Èñ¢Êï∞ ---

function openMagic() {
    if (mode === "B" && magicUsedInBattle) {
        log("„Åì„ÅÆÊà¶Èóò„Åß„ÅØ„Åô„Åß„Å´È≠îÊ≥ï„Çí‰ΩøÁî®„Åó„Åæ„Åó„Åü„ÄÇ");
        return;
    }
    mode = "I"; // „Ç§„É≥„Çø„Éº„Éï„Çß„Éº„Çπ„É¢„Éº„Éâ„Å´Âàá„ÇäÊõø„Åà
    document.getElementById('magic-overlay').classList.remove('hidden');
    renderMagicList();
    updateUI();
}

function closeMagic() {
    document.getElementById('magic-overlay').classList.add('hidden');
    // Êà¶Èóò‰∏≠„Å†„Å£„ÅüÂ†¥Âêà„ÅØ„Éê„Éà„É´„É¢„Éº„Éâ„Å´Êàª„Çã
    if (ehp > 0 && mode === "I") mode = "B"; 
    updateUI();
}

function renderMagicList() {
    const listDiv = document.getElementById('magic-list');
    const spCount = document.getElementById('sp-count');
    spCount.innerText = skillPoints;
    
    let html = '';
    
    for (const key in MAGIC_DATA) {
        const data = MAGIC_DATA[key];
        const currentLv = magicLevels[key];
        const nextLv = currentLv + 1;
        const cost = nextLv; // ÂøÖË¶Å„Å™SP„ÅØÊ¨°„ÅÆ„É¨„Éô„É´„ÅÆÊï∞
        const isMax = currentLv >= 5;
        const canUpgrade = !isMax && skillPoints >= cost;

        // È≠îÊ≥ï„ÅÆ‰ΩøÁî®„Éú„Çø„É≥
        let actionBtn;
        if (mode === "B" && currentLv > 0) {
            actionBtn = `<button onclick="useMagic('${key}')" style="background:#004400; width: 45%;">‰ΩøÁî®</button>`;
        } else if (mode === "B" && currentLv === 0) {
            actionBtn = `<button disabled style="background:#333; width: 45%;">Êú™ÁøíÂæó</button>`;
        } else {
            actionBtn = '';
        }

        // Âº∑Âåñ„Éú„Çø„É≥
        let upgradeBtn;
        if (isMax) {
            upgradeBtn = `<button disabled style="background:#555; width: 45%;">MAX</button>`;
        } else if (canUpgrade) {
            upgradeBtn = `<button onclick="upgradeMagic('${key}', ${cost})" style="background:#440044; width: 45%;">Âº∑Âåñ (${cost}SP)</button>`;
        } else {
            upgradeBtn = `<button disabled style="background:#333; width: 45%;">Âº∑Âåñ (${cost}SP)</button>`;
        }

        html += `
            <div style="background:#222; margin-bottom: 5px; padding: 10px; border-left: 5px solid ${currentLv > 0 ? '#0f0' : '#888'}; display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <strong>${data.name}</strong> [Lv.${currentLv}]<br>
                    <small>Type: ${data.type}</small>
                </div>
                <div style="display: flex; gap: 5px;">
                    ${actionBtn}
                    ${upgradeBtn}
                </div>
            </div>
        `;
    }
    listDiv.innerHTML = html;
}

function upgradeMagic(key, cost) {
    if (skillPoints >= cost) {
        skillPoints -= cost;
        magicLevels[key]++;
        log(`${MAGIC_DATA[key].name}„ÅåLv.${magicLevels[key]}„Å´„Ç¢„ÉÉ„Éó„Åó„Åæ„Åó„ÅüÔºÅ`);
        renderMagicList(); // „É™„Çπ„Éà„ÇíÂÜçÊèèÁîª
        updateUI();
    }
}

function useMagic(key) {
    if (mode !== "B" || magicUsedInBattle) return;

    magicUsedInBattle = true; // 1Êà¶Èóò1Âõû„Éï„É©„Ç∞„ÇíÁ´ã„Å¶„Çã
    const lv = magicLevels[key];
    const data = MAGIC_DATA[key];

    log(`${data.name} (Lv.${lv}) „Çí‰ΩøÁî®ÔºÅ`);
    
    // HEAL, ATTACK, BUFF/DEBUFF „ÅÆÂäπÊûú„ÇíÂá¶ÁêÜ
    if (data.type === "Heal") {
        const healPercent = 0.15 * lv; // 15% * Lv
        const healAmount = Math.floor(pMax * healPercent);
        php = Math.min(pMax, php + healAmount);
        log(`${healAmount}ÂõûÂæ©„Åó„Åæ„Åó„ÅüÔºÅ`);

    } else if (data.type === "Attack") {
        const damagePercent = 0.10 * lv; // 10% * Lv
        const mod = getElementModifier(data.elem, enemyElement);
        let dmg = 0;
        
        if (mod === 0.5) { // ‰∏çÂà©Â±ûÊÄß (Êïµ„ÅÆÂõûÂæ©)
            const healAmount = Math.floor(eMax * damagePercent);
            ehp = Math.min(eMax, ehp + healAmount);
            log(`Áõ∏ÊÄß„ÅåÊÇ™„Åè„ÄÅÊïµ„ÅÆHP„Çí ${healAmount} ÂõûÂæ©„Åï„Åõ„Å¶„Åó„Åæ„Å£„Åü...`);
        } else if (mod === 1.5) { // ÊúâÂà©Â±ûÊÄß („ÉÄ„É°„Éº„Ç∏1.5ÂÄç)
            dmg = Math.floor(eMax * damagePercent * 1.5);
            ehp = Math.max(0, ehp - dmg);
            log(`ÂäπÊûúÁµ∂Â§ßÔºÅ ${dmg}„ÉÄ„É°„Éº„Ç∏„Çí‰∏é„Åà„ÅüÔºÅ`);
        } else if (mod === 1.0) { // Á≠âÂÄç/ÂêåÂ±ûÊÄß (ÂêåÂ±ûÊÄß„ÅØgetElementModifier„Åß1.0„ÇíËøî„ÅôÊÉ≥ÂÆö)
            dmg = Math.floor(eMax * damagePercent);
            if (data.elem === enemyElement) { // ÂêåÂ±ûÊÄß„ÅØÂäπÊûú„Å™„Åó
                log(`ÂêåÂ±ûÊÄß„ÅÆ„Åü„ÇÅ„ÄÅÂäπÊûú„Å™„ÅóÔºÅ`);
            } else {
                ehp = Math.max(0, ehp - dmg);
                log(`${dmg}„ÉÄ„É°„Éº„Ç∏„Çí‰∏é„Åà„ÅüÔºÅ`);
            }
        }

    } else if (data.type === "Buff") {
        const bonus = 1 + (0.10 * lv); // 1.1ÂÄç „Äú 1.5ÂÄç
        if (key === "BRAV") {
            pAtkBonus = bonus;
            log(`„Éó„É¨„Ç§„É§„Éº„ÅÆÊîªÊíÉÂäõ„Åå ${((bonus - 1) * 100).toFixed(0)}% ‰∏äÊòáÔºÅ`);
        } else if (key === "SELD") {
            pDefBonus = bonus;
            log(`„Éó„É¨„Ç§„É§„Éº„ÅÆÈò≤Âæ°Âäõ„Åå ${((bonus - 1) * 100).toFixed(0)}% ‰∏äÊòáÔºÅ`);
        }
    } else if (data.type === "Debuff") {
        const penalty = 1 - (0.10 * lv); // 0.9ÂÄç „Äú 0.5ÂÄç
        if (key === "WEEK") {
            // Êïµ„ÅÆÊîªÊíÉÂäõ„Å´ÈÅ©Áî®„Åô„Çã„Åü„ÇÅ„ÄÅ„Éó„É¨„Ç§„É§„Éº„ÅÆÊîªÊíÉÂäõÂÄçÁéáÂ§âÊï∞„Çí‰ΩøÁî®
            pAtkBonus = penalty; 
            log(`Êïµ„ÅÆÊîªÊíÉÂäõ„Åå ${((1 - penalty) * 100).toFixed(0)}% ‰∏ãÈôçÔºÅ`);
        } else if (key === "BRAK") {
            // Êïµ„ÅÆÈò≤Âæ°Âäõ„Å´ÈÅ©Áî®„Åô„Çã„Åü„ÇÅ„ÄÅ„Éó„É¨„Ç§„É§„Éº„ÅÆÈò≤Âæ°ÂäõÂÄçÁéáÂ§âÊï∞„Çí‰ΩøÁî®
            pDefBonus = penalty; 
            log(`Êïµ„ÅÆÈò≤Âæ°Âäõ„Åå ${((1 - penalty) * 100).toFixed(0)}% ‰∏ãÈôçÔºÅ`);
        }
    }

    closeMagic();
    // Êïµ„ÅÆ„Çø„Éº„É≥„Å´ÈÄ≤„ÇÄ
    if (ehp > 0) {
        setTimeout(enemyTurnAfterMagic, 600);
    } else {
        // ÊîªÊíÉÈ≠îÊ≥ï„ÅßÂÄí„Åó„ÅüÂ†¥Âêà„ÅÆÂá¶ÁêÜÔºàhandleAttack„ÅÆÂãùÂà©Âá¶ÁêÜ„Çí„Ç≥„Éî„ÉºÔºâ
        log(`${enemyName}„ÇíÂÄí„Åó„ÅüÔºÅ`);
        resetBattleState(true);
    }
    updateUI();
}
    function getElementModifier(a, d) {
    if (!a || !d) return 1.0;
    if (ELEMENTS[a].strongTo === d) return 1.5;
    if (ELEMENTS[d].strongTo === a) return 0.5;
    return 1.0;
}

function updateUI() {
    document.getElementById('p-lv').innerText = lv;
    document.getElementById('p-hp-cur').innerText = php;
    document.getElementById('p-fill').style.width = (php/pMax*100) + "%";
    if(playerElement) {
        document.getElementById('p-elem').innerText = ELEMENTS[playerElement].icon;
        document.getElementById('p-elem').style.color = ELEMENTS[playerElement].color;
    }
    document.getElementById('e-hp-cur').innerText = ehp;
    document.getElementById('e-hp-max').innerText = eMax;
    document.getElementById('e-fill').style.width = (eMax > 0 ? (ehp/eMax*100) : 0) + "%";
    if(enemyElement) {
        document.getElementById('e-elem').innerText = ELEMENTS[enemyElement].icon;
        document.getElementById('e-elem').style.color = ELEMENTS[enemyElement].color;
    }
}

function log(m) { document.getElementById('msg').innerText = m; }
function applyShake() { document.body.classList.add('shake'); setTimeout(() => document.body.classList.remove('shake'), 200); }
 // --- Âõ≥Èëë„Ç∑„Çπ„ÉÜ„É†Áî®Â§âÊï∞ (Â§âÊï∞„ÅÆÈõÜ„Åæ„Å£„Å¶„ÅÑ„ÇãÂ†¥ÊâÄ„Å∏) ---
let library = {
    weapons: [], 
    monsters: [] 
};

// --- Âõ≥Èëë„Ç∑„Çπ„ÉÜ„É†Èñ¢Êï∞ (Èñ¢Êï∞„ÅÆÈõÜ„Åæ„Å£„Å¶„ÅÑ„ÇãÂ†¥ÊâÄ„Å∏) ---
function addToLibrary(type, item) {
    const list = library[type];
    // Êó¢„Å´Âõ≥Èëë„Å´ÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ (ÂêçÂâç„ÅßÂà§ÂÆö)
    if (!list.some(i => i.name === item.name)) {
        list.push(item);
        log(`[${item.name}]„ÇíÂõ≥Èëë„Å´ÁôªÈå≤„Åó„Åæ„Åó„ÅüÔºÅ`);
    }
}

function openLibrary() {
    mode = "I"; // „Ç§„É≥„Çø„Éº„Éï„Çß„Éº„Çπ„É¢„Éº„Éâ
    document.getElementById('library-overlay').classList.remove('hidden');
    changeLibraryTab('weapons'); 
    updateUI();
}

function closeLibrary() {
    document.getElementById('library-overlay').classList.add('hidden');
    // Áä∂ÊÖã„Å´Âøú„Åò„Å¶„É¢„Éº„Éâ„ÇíÊàª„Åô
    if (ehp > 0) mode = "B";
    else if (pAtk > 0) mode = "E";
    else mode = "W";
    updateUI();
}

function changeLibraryTab(tab) {
    const contentDiv = document.getElementById('library-content');
    let html = '';

    document.getElementById('lib-tab-weapons').style.background = (tab === 'weapons' ? '#004400' : '#002200');
    document.getElementById('lib-tab-monsters').style.background = (tab === 'monsters' ? '#004400' : '#002200');

    if (tab === 'weapons') {
        library.weapons.forEach(w => {
            html += `<div style="margin-bottom:8px; border-bottom:1px dashed #333; padding:5px;">
                        <strong>${w.name}</strong> [${w.rarity}]<br>ATK:${w.atk} DEF:${w.def}</div>`;
        });
        if (library.weapons.length === 0) html = '<p>Ê≠¶Âô®„Éá„Éº„Çø„Å™„Åó</p>';
    } else {
        library.monsters.forEach(m => {
            const icon = ELEMENTS[m.elem]?.icon || "";
            html += `<div style="margin-bottom:8px; border-bottom:1px dashed #333; padding:5px;">
                        <strong>${icon}${m.name}</strong> [${m.rarity}]<br>HP:${m.hp} ATK:${m.atk}</div>`;
        });
        if (library.monsters.length === 0) html = '<p>„É¢„É≥„Çπ„Çø„Éº„Éá„Éº„Çø„Å™„Åó</p>';
    }
    contentDiv.innerHTML = html;
}   
</script>
</body>
</html>
