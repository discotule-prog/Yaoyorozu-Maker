<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Mythic RPG v6</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@latest"></script>
    <style>
    body { 
        margin: 0; 
        background: #000; 
        overflow: hidden; 
        position: fixed; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’å®Œå…¨ã«ç¦æ­¢ */
        width: 100%;
        height: 100%;
    }
    #game-container {
        width: 100%;
        height: 100dvh; /* å‹•çš„ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆï¼ˆãƒ„ãƒ¼ãƒ«ãƒãƒ¼ã‚’è€ƒæ…®ï¼‰ */
        display: flex;
        flex-direction: column;
        padding: 5px;
        box-sizing: border-box;
        justify-content: space-between;
    }
    #main-display {
        flex: 1; /* ã‚«ãƒ¡ãƒ©ã‚¨ãƒªã‚¢ãŒä½™ç™½ã‚’åŸ‹ã‚ã‚‹ */
        max-height: 35%; /* ã‚«ãƒ¡ãƒ©ãŒå¤§ãããªã‚Šã™ããªã„ã‚ˆã†åˆ¶é™ */
        min-height: 180px;
        position: relative;
        background: #111;
        border: 1px solid #444;
    }
    #all-controls button {
        padding: 10px 5px !important; /* ãƒœã‚¿ãƒ³ã®é«˜ã•ã‚’æŠ‘ãˆã‚‹ */
        font-size: 0.8em;
    }
</style>
</head>
<body>
    <div id="loading-layer" style="position:fixed; top:0; left:0; width:100%; height:100%; background:#000; z-index:1000; display:flex; flex-direction:column; justify-content:center; align-items:center;">
    <h1 style="color:#0f0; font-family:monospace;">AI SYSTEM</h1>
    <p id="init-msg" style="color:#0f0; font-family:monospace;">INITIALIZING...</p>
    <button id="start-btn" class="hidden" 
    onclick="document.getElementById('loading-layer').style.display='none'; document.getElementById('webcam').play();" 
    style="...">
    START GAME
</button>
</div>
    <div id="game-container">
    <div id="enemy-ui">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <span id="e-name" style="font-weight:bold; color:#f00; font-size: 1.1em;">E:------</span>
            <span style="font-size: 0.8em; color: #f66;">ATT:<span id="e-atk">0</span> / DEF:0 / ELE:<span id="e-elem">-</span></span>
        </div>
        <div style="width: 100%; background: #300; height: 10px; border: 1px solid #f00; margin: 5px 0;">
            <div id="e-hp-bar" style="width: 0%; height: 100%; background: #f00; transition: width 0.3s;"></div>
        </div>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 2px;">
            <span style="background:#f00; color:#000; padding: 0 5px; font-size: 0.7em; font-weight: bold;">ENEMY</span>
            <span id="e-hp-text" style="font-size: 0.8em; color: #f66;">HP:0/0</span>
        </div>
    </div>

    <div id="main-display" style="position: relative; height: 30vh; background: #111; border: 1px solid #444; overflow: hidden;">
        <video id="webcam" autoplay playsinline muted style="width: 100%; height: 100%; object-fit: cover;"></video>
        <canvas id="canvas" style="display:none;"></canvas>
        <div id="msg" style="display:none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); color: #0f0; padding: 10px; font-family: 'Courier New', monospace; font-size: 0.9em; overflow-y: auto; white-space: pre-wrap; box-sizing: border-box;"></div>
    </div>

    <div id="player-ui">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <span style="font-weight:bold; color:#0f0;">P: LV.<span id="p-lv">1</span></span>
            <span style="font-size:0.8em; color: #0f0;">W: <span id="p-weapon">------</span></span>
        </div>
        <div style="width: 100%; background: #020; height: 10px; border: 1px solid #0f0; margin: 5px 0;">
            <div id="p-hp-bar" style="width: 100%; height: 100%; background: #0f0; transition: width 0.3s;"></div>
        </div>
        <div style="display: flex; justify-content: space-between; font-size: 0.8em; color: #0f0;">
            <span>ATT:<span id="p-atk">0</span> / DEF:0 / ELE:<span id="p-elem">-</span></span>
            <span id="p-hp-text">HP:1000/1000</span>
        </div>
        <div style="margin-top: 5px; border-top: 1px dotted #0f0; padding-top: 3px;">
            <div style="display: flex; justify-content: space-between; font-size: 0.65em; color: #0af;">
                <span>EXP NEXT</span><span id="p-exp-text">0/100</span>
            </div>
            <div style="width: 100%; background: #001; height: 4px; border: 1px solid #0af;">
                <div id="p-exp-bar" style="width: 0%; height: 100%; background: #0af;"></div>
            </div>
        </div>
    </div>

    <div id="all-controls">
        <button id="scan-btn" onclick="startScan()" style="width: 100%; background: #00f; color: #fff; border: 1px solid #fff; padding: 12px; font-family: 'Courier New', monospace; font-weight: bold; margin-bottom: 8px;">WEAPON SCAN</button>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px;">
            <button id="atk-btn" disabled onclick="attack()" style="background: #200; color: #f00; border: 1px solid #f00; padding: 8px; font-family: 'Courier New', monospace; font-weight: bold;">ATTACK</button>
            <button id="magic-btn" disabled onclick="openMagic()" style="background: #022; color: #0ff; border: 1px solid #0ff; padding: 8px; font-family: 'Courier New', monospace; font-weight: bold;">MAGIC</button>
            <button id="item-btn" style="background: #220; color: #ff0; border: 1px solid #ff0; padding: 8px; opacity: 0.5;">ITEM</button>
            <button id="escape-btn" style="background: #202; color: #f0f; border: 1px solid #f0f; padding: 8px; opacity: 0.5;">ESCAPE</button>
            <button id="status-btn" onclick="openStatus()" style="background: #111; color: #0f0; border: 1px solid #0f0; padding: 8px;">STATUS</button>
            <button id="library-btn" onclick="openLibrary()" style="background: #111; color: #0f0; border: 1px solid #0f0; padding: 8px;">LIBRARY</button>
        </div>
    </div>
</div>
<script>
// --- 1. ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°å®£è¨€ ---
// â€»åŒã˜å¤‰æ•°ã‚’äºŒåº¦ let ã§å®£è¨€ã™ã‚‹ã¨ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ãŸã‚ã€ã“ã“ã ã‘ã§å®šç¾©ã—ã¾ã™ã€‚
// --- 1. ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°å®£è¨€ ---
let net; 
let stream; 
let mode = "W"; // W:æ­¦å™¨, E:æ•µ, B:ãƒãƒˆãƒ«, I:ç”»é¢è¡¨ç¤ºä¸­
let lv = 1;
let php = 1000, pMax = 1000;
let pAtk = 0; // 1å›ã ã‘å®£è¨€
let pDef = 0; // 1å›ã ã‘å®£è¨€
let playerElement = null; 
let weaponName = "------"; 

// æ•µãƒ‡ãƒ¼ã‚¿ç”¨
let eAtk = 0, eExp = 0, ehp = 0, eMax = 0, enemyName = "", enemyElement = null;

// å›³é‘‘ãƒ‡ãƒ¼ã‚¿ã®åˆæœŸåŒ–
let library = { 
    weapons: [], 
    monsters: [] 
};

// --- 2. é­”æ³•ãƒ»ã‚¹ã‚­ãƒ«ã‚·ã‚¹ãƒ†ãƒ ç”¨å¤‰æ•° ---
let skillPoints = 0; 
let magicUsedInBattle = false; 
let pAtkBonus = 1.0; 
let pDefBonus = 1.0; 
let learnedMagics = []; // ç¿’å¾—æ¸ˆã¿é­”æ³•ãƒªã‚¹ãƒˆ

// é­”æ³•ãƒ¬ãƒ™ãƒ«ï¼ˆAQUA, WOODã‚’ä½¿ç”¨ï¼‰
let magicLevels = {
    HEAL: 1, 
    FIRE: 0, AQUA: 0, EARTH: 0, WOOD: 0, 
    BRAV: 0, SELD: 0, 
    WEEK: 0, BRAK: 0  
};

// --- 3. å±æ€§ãƒ»ãƒ¬ã‚¢ãƒªãƒ†ã‚£è¨­å®š (æŒ‡å®šã®ç›¸æ€§ï¼šFIRE < AQUA < EARTH < WOOD < FIRE) ---
const ELEMENTS = {
    AQUA:  { icon: "ğŸ’§", color: "#4af", strongTo: "FIRE" },  // æ°´ã¯ç«ã«å¼·ã„
    EARTH: { icon: "â›°ï¸", color: "#a64", strongTo: "AQUA" },  // åœŸã¯æ°´ã«å¼·ã„
    WOOD:  { icon: "ğŸƒ", color: "#4c4", strongTo: "EARTH" }, // æœ¨ã¯åœŸã«å¼·ã„
    FIRE:  { icon: "ğŸ”¥", color: "#f44", strongTo: "WOOD" }   // ç«ã¯æœ¨ã«å¼·ã„
};

// å±æ€§ç›¸æ€§ãƒ‡ãƒ¼ã‚¿ï¼šã‚¢ã‚¤ã‚³ãƒ³ã‚’ ELEMENTS ã¨çµ±ä¸€
const ELEMENT_CHART = {
    "ğŸ”¥": { "ğŸƒ": 2.0, "ğŸ’§": 0.5, "ğŸ”¥": 0.8 }, // ç«ã¯æœ¨(ğŸƒ)ã«å¼·ãã€æ°´ã«å¼±ã„
    "ğŸ’§": { "ğŸ”¥": 2.0, "â›°ï¸": 0.5, "ğŸ’§": 0.8 }, // æ°´ã¯ç«ã«å¼·ãã€åœŸã«å¼±ã„
    "â›°ï¸": { "ğŸ’§": 2.0, "ğŸƒ": 0.5, "â›°ï¸": 0.8 }, // åœŸã¯æ°´ã«å¼·ãã€æœ¨ã«å¼±ã„
    "ğŸƒ": { "â›°ï¸": 2.0, "ğŸ”¥": 0.5, "ğŸƒ": 0.8 }  // æœ¨ã¯åœŸã«å¼·ãã€ç«ã«å¼±ã„
};

const RARITY_RATES = [
    { rarity: "LEGENDARY", rate: 0.01 },
    { rarity: "EPIC",      rate: 0.05 },
    { rarity: "RARE",      rate: 0.20 },
    { rarity: "COMMON",    rate: 0.74 }
];

// ã“ã“ã‹ã‚‰å…ˆã¯ä»¥å‰ã® MAGIC_DATA ã®ç¶šãã‚’ç¹‹ã’ã¦ãã ã•ã„

const MAGIC_DATA = {
    HEAL: { name: "å›å¾©", type: "Heal", elem: null },
    FIRE: { name: "ãƒ•ã‚¡ã‚¤ã‚¢", type: "Attack", elem: "FIRE" },
    AQUA: { name: "ã‚¢ã‚¯ã‚¢", type: "Attack", elem: "AQUA" },
    EARTH: { name: "ã‚¢ãƒ¼ã‚¹", type: "Attack", elem: "EARTH" },
    WOOD: { name: "ãƒªãƒ¼ãƒ•", type: "Attack", elem: "WOOD" },
    BRAV: { name: "ãƒ–ãƒ¬ã‚¤ãƒ–", type: "Buff", elem: null },
    SELD: { name: "ã‚·ãƒ¼ãƒ«ãƒ‰", type: "Buff", elem: null },
    WEEK: { name: "ã‚¦ã‚£ãƒ¼ã‚¯", type: "Debuff", elem: null },
    BRAK: { name: "ãƒ–ãƒ¬ã‚¤ã‚¯", type: "Debuff", elem: null }
};

const COLOR_MAPPING = [
    { elem: "FIRE",  check: (r, g, b) => r > 150 && g < 100 },
    { elem: "AQUA",  check: (r, g, b) => b > 150 && r < 100 }, // WATERã‚’AQUAã«å¤‰æ›´
    { elem: "WOOD",  check: (r, g, b) => g > 120 && r < 120 && b < 120 },
    { elem: "EARTH", check: (r, g, b) => r > 100 && g > 50 && b < 100 }
];

// --- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ ---
const WEAPON_DB = [
    // --- MYTH (No.91 - 100) ---
    { no: 100, rarity: "MYTH", name: "å¤©å¢é›²å‰£", keywords: ["sword", "blade"], atk: 800, def: 200 },
    { no: 99, rarity: "MYTH", name: "ãƒ­ãƒ³ã‚®ãƒŒã‚¹ã®æ§", keywords: ["stick", "pitcher", "racket"], atk: 750, def: 150 },
    { no: 98, rarity: "MYTH", name: "ãƒã‚§ãƒ¼ãƒ³ã‚½ãƒ¼", keywords: ["tools", "drill"], atk: 900, def: 50 },
    { no: 97, rarity: "MYTH", name: "è¶…é›»ç£ç ²", keywords: ["gun", "toy"], atk: 1000, def: 0 },
    { no: 96, rarity: "MYTH", name: "ãƒ‡ãƒ¥ãƒ©ãƒ³ãƒ€ãƒ«", keywords: ["sword", "knife"], atk: 700, def: 300 },
    { no: 95, rarity: "MYTH", name: "å¦‚æ„æ£’", keywords: ["stick", "umbrella", "pole"], atk: 650, def: 250 },
    { no: 94, rarity: "MYTH", name: "ãƒŸãƒ§ãƒ«ãƒ‹ãƒ«", keywords: ["tools", "hammer"], atk: 850, def: 100 },
    { no: 93, rarity: "MYTH", name: "ã‚°ãƒ³ã‚°ãƒ‹ãƒ«", keywords: ["stick", "pen"], atk: 780, def: 120 },
    { no: 92, rarity: "MYTH", name: "ãƒ¬ãƒ¼ãƒ´ã‚¡ãƒ†ã‚¤ãƒ³", keywords: ["lighter", "fire"], atk: 820, def: 80 },
    { no: 91, rarity: "MYTH", name: "è–å‰£ã‚¨ã‚¯ã‚¹ã‚«ãƒªãƒãƒ¼", keywords: ["sword", "blade"], atk: 880, def: 180 },

    // --- LEGEND (No.71 - 90) ---
    { no: 90, rarity: "LEGEND", name: "æ‘æ­£", keywords: ["knife", "scissors"], atk: 500, def: 50 },
    { no: 89, rarity: "LEGEND", name: "ãƒ‰ãƒ©ã‚´ãƒ³ã‚¹ãƒ¬ã‚¤ãƒ¤ãƒ¼", keywords: ["plate", "iron"], atk: 550, def: 100 },
    { no: 88, rarity: "LEGEND", name: "æ–¹å¤©ç”»æˆŸ", keywords: ["stick"], atk: 480, def: 80 },
    { no: 87, rarity: "LEGEND", name: "é’é¾åƒæœˆåˆ€", keywords: ["stick"], atk: 490, def: 90 },
    { no: 86, rarity: "LEGEND", name: "ã‚«ãƒ©ãƒ‰ãƒœãƒ«ã‚°", keywords: ["sword"], atk: 470, def: 110 },
    { no: 85, rarity: "LEGEND", name: "ãƒãƒ«ãƒ‘ãƒ¼", keywords: ["hook", "sickle"], atk: 440, def: 60 },
    { no: 84, rarity: "LEGEND", name: "ãƒ¬ãƒ¼ã‚¶ãƒ¼ãƒ–ãƒ¬ãƒ¼ãƒ‰", keywords: ["flashlight"], atk: 600, def: 20 },
    { no: 83, rarity: "LEGEND", name: "ãƒ‡ã‚¹ã‚µã‚¤ã‚º", keywords: ["sickle"], atk: 580, def: 40 },
    { no: 82, rarity: "LEGEND", name: "ã‚¤ãƒ¼ã‚¸ã‚¹ã®ç›¾", keywords: ["plate", "lid"], atk: 100, def: 600 },
    { no: 81, rarity: "LEGEND", name: "ãƒ´ã‚¡ã‚¸ãƒ¥ãƒ©", keywords: ["toy", "remote"], atk: 520, def: 100 },
    // (ä¸­ç•¥: 80-71ã‚‚åŒæ§˜ã®LEGENDç´šãŒå…¥ã‚Šã¾ã™)

    // --- ELITE (No.31 - 70) ---
    { no: 70, rarity: "ELITE", name: "æ—¥æœ¬åˆ€", keywords: ["sword", "knife"], atk: 250, def: 30 },
    { no: 69, rarity: "ELITE", name: "ãƒãƒˆãƒ«ã‚¢ãƒƒã‚¯ã‚¹", keywords: ["tools"], atk: 280, def: 50 },
    { no: 68, rarity: "ELITE", name: "ãƒ­ãƒ³ã‚°ãƒœã‚¦", keywords: ["hanger"], atk: 220, def: 10 },
    { no: 67, rarity: "ELITE", name: "ãƒãƒ«ãƒãƒ¼ãƒ‰", keywords: ["mop", "broom"], atk: 260, def: 60 },
    { no: 66, rarity: "ELITE", name: "ã‚¦ã‚©ãƒ¼ãƒãƒ³ãƒãƒ¼", keywords: ["hammer"], atk: 300, def: 40 },
    { no: 65, rarity: "ELITE", name: "ãƒ¬ã‚¤ãƒ”ã‚¢", keywords: ["pen", "needle"], atk: 210, def: 20 },
    { no: 64, rarity: "ELITE", name: "ãƒ•ãƒ©ãƒ³ãƒ™ãƒ«ã‚¸ãƒ¥", keywords: ["knife"], atk: 240, def: 40 },
    { no: 63, rarity: "ELITE", name: "ãƒ¢ãƒ¼ãƒ‹ãƒ³ã‚°ã‚¹ã‚¿ãƒ¼", keywords: ["brush"], atk: 290, def: 30 },
    { no: 62, rarity: "ELITE", name: "ã‚¯ãƒ­ã‚¹ãƒœã‚¦", keywords: ["toy"], atk: 270, def: 10 },
    { no: 61, rarity: "ELITE", name: "ã‚«ã‚¿ãƒ¼ãƒ«", keywords: ["fork"], atk: 200, def: 30 },
    // (ä¸­ç•¥: 60-31ã‚‚å®Ÿæˆ¦çš„ãªæ­¦å™¨ãŒå…¥ã‚Šã¾ã™)

    // --- COMMON (No.1 - 30) ---
    { no: 30, rarity: "COMMON", name: "é‰„ã®å‰£", keywords: ["knife", "spoon"], atk: 80, def: 10 },
    { no: 29, rarity: "COMMON", name: "æœ¨ã®æ–", keywords: ["stick"], atk: 40, def: 20 },
    { no: 28, rarity: "COMMON", name: "çŸ³ã®æ–§", keywords: ["stone"], atk: 90, def: 5 },
    { no: 27, rarity: "COMMON", name: "ç·´ç¿’ç”¨ç«¹åˆ€", keywords: ["ruler", "stick"], atk: 30, def: 40 },
    { no: 26, rarity: "COMMON", name: "çš®ã®ç›¾", keywords: ["book", "wallet"], atk: 5, def: 60 },
    { no: 25, rarity: "COMMON", name: "ãƒ–ãƒ¼ãƒ¡ãƒ©ãƒ³", keywords: ["banana"], atk: 70, def: 0 },
    { no: 24, rarity: "COMMON", name: "ãƒ‘ãƒãƒ³ã‚³", keywords: ["rubber band"], atk: 50, def: 0 },
    { no: 23, rarity: "COMMON", name: "é’éŠ…ã®æ§", keywords: ["umbrella"], atk: 110, def: 20 },
    { no: 22, rarity: "COMMON", name: "ã‚¯ãƒ©ãƒ–(æ£æ£’)", keywords: ["bottle"], atk: 100, def: 10 },
    { no: 21, rarity: "COMMON", name: "ãƒŠã‚¤ãƒ•", keywords: ["knife"], atk: 70, def: 5 },
    // ... No.1ã¾ã§ç¶šã (ä»¥ä¸‹çœç•¥ã€‚ã‚·ã‚¹ãƒ†ãƒ ä¸Šã¯ã“ã‚Œã ã‘ã§ååˆ†å‹•ä½œã—ã¾ã™)
    { no: 1, rarity: "COMMON", name: "ã²ã®ãã®ã¼ã†", keywords: ["stick", "pen"], atk: 10, def: 5 }
];
const MONSTER_DB = [
    // --- MYTH (No.91 - 100) ---
    { no: 100, rarity: "MYTH", name: "æœ€å¾Œã®å¯©åˆ¤", keywords: ["book", "paper"], hp: 9999, atk: 600, exp: 5000 },
    { no: 99, rarity: "MYTH", name: "ãƒ«ã‚·ãƒ•ã‚¡ãƒ¼", keywords: ["bird", "feather"], hp: 7000, atk: 550, exp: 4000 },
    { no: 98, rarity: "MYTH", name: "ç¹”ç”°ä¿¡é•·", keywords: ["human", "person", "suit"], hp: 5500, atk: 450, exp: 3000 },
    { no: 97, rarity: "MYTH", name: "ãƒãƒãƒ ãƒ¼ãƒˆ", keywords: ["lizard", "toy"], hp: 8000, atk: 500, exp: 4500 },
    { no: 96, rarity: "MYTH", name: "ã‚±ãƒ«ãƒ™ãƒ­ã‚¹", keywords: ["dog", "pet"], hp: 4500, atk: 480, exp: 2500 },
    { no: 95, rarity: "MYTH", name: "ãƒ•ã‚§ãƒ³ãƒªãƒ«", keywords: ["dog", "wolf"], hp: 5000, atk: 460, exp: 2800 },
    { no: 94, rarity: "MYTH", name: "ãƒªãƒ´ã‚¡ã‚¤ã‚¢ã‚µãƒ³", keywords: ["fish", "drink"], hp: 6500, atk: 420, exp: 3200 },
    { no: 93, rarity: "MYTH", name: "ãƒ¤ãƒã‚¿ãƒã‚ªãƒ­ãƒ", keywords: ["snake", "rope"], hp: 6000, atk: 440, exp: 3500 },
    { no: 92, rarity: "MYTH", name: "å¤§å¤©ä½¿ãƒŸã‚«ã‚¨ãƒ«", keywords: ["sculpture", "doll"], hp: 7500, atk: 400, exp: 4200 },
    { no: 91, rarity: "MYTH", name: "ã‚·ãƒ´ã‚¡", keywords: ["human", "statue"], hp: 8500, atk: 520, exp: 4800 },

    // --- LEGEND (No.71 - 90) ---
    { no: 90, rarity: "LEGEND", name: "ãƒ‰ãƒ©ã‚´ãƒ³", keywords: ["lizard", "toy"], hp: 3000, atk: 300, exp: 1200 },
    { no: 89, rarity: "LEGEND", name: "å¸è¡€é¬¼", keywords: ["human", "person"], hp: 2500, atk: 280, exp: 1000 },
    { no: 88, rarity: "LEGEND", name: "ã‚­ãƒã‚¤ãƒ©", keywords: ["cat", "dog"], hp: 2800, atk: 250, exp: 1100 },
    { no: 87, rarity: "LEGEND", name: "ãƒ¡ãƒ‡ãƒ¥ãƒ¼ã‚µ", keywords: ["hair", "wig"], hp: 2200, atk: 240, exp: 950 },
    { no: 86, rarity: "LEGEND", name: "ãƒŸãƒã‚¿ã‚¦ãƒ­ã‚¹", keywords: ["box", "gym"], hp: 3500, atk: 320, exp: 1300 },
    { no: 85, rarity: "LEGEND", name: "ã‚¶ãƒ»ãƒ©ã‚¤ãƒ•", keywords: ["drink", "bottle"], hp: 4000, atk: 150, exp: 1500 },
    { no: 84, rarity: "LEGEND", name: "ã‚°ãƒªãƒ•ã‚£ãƒ³", keywords: ["bird"], hp: 2400, atk: 260, exp: 900 },
    { no: 83, rarity: "LEGEND", name: "ãƒ‡ãƒ¥ãƒ©ãƒãƒ³", keywords: ["helmet", "hat"], hp: 3200, atk: 290, exp: 1150 },
    { no: 82, rarity: "LEGEND", name: "ã‚µãƒ©ãƒãƒ³ãƒ€ãƒ¼", keywords: ["lighter", "stove"], hp: 2100, atk: 310, exp: 980 },
    { no: 81, rarity: "LEGEND", name: "ã‚¯ãƒ©ãƒ¼ã‚±ãƒ³", keywords: ["cloth", "curtain"], hp: 3800, atk: 270, exp: 1250 },

    // --- ELITE (No.31 - 70) ---
    { no: 70, rarity: "ELITE", name: "ã‚¬ãƒ¼ã‚´ã‚¤ãƒ«", keywords: ["stone", "shelf"], hp: 1200, atk: 150, exp: 450 },
    { no: 69, rarity: "ELITE", name: "ã‚¦ã‚§ã‚¢ã‚¦ãƒ«ãƒ•", keywords: ["dog", "coat"], hp: 1000, atk: 180, exp: 400 },
    { no: 68, rarity: "ELITE", name: "ã‚ªãƒ¼ã‚¬", keywords: ["chair", "big"], hp: 1500, atk: 200, exp: 500 },
    { no: 67, rarity: "ELITE", name: "ãƒŸã‚¤ãƒ©", keywords: ["human", "toilet paper", "towel"], hp: 900, atk: 120, exp: 350 },
    { no: 66, rarity: "ELITE", name: "ã‚µã‚­ãƒ¥ãƒã‚¹", keywords: ["pillow", "bed"], hp: 800, atk: 140, exp: 380 },
    { no: 65, rarity: "ELITE", name: "ãƒªãƒ“ãƒ³ã‚°ã‚¢ãƒ¼ãƒãƒ¼", keywords: ["jacket", "metal"], hp: 1800, atk: 130, exp: 480 },
    { no: 64, rarity: "ELITE", name: "ã‚³ã‚«ãƒˆãƒªã‚¹", keywords: ["chicken", "egg"], hp: 750, atk: 170, exp: 320 },
    { no: 63, rarity: "ELITE", name: "ãƒ©ãƒŸã‚¢", keywords: ["snake", "belt"], hp: 1100, atk: 160, exp: 420 },
    { no: 62, rarity: "ELITE", name: "ã‚±ãƒ³ã‚¿ã‚¦ãƒ­ã‚¹", keywords: ["bicycle", "machine"], hp: 1300, atk: 190, exp: 460 },
    { no: 61, rarity: "ELITE", name: "ãƒ˜ãƒ«ãƒã‚¦ãƒ³ãƒ‰", keywords: ["dog", "black"], hp: 950, atk: 210, exp: 430 },

    // --- COMMON (No.1 - 30) ---
    { no: 30, rarity: "COMMON", name: "ã‚´ãƒ–ãƒªãƒ³", keywords: ["wallet", "coin"], hp: 400, atk: 60, exp: 120 },
    { no: 29, rarity: "COMMON", name: "ã‚¹ã‚±ãƒ«ãƒˆãƒ³", keywords: ["spoon", "fork", "white"], hp: 350, atk: 70, exp: 100 },
    { no: 28, rarity: "COMMON", name: "ã‚¤ãƒ³ãƒ—", keywords: ["book", "smartphone"], hp: 300, atk: 80, exp: 110 },
    { no: 27, rarity: "COMMON", name: "ãƒãƒ–ãƒ«ã‚¼ãƒªãƒ¼", keywords: ["drink", "cup", "soap"], hp: 500, atk: 40, exp: 90 },
    { no: 26, rarity: "COMMON", name: "ãƒ¯ã‚¤ãƒ«ãƒ‰ãƒœã‚¢", keywords: ["bag", "brown"], hp: 450, atk: 90, exp: 130 },
    { no: 25, rarity: "COMMON", name: "ãƒãƒ³ãƒ‰ãƒ©ã‚´ãƒ©", keywords: ["plant", "pot"], hp: 250, atk: 50, exp: 80 },
    { no: 24, rarity: "COMMON", name: "ãƒãƒƒãƒˆ", keywords: ["umbrella", "black"], hp: 200, atk: 65, exp: 70 },
    { no: 23, rarity: "COMMON", name: "ãƒã‚¤ã‚ºãƒ³ã‚¹ãƒ‘ã‚¤ãƒ€ãƒ¼", keywords: ["mouse", "black"], hp: 220, atk: 100, exp: 150 },
    { no: 10, rarity: "COMMON", name: "ã‚¹ãƒ©ã‚¤ãƒ ", keywords: ["drink", "drink", "bottle", "cap", "blue"], hp: 150, atk: 30, exp: 50 },
    { no: 1, rarity: "COMMON", name: "ãƒ©ãƒƒãƒˆ", keywords: ["mouse", "cheese"], hp: 100, atk: 20, exp: 30 }
];

// --- ã‚·ã‚¹ãƒ†ãƒ ãƒ­ã‚¸ãƒƒã‚¯ ---

window.onload = async () => {
    try {
        // IDãŒ init-msg ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
        const msgElem = document.getElementById('init-msg');
        if(msgElem) msgElem.innerText = "LOADING AI...";

        net = await mobilenet.load();

        if(msgElem) msgElem.innerText = "AI READY";
        const startBtn = document.getElementById('start-btn');
        if(startBtn) {
            startBtn.classList.remove('hidden');
            startBtn.disabled = false;
        }
    } catch(e) {
        console.error(e);
        // ã‚¨ãƒ©ãƒ¼ã§ã‚‚ãƒœã‚¿ãƒ³ã ã‘ã¯å‡ºã™
        const startBtn = document.getElementById('start-btn');
        if(startBtn) startBtn.classList.remove('hidden');
    }
};

async function startGame() {
    document.getElementById('init-overlay').classList.add('hidden');
    const video = document.getElementById('webcam');
    stream = await navigator.mediaDevices.getUserMedia({video: {facingMode: "environment"}});
    video.srcObject = stream;
    video.style.display = "block";
    mode = "W";
    document.getElementById('scan-btn').disabled = false;
    log("æ­¦å™¨(WEAPON)ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ãã ã•ã„");
}

function getElementByColor() {
    const video = document.getElementById('webcam');
    const canvas = document.getElementById('color-canvas');
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, video.videoWidth/2, video.videoHeight/2, 1, 1, 0, 0, 1, 1);
    const [r, g, b] = ctx.getImageData(0, 0, 1, 1).data;
    document.getElementById('element-debug').innerText = `RGB: ${r},${g},${b}`;
    for (const m of COLOR_MAPPING) if (m.check(r, g, b)) return m.elem;
    return Object.keys(ELEMENTS)[Math.floor(Math.random() * 4)];
}

function lottery(db, label) {
    try {
        const labels = label ? label.toLowerCase().split(',').map(s => s.trim()) : ["unknown"];
        
        // 1. ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ä¸€è‡´ã‚’æ¤œç´¢
        let candidates = db.filter(item => 
            item.keywords && item.keywords.some(k => labels.includes(k.toLowerCase()))
        );

        // 2. ä¸€è‡´ãŒãªã‘ã‚Œã°å…¨æŠ½é¸
        if (candidates.length === 0) candidates = db;

        let totalWeight = 0;
        const weighted = candidates.map(c => {
            // ãƒ¬ã‚¢ãƒªãƒ†ã‚£è¨­å®šã®å®‰å…¨ç¢ºèª
            const rateObj = (typeof RARITY_RATES !== 'undefined') ? 
                            RARITY_RATES.find(r => r.rarity === c.rarity) : null;
            const w = rateObj ? rateObj.rate : 1;
            totalWeight += w;
            return { item: c, w: totalWeight };
        });

        const r = Math.random() * totalWeight;
        const result = weighted.find(item => r <= item.w);
        return result ? result.item : db[0];
    } catch (e) {
        console.error("Lottery Error:", e);
        return db[0]; // æœ€æ‚ªã€æœ€åˆã®è¦ç´ ã‚’è¿”ã—ã¦ãƒ•ãƒªãƒ¼ã‚ºã‚’é˜²ã
    }
}
function toggleDisplay(showLog) {
    const video = document.getElementById('webcam');
    const logArea = document.getElementById('log-display');

    if (showLog) {
        video.classList.add('hidden');
        logArea.classList.remove('hidden');
    } else {
        video.classList.remove('hidden');
        logArea.classList.add('hidden');
        if (video.paused) video.play().catch(()=>{});
    }
}
async function startScan() {
    if (mode === "B") return;

    const video = document.getElementById('webcam');
    const btn = document.getElementById('scan-btn');

    if (!video || !btn) return;

    // ãƒ“ãƒ‡ã‚ªå†ç”Ÿãƒã‚§ãƒƒã‚¯
    if (video.paused) {
        try {
            await video.play();
            await new Promise(resolve => setTimeout(resolve, 300));
        } catch (e) {
            log("ã‚«ãƒ¡ãƒ©ã®å†èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸ");
            return;
        }
    }
    
    if (video.readyState !== 4) {
        log("ã‚«ãƒ¡ãƒ©æº–å‚™ä¸­...");
        return;
    }

    btn.disabled = true;
    log("AIè§£æä¸­...");

    try {
        let label = "unknown";
        const result = await net.classify(video);
        if (result && result.length > 0) label = result[0].className;

        let elemKey = "FIRE";
        try {
            elemKey = getElementByColor() || "FIRE";
            if (elemKey === "WATER") elemKey = "AQUA"; 
        } catch (colorErr) { console.warn(colorErr); }

        if (mode === "W") {
    const weapon = lottery(WEAPON_DB, label);
    playerElement = elemKey;
    weaponName = weapon.name; // å¤‰æ•°ã«ä¿å­˜
    pAtk = weapon.atk;
    pDef = weapon.def;

    // ç›´æ¥HTMLã‚’æ›¸ãæ›ãˆã‚‹
    document.getElementById('p-weapon').innerText = weaponName; 
    
    log(`æ­¦å™¨: ${weaponName} [ATK:${pAtk}]\nå±æ€§: ${ELEMENTS[elemKey].icon}`);
    // ...
} else if (mode === "E") {
            const monster = lottery(MONSTER_DB, label);
            enemyElement = elemKey;
            enemyName = monster.name;
            eMax = monster.hp; ehp = eMax;
            eAtk = monster.atk; eExp = monster.exp;
            log(`æ•µ: ${monster.name} [HP:${eMax}]\nå±æ€§: ${ELEMENTS[elemKey].icon}`);
            mode = "B";
    log("ãƒãƒˆãƒ«é–‹å§‹ï¼");
    toggleDisplay(true); // â˜…ã“ã“ã§ã‚«ãƒ¡ãƒ©ã‹ã‚‰ãƒ­ã‚°ã«åˆ‡ã‚Šæ›¿ãˆ
    // â˜… ã“ã“ã«è¿½åŠ ï¼šãƒãƒˆãƒ«ãƒ¢ãƒ¼ãƒ‰ã«ãªã£ãŸã®ã§ãƒœã‚¿ãƒ³ã‚’è§£æ”¾ã™ã‚‹
            document.getElementById('atk-btn').disabled = false;
            document.getElementById('magic-btn').disabled = false;
            // ã¤ã„ã§ã«ã‚¹ã‚­ãƒ£ãƒ³ãƒœã‚¿ãƒ³ã‚’ãƒãƒˆãƒ«ä¸­ã¯ç„¡åŠ¹ã«ã—ã¦ãŠãã¨èª¤çˆ†ã‚’é˜²ã’ã¾ã™
            btn.disabled = true; 
            btn.innerText = "BATTLE IN PROGRESS";
        }
        updateUI();
    } catch (e) {
        log("ã‚¹ã‚­ãƒ£ãƒ³ã‚¨ãƒ©ãƒ¼ã€‚ã‚‚ã†ä¸€åº¦ã€‚");
        btn.disabled = false;
    }
}

function handleAttack() {
    // 1. å±æ€§è£œæ­£ã®è¨ˆç®—
    const mod = getElementModifier(playerElement, enemyElement);
    
    // 2. ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ”»æ’ƒåŠ›è¨ˆç®— (åŸºæœ¬æ”»æ’ƒåŠ› * ãƒãƒ•å€ç‡ + ãƒ¬ãƒ™ãƒ«ãƒœãƒ¼ãƒŠã‚¹)
    const finalAtk = (pAtk * pAtkBonus) + (lv * 10);
    
    // 3. ãƒ€ãƒ¡ãƒ¼ã‚¸è¨ˆç®— (æ”»æ’ƒåŠ› * å±æ€§è£œæ­£)
    // æ•µã«é˜²å¾¡åŠ›è¨­å®šãŒãªã„ãŸã‚ã€ã‚·ãƒ³ãƒ—ãƒ«ã«è¨ˆç®—ã—ã¾ã™
    const dmg = Math.floor(Math.max(1, finalAtk * mod)); 
    
    // 4. HPæ¸›å°‘ã¨æ¼”å‡º
    ehp = Math.max(0, ehp - dmg);
    applyShake(); // ç”»é¢ã‚’æºã‚‰ã™
    
    // 5. ãƒ­ã‚°è¡¨ç¤º
    let effMsg = mod === 1.5 ? "åŠ¹æœçµ¶å¤§ï¼" : (mod === 0.5 ? "ã‚¤ãƒã‚¤ãƒ..." : "");
    log(`${enemyName}ã« ${dmg}ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼ ${effMsg}`);

    // 6. åˆ¤å®š
    if (ehp <= 0) {
        log(`${enemyName}ã‚’å€’ã—ãŸï¼`);
        // å‹åˆ©æ™‚ã¯å°‘ã—å¾…ã£ã¦ã‹ã‚‰ãƒªã‚»ãƒƒãƒˆï¼ˆçµŒé¨“å€¤å‡¦ç†ã¸ï¼‰
        setTimeout(() => resetBattleState(true), 1000);
    } else {
        // ã¾ã å€’ã›ã¦ã„ãªã‘ã‚Œã°æ•µã®ã‚¿ãƒ¼ãƒ³ã¸
        document.getElementById('atk-btn').disabled = true; // ãƒœã‚¿ãƒ³ã‚’æ¶ˆã™
    document.getElementById('magic-btn').disabled = true;
    setTimeout(enemyTurn, 1000); // 1ç§’å¾Œã«æ•µã®ã‚¿ãƒ¼ãƒ³
}
    updateUI();
}// --- é­”æ³•ã‚·ã‚¹ãƒ†ãƒ ã¨æˆ¦é—˜è£œåŠ©é–¢æ•° ---

// æ•µã®æ”»æ’ƒå‡¦ç†ï¼ˆé€šå¸¸æ”»æ’ƒï¼‰
function enemyTurn() {
    // 1. æ•µã®ãƒ€ãƒ¡ãƒ¼ã‚¸è¨ˆç®—
    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®é˜²å¾¡åŠ› pDef ã‚’è€ƒæ…®ï¼ˆæœ€ä½ãƒ€ãƒ¡ãƒ¼ã‚¸1ï¼‰
    const dmg = Math.floor(Math.max(1, eAtk - (pDef || 0)));
    
    // 2. ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®HPã‚’æ¸›ã‚‰ã™
    php = Math.max(0, php - dmg);
    
    // 3. æ¼”å‡ºã¨ãƒ­ã‚°
    applyShake(); // ç”»é¢ã‚’æºã‚‰ã™
    log(`${enemyName}ã®æ”»æ’ƒï¼ ${dmg}ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼`);
    
    // 4. åˆ¤å®š
    if (php <= 0) {
        log("ã‚ãªãŸã¯å€’ã‚Œã¦ã—ã¾ã£ãŸ...");
        setTimeout(() => resetBattleState(false), 2000);
    } else {
        // â˜…ã“ã“ãŒé‡è¦ï¼â˜… 
        // æ•µã®æ”»æ’ƒãŒçµ‚ã‚ã£ãŸã®ã§ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã›ã‚‹ã‚ˆã†ã«æˆ»ã™
        document.getElementById('atk-btn').disabled = false;
        document.getElementById('magic-btn').disabled = false;
        log("ã‚ãªãŸã®ã‚¿ãƒ¼ãƒ³ã§ã™ã€‚");
    }
    
    updateUI();
}
// é­”æ³•ä½¿ç”¨å¾Œã®æ•µã®æ”»æ’ƒå‡¦ç†ï¼ˆãƒ­ã‚¸ãƒƒã‚¯ã¯enemyTurnã¨åŒã˜ï¼‰
function enemyTurnAfterMagic() {
    const finalEAtk = eAtk * pAtkBonus; 
    const finalPDef = pDef * pDefBonus; 
    const edmg = Math.max(10, finalEAtk - finalPDef); 
    
    php = Math.max(0, php - edmg);
    log(`æ•µã®æ”»æ’ƒï¼ ${edmg}ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼`);
    if (php <= 0) { alert("GAMEOVER"); location.reload(); }
    updateUI();
}

function attack() {
    if (mode !== "B" || ehp <= 0) return;

    // 1. ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ”»æ’ƒåŠ›è¨ˆç®—ï¼ˆå°‘ã—ãƒ©ãƒ³ãƒ€ãƒ å¹…ã‚’æŒãŸã›ã‚‹ï¼‰
    let damage = Math.floor(pAtk * (0.9 + Math.random() * 0.2) * pAtkBonus);

    // 2. å±æ€§ç›¸æ€§ã®è¨ˆç®—
    let multiplier = 1.0;
    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ­¦å™¨å±æ€§ã‚¢ã‚¤ã‚³ãƒ³ã¨ã€æ•µã®å±æ€§ã‚¢ã‚¤ã‚³ãƒ³ã‚’æ¯”è¼ƒ
    const pIcon = playerElement ? playerElement.icon : null;
    const eIcon = enemyElement ? ELEMENTS[enemyElement].icon : null;

    if (pIcon && eIcon) {
        multiplier = (ELEMENT_CHART[pIcon] && ELEMENT_CHART[pIcon][eIcon]) ? ELEMENT_CHART[pIcon][eIcon] : 1.0;
    }

    damage = Math.floor(damage * multiplier);
    ehp -= damage;

    // 3. æ¼”å‡ºã¨ãƒ­ã‚°
    applyShake(); // ç”»é¢ã‚’æºã‚‰ã™
    log(`ã‚ãªãŸã®æ”»æ’ƒï¼ ${enemyName}ã« ${damage} ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼`);
    if (multiplier > 1.0) log("âœ¨ åŠ¹æœã¯ã°ã¤ãã‚“ã ï¼");
    if (multiplier < 1.0) log("ğŸ›¡ï¸ åŠ¹æœã¯ã„ã¾ã²ã¨ã¤ã®ã‚ˆã†ã ...");

    updateUI();

    // 4. å‹åˆ©åˆ¤å®šã¾ãŸã¯æ•µã®åæ’ƒ
    if (ehp <= 0) {
        ehp = 0;
        updateUI();
        log(`${enemyName}ã‚’å€’ã—ãŸï¼`);
        setTimeout(() => resetBattleState(true), 1500);
    } else {
        // 1ç§’å¾Œã«æ•µãŒåæ’ƒã—ã¦ãã‚‹
        document.getElementById('atk-btn').disabled = true;
        setTimeout(enemyAttack, 1000);
    }
}

function enemyAttack() {
    if (mode !== "B" || ehp <= 0) return;

    let eDamage = Math.floor(eAtk * (0.9 + Math.random() * 0.2) / pDefBonus);
    php -= eDamage;
    
    applyShake();
    log(`${enemyName}ã®æ”»æ’ƒï¼ ã‚ãªãŸã¯ ${eDamage} ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å—ã‘ãŸï¼`);
    
    updateUI();

    if (php <= 0) {
        php = 0;
        updateUI();
        log("ã‚ãªãŸã¯åŠ›å°½ããŸ...");
        setTimeout(() => location.reload(), 3000); // 3ç§’å¾Œã«ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãƒªãƒˆãƒ©ã‚¤
    } else {
        document.getElementById('atk-btn').disabled = false;
    }
}

// æˆ¦é—˜çµ‚äº†å¾Œã®çŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆã¨çµŒé¨“å€¤å‡¦ç†
function resetBattleState(isVictory) {
    magicUsedInBattle = false;
    pAtkBonus = 1.0;
    pDefBonus = 1.0;
    
    mode = "W";
    toggleDisplay(false); // ãƒ­ã‚°ã‹ã‚‰ã‚«ãƒ¡ãƒ©ã«æˆ»ã™
    
    const scanBtn = document.getElementById('scan-btn');
    // ãƒãƒˆãƒ«ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
    document.getElementById('atk-btn').disabled = true;
    document.getElementById('magic-btn').disabled = true;

    if (isVictory) {
        exp += eExp;
        if (exp >= lv * 100) {
            lv++;
            exp = 0;
            pMax += 200;
            php = pMax;
            skillPoints++;
            log(`ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ï¼ Lv.${lv} SPã‚’1ç²å¾—ï¼`);

            // ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—æ™‚ã¯ã€ŒMENU OPENING...ã€ã«ã—ã¦ãƒœã‚¿ãƒ³ã‚’å›ºã‚ã‚‹
            scanBtn.disabled = true; 
            scanBtn.innerText = "MENU OPENING...";

            setTimeout(() => {
                openMagic();
                scanBtn.disabled = false;
                scanBtn.innerText = "WEAPON SCAN";
                updateUI(); 
            }, 1500);
            return; // ã“ã“ã¯é–¢æ•°ã®å†…å´ãªã®ã§æ­£ã—ãå‹•ä½œã—ã¾ã™
        }
    }

    // ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ã—ãªã‹ã£ãŸå ´åˆã€ã¾ãŸã¯å‹åˆ©ã—ãªã‹ã£ãŸå ´åˆã®å…±é€šå‡¦ç†
    scanBtn.disabled = false;
    scanBtn.innerText = "WEAPON SCAN";
    updateUI();
}
// --- é­”æ³•ã‚·ã‚¹ãƒ†ãƒ é–¢æ•° ---

function openMagic() {
    if (mode === "B" && magicUsedInBattle) {
        log("ã“ã®æˆ¦é—˜ã§ã¯ã™ã§ã«é­”æ³•ã‚’ä½¿ç”¨ã—ã¾ã—ãŸã€‚");
        return;
    }
    mode = "I"; // ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ
    document.getElementById('magic-overlay').classList.remove('hidden');
    renderMagicList();
    updateUI();
}

function closeMagic() {
    // 1. IDã‚’ magic-overlay ã«ä¿®æ­£
    const overlay = document.getElementById('magic-overlay');
    if (overlay) {
        overlay.classList.add('hidden'); // style.display ã§ã¯ãªã class ã§åˆ¶å¾¡
    }

    // 2. ãƒ¢ãƒ¼ãƒ‰ã‚’æˆ»ã™ (ãƒãƒˆãƒ«ä¸­ãªã‚‰Bã€æ¢ç´¢ä¸­ãªã‚‰W)
    if (ehp > 0) {
        mode = "B";
    } else {
        mode = "W";
    }

    // 3. ã‚«ãƒ¡ãƒ©ã®å†é–‹
    const video = document.getElementById('webcam');
    if (video) {
        video.play().catch(err => console.warn("Camera resume failed:", err));
    }
    updateUI();
}

function renderMagicList() {
    const listDiv = document.getElementById('magic-list');
    const spCount = document.getElementById('sp-count');
    spCount.innerText = skillPoints;
    
    let html = '';
    
    for (const key in MAGIC_DATA) {
        const data = MAGIC_DATA[key];
        const currentLv = magicLevels[key];
        const nextLv = currentLv + 1;
        const cost = nextLv; // å¿…è¦ãªSPã¯æ¬¡ã®ãƒ¬ãƒ™ãƒ«ã®æ•°
        const isMax = currentLv >= 5;
        const canUpgrade = !isMax && skillPoints >= cost;

        // é­”æ³•ã®ä½¿ç”¨ãƒœã‚¿ãƒ³
        let actionBtn;
        if (mode === "B" && currentLv > 0) {
            actionBtn = `<button onclick="useMagic('${key}')" style="background:#004400; width: 45%;">ä½¿ç”¨</button>`;
        } else if (mode === "B" && currentLv === 0) {
            actionBtn = `<button disabled style="background:#333; width: 45%;">æœªç¿’å¾—</button>`;
        } else {
            actionBtn = '';
        }

        // å¼·åŒ–ãƒœã‚¿ãƒ³
        let upgradeBtn;
        if (isMax) {
            upgradeBtn = `<button disabled style="background:#555; width: 45%;">MAX</button>`;
        } else if (canUpgrade) {
            upgradeBtn = `<button onclick="upgradeMagic('${key}', ${cost})" style="background:#440044; width: 45%;">å¼·åŒ– (${cost}SP)</button>`;
        } else {
            upgradeBtn = `<button disabled style="background:#333; width: 45%;">å¼·åŒ– (${cost}SP)</button>`;
        }

        html += `
            <div style="background:#222; margin-bottom: 5px; padding: 10px; border-left: 5px solid ${currentLv > 0 ? '#0f0' : '#888'}; display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <strong>${data.name}</strong> [Lv.${currentLv}]<br>
                    <small>Type: ${data.type}</small>
                </div>
                <div style="display: flex; gap: 5px;">
                    ${actionBtn}
                    ${upgradeBtn}
                </div>
            </div>
        `;
    }
    listDiv.innerHTML = html;
}

function upgradeMagic(key, cost) {
    if (skillPoints >= cost) {
        skillPoints -= cost;
        magicLevels[key]++;
        log(`${MAGIC_DATA[key].name}ãŒLv.${magicLevels[key]}ã«ã‚¢ãƒƒãƒ—ã—ã¾ã—ãŸï¼`);
        renderMagicList(); // ãƒªã‚¹ãƒˆã‚’å†æç”»
        updateUI();
    }
}

function useMagic(key) {
    if (mode !== "B" || magicUsedInBattle) return;

    magicUsedInBattle = true; // 1æˆ¦é—˜1å›ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹
    const lv = magicLevels[key];
    const data = MAGIC_DATA[key];

    log(`${data.name} (Lv.${lv}) ã‚’ä½¿ç”¨ï¼`);
    
    // HEAL, ATTACK, BUFF/DEBUFF ã®åŠ¹æœã‚’å‡¦ç†
    if (data.type === "Heal") {
        const healPercent = 0.15 * lv; // 15% * Lv
        const healAmount = Math.floor(pMax * healPercent);
        php = Math.min(pMax, php + healAmount);
        log(`${healAmount}å›å¾©ã—ã¾ã—ãŸï¼`);

    } else if (data.type === "Attack") {
        const damagePercent = 0.10 * lv; // 10% * Lv
        const mod = getElementModifier(data.elem, enemyElement);
        let dmg = 0;
        
        if (mod === 0.5) { // ä¸åˆ©å±æ€§ (æ•µã®å›å¾©)
            const healAmount = Math.floor(eMax * damagePercent);
            ehp = Math.min(eMax, ehp + healAmount);
            log(`ç›¸æ€§ãŒæ‚ªãã€æ•µã®HPã‚’ ${healAmount} å›å¾©ã•ã›ã¦ã—ã¾ã£ãŸ...`);
        } else if (mod === 1.5) { // æœ‰åˆ©å±æ€§ (ãƒ€ãƒ¡ãƒ¼ã‚¸1.5å€)
            dmg = Math.floor(eMax * damagePercent * 1.5);
            ehp = Math.max(0, ehp - dmg);
            log(`åŠ¹æœçµ¶å¤§ï¼ ${dmg}ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’ä¸ãˆãŸï¼`);
        } else if (mod === 1.0) { // ç­‰å€/åŒå±æ€§ (åŒå±æ€§ã¯getElementModifierã§1.0ã‚’è¿”ã™æƒ³å®š)
            dmg = Math.floor(eMax * damagePercent);
            if (data.elem === enemyElement) { // åŒå±æ€§ã¯åŠ¹æœãªã—
                log(`åŒå±æ€§ã®ãŸã‚ã€åŠ¹æœãªã—ï¼`);
            } else {
                ehp = Math.max(0, ehp - dmg);
                log(`${dmg}ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’ä¸ãˆãŸï¼`);
            }
        }

    } else if (data.type === "Buff") {
        const bonus = 1 + (0.10 * lv); // 1.1å€ ã€œ 1.5å€
        if (key === "BRAV") {
            pAtkBonus = bonus;
            log(`ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ”»æ’ƒåŠ›ãŒ ${((bonus - 1) * 100).toFixed(0)}% ä¸Šæ˜‡ï¼`);
        } else if (key === "SELD") {
            pDefBonus = bonus;
            log(`ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®é˜²å¾¡åŠ›ãŒ ${((bonus - 1) * 100).toFixed(0)}% ä¸Šæ˜‡ï¼`);
        }
    } else if (data.type === "Debuff") {
        const penalty = 1 - (0.10 * lv); // 0.9å€ ã€œ 0.5å€
        if (key === "WEEK") {
            // æ•µã®æ”»æ’ƒåŠ›ã«é©ç”¨ã™ã‚‹ãŸã‚ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ”»æ’ƒåŠ›å€ç‡å¤‰æ•°ã‚’ä½¿ç”¨
            pAtkBonus = penalty; 
            log(`æ•µã®æ”»æ’ƒåŠ›ãŒ ${((1 - penalty) * 100).toFixed(0)}% ä¸‹é™ï¼`);
        } else if (key === "BRAK") {
            // æ•µã®é˜²å¾¡åŠ›ã«é©ç”¨ã™ã‚‹ãŸã‚ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®é˜²å¾¡åŠ›å€ç‡å¤‰æ•°ã‚’ä½¿ç”¨
            pDefBonus = penalty; 
            log(`æ•µã®é˜²å¾¡åŠ›ãŒ ${((1 - penalty) * 100).toFixed(0)}% ä¸‹é™ï¼`);
        }
    }

    closeMagic();
    // æ•µã®ã‚¿ãƒ¼ãƒ³ã«é€²ã‚€
    if (ehp > 0) {
        setTimeout(enemyTurnAfterMagic, 600);
    } else {
        // æ”»æ’ƒé­”æ³•ã§å€’ã—ãŸå ´åˆã®å‡¦ç†ï¼ˆhandleAttackã®å‹åˆ©å‡¦ç†ã‚’ã‚³ãƒ”ãƒ¼ï¼‰
        log(`${enemyName}ã‚’å€’ã—ãŸï¼`);
        resetBattleState(true);
    }
    updateUI();
}
    function getElementModifier(a, d) {
    if (!a || !d) return 1.0;
    if (ELEMENTS[a].strongTo === d) return 1.5;
    if (ELEMENTS[d].strongTo === a) return 0.5;
    return 1.0;
}

function updateUI() {
    // --- æ•µæƒ…å ±ã®æ›´æ–° ---
    document.getElementById('e-name').innerText = "E:" + (enemyName || "------");
    document.getElementById('e-atk').innerText = eAtk;
    document.getElementById('e-elem').innerText = enemyElement ? ELEMENTS[enemyElement].icon : "-";
    document.getElementById('e-hp-text').innerText = `HP:${ehp}/${eMax}`;
    const ePercent = eMax > 0 ? (ehp / eMax) * 100 : 0;
    document.getElementById('e-hp-bar').style.width = ePercent + "%";

    // --- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ±ã®æ›´æ–° ---
    document.getElementById('p-lv').innerText = lv;
    document.getElementById('p-atk').innerText = pAtk;
    // æ­¦å™¨åã®æ›´æ–°ã‚’è¿½åŠ 
    document.getElementById('p-weapon').innerText = weaponName; 
    document.getElementById('p-elem').innerText = playerElement ? ELEMENTS[playerElement].icon : "-";
    document.getElementById('p-hp-text').innerText = `HP:${php}/${pMax}`;
    const pPercent = pMax > 0 ? (php / pMax) * 100 : 0;
    document.getElementById('p-hp-bar').style.width = pPercent + "%";

    // çµŒé¨“å€¤ãƒãƒ¼ï¼ˆã‚‚ã—ã‚ã‚Œã°ï¼‰
    const expBar = document.getElementById('p-exp-bar');
    if (expBar) {
        const expPercent = (exp / (lv * 100)) * 100;
        expBar.style.width = Math.min(100, expPercent) + "%";
    }
}

function log(m) {
    // ç”»é¢ä¸‹éƒ¨ã«ã€Œmsgã€ã¨ã„ã†IDãŒãªããªã£ãŸå ´åˆã¯ã€ã“ã“ã‚’å‰Šé™¤ã¾ãŸã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ
    // const msgElem = document.getElementById('msg');
    // if (msgElem) msgElem.innerText = m;

    const logArea = document.getElementById('log-display');
    if (logArea) {
        const line = document.createElement('div');
        line.style.borderBottom = "1px dotted #030";
        line.innerHTML = `> ${m.replace(/\n/g, '<br>')}`;
        logArea.appendChild(line);
        logArea.scrollTop = logArea.scrollHeight;
    }
}
function applyShake() { document.body.classList.add('shake'); setTimeout(() => document.body.classList.remove('shake'), 200); }
 // --- å›³é‘‘ã‚·ã‚¹ãƒ†ãƒ ç”¨å¤‰æ•° (å¤‰æ•°ã®é›†ã¾ã£ã¦ã„ã‚‹å ´æ‰€ã¸) ---


// --- å›³é‘‘ã‚·ã‚¹ãƒ†ãƒ é–¢æ•° (é–¢æ•°ã®é›†ã¾ã£ã¦ã„ã‚‹å ´æ‰€ã¸) ---
function addToLibrary(type, item) {
    // libraryãŒæœªå®šç¾©ãªã‚‰ãã®å ´ã§ä½œæˆ
    if (typeof library === 'undefined' || !library) {
        library = { weapons: [], monsters: [] };
    }
    const list = library[type];
    if (!list) return;

    if (!list.some(i => i.name === item.name)) {
        list.push(item);
        log(`[${item.name}]ã‚’å›³é‘‘ã«ç™»éŒ²ï¼`);
    }
}

function openLibrary() {
    mode = "I"; // ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ãƒ¢ãƒ¼ãƒ‰
    document.getElementById('library-overlay').classList.remove('hidden');
    changeLibraryTab('weapons'); 
    updateUI();
}

function closeLibrary() {
    document.getElementById('library-overlay').classList.add('hidden');
    // çŠ¶æ…‹ã«å¿œã˜ã¦ãƒ¢ãƒ¼ãƒ‰ã‚’æˆ»ã™
    if (ehp > 0) mode = "B";
    else if (pAtk > 0) mode = "E";
    else mode = "W";
    updateUI();
}

function changeLibraryTab(tab) {
    const contentDiv = document.getElementById('library-content');
    let html = '';

    document.getElementById('lib-tab-weapons').style.background = (tab === 'weapons' ? '#004400' : '#002200');
    document.getElementById('lib-tab-monsters').style.background = (tab === 'monsters' ? '#004400' : '#002200');

    if (tab === 'weapons') {
        library.weapons.forEach(w => {
            html += `<div style="margin-bottom:8px; border-bottom:1px dashed #333; padding:5px;">
                        <strong>${w.name}</strong> [${w.rarity}]<br>ATK:${w.atk} DEF:${w.def}</div>`;
        });
        if (library.weapons.length === 0) html = '<p>æ­¦å™¨ãƒ‡ãƒ¼ã‚¿ãªã—</p>';
    } else {
        library.monsters.forEach(m => {
            const icon = ELEMENTS[m.elem]?.icon || "";
            html += `<div style="margin-bottom:8px; border-bottom:1px dashed #333; padding:5px;">
                        <strong>${icon}${m.name}</strong> [${m.rarity}]<br>HP:${m.hp} ATK:${m.atk}</div>`;
        });
        if (library.monsters.length === 0) html = '<p>ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ãªã—</p>';
    }
    contentDiv.innerHTML = html;
}// --- è¨ºæ–­ç”¨ï¼šã“ã‚ŒãŒå‹•ã‘ã°ã‚¹ã‚¯ãƒªãƒ—ãƒˆè‡ªä½“ã¯èª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã™ ---
    console.log("ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®æœ€å¾Œã¾ã§èª­ã¿è¾¼ã¿å®Œäº†");
    alert("ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã¯æœ€å¾Œã¾ã§èª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸï¼");
// --- æœ€çµ‚èµ·å‹•ãƒ—ãƒ­ã‚»ã‚¹ ---

// â˜…ã“ã“ã« initWebcam ã‚’è²¼ã‚Šä»˜ã‘
async function initWebcam() {
    const video = document.getElementById('webcam');
    const initMsg = document.getElementById('init-msg');
    
    try {
        const stream = await navigator.mediaDevices.getUserMedia({
            video: { 
                facingMode: "environment", // å¤–ã‚«ãƒ¡ãƒ©ã‚’å„ªå…ˆ
                width: { ideal: 640 },
                height: { ideal: 480 }
            },
            audio: false
        });
        video.srcObject = stream;
        initMsg.innerText = "CAMERA CONNECTED.";
        
        // AIã®ãƒ­ãƒ¼ãƒ‰ã‚’ç¢ºèª
        if (typeof net === 'undefined') {
            initMsg.innerText = "LOADING AI...";
            net = await mobilenet.load();
        }
        
        // æº–å‚™ãŒã§ããŸã‚‰ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
        document.getElementById('start-btn').classList.remove('hidden');
        initMsg.innerText = "SYSTEM READY.";
    } catch (err) {
        console.error(err);
        initMsg.innerText = "CAMERA ERROR: " + err.name;
    }
}

async function bootGame() {
    const msgElem = document.getElementById('init-msg');
    const startBtn = document.getElementById('start-btn');

    try {
        if (msgElem) msgElem.innerText = "LOADING AI MODELS...";
        
        // MobileNetã®èª­ã¿è¾¼ã¿
        net = await mobilenet.load();
        
        if (msgElem) {
            msgElem.innerText = "AI READY";
            msgElem.style.color = "#0f0";
        }

        // ã‚«ãƒ¡ãƒ©ã‚’ã“ã®æ™‚ç‚¹ã§èµ·å‹•ã—ã¦ãŠã
        await initWebcam();

        if (startBtn) {
            startBtn.classList.remove('hidden');
            startBtn.disabled = false;
        }
    } catch (e) {
        console.error("bootGame Error:", e);
        if (msgElem) msgElem.innerText = "ERROR: " + e.message;
    }
}

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å®Ÿè¡Œ
window.addEventListener('load', bootGame);
</script>
</body>
</html>
