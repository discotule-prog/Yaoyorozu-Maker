<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MYTH SCANNER GEN2</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet"></script>
    <link href="https://fonts.googleapis.com/css2?family=DotGothic16&display=swap" rel="stylesheet">
    <style>
        :root { --p-color: #00f2ff; --e-color: #ff3c00; }
        body { font-family: 'DotGothic16', sans-serif; background: #000; color: #fff; margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        #header { height: 35px; background: #222; display: flex; justify-content: space-around; align-items: center; font-size: 0.8rem; border-bottom: 2px solid #444; }

        .char-area { height: 38%; display: flex; border-bottom: 1px solid #333; padding: 5px; box-sizing: border-box; }
        
        /* Â∑¶Ôºö„Ç´„É°„É©ÔºàÂøÖË¶Å„Å™ÊôÇ„Å†„ÅëË°®Á§∫Ôºâ */
        .cam-part { width: 45%; display: flex; align-items: center; justify-content: center; position: relative; }
        .cam-frame { width: 120px; height: 120px; border: 2px solid #555; background: #111; position: relative; overflow: hidden; }
        video { width: 100%; height: 100%; object-fit: cover; display: none; }
        .cam-active video { display: block; border-color: #0f0; }

        /* Âè≥ÔºöÁîüÊàê„Åï„Çå„Åü„Ç§„É©„Çπ„Éà„Å®„Çπ„ÉÜ„Éº„Çø„Çπ */
        .info-part { width: 55%; display: flex; flex-direction: column; padding-left: 10px; justify-content: space-between; }
        
        /* „Ç§„É©„Çπ„ÉàÁîüÊàê„Ç®„É™„Ç¢ */
        .visual-card { 
            width: 100%; height: 90px; border: 2px solid #fff; 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: linear-gradient(45deg, #222, #000);
            text-shadow: 2px 2px 4px #000;
            box-shadow: inset 0 0 15px rgba(255,255,255,0.2);
            position: relative; overflow: hidden;
        }
        .visual-card .rarity-tag { position: absolute; top: 0; right: 0; font-size: 0.5rem; padding: 2px 5px; background: #fff; color: #000; }
        .visual-card .symbol { font-size: 3rem; z-index: 2; }

        .stat-label { font-size: 0.75rem; color: #ccc; margin-top: 5px; }
        .hp-bar-bg { width: 100%; height: 10px; background: #333; border: 1px solid #fff; margin-top: 4px; }
        .hp-bar-fill { height: 100%; transition: width 0.3s; }

        /* ‰∏≠Â§Æ„Ç≥„Éû„É≥„Éâ„Ç®„É™„Ç¢ */
        #mid-ui { height: 90px; background: #111; border-top: 2px solid #444; border-bottom: 2px solid #444; display: flex; flex-direction: column; align-items: center; padding: 5px; }
        #msg { font-size: 0.75rem; color: #0f0; height: 25px; text-align: center; }
        .btn-row { display: flex; gap: 5px; width: 100%; flex: 1; }
        button { flex: 1; font-family: 'DotGothic16'; border: 2px solid #fff; color: #fff; background: #444; font-size: 0.8rem; }
        button:active { transform: scale(0.95); }

        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 100; display: none; flex-direction: column; align-items: center; padding: 20px; box-sizing: border-box; }
        .shake { animation: s 0.2s; }
        @keyframes s { 0%,100% {transform:translateX(0)} 25% {transform:translateX(5px)} 75% {transform:translateX(-5px)} }
    </style>
</head>
<body>

<div id="header">
    <span>LV: <b id="p-lv">1</b> HP+: <b id="hp-bonus">0</b>%</span>
    <button onclick="showColl()" style="font-size:0.6rem; height:20px;">LIBRARY</button>
</div>

<div class="char-area" id="p-area">
    <div class="cam-part" id="p-cam-box"><div class="cam-frame"><video id="pv" autoplay playsinline muted></video></div></div>
    <div class="info-part">
        <div id="p-card" class="visual-card">
            <div id="p-rarity" class="rarity-tag">WAITING</div>
            <div id="p-symbol" class="symbol">‚ùî</div>
            <div id="p-name-disp" style="font-size:0.7rem;">READY TO SCAN</div>
        </div>
        <div class="stat-label">HP: <span id="p-hp-cur">1000</span>/<span id="p-hp-max">1000</span> ATK: <span id="p-atk">0</span></div>
        <div class="hp-bar-bg"><div id="p-fill" class="hp-bar-fill" style="background:var(--p-color); width:100%"></div></div>
    </div>
</div>

<div id="mid-ui">
    <div id="msg">„ÄåSCAN„Äç„ÇíÊäº„Åó„Å¶Ê≠¶Âô®„ÇíË™≠„ÅøÂèñ„Çå</div>
    <div class="btn-row">
        <button id="scan-btn" onclick="handleScan()" style="background:#0044cc;">SCAN</button>
        <button id="atk-btn" onclick="handleAttack()" disabled style="background:#aa0000;">ATTACK</button>
        <button id="heal-btn" onclick="handleHeal()" disabled style="background:#008844;">HEAL (<span id="h-cnt">2</span>)</button>
    </div>
</div>

<div class="char-area" id="e-area">
    <div class="cam-part" id="e-cam-box"><div class="cam-frame"><video id="ev" autoplay playsinline muted></video></div></div>
    <div class="info-part">
        <div id="e-card" class="visual-card">
            <div id="e-rarity" class="rarity-tag">UNKNOWN</div>
            <div id="e-symbol" class="symbol">‚ùî</div>
            <div id="e-name-disp" style="font-size:0.7rem;">???</div>
        </div>
        <div class="stat-label">HP: <span id="e-hp-cur">1000</span>/<span id="e-hp-max">1000</span> ATK: <span id="e-atk">0</span></div>
        <div class="hp-bar-bg"><div id="e-fill" class="hp-bar-fill" style="background:var(--e-color); width:100%"></div></div>
    </div>
</div>

<div id="res-screen" class="overlay" style="justify-content:center;">
    <h1 id="res-title"></h1>
    <p id="res-msg"></p>
    <button onclick="nextCycle()" style="width:200px; height:50px; background:#0044cc;">NEXT SCAN</button>
</div>

<div id="coll-screen" class="overlay">
    <h2 id="lib-total" style="color:yellow;">LIBRARY</h2>
    <div id="w-coll" style="width:100%; overflow-y:auto; flex:1; font-size:0.7rem; border:1px solid #444; padding:5px; margin-bottom:5px;"></div>
    <div id="m-coll" style="width:100%; overflow-y:auto; flex:1; font-size:0.7rem; border:1px solid #444; padding:5px;"></div>
    <button onclick="document.getElementById('coll-screen').style.display='none'" style="margin-top:10px;">CLOSE</button>
</div>

<script>
    let net, mode = "W", lv = 1, exp = 0, nextExp = 100, hpBonus = 0;
    let php = 1000, pMax = 1000, ehp = 1000, eMax = 1000;
    let patk=0, pdef=0, eatk=0, edef=0, heals = 2, stream = null;
    let collection = JSON.parse(localStorage.getItem('myth_v_gen2')) || { weapons: {}, monsters: {} };

    const db = {
        W: [
            {n:"„Éñ„É¨„Éº„Éâ", i:"üó°Ô∏è", c:"#555"}, {n:"„Ç¢„ÉÉ„ÇØ„Çπ", i:"ü™ì", c:"#743"}, {n:"„É©„É≥„Çπ", i:"üî±", c:"#357"},
            {n:"„É≠„ÉÉ„Éâ", i:"ü™Ñ", c:"#737"}, {n:"„Éú„Ç¶", i:"üèπ", c:"#463"}, {n:"„Ç∑„Éº„É´„Éâ", i:"üõ°Ô∏è", c:"#444"}
        ],
        M: [
            {n:"„Çπ„É©„Ç§„É†", i:"üíß", c:"#05f"}, {n:"„Éì„Éº„Çπ„Éà", i:"üêæ", c:"#840"}, {n:"„Éê„Éº„Éâ", i:"ü¶Ö", c:"#488"},
            {n:"„Çπ„Ç±„É´„Éà„É≥", i:"üíÄ", c:"#eee"}, {n:"„Éâ„É©„Ç¥„É≥", i:"üêâ", c:"#f00"}, {n:"„Ç¥„Éº„É¨„É†", i:"üß±", c:"#654"}
        ],
        R: ["COMMON", "RARE", "SUPER", "MYTHIC"]
    };

    async function init() {
        net = await mobilenet.load();
        document.getElementById('msg').innerText = "Ê∫ñÂÇôÂÆå‰∫Ü„ÄÇÊ≠¶Âô®„ÇíSCAN„Åõ„Çà";
        switchCamera('P');
    }

    async function switchCamera(target) {
        if(stream) stream.getTracks().forEach(t => t.stop());
        const boxP = document.getElementById('p-cam-box');
        const boxE = document.getElementById('e-cam-box');
        boxP.classList.remove('cam-active'); boxE.classList.remove('cam-active');

        try {
            stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
            const vid = target === 'P' ? document.getElementById('pv') : document.getElementById('ev');
            vid.srcObject = stream;
            (target === 'P' ? boxP : boxE).classList.add('cam-active');
        } catch(e) { console.error("Camera Error"); }
    }

    async function handleScan() {
        const vid = mode === "W" ? document.getElementById('pv') : document.getElementById('ev');
        const r = await net.classify(vid);
        
        // ‰π±Êï∞„Ç∑„Éº„ÉâÔºöË™çË≠òÂêç + ÊôÇÂàª + Ë™çË≠ò„Çπ„Ç≥„Ç¢„ÇíÊ∑∑„Åú„Å¶„Äå„Ç¢„Ç§„Ç¢„É≥„ÇΩ„Éº„ÉâÂõ∫ÂÆö„Äç„ÇíÈò≤„Åê
        const seed = Math.floor((r[0].className.length * Date.now() * r[0].probability) % 1000);
        const rarityIdx = seed % 100 < 70 ? 0 : seed % 100 < 90 ? 1 : seed % 100 < 98 ? 2 : 3;
        const typeIdx = seed % db[mode].length;
        const base = db[mode][typeIdx];
        const rarity = db.R[rarityIdx];

        if (mode === "W") {
            patk = (rarityIdx + 1) * 100 + (seed % 50) + (lv * 15);
            pdef = (rarityIdx + 1) * 50 + (lv * 5);
            php = Math.min(pMax, php + Math.floor(pMax * 0.8));
            
            updateCard('p', rarity, base.i, `${rarity} ${base.n}`, base.c);
            collection.weapons[seed] = {no:seed, n:`${rarity} ${base.n}`, i:base.i};
            localStorage.setItem('myth_v_gen2', JSON.stringify(collection));
            
            mode = "M";
            document.getElementById('msg').innerText = "Ê≠¶Âô®„ÇíË£ÖÂÇôÔºÅ Êïµ„ÇíSCAN„Åõ„Çà";
            switchCamera('E');
        } else {
            eMax = 800 + (rarityIdx * 500) + (lv * 150) + (seed % 100);
            ehp = eMax;
            eatk = (rarityIdx + 1) * 90 + (lv * 12);
            edef = (rarityIdx + 1) * 40;

            updateCard('e', rarity, base.i, `${rarity} ${base.n}`, base.c);
            this.currentM = {no:seed, n:`${rarity} ${base.n}`, i:base.i};
            
            document.getElementById('atk-btn').disabled = false;
            document.getElementById('heal-btn').disabled = false;
            document.getElementById('scan-btn').disabled = true;
            document.getElementById('msg').innerText = "Êà¶ÈóòÈñãÂßãÔºÅ „Ç≥„Éû„É≥„Éâ„ÇíÈÅ∏„Åπ";
        }
        updateUI();
    }

    function updateCard(side, rarity, symbol, name, color) {
        const card = document.getElementById(`${side}-card`);
        card.style.background = `radial-gradient(circle, ${color}cc, #000)`;
        card.style.borderColor = rarity === "MYTHIC" ? "gold" : rarity === "SUPER" ? "silver" : "#fff";
        document.getElementById(`${side}-rarity`).innerText = rarity;
        document.getElementById(`${side}-symbol`).innerText = symbol;
        document.getElementById(`${side}-name-disp`).innerText = name;
    }

    function handleAttack() {
        document.getElementById('e-area').classList.add('shake');
        let d = Math.max(30, patk - Math.floor(edef/2));
        ehp -= d;
        setTimeout(() => {
            document.getElementById('e-area').classList.remove('shake');
            if(ehp <= 0) return finish(true);
            enemyTurn();
        }, 400);
        updateUI();
    }

    function handleHeal() {
        if(heals > 0) {
            php = Math.min(pMax, php + Math.floor(pMax * 0.3));
            heals--; document.getElementById('h-cnt').innerText = heals;
            updateUI(); enemyTurn();
        }
    }

    function enemyTurn() {
        document.getElementById('p-area').classList.add('shake');
        php -= Math.max(20, eatk - Math.floor(pdef/2));
        updateUI();
        setTimeout(() => {
            document.getElementById('p-area').classList.remove('shake');
            if(php <= 0) finish(false);
        }, 200);
    }

    function finish(win) {
        document.getElementById('res-screen').style.display = "flex";
        if(win) {
            document.getElementById('res-title').innerText = "VICTORY!";
            exp += 50;
            if(exp >= nextExp) {
                lv++; exp=0; nextExp+=50; hpBonus += 10;
                pMax = Math.floor(pMax * 1.1); php = pMax;
            }
            collection.monsters[this.currentM.no] = this.currentM;
            localStorage.setItem('myth_v_gen2', JSON.stringify(collection));
            document.getElementById('res-msg').innerText = `„É¨„Éô„É´„Ç¢„ÉÉ„ÉóÔºÅHPÊúÄÂ§ßÂÄ§„Åå10%‰∏äÊòáÔºÅ\n(Á¥ØË®à„Éú„Éº„Éä„Çπ: ${hpBonus}%)`;
        } else {
            document.getElementById('res-title').innerText = "DEFEAT...";
            lv = Math.max(1, lv - 5);
            hpBonus = (lv - 1) * 10;
            pMax = Math.floor(1000 * Math.pow(1.1, lv-1));
            php = pMax;
            document.getElementById('res-msg').innerText = "ÊïóÂåó„ÄÇ„É¨„Éô„É´„Å´Âøú„Åò„ÅüÊúÄÂ§ßHP„Å´„É™„Çª„ÉÉ„Éà„Åï„Çå„Åæ„Åó„Åü„ÄÇ";
        }
        updateUI();
    }

    function nextCycle() {
        mode = "W"; heals = 2;
        document.getElementById('h-cnt').innerText = heals;
        document.getElementById('atk-btn').disabled = true;
        document.getElementById('heal-btn').disabled = true;
        document.getElementById('scan-btn').disabled = false;
        document.getElementById('res-screen').style.display = "none";
        document.getElementById('p-symbol').innerText = "‚ùî";
        document.getElementById('e-symbol').innerText = "‚ùî";
        switchCamera('P');
        updateUI();
    }

    function updateUI() {
        document.getElementById('p-fill').style.width = (php / pMax * 100) + "%";
        document.getElementById('e-fill').style.width = (ehp / eMax * 100) + "%";
        document.getElementById('p-hp-cur').innerText = Math.max(0, php);
        document.getElementById('p-hp-max').innerText = pMax;
        document.getElementById('e-hp-cur').innerText = Math.max(0, ehp);
        document.getElementById('e-hp-max').innerText = eMax;
        document.getElementById('p-lv').innerText = lv;
        document.getElementById('hp-bonus').innerText = hpBonus;
    }

    function showColl() {
        const wC = Object.keys(collection.weapons).length;
        const mC = Object.keys(collection.monsters).length;
        document.getElementById('lib-total').innerText = `LIB: W ${wC}/100 M ${mC}/100`;
        const render = (box, data) => {
            box.innerHTML = "";
            Object.values(data).sort((a,b)=>a.no-b.no).forEach(v => {
                box.innerHTML += `No.${v.no % 100} ${v.i} ${v.n}<br>`;
            });
        };
        render(document.getElementById('w-coll'), collection.weapons);
        render(document.getElementById('m-coll'), collection.monsters);
        document.getElementById('coll-screen').style.display = "flex";
    }

    init();
</script>
</body>
</html>
