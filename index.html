<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MYTH SCANNER 4.36 - MAGIC DEFINITION</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet"></script>
    <link href="https://fonts.googleapis.com/css2?family=DotGothic16&display=swap" rel="stylesheet">
    <style>
        :root { --p-color: #00f2ff; --e-color: #ff3c00; --magic-p: #a200ff; }
        body { font-family: 'DotGothic16', sans-serif; background: #000; color: #fff; margin: 0; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }
        .char-area { height: 32%; display: flex; border-bottom: 1px solid #333; padding: 10px; box-sizing: border-box; }
        .cam-frame { width: 90px; height: 90px; border: 2px solid #333; background: #111; overflow: hidden; position: relative; border-radius: 8px; }
        video { width: 100%; height: 100%; object-fit: cover; display: none; }
        .cam-active { border: 2px solid #0f0; box-shadow: 0 0 10px #0f0; }
        .cam-active video { display: block; }
        .info-part { flex-grow: 1; padding-left: 10px; display: flex; flex-direction: column; justify-content: center; }
        .visual-card { width: 100%; height: 80px; border: 2px solid #fff; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #111; position: relative; }
        .bar-bg { width: 100%; height: 10px; background: #222; border: 1px solid #666; margin-top: 5px; }
        .bar-fill { height: 100%; width: 0%; transition: width 0.3s; }
        #mid-ui { flex-grow: 1; background: #111; border-top: 2px solid #444; display: flex; flex-direction: column; align-items: center; padding: 5px; }
        #msg { font-size: 0.8rem; color: #0f0; height: 45px; text-align: center; display: flex; align-items: center; }
        .btn-row { display: flex; gap: 5px; width: 95%; margin-bottom: 5px; }
        button { flex: 1; height: 40px; font-family: 'DotGothic16'; background: #444; color: #fff; border: 2px solid #fff; cursor: pointer; }
        button:disabled { opacity: 0.3; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 100; display: none; flex-direction: column; align-items: center; padding: 20px; box-sizing: border-box; }
        .magic-option { width: 100%; height: 50px; margin-bottom: 10px; background: #333; color: #fff; border: 1px solid #fff; }
        .shake { animation: s 0.2s; }
        @keyframes s { 0%,100%{transform:translateX(0)} 50%{transform:translateX(5px)} }
    </style>
</head>
<body>

<div class="char-area" id="p-area">
    <div class="cam-frame" id="pf"><video id="pv" autoplay playsinline muted></video></div>
    <div class="info-part">
        <div class="visual-card">
            <div id="p-sym" style="font-size:3rem;">?</div>
            <div id="p-name" style="font-size:0.6rem; position:absolute; bottom:2px;">READY</div>
        </div>
        <div style="font-size:0.7rem; margin-top:5px;">LV:<span id="lv">1</span> HP:<span id="php">1000</span></div>
        <div class="bar-bg"><div id="p-bar" class="bar-fill" style="background:var(--p-color); width:100%;"></div></div>
        <div style="font-size:0.6rem; margin-top:2px;">EXP:<span id="exp">0</span>/100</div>
    </div>
</div>

<div id="mid-ui">
    <div id="msg">AI BOOTING...</div>
    <div class="btn-row">
        <button id="scan-btn" onclick="doScan()" style="background:#0044cc;">SCAN</button>
        <button id="atk-btn" onclick="doAtk()" disabled style="background:#880000;">ATTACK</button>
        <button id="mag-btn" onclick="showMagic()" disabled style="background:var(--magic-p);">MAGIC</button>
    </div>
</div>

<div class="char-area" id="e-area">
    <div class="cam-frame" id="ef"><video id="ev" autoplay playsinline muted></video></div>
    <div class="info-part">
        <div class="visual-card">
            <div id="e-sym" style="font-size:3rem;">?</div>
            <div id="e-name" style="font-size:0.6rem; position:absolute; bottom:2px;">???</div>
        </div>
        <div style="font-size:0.7rem; margin-top:5px;">HP:<span id="ehp">0</span> <span id="e-elem"></span></div>
        <div class="bar-bg"><div id="e-bar" class="bar-fill" style="background:var(--e-color);"></div></div>
    </div>
</div>

<div id="choice-ui" class="overlay">
    <h2 id="choice-title">ÁøíÂæóÈ≠îÊ≥ïÈÅ∏Êäû</h2>
    <div id="choice-list" style="width:100%;"></div>
</div>

<script>
    const W_DB = ["Ââ£","Êñß","Êùñ","Âºì","Êßç"];
    const M_DB = ["„Ç¥„Éñ„É™„É≥","„Ç¥„Éº„É¨„É†","„Éâ„É©„Ç¥„É≥","Ê≠ªÈúä"];
    const ELEMS = ["üî•", "üíß", "‚ö°", "üåø"];
    
    let net, mode="W", stream, busy=false;
    let plv=1, php=1000, pmx=1000, patk=0, pexp=0;
    let ehp=0, emx=0, eatk=0, eelem="";
    let magLvl = { "üî•":0, "üíß":0, "‚ö°":0, "üåø":0, "üíñ":1 };

    async function init() {
        net = await mobilenet.load();
        resetGame();
    }

    async function cam(t) {
        if(stream) stream.getTracks().forEach(s=>s.stop());
        if(t==='OFF') return;
        try {
            stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
            const id = t==='W'?'pv':'ev';
            document.getElementById(id).srcObject = stream;
            document.getElementById(t==='W'?'pf':'ef').classList.add('cam-active');
        } catch(e) { console.log("Cam Error"); }
    }

    async function doScan() {
        if(busy) return;
        busy = true;
        document.getElementById('msg').innerText = "SCANNING...";
        const v = mode==="W"?document.getElementById('pv'):document.getElementById('ev');
        const res = await net.classify(v);
        const id = Math.floor(res[0].probability * 100);

        if(mode==="W") {
            document.getElementById('p-name').innerText = res[0].className.split(',')[0].toUpperCase() + "„ÅÆ" + W_DB[id % 5];
            patk = 100 + id;
            document.getElementById('p-sym').innerText = "‚öîÔ∏è";
            mode = "M";
            document.getElementById('msg').innerText = "Ê≠¶Âô®„ÇíË£ÖÂÇô„Åó„ÅüÔºÅÊïµ„ÇíÊé¢„ÅõÔºÅ";
            await cam('OFF');
            setTimeout(()=> { cam('M'); busy=false; }, 1000);
        } else {
            document.getElementById('e-name').innerText = res[0].className.split(',')[0].toUpperCase() + "„ÅÆ" + M_DB[id % 4];
            eelem = ELEMS[id % 4];
            document.getElementById('e-elem').innerText = eelem;
            document.getElementById('e-sym').innerText = "üëæ";
            emx = 500 + (id * 10); ehp = emx; eatk = 50 + id;
            document.getElementById('msg').innerText = "ÊïµÁô∫Ë¶ãÔºÅ„Éê„Éà„É´ÈñãÂßãÔºÅ";
            document.getElementById('scan-btn').disabled = true;
            document.getElementById('atk-btn').disabled = false;
            document.getElementById('mag-btn').disabled = false;
            await cam('OFF');
            busy = false;
        }
        updateUI();
    }

    function doAtk() {
        let d = Math.floor(patk * (0.8 + Math.random()*0.4));
        applyDmg(d);
    }

    function showMagic() {
        const list = document.getElementById('choice-list');
        list.innerHTML = "";
        document.getElementById('choice-title').innerText = "MAGIC SELECT";
        for(let m in magLvl) {
            if(magLvl[m] > 0) {
                const b = document.createElement('button');
                b.className = "magic-option";
                b.innerText = `${m} Lv.${magLvl[m]}`;
                b.onclick = () => castMagic(m);
                list.appendChild(b);
            }
        }
        document.getElementById('choice-ui').style.display = 'flex';
    }

    function castMagic(m) {
        document.getElementById('choice-ui').style.display = 'none';
        let d = 200 + (magLvl[m] * 100);
        if(m === "üíñ") {
            php = Math.min(pmx, php + d);
            document.getElementById('msg').innerText = "„Éí„Éº„É´„ÅßÂõûÂæ©ÔºÅ";
            updateUI();
            setTimeout(eTurn, 800);
        } else {
            const rel = {"üî•":"üåø", "üåø":"‚ö°", "‚ö°":"üíß", "üíß":"üî•"};
            if(rel[m] === eelem) d *= 2;
            applyDmg(d);
        }
    }

    function applyDmg(d) {
        ehp -= d;
        document.getElementById('msg').innerText = d + "„ÅÆ„ÉÄ„É°„Éº„Ç∏ÔºÅ";
        document.getElementById('e-area').classList.add('shake');
        setTimeout(()=>document.getElementById('e-area').classList.remove('shake'), 200);
        if(ehp <= 0) {
            alert("ÂãùÂà©ÔºÅ");
            pexp += 50;
            if(pexp >= 100) levelUp(); else resetGame();
        } else {
            setTimeout(eTurn, 800);
        }
        updateUI();
    }

    function eTurn() {
        const d = Math.floor(eatk * (0.8 + Math.random()*0.4));
        php -= d;
        document.getElementById('p-area').classList.add('shake');
        setTimeout(()=>document.getElementById('p-area').classList.remove('shake'), 200);
        if(php <= 0) { alert("ÊïóÂåó..."); resetGame(); }
        updateUI();
    }

    function levelUp() {
        pexp = 0; plv++; pmx += 200; php = pmx;
        const list = document.getElementById('choice-list');
        list.innerHTML = "";
        document.getElementById('choice-title').innerText = "LEVEL UP! ÁøíÂæóÈ≠îÊ≥ïÈÅ∏Êäû";
        ["üî•", "üíß", "‚ö°", "üåø", "üíñ"].forEach(m => {
            const b = document.createElement('button');
            b.className = "magic-option";
            b.innerText = `${m} „ÇíÁøíÂæó„ÉªÂº∑Âåñ`;
            b.onclick = () => { magLvl[m]++; document.getElementById('choice-ui').style.display = 'none'; resetGame(); };
            list.appendChild(b);
        });
        document.getElementById('choice-ui').style.display = 'flex';
    }

    function resetGame() {
        mode = "W"; busy = false; php = pmx; ehp = 0; emx = 0;
        document.getElementById('p-name').innerText = "READY";
        document.getElementById('p-sym').innerText = "?";
        document.getElementById('e-name').innerText = "???";
        document.getElementById('e-sym').innerText = "?";
        document.getElementById('e-elem').innerText = "";
        document.getElementById('scan-btn').disabled = false;
        document.getElementById('atk-btn').disabled = true;
        document.getElementById('mag-btn').disabled = true;
        document.getElementById('msg').innerText = "Ê≠¶Âô®„Çí„Çπ„Ç≠„É£„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ";
        cam('W');
        updateUI();
    }

    function updateUI() {
        document.getElementById('lv').innerText = plv;
        document.getElementById('php').innerText = Math.max(0, Math.floor(php));
        document.getElementById('ehp').innerText = Math.max(0, Math.floor(ehp));
        document.getElementById('exp').innerText = pexp;
        document.getElementById('p-bar').style.width = (php/pmx*100) + "%";
        document.getElementById('e-bar').style.width = emx>0 ? (ehp/emx*100) + "%" : "0%";
    }

    window.onload = init;
</script>
</body>
</html>
