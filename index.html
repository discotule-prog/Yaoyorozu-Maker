<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MYTH SCANNER 4.36 - MAGIC ORIGIN</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet"></script>
    <link href="https://fonts.googleapis.com/css2?family=DotGothic16&display=swap" rel="stylesheet">
    <style>
        :root { --p-color: #00f2ff; --e-color: #ff3c00; --magic-p: #a200ff; }
        body { font-family: 'DotGothic16', sans-serif; background: #000; color: #fff; margin: 0; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }
        .char-area { height: 30%; display: flex; border-bottom: 1px solid #333; padding: 10px; box-sizing: border-box; }
        .cam-frame { width: 80px; height: 80px; border: 2px solid #333; background: #111; overflow: hidden; border-radius: 8px; }
        video { width: 100%; height: 100%; object-fit: cover; display: none; }
        .cam-active { border: 2px solid #0f0; box-shadow: 0 0 10px #0f0; }
        .cam-active video { display: block; }
        .info-part { flex-grow: 1; padding-left: 10px; display: flex; flex-direction: column; justify-content: center; }
        .bar-bg { width: 100%; height: 8px; background: #222; border: 1px solid #666; margin-top: 4px; }
        .bar-fill { height: 100%; width: 0%; transition: width 0.3s; }
        #mid-ui { flex-grow: 1; background: #111; border-top: 2px solid #444; display: flex; flex-direction: column; align-items: center; padding: 5px; }
        #msg { font-size: 0.75rem; color: #0f0; height: 40px; text-align: center; display: flex; align-items: center; }
        .btn-row { display: flex; gap: 5px; width: 95%; margin-bottom: 5px; }
        button { flex: 1; height: 38px; font-family: 'DotGothic16'; background: #444; color: #fff; border: 1px solid #fff; cursor: pointer; font-size: 0.7rem; }
        button:disabled { opacity: 0.3; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 100; display: none; flex-direction: column; align-items: center; padding: 20px; box-sizing: border-box; }
        .magic-btn { background: var(--magic-p); margin-bottom: 8px; width: 100%; }
        .shake { animation: s 0.2s; }
        @keyframes s { 0%,100%{transform:translateX(0)} 50%{transform:translateX(5px)} }
    </style>
</head>
<body>

<div class="char-area" id="p-area">
    <div class="cam-frame" id="pf"><video id="pv" autoplay playsinline muted></video></div>
    <div class="info-part">
        <div id="p-name" style="font-size:0.8rem; color:var(--p-color);">READY</div>
        <div style="font-size:0.6rem;">LV:<span id="lv">1</span> HP:<span id="php">1000</span></div>
        <div class="bar-bg"><div id="p-bar" class="bar-fill" style="background:var(--p-color); width:100%;"></div></div>
        <div style="font-size:0.5rem; margin-top:4px;">EXP:<span id="exp">0</span>/100</div>
        <div class="bar-bg" style="height:4px;"><div id="exp-bar" class="bar-fill" style="background:#0f0;"></div></div>
    </div>
</div>

<div id="mid-ui">
    <div id="msg">INITIALIZING...</div>
    <div class="btn-row">
        <button id="scan-btn" onclick="doScan()" style="background:#0044cc;">SCAN</button>
        <button id="atk-btn" onclick="doAtk()" disabled style="background:#880000;">ATTACK</button>
        <button id="mag-btn" onclick="openMagic()" disabled style="background:var(--magic-p);">MAGIC</button>
    </div>
</div>

<div class="char-area" id="e-area">
    <div class="cam-frame" id="ef"><video id="ev" autoplay playsinline muted></video></div>
    <div class="info-part">
        <div id="e-name" style="font-size:0.8rem; color:var(--e-color);">???</div>
        <div style="font-size:0.6rem;">HP:<span id="ehp">0</span> <span id="e-elem"></span></div>
        <div class="bar-bg"><div id="e-bar" class="bar-fill" style="background:var(--e-color);"></div></div>
    </div>
</div>

<div id="magic-ui" class="overlay">
    <h3 id="magic-title">MAGIC</h3>
    <div id="magic-list" style="width:100%;"></div>
    <button onclick="closeMagic()" style="margin-top:20px; width:80%;">CLOSE</button>
</div>

<script>
    const W_DB = ["å‰£","æ–§","æ–","å¼“","æ§"];
    const M_DB = ["ã‚´ãƒ–ãƒªãƒ³","ã‚´ãƒ¼ãƒ¬ãƒ ","ãƒ‰ãƒ©ã‚´ãƒ³","æ­»éœŠ"];
    const ELEMS = ["ðŸ”¥", "ðŸ’§", "âš¡", "ðŸŒ¿"];
    
    let net, mode="W", stream, busy=false;
    let plv=1, php=1000, pmx=1000, patk=0, pexp=0;
    let ehp=0, emx=0, eatk=0, eelem="";
    let magLvl = { "ðŸ”¥":0, "ðŸ’§":0, "âš¡":0, "ðŸŒ¿":0, "ðŸ’–":1 };

    async function init() {
        net = await mobilenet.load();
        resetGame();
    }

    async function cam(t) {
        if(stream) stream.getTracks().forEach(s=>s.stop());
        if(t==='OFF') return;
        try {
            stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
            const id = t==='W'?'pv':'ev';
            document.getElementById(id).srcObject = stream;
            document.getElementById(t==='W'?'pf':'ef').classList.add('cam-active');
        } catch(e) { console.log(e); }
    }

    async function doScan() {
        if(busy) return;
        busy = true;
        document.getElementById('msg').innerText = "SCANNING...";
        const vid = mode==="W"?document.getElementById('pv'):document.getElementById('ev');
        const res = await net.classify(vid);
        const id = Math.floor(res[0].probability * 100);

        if(mode==="W") {
            document.getElementById('p-name').innerText = res[0].className.split(',')[0].toUpperCase() + "ã®" + W_DB[id % 5];
            patk = 100 + id;
            mode = "M";
            document.getElementById('msg').innerText = "æ­¦å™¨ã‚’è£…å‚™ã—ãŸï¼æ•µã‚’æŽ¢ã›ï¼";
            await cam('OFF');
            setTimeout(()=> { cam('M'); busy=false; }, 1000);
        } else {
            document.getElementById('e-name').innerText = res[0].className.split(',')[0].toUpperCase() + "ã®" + M_DB[id % 4];
            eelem = ELEMS[id % 4];
            document.getElementById('e-elem').innerText = eelem;
            emx = 500 + (id * 10); ehp = emx; eatk = 50 + id;
            document.getElementById('msg').innerText = "æ•µã‚’ç™ºè¦‹ï¼";
            document.getElementById('scan-btn').disabled = true;
            document.getElementById('atk-btn').disabled = false;
            document.getElementById('mag-btn').disabled = false;
            await cam('OFF');
            busy = false;
        }
        updateUI();
    }

    function doAtk() {
        let d = Math.floor(patk * (0.8 + Math.random()*0.4));
        processDmg(d);
    }

    function openMagic() {
        const list = document.getElementById('magic-list');
        list.innerHTML = "";
        for(let m in magLvl) {
            if(magLvl[m] > 0) {
                const btn = document.createElement('button');
                btn.className = "magic-btn";
                btn.innerText = `${m} Lv.${magLvl[m]} ã‚’æ”¾ã¤`;
                btn.onclick = () => castMagic(m);
                list.appendChild(btn);
            }
        }
        document.getElementById('magic-ui').style.display = 'flex';
    }

    function castMagic(m) {
        closeMagic();
        let d = 200 + (magLvl[m] * 100);
        if(m === "ðŸ’–") {
            php = Math.min(pmx, php + d);
            document.getElementById('msg').innerText = "ãƒ’ãƒ¼ãƒ«ï¼HPå›žå¾©ï¼";
        } else {
            const rel = {"ðŸ”¥":"ðŸŒ¿", "ðŸŒ¿":"âš¡", "âš¡":"ðŸ’§", "ðŸ’§":"ðŸ”¥"};
            if(rel[m] === eelem) d *= 2;
            processDmg(d);
        }
        updateUI();
    }

    function processDmg(d) {
        ehp -= d;
        document.getElementById('msg').innerText = d + "ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼";
        document.getElementById('e-area').classList.add('shake');
        setTimeout(()=>document.getElementById('e-area').classList.remove('shake'), 200);
        if(ehp <= 0) win(); else setTimeout(eTurn, 800);
        updateUI();
    }

    function eTurn() {
        const d = Math.floor(eatk * (0.8 + Math.random()*0.4));
        php -= d;
        document.getElementById('p-area').classList.add('shake');
        setTimeout(()=>document.getElementById('p-area').classList.remove('shake'), 200);
        if(php <= 0) { alert("æ•—åŒ—..."); resetGame(); }
        updateUI();
    }

    function win() {
        pexp += 50;
        if(pexp >= 100) {
            pexp = 0; plv++; pmx += 200; php = pmx;
            showLvUp();
        } else {
            alert("å‹åˆ©ï¼"); resetGame();
        }
    }

    function showLvUp() {
        const list = document.getElementById('magic-list');
        list.innerHTML = "";
        document.getElementById('magic-title').innerText = "LEVEL UP! ç¿’å¾—é­”æ³•é¸æŠž";
        ["ðŸ”¥", "ðŸ’§", "âš¡", "ðŸŒ¿", "ðŸ’–"].forEach(m => {
            const btn = document.createElement('button');
            btn.className = "magic-btn";
            btn.innerText = `${m} ã‚’å¼·åŒ–/ç¿’å¾—`;
            btn.onclick = () => { magLvl[m]++; resetGame(); closeMagic(); };
            list.appendChild(btn);
        });
        document.getElementById('magic-ui').style.display = 'flex';
    }

    function resetGame() {
        mode = "W"; busy = false; php = pmx; ehp = 0; emx = 0;
        document.getElementById('scan-btn').disabled = false;
        document.getElementById('atk-btn').disabled = true;
        document.getElementById('mag-btn').disabled = true;
        document.getElementById('msg').innerText = "æ­¦å™¨ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ãã ã•ã„";
        cam('W'); updateUI();
    }

    function updateUI() {
        document.getElementById('lv').innerText = plv;
        document.getElementById('php').innerText = Math.max(0, Math.floor(php));
        document.getElementById('ehp').innerText = Math.max(0, Math.floor(ehp));
        document.getElementById('exp').innerText = pexp;
        document.getElementById('p-bar').style.width = (php/pmx*100) + "%";
        document.getElementById('e-bar').style.width = emx>0 ? (ehp/emx*100) + "%" : "0%";
        document.getElementById('exp-bar').style.width = pexp + "%";
    }

    function closeMagic() { document.getElementById('magic-ui').style.display='none'; }
    window.onload = init;
</script>
</body>
</html>
