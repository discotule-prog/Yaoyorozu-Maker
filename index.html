<!DOCTYPE html>
<html lang="ja">
<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
 <title>MYTH SCANNER FIXED</title>
 <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
 <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet"></script>
 <link href="https://fonts.googleapis.com/css2?family=DotGothic16&display=swap" rel="stylesheet">
 <style>
 :root { --p-color: #00f2ff; --e-color: #ff3c00; }
 body { font-family: 'DotGothic16', sans-serif; background: #000; color: #fff; margin: 0; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
 
 #header-info { height: 35px; background: #222; display: flex; justify-content: space-around; align-items: center; font-size: 0.8rem; border-bottom: 2px solid #444; }

 .area { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; border-bottom: 1px solid #333; overflow: hidden; }
 
 /* カメラ・イラスト枠 */
 .frame { width: 120px; height: 120px; border: 3px solid #fff; background: #111; position: relative; overflow: hidden; }
 
 /* カメラを動的に制御 */
 .camera-video { position: absolute; width: 100%; height: 100%; object-fit: cover; z-index: 10; }
 .camera-off .camera-video { transform: translateY(-200%); } /* スキャン後、画面外へ飛ばす */

 /* イラストレイヤー */
 .visual-overlay { position: absolute; top:0; left:0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 5rem; z-index: 5; background: #111; }

 .label { position: absolute; top: 5px; left: 5px; font-size: 0.6rem; color: #888; z-index: 20; }
 
 /* ステータス表示 */
 .status-box { text-align: center; width: 100%; z-index: 30; background: rgba(0,0,0,0.6); }
 .hp-cont { width: 80%; height: 12px; background: #333; border: 1px solid #fff; margin: 4px auto; overflow: hidden; position: relative; }
 .hp-fill { height: 100%; width: 100%; transition: width 0.3s ease; }
 .val-text { font-size: 0.8rem; color: #fff; line-height: 1.2; }

 #ui { height: 130px; background: #111; padding: 10px; border-top: 3px solid #fff; z-index: 50; }
 #msg { height: 40px; font-size: 0.85rem; color: #0f0; text-align: center; }
 .btns { display: flex; gap: 8px; height: 50px; }
 button { flex: 1; font-family: 'DotGothic16'; border: 3px solid #fff; color: #fff; font-size: 0.9rem; background: #444; }

 .overlay-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 100; display: none; flex-direction: column; align-items: center; padding: 20px; box-sizing: border-box; }
 .coll-list { background: #222; border: 1px solid #555; padding: 10px; font-size: 0.7rem; width: 90%; flex:1; overflow-y:auto; margin-bottom:10px; }
 .coll-item { display: flex; justify-content: space-between; border-bottom: 1px solid #444; }

 .shake { animation: s 0.2s; }
 @keyframes s { 0% { transform:translateX(5px) } 50% { transform:translateX(-5px) } 100% { transform:translateX(0) } }
 </style>
</head>
<body>

<div id="header-info">
 <span>LV: <b id="p-lv">1</b></span>
 <span>EXP: <b id="p-exp">0</b>/<b id="p-next">100</b></span>
</div>

<div class="area" id="p-area">
 <div class="label">PLAYER</div>
 <div class="frame" id="pf">
 <video id="pv" class="camera-video" autoplay playsinline muted></video>
 <div id="pw-icon" class="visual-overlay"></div>
 </div>
 <div class="status-box">
 <div id="p-name" style="color:yellow;">SCAN WEAPON...</div>
 <div class="val-text">HP:<span id="p-hp-cur">1000</span>/<span id="p-hp-max">1000</span><br>ATK:<span id="p-atk">0</span> DEF:<span id="p-def">0</span></div>
 <div class="hp-cont"><div id="phf" class="hp-fill" style="background:var(--p-color);"></div></div>
 </div>
</div>

<div class="area" id="e-area">
 <div class="label">ENEMY</div>
 <div class="frame" id="ef">
 <video id="ev" class="camera-video" autoplay playsinline muted></video>
 <div id="em-icon" class="visual-overlay"></div>
 </div>
 <div class="status-box">
 <div id="e-name" style="color:red;">WAITING...</div>
 <div class="val-text">HP:<span id="e-hp-cur">1000</span>/<span id="e-hp-max">1000</span><br>ATK:<span id="e-atk">0</span> DEF:<span id="e-def">0</span></div>
 <div class="hp-cont"><div id="ehf" class="hp-fill" style="background:var(--e-color);"></div></div>
 </div>
</div>

<div id="ui">
 <div id="msg">武器をスキャンしてください</div>
 <div class="btns">
 <button id="scan-btn" onclick="handleScan()" style="background:#0044cc;">SCAN</button>
 <button id="atk-btn" disabled onclick="handleAttack()" style="background:#aa0000;">ATTACK!</button>
 <button onclick="showColl()" style="background:#444;">LIBRARY</button>
 </div>
</div>

<div id="result-screen" class="overlay-screen" style="justify-content:center;">
 <div id="result-title" style="font-size:3rem; font-weight:bold;"></div>
 <div id="result-msg" style="margin:20px 0; text-align:center;"></div>
 <button onclick="nextCycle()" style="width:200px; height:50px; background:#0044cc; border:3px solid #fff;">NEXT SCAN</button>
</div>

<div id="coll-screen" class="overlay-screen">
 <h2 style="color:yellow;">COLLECTION</h2>
 <div class="coll-list" id="w-list"></div>
 <div class="coll-list" id="m-list"></div>
 <button onclick="document.getElementById('coll-screen').style.display='none'" style="width:100px;">CLOSE</button>
</div>

<script>
 let net, mode = "W", lv = 1, exp = 0, nextExp = 100;
 let php = 1000, pMax = 1000, ehp = 1000, eMax = 1000;
 let patk=0, pdef=0, eatk=0, edef=0;
 let collection = JSON.parse(localStorage.getItem('myth_vfinal')) || { weapons: {}, monsters: {} };

 const db = {
 weapons: [{r:"COMMON",n:["アイアンソード","石の斧"],i:" ",b:100}, {r:"RARE",n:["焔の剣","雷鳴の杖"],i:" ",b:200}, {r:"SUPER",n:["聖剣","魔導書"],i:" ",b:400}, {r:"MYTH",n:["ゼウスの雷","ラグナロク"],i:" ",b:800}],
 monsters: [{r:"COMMON",n:["スライム","ゴブリン"],i:" ",b:80}, {r:"RARE",n:["ドラゴン","オーク"],i:" ",b:180}, {r:"SUPER",n:["フェニックス","死神"],i:" ",b:350}, {r:"MYTH",n:["破壊神","バハムート"],i:" ",b:700}]
 };

 async function init() {
 net = await mobilenet.load();
 const stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
 document.getElementById('pv').srcObject = stream;
 document.getElementById('ev').srcObject = stream;
 }

 async function handleScan() {
 const r = await net.classify(document.getElementById('pv'));
 const seed = Math.floor((r[0].className.length * Date.now()) % 100);
 const rarity = seed < 70 ? 0 : seed < 90 ? 1 : seed < 99 ? 2 : 3;

 if (mode === "W") {
 const data = db.weapons[rarity];
 patk = data.b + (seed * 2) + (lv * 10);
 pdef = Math.floor(data.b / 2) + (lv * 5);
 php = Math.min(pMax, php + Math.floor(pMax * 0.8)); // 80%回復

 document.getElementById('p-name').innerText = `No.${seed} [${data.r}] ${data.n[seed % data.n.length]}`;
 document.getElementById('pw-icon').innerText = data.i;
 document.getElementById('p-atk').innerText = patk;
 document.getElementById('p-def').innerText = pdef;
 document.getElementById('pf').classList.add('camera-off');
 
 collection.weapons[seed] = {no:seed, name:data.n[seed % data.n.length], icon:data.i};
 localStorage.setItem('myth_vfinal', JSON.stringify(collection));
 mode = "M";
 document.getElementById('msg').innerText = "敵をスキャンしてください";
 } else {
 const data = db.monsters[rarity];
 eatk = data.b + (seed * 2) + (lv * 8);
 edef = Math.floor(data.b / 2) + (lv * 4);
 eMax = 1000 + (lv * 100) + seed; // 敵HPの動的設定
 ehp = eMax;

 document.getElementById('e-name').innerText = `No.${seed} [${data.r}] ${data.n[seed % data.n.length]}`;
 document.getElementById('em-icon').innerText = data.i;
 document.getElementById('e-atk').innerText = eatk;
 document.getElementById('e-def').innerText = edef;
 document.getElementById('ef').classList.add('camera-off');
 
 this.tempMonster = {no:seed, name:data.n[seed % data.n.length], icon:data.i};
 document.getElementById('atk-btn').disabled = false;
 document.getElementById('scan-btn').disabled = true;
 document.getElementById('msg').innerText = "バトル開始！";
 }
 updateUI();
 }

 function handleAttack() {
 document.getElementById('ef').classList.add('shake');
 ehp -= Math.max(30, patk - Math.floor(edef/2));
 setTimeout(() => {
 document.getElementById('ef').classList.remove('shake');
 if(ehp <= 0) return finish(true);
 document.getElementById('pf').classList.add('shake');
 php -= Math.max(30, eatk - Math.floor(pdef/2));
 updateUI();
 setTimeout(() => {
 document.getElementById('pf').classList.remove('shake');
 if(php <= 0) finish(false);
 }, 200);
 }, 400);
 updateUI();
 }

 function finish(win) {
 const screen = document.getElementById('result-screen');
 screen.style.display = "flex";
 if(win) {
 document.getElementById('result-title').innerText = "WIN!";
 document.getElementById('result-title').style.color = "yellow";
 exp += 50; if(exp >= nextExp) { lv++; exp=0; nextExp+=50; }
 collection.monsters[this.tempMonster.no] = this.tempMonster;
 localStorage.setItem('myth_vfinal', JSON.stringify(collection));
 document.getElementById('result-msg').innerText = "経験値を獲得し、モンスターを図鑑に登録しました。";
 } else {
 document.getElementById('result-title').innerText = "GAME OVER";
 document.getElementById('result-title').style.color = "red";
 lv = Math.max(1, lv - 5); php = pMax;
 document.getElementById('result-msg').innerText = "敗北。レベルが5低下しました。";
 }
 }

 function nextCycle() {
 mode = "W";
 document.getElementById('pf').classList.remove('camera-off');
 document.getElementById('ef').classList.remove('camera-off');
 document.getElementById('scan-btn').disabled = false;
 document.getElementById('atk-btn').disabled = true;
 document.getElementById('result-screen').style.display = "none";
 document.getElementById('msg').innerText = "新しい武器をスキャンしてください";
 updateUI();
 }

 function updateUI() {
 document.getElementById('phf').style.width = (php / pMax * 100) + "%";
 document.getElementById('ehf').style.width = (ehp / eMax * 100) + "%";
 document.getElementById('p-hp-cur').innerText = Math.max(0, php);
 document.getElementById('p-hp-max').innerText = pMax;
 document.getElementById('e-hp-cur').innerText = Math.max(0, ehp);
 document.getElementById('e-hp-max').innerText = eMax;
 document.getElementById('p-lv').innerText = lv;
 document.getElementById('p-exp').innerText = exp;
 document.getElementById('p-next').innerText = nextExp;
 }

 function showColl() {
 const wBox = document.getElementById('w-list');
 const mBox = document.getElementById('m-list');
 wBox.innerHTML = "<b>[WEAPONS]</b><br>";
 mBox.innerHTML = "<b>[MONSTERS]</b><br>";
 Object.values(collection.weapons).sort((a,b)=>a.no-b.no).forEach(v => wBox.innerHTML += `No.${v.no} ${v.icon} ${v.name}<br>`);
 Object.values(collection.monsters).sort((a,b)=>a.no-b.no).forEach(v => mBox.innerHTML += `No.${v.no} ${v.icon} ${v.name}<br>`);
 document.getElementById('coll-screen').style.display = "flex";
 }

 init();
</script>
</body>
</html>
