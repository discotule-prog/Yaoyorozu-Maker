<!DOCTYPE html>
<html lang="ja">
<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <title>MONSTER SCANNER EVO</title>
 <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
 <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet"></script>
 <link href="https://fonts.googleapis.com/css2?family=DotGothic16&family=Share+Tech+Mono&display=swap" rel="stylesheet">
 <style>
 :root { --main-color: #fff; --accent-color: #00ff00; }
 body { 
 font-family: 'DotGothic16', sans-serif; 
 background-color: #443322;
 background-image: repeating-linear-gradient(0deg, #332211, #332211 10px, #443322 10px, #443322 20px);
 color: var(--main-color); margin: 0; display: flex; flex-direction: column; align-items: center;
 overflow: hidden;
 }

 #game-container { background: rgba(0,0,0,0.9); width: 95%; max-width: 400px; padding: 15px; border: 4px solid #fff; margin-top: 10px; position: relative; }
 
 /* バトルフィールド */
 #battle-field { width: 100%; height: 200px; border: 4px solid #fff; background: #111; position: relative; display: flex; justify-content: space-around; align-items: flex-end; padding-bottom: 10px; }
 .unit-container { width: 45%; text-align: center; }
 .unit-sprite { width: 100%; height: 120px; object-fit: contain; image-rendering: pixelated; border: 1px solid #333; }
 
 /* アニメーション */
 .shake { animation: shake 0.3s; }
 @keyframes shake {
 0% { transform: translate(1px, 1px) rotate(0deg); }
 20% { transform: translate(-3px, 0px) rotate(-1deg); }
 40% { transform: translate(3px, 2px) rotate(1deg); }
 60% { transform: translate(-1px, -1px) rotate(1deg); }
 80% { transform: translate(-3px, 1px) rotate(-1deg); }
 100% { transform: translate(1px, -2px) rotate(0deg); }
 }
 .flash { animation: flash 0.2s; }
 @keyframes flash {
 0% { background: #fff; }
 100% { background: #111; }
 }

 /* ステータス */
 #status-area { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; font-family: 'Share Tech Mono', monospace; font-size: 0.9rem; }
 .window { border: 2px solid #fff; padding: 5px; background: #000; }
 .hp-bar { height: 8px; background: #555; margin-top: 4px; }
 .hp-fill { height: 100%; background: var(--accent-color); transition: width 0.3s; }

 #msg-log { height: 50px; border: 2px solid #fff; margin-top: 10px; padding: 5px; font-size: 0.8rem; background: #111; overflow-y: hidden; }

 .btn-group { display: flex; gap: 5px; margin-top: 10px; }
 button { flex: 1; padding: 10px; font-family: 'DotGothic16'; background: #e60012; color: #fff; border: 3px solid #fff; cursor: pointer; }
 button:disabled { background: #444; border-color: #888; }

 video { display: none; }
 </style>
</head>
<body>

<video id="webcam" autoplay playsinline muted></video>

<div id="game-container">
 <div id="level-display" style="text-align:right; font-size:0.8rem; color:yellow;">LV: <span id="lv">1</span> EXP: <span id="exp">0</span></div>
 
 <div id="battle-field">
 <div class="unit-container" id="player-unit">
 <div style="font-size:0.7rem;">PLAYER</div>
 <canvas id="player-canvas" class="unit-sprite"></canvas>
 </div>
 <div class="unit-container" id="enemy-unit">
 <div style="font-size:0.7rem;">ENEMY</div>
 <div id="enemy-view" class="unit-sprite" style="background:#300; display:flex; align-items:center; justify-content:center; font-size:2rem;"> </div>
 </div>
 </div>

 <div id="status-area">
 <div class="window">
 <div>HP: <span id="p-hp">0</span></div>
 <div class="hp-bar"><div id="p-hp-fill" class="hp-fill" style="width:100%"></div></div>
 </div>
 <div class="window">
 <div>ENEMY HP: <span id="e-hp">0</span></div>
 <div class="hp-bar"><div id="e-hp-fill" class="hp-fill" style="width:100%; background:red;"></div></div>
 </div>
 </div>

 <div id="msg-log">SYSTEM READY...</div>

 <div class="btn-group">
 <button id="scan-btn">SCAN</button>
 <button id="atk-btn" disabled>ATTACK!</button>
 </div>
</div>

<script>
 let net;
 let player = { lv: 1, exp: 0, hp: 100, maxHp: 100, atk: 20, def: 10, name: "" };
 let enemy = { hp: 100, maxHp: 100, atk: 15, def: 5 };
 
 const video = document.getElementById('webcam');
 const pCanvas = document.getElementById('player-canvas');
 const pCtx = pCanvas.getContext('2d');
 const log = document.getElementById('msg-log');

 async function init() {
 try {
 net = await mobilenet.load();
 const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
 video.srcObject = stream;
 log.innerText = "SCANNER STANDBY.";
 } catch(e) { log.innerText = "ERROR: CAMERA NOT FOUND."; }
 }

 function updateUI() {
 document.getElementById('lv').innerText = player.lv;
 document.getElementById('exp').innerText = player.exp;
 document.getElementById('p-hp').innerText = Math.max(0, player.hp);
 document.getElementById('e-hp').innerText = Math.max(0, enemy.hp);
 document.getElementById('p-hp-fill').style.width = (player.hp / player.maxHp * 100) + "%";
 document.getElementById('e-hp-fill').style.width = (enemy.hp / enemy.maxHp * 100) + "%";
 }

 document.getElementById('scan-btn').onclick = async () => {
 const result = await net.classify(video);
 player.name = result[0].className.split(',')[0].toUpperCase();
 
 // 高解像度ドット絵化 (128x128)
 pCanvas.width = 128;
 pCanvas.height = 128;
 pCtx.drawImage(video, 0, 0, 128, 128);
 
 // ステータス設定 (レベルに応じて強化)
 player.maxHp = 500 + (player.lv * 50);
 player.hp = player.maxHp;
 player.atk = 50 + (player.lv * 10);
 
 enemy.maxHp = 400 + Math.floor(Math.random() * 200);
 enemy.hp = enemy.maxHp;
 
 log.innerText = "FOUND: " + player.name + "!";
 document.getElementById('atk-btn').disabled = false;
 updateUI();
 };

 document.getElementById('atk-btn').onclick = () => {
 // 攻撃演出
 document.getElementById('enemy-unit').classList.add('shake');
 document.getElementById('battle-field').classList.add('flash');
 setTimeout(() => {
 document.getElementById('enemy-unit').classList.remove('shake');
 document.getElementById('battle-field').classList.remove('flash');
 }, 300);

 let dmg = Math.max(10, player.atk - enemy.def);
 enemy.hp -= dmg;
 log.innerText = `YOU DEAL ${dmg} DMG!`;

 if (enemy.hp <= 0) {
 log.innerText = "ENEMY DEFEATED! +50 EXP";
 player.exp += 50;
 if (player.exp >= player.lv * 100) {
 player.lv++;
 log.innerText = "LEVEL UP! LV " + player.lv;
 }
 document.getElementById('atk-btn').disabled = true;
 } else {
 // 反撃
 setTimeout(() => {
 document.getElementById('player-unit').classList.add('shake');
 let eDmg = Math.max(5, enemy.atk - player.def);
 player.hp -= eDmg;
 log.innerText = `ENEMY DEALS ${eDmg} DMG!`;
 setTimeout(() => document.getElementById('player-unit').classList.remove('shake'), 300);
 updateUI();
 }, 800);
 }
 updateUI();
 };

 init();
</script>
</body>
</html>
