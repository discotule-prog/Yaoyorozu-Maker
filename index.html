<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MYTH SCANNER 6.2 - FULL INTEGRATED</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet"></script>
    <link href="https://fonts.googleapis.com/css2?family=DotGothic16&display=swap" rel="stylesheet">
    <style>
        :root { --p-color: #00f2ff; --e-color: #ff3c00; --exp-color: #32ff32; --gold: #ffd700; --magic-purple: #9d4edd; --close-btn: #880000; --main-blue: #0044cc; --reset-red: #cc0000; }
        body { font-family: 'DotGothic16', sans-serif; background: #000; color: #fff; margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        #init-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; color: #0f0; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10000; }
        
        #header { height: 40px; background: #222; display: flex; justify-content: space-around; align-items: center; border-bottom: 2px solid #444; flex-shrink: 0; padding: 0 5px; }
        .head-btn { flex: 1; font-size: 0.55rem; height: 26px; border: 1px solid #fff; color: #fff; cursor: pointer; margin: 0 2px; }
        
        .char-area { height: 30%; display: flex; border-bottom: 1px solid #333; padding: 10px; box-sizing: border-box; position: relative; }
        .cam-part { width: 35%; display: flex; align-items: center; justify-content: center; }
        .cam-frame { width: 90px; height: 90px; border: 2px solid #555; background: #111; overflow: hidden; position: relative; border-radius: 8px; }
        .cam-active { border-color: var(--p-color); box-shadow: 0 0 10px var(--p-color); }
        video { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; }
        
        .info-part { width: 65%; display: flex; flex-direction: column; padding-left: 10px; justify-content: center; }
        .visual-card { width: 100%; height: 75px; border: 2px solid #fff; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #111; position: relative; border-radius: 4px; }
        .stat-text { font-size: 0.65rem; color: #ccc; margin-top: 2px; line-height: 1.2; }
        .bar-container { width: 100%; margin-top: 4px; }
        .bar-bg { width: 100%; height: 8px; background: #222; border: 1px solid #666; overflow: hidden; }
        .bar-fill { height: 100%; width: 0%; transition: width 0.4s ease-out; }
        
        #mid-ui { height: 155px; background: #111; border-top: 2px solid #444; display: flex; flex-direction: column; align-items: center; padding: 5px; flex-shrink: 0; }
        #msg { font-size: 0.75rem; color: #0f0; height: 50px; text-align: center; display: flex; align-items: center; justify-content: center; white-space: pre-wrap; width: 90%; }
        
        .btn-row { display: flex; gap: 6px; width: 95%; justify-content: center; margin-bottom: 6px; }
        button { flex: 1; height: 38px; font-family: 'DotGothic16'; border: 2px solid #fff; color: #fff; background: #444; font-size: 0.65rem; cursor: pointer; }
        button:disabled { opacity: 0.25; }

        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 100; display: none; flex-direction: column; align-items: center; padding: 20px; box-sizing: border-box; }
        .scroll-list { width: 100%; overflow-y: auto; display: flex; flex-direction: column; align-items: center; gap: 10px; }
        
        .shake { animation: shake-anim 0.3s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake-anim { 10%, 90% { transform: translate3d(-2px, 0, 0); } 20%, 80% { transform: translate3d(3px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-6px, 0, 0); } }
    </style>
</head>
<body>

<div id="init-overlay">
    <h1 style="margin-bottom:10px;">MYTH SCANNER 6.2</h1>
    <div id="init-msg">SYSTEM INITIALIZING...</div>
    <button id="start-btn" onclick="startGame()" style="display:none; margin-top:20px; padding:15px 40px; background:var(--main-blue); border-radius:8px; border:none; color:white;">LINK START</button>
</div>

<div id="header">
    <button onclick="if(confirm('RESET?')){localStorage.clear();location.reload();}" class="head-btn" style="background:var(--reset-red);">RESET</button>
    <button onclick="openLibrary()" class="head-btn" style="background:#555;">COLLECTION</button>
    <button id="sp-btn" onclick="openSkillMenu()" class="head-btn" style="background:var(--magic-purple);">SKILL UP (0)</button>
</div>

<div class="char-area" id="p-area">
    <div class="cam-part"><div class="cam-frame"><video id="pv" autoplay playsinline muted></video></div></div>
    <div class="info-part">
        <div class="visual-card">
            <div id="p-elem" style="position:absolute; top:2px; left:5px;"></div>
            <div id="p-rare" style="position:absolute; top:2px; right:5px; font-size:0.5rem; background:#fff; color:#000; padding:1px 3px;">-</div>
            <div id="p-sym" style="font-size:1.8rem;">‚öîÔ∏è</div>
            <div id="p-name" style="font-size:0.55rem;">WEAPON READY</div>
        </div>
        <div class="stat-text">LV:<span id="p-lv">1</span> HP:<span id="p-hp-cur">1000</span>/<span id="p-hp-max">1000</span></div>
        <div class="bar-container"><div class="bar-bg"><div id="p-fill" class="bar-fill" style="background:var(--p-color); width:100%"></div></div></div>
    </div>
</div>

<div id="mid-ui">
    <div id="msg">INITIALIZING SYSTEM...</div>
    <div class="btn-row">
        <button id="scan-btn" onclick="handleScan()" disabled style="background:var(--main-blue); flex:1.5;">SCAN</button>
        <button id="atk-btn" onclick="handleAttack()" disabled style="background:#aa0000; flex:1.5;">ATTACK</button>
    </div>
    <div class="btn-row">
        <button id="magic-btn" onclick="openMagicMenu()" disabled style="background:var(--magic-purple);">MAGIC</button>
        <button id="item-open-btn" onclick="openItemMenu()" disabled style="background:#008844;">ITEM</button>
        <button id="esc-btn" onclick="handleEscape()" disabled style="background:#555;">ESCAPE</button>
    </div>
</div>

<div class="char-area" id="e-area">
    <div class="cam-part"><div class="cam-frame"><video id="ev" autoplay playsinline muted></video></div></div>
    <div class="info-part">
        <div class="visual-card">
            <div id="e-elem" style="position:absolute; top:2px; left:5px;"></div>
            <div id="e-rare" style="position:absolute; top:2px; right:5px; font-size:0.5rem; background:#fff; color:#000; padding:1px 3px;">-</div>
            <div id="e-sym" style="font-size:1.8rem;">?</div>
            <div id="e-name" style="font-size:0.55rem;">???</div>
        </div>
        <div class="stat-text">HP:<span id="e-hp-cur">0</span>/<span id="e-hp-max">0</span></div>
        <div class="bar-container"><div class="bar-bg"><div id="e-fill" class="bar-fill" style="background:var(--e-color);"></div></div></div>
    </div>
</div>

<div id="magic-overlay" class="overlay"><h2>MAGIC</h2><div id="magic-list" class="scroll-list"></div><button onclick="closeOverlay()" style="margin-top:20px; background:var(--close-btn);">CLOSE</button></div>
<div id="item-overlay" class="overlay"><h2>ITEMS</h2><div id="item-list" class="scroll-list"></div><button onclick="closeOverlay()" style="margin-top:20px; background:var(--close-btn);">CLOSE</button></div>
<div id="skill-overlay" class="overlay"><h2>SKILL UP</h2><div id="skill-points-display"></div><div id="skill-list" class="scroll-list"></div><button onclick="closeOverlay()" style="margin-top:20px; background:var(--close-btn);">CLOSE</button></div>
<div id="bonus-overlay" class="overlay"><h2>VICTORY!</h2><div class="cam-frame" style="width:150px; height:150px; margin:20px;"><video id="bv" autoplay playsinline muted></video></div><button id="get-item-btn" onclick="getBonusItem()" style="background:var(--gold); color:#000; font-weight:bold; padding:20px;">SCAN FOR LOOT</button></div>

<script>
// --- Data ---
const DB_WEAPON = ["ÈåÜ„Å≥„ÅüÁü≠Ââ£","ÈâÑ„ÅÆÂâ£","ÂêçÂàÄÊ≠£ÂÆó","„É¨„Éº„É¥„Ç°„ÉÜ„Ç§„É≥","ÊòüÁ†ï„Åç„ÅÆÊßå"];
const DB_MONSTER = ["ÈáéËâØÁä¨","„ÅØ„Åê„Çå„É°„Çø„É´","Âú∞ÁçÑ„ÅÆÈñÄÁï™","Âè§„ÅÆÈ≠îÈæç","ËôöÁÑ°„ÅÆÁéã"];
const DB_ITEM_FULL = {
    201: { name: "Ëñ¨Ëçâ", type: "HP RECOVERY", val: 300, rare: "NORMAL", mode: "fix" },
    202: { name: "ËÅñÊ∞¥", type: "ELEMENTAL ATTACK", val: 0.3, elem: "üíß", rare: "ELITE" },
    203: { name: "ÂãáËÄÖ„ÅÆÊóó", type: "BUFF_ATK", val: 0.5, rare: "LEGEND" }
};
const ELEMENTS = { "üî•": "üåø", "üåø": "‚ö°", "‚ö°": "üíß", "üíß": "üî•" };
const MAGIC_INFO = {
    H: { n: "„Éí„Éº„É´", s: "‚ú®" }, F: { n: "„Éï„Ç°„Ç§„Ç¢", s: "üî•" }, W: { n: "„Ç¶„Ç©„Éº„Çø„Éº", s: "üíß" },
    L: { n: "„É©„Ç§„Éà„Éã„É≥„Ç∞", s: "‚ö°" }, G: { n: "„Ç¨„Ç§„Ç¢", s: "üåø" }, K: { n: "„Ç´„Éº„Çπ", s: "üíÄ" },
    B: { n: "„Éñ„É¨„Ç§„ÇØ", s: "‚öîÔ∏è" }, R: { n: "„Éñ„É¨„Ç§„Éñ", s: "‚úä" }, S: { n: "„Ç∑„Éº„É´", s: "üõ°Ô∏è" }
};

// --- Variables ---
let lv=1, exp=0, php=1000, pMax=1000, patk=120, pdef=60, pelem="üî•", inventory=[], skillPoints=0;
let magicLv = {H:1, F:0, W:0, L:0, G:0, B:0, K:0, S:0, R:0};
let net, mode="W", ehp=0, eMax=0, eatk=0, edef=0, eelem="", stream=null;
let hasUsedItemThisTurn = false, isSureHit = false, isPerfectEvasion = false, trapTimer = 0;
let magicUsedThisBattle = {H:false,F:false,W:false,L:false,G:false,B:false,K:false,S:false,R:false};
let library = JSON.parse(localStorage.getItem('myth_v6_lib')) || { W: {}, M: {}, I: {} };

// --- Core Logic ---
async function init() {
    const saved = JSON.parse(localStorage.getItem('myth_v6_save')) || {};
    if(saved.lv) { lv=saved.lv; exp=saved.exp; pMax=saved.pMax; magicLv=saved.magicLv; skillPoints=saved.skillPoints; inventory=saved.inventory; }
    php = pMax;
    updateUI();
    try {
        net = await mobilenet.load();
        document.getElementById('init-msg').innerText = "SYSTEM READY";
        document.getElementById('start-btn').style.display = 'block';
    } catch(e) { alert("AI Load Error"); }
}

async function startGame() {
    await switchCamera('P');
    document.getElementById('init-overlay').style.display = 'none';
    document.getElementById('scan-btn').disabled = false;
    document.getElementById('msg').innerText = "Ê≠¶Âô®„Çí„Çπ„Ç≠„É£„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ";
}

async function switchCamera(target) {
    if(stream) stream.getTracks().forEach(t => t.stop());
    const vId = {P:'pv', E:'ev', B:'bv'}[target];
    const video = document.getElementById(vId);
    if(!video) return;
    stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
    video.srcObject = stream;
    video.style.display = 'block';
}

async function handleScan() {
    const vid = mode === "W" ? document.getElementById('pv') : document.getElementById('ev');
    applyShake();
    let id = Math.floor(Math.random() * 100);
    try { const r = await net.classify(vid); id = (r[0].className.length * 7) % 100; } catch(e){}
    
    const rare = id >= 90 ? "LEGEND" : id >= 60 ? "ELITE" : "NORMAL";
    const typeId = id % 4;
    const elemList = ["üî•", "üíß", "‚ö°", "üåø"];

    if(mode === "W") {
        pelem = elemList[typeId];
        const name = DB_WEAPON[id % DB_WEAPON.length];
        updateCardUI('p', "‚öîÔ∏è", name, pelem, rare);
        library.W[id] = { t: name, e: pelem, r: rare };
        mode = "E";
        await switchCamera('E');
        document.getElementById('msg').innerText = "„É¢„É≥„Çπ„Çø„Éº„ÇíÊé¢„Åó„Å¶„ÅÑ„Åæ„Åô...";
    } else {
        eelem = elemList[typeId];
        eMax = Math.floor(800 * (1 + lv*0.1)); ehp = eMax;
        eatk = Math.floor(80 * (1 + lv*0.1)); edef = Math.floor(40 * (1 + lv*0.1));
        const name = DB_MONSTER[id % DB_MONSTER.length];
        updateCardUI('e', "üëæ", name, eelem, rare);
        library.M[id+100] = { t: name, e: eelem, r: rare };
        setBattleBtns(false);
        document.getElementById('scan-btn').disabled = true;
        document.getElementById('msg').innerText = "„Éê„Éà„É´ÈñãÂßãÔºÅ";
    }
    updateUI();
    save();
}

function handleAttack() {
    setBattleBtns(true);
    let isHit = isSureHit || Math.random() > 0.15;
    if(isHit) {
        applyShake();
        const bonus = ELEMENTS[pelem] === eelem ? 1.5 : 1.0;
        let dmg = Math.floor(Math.max(50, (patk * bonus) - (edef * 0.2)));
        if(isSureHit) dmg = Math.floor(dmg * 1.5);
        ehp = Math.max(0, ehp - dmg);
        document.getElementById('msg').innerText = `üí• ${dmg}„ÉÄ„É°„Éº„Ç∏ÔºÅ`;
    } else {
        document.getElementById('msg').innerText = "üí® „Éü„ÇπÔºÅ";
    }
    isSureHit = false;
    updateUI();
    setTimeout(() => { if(ehp <= 0) showBonus(); else enemyTurn(); }, 1000);
}

function enemyTurn() {
    if(trapTimer > 0) { trapTimer--; if(Math.random() < 0.5) { document.getElementById('msg').innerText = "ÁΩ†„Å´„Åã„Åã„Å£„Å¶„ÅÑ„ÇãÔºÅ"; setTimeout(()=>setBattleBtns(false), 1000); return; } }
    document.getElementById('msg').innerText = "Êïµ„ÅÆÊîªÊíÉÔºÅ";
    setTimeout(() => {
        if(isPerfectEvasion) { document.getElementById('msg').innerText = "üí® ÂõûÈÅøÔºÅ"; isPerfectEvasion=false; setBattleBtns(false); return; }
        applyShake();
        let dmg = Math.floor(Math.max(30, eatk - (pdef * 0.2)));
        php = Math.max(0, php - dmg);
        document.getElementById('msg').innerText = `‚ö†Ô∏è ${dmg}„ÅÆ„ÉÄ„É°„Éº„Ç∏ÔºÅ`;
        updateUI();
        if(php <= 0) { alert("ÊïóÂåó..."); resetBattle(); } else { setBattleBtns(false); }
    }, 1000);
}

// --- Menu Systems ---
function openMagicMenu() {
    const list = document.getElementById('magic-list'); list.innerHTML = "";
    for(let k in magicLv) {
        if(magicLv[k] > 0) {
            const b = document.createElement('button');
            b.innerHTML = `${MAGIC_INFO[k].s} ${MAGIC_INFO[k].n} (Lv.${magicLv[k]}) ${magicUsedThisBattle[k]?'[Á©∫]':''}`;
            b.disabled = magicUsedThisBattle[k];
            b.onclick = () => castMagic(k);
            list.appendChild(b);
        }
    }
    document.getElementById('magic-overlay').style.display = 'flex';
}

function castMagic(k) {
    magicUsedThisBattle[k] = true;
    const mlv = magicLv[k];
    document.getElementById('magic-overlay').style.display = 'none';
    if(k === 'H') { php = Math.min(pMax, php + Math.floor(pMax * 0.3)); document.getElementById('msg').innerText = "ÂõûÂæ©È≠îÊ≥ïÔºÅ"; }
    else { applyShake(); ehp = Math.max(0, ehp - (mlv * 100)); document.getElementById('msg').innerText = `${MAGIC_INFO[k].n}ÔºÅ`; }
    updateUI();
    setTimeout(() => { if(ehp <= 0) showBonus(); else enemyTurn(); }, 1000);
}

function openItemMenu() {
    const list = document.getElementById('item-list'); list.innerHTML = "";
    inventory.forEach((gid, i) => {
        const itm = DB_ITEM_FULL[gid] || {name:"‰∏çÊòé„Å™Áü≥", rare:"NORMAL"};
        const b = document.createElement('button');
        b.innerHTML = `[${itm.rare}] ${itm.name}`;
        b.onclick = () => { if(!hasUsedItemThisTurn) { useItem(gid, i); } else { alert("1„Çø„Éº„É≥1Âõû„Åæ„Åß„Åß„Åô"); } };
        list.appendChild(b);
    });
    document.getElementById('item-overlay').style.display = 'flex';
}

function useItem(gid, idx) {
    const itm = DB_ITEM_FULL[gid];
    if(itm && itm.type === "HP RECOVERY") php = Math.min(pMax, php + itm.val);
    inventory.splice(idx, 1);
    hasUsedItemThisTurn = true;
    document.getElementById('item-overlay').style.display = 'none';
    document.getElementById('msg').innerText = `${itm?itm.name:'„Ç¢„Ç§„ÉÜ„É†'}„Çí‰ΩøÁî®„Åó„ÅüÔºÅ`;
    updateUI();
    if(ehp <= 0) showBonus();
}

function openSkillMenu() {
    document.getElementById('skill-points-display').innerText = `„Éù„Ç§„É≥„Éà: ${skillPoints}`;
    const list = document.getElementById('skill-list'); list.innerHTML = "";
    for(let k in magicLv) {
        const b = document.createElement('button');
        const cost = magicLv[k] + 1;
        b.innerHTML = `${MAGIC_INFO[k].n} Lv.${magicLv[k]} -> ${magicLv[k]+1} (Ê∂àË≤ª:${cost})`;
        b.onclick = () => { if(skillPoints >= cost) { skillPoints -= cost; magicLv[k]++; save(); openSkillMenu(); updateUI(); } };
        list.appendChild(b);
    }
    document.getElementById('skill-overlay').style.display = 'flex';
}

// --- Utils ---
function updateUI() {
    document.getElementById('p-lv').innerText = lv;
    document.getElementById('p-hp-cur').innerText = php;
    document.getElementById('p-hp-max').innerText = pMax;
    document.getElementById('p-fill').style.width = (php/pMax*100) + "%";
    document.getElementById('e-hp-cur').innerText = ehp;
    document.getElementById('e-hp-max').innerText = eMax;
    document.getElementById('e-fill').style.width = eMax > 0 ? (ehp/eMax*100) + "%" : "0%";
    document.getElementById('sp-btn').innerText = `SKILL UP (${skillPoints})`;
}
function updateCardUI(side, sym, name, elem, rare) {
    document.getElementById(`${side}-sym`).innerText = sym;
    document.getElementById(`${side}-name`).innerText = name;
    document.getElementById(`${side}-elem`).innerText = elem;
    document.getElementById(`${side}-rare`).innerText = rare;
}
function setBattleBtns(dis) {
    document.getElementById('atk-btn').disabled = dis;
    document.getElementById('magic-btn').disabled = dis;
    document.getElementById('item-open-btn').disabled = dis;
    document.getElementById('esc-btn').disabled = dis;
    if(!dis) hasUsedItemThisTurn = false;
}
function applyShake() { document.body.classList.add('shake'); setTimeout(() => document.body.classList.remove('shake'), 300); if(navigator.vibrate) navigator.vibrate(100); }
function closeOverlay() { document.querySelectorAll('.overlay').forEach(o => o.style.display = 'none'); }
function save() { localStorage.setItem('myth_v6_save', JSON.stringify({lv, exp, pMax, magicLv, skillPoints, inventory})); localStorage.setItem('myth_v6_lib', JSON.stringify(library)); }
function handleEscape() { if(confirm("ÈÄÉ„Åí„Åæ„Åô„ÅãÔºü")) resetBattle(); }

function showBonus() {
    skillPoints += 1; lv++; pMax += 100; php = pMax;
    document.getElementById('bonus-overlay').style.display = 'flex';
    switchCamera('B');
}
function getBonusItem() {
    const gids = Object.keys(DB_ITEM_FULL);
    const gid = parseInt(gids[Math.floor(Math.random()*gids.length)]);
    if(inventory.length < 8) inventory.push(gid);
    alert("„Ç¢„Ç§„ÉÜ„É†Áç≤ÂæóÔºÅ");
    closeOverlay();
    resetBattle();
}
function resetBattle() {
    mode="W"; ehp=0; eMax=0;
    magicUsedThisBattle = {H:false,F:false,W:false,L:false,G:false,B:false,K:false,S:false,R:false};
    document.getElementById('scan-btn').disabled = false;
    setBattleBtns(true);
    switchCamera('P');
    updateUI();
    save();
}

window.onload = init;
</script>
</body>
</html>
