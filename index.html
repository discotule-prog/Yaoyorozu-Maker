<script>
    // çŠ¶æ…‹ç®¡ç†ãƒ•ãƒ©ã‚°
    let isProcessing = false; 

    async function handleScan() {
        if(isProcessing) return; // äºŒé‡å‹•ä½œé˜²æ­¢
        isProcessing = true;
        
        const btn = document.getElementById('scan-btn');
        btn.disabled = true;
        btn.innerText = "SCANNING...";

        try {
            const vid = (mode === "W") ? document.getElementById('pv') : document.getElementById('ev');
            const r = await net.classify(vid);
            const id = Math.floor(r[0].probability * 100);
            const aiName = r[0].className.split(',')[0].toUpperCase();

            if (mode === "W") {
                // 1. æ­¦å™¨ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºå®š
                let name = aiName + "ã®" + (DB_WEAPON[id % 100]);
                pelem = ["ðŸ”¥", "ðŸ’§", "âš¡", "ðŸŒ¿"][id % 4];
                patk = 100 + id + (lv * 10);
                updateCardUI('p', id >= 90 ? "MYTH" : "REG", pelem, "âš”ï¸", name);
                library.W[id % 100] = name;
                save();

                // 2. ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ›´æ–°
                document.getElementById('msg').innerText = "æ­¦å™¨ã‚’è£…å‚™ã—ãŸï¼\næ¬¡ã¯ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ(æ•µ)ã‚’æ˜ ã›ï¼";

                // 3. ãƒ¢ãƒ¼ãƒ‰ã‚’å³åº§ã«å¤‰æ›´
                mode = "M";

                // 4. ã‚«ãƒ¡ãƒ©ã®ç‰©ç†çš„ãªåˆ‡ã‚Šæ›¿ãˆï¼ˆå®Œå…¨ã«åœæ­¢ã—ã¦ã‹ã‚‰é–‹å§‹ï¼‰
                await switchCamera('OFF');
                await new Promise(resolve => setTimeout(resolve, 800)); // ãƒ–ãƒ©ã‚¦ã‚¶ã®è§£æ”¾å¾…ã¡
                const success = await switchCamera('E');
                
                if(success) {
                    btn.innerText = "ENEMY SCAN";
                    btn.disabled = false;
                }
            } else if (mode === "M") {
                // æ•µã®ç”Ÿæˆå‡¦ç†
                let name = aiName + "ã®" + (DB_MONSTER[id % 100]);
                eelem = ["ðŸ”¥", "ðŸ’§", "âš¡", "ðŸŒ¿"][id % 4];
                eMax = 500 + (id * 15) + (lv * 20); ehp = eMax; eatk = 50 + id + (lv * 5);
                updateCardUI('e', id >= 80 ? "BOSS" : "NM", eelem, "ðŸ‘¾", name);
                library.M[id % 100] = name;
                save();

                await switchCamera('OFF');
                document.getElementById('msg').innerText = `${name}ãŒç¾ã‚ŒãŸï¼`;
                setBattleBtns(false);
                btn.innerText = "SCAN";
            } else if (mode === "I") {
                // ã‚¢ã‚¤ãƒ†ãƒ ã®ç”Ÿæˆ
                let name = aiName + "ã®" + (DB_ITEM[id % 10]);
                library.I[id % 10] = name;
                save();
                document.getElementById('msg').innerText = `ã€${name}ã€‘ã‚’ç²å¾—ï¼`;
                setTimeout(() => { startGame(); }, 1500);
            }
        } catch (error) {
            console.error(error);
            document.getElementById('msg').innerText = "SCAN ERROR - RETRYING...";
            btn.disabled = false;
        } finally {
            isProcessing = false;
            updateUI();
        }
    }

    async function switchCamera(target) {
        // å…¨ã¦ã®ãƒ“ãƒ‡ã‚ªè¦ç´ ã¨ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’æ˜Žç¤ºçš„ã«ã‚¯ãƒªã‚¢
        if (stream) {
            stream.getTracks().forEach(track => {
                track.stop();
                console.log("Track stopped");
            });
            stream = null;
        }
        
        const videos = document.querySelectorAll('video');
        videos.forEach(v => {
            v.pause();
            v.srcObject = null;
            v.load();
        });

        document.querySelectorAll('.cam-frame').forEach(f => f.classList.remove('cam-active'));

        if (target === 'OFF') return true;

        const vId = target === 'P' ? 'pv' : 'ev';
        try {
            const newStream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: "environment" },
                audio: false
            });
            stream = newStream;
            const el = document.getElementById(vId);
            el.srcObject = stream;
            await el.play();
            document.getElementById(vId === 'pv' ? 'pf-frame' : 'ef-frame').classList.add('cam-active');
            return true;
        } catch (e) {
            console.error("Camera Error:", e);
            return false;
        }
    }
</script>
