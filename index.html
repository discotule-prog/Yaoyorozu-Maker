<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MYTH SCANNER 6.2 - FULL INTEGRATED</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet"></script>
    <link href="https://fonts.googleapis.com/css2?family=DotGothic16&display=swap" rel="stylesheet">
    <style>
        :root { --p-color: #00f2ff; --e-color: #ff3c00; --exp-color: #32ff32; --gold: #ffd700; --magic-purple: #9d4edd; --close-btn: #880000; --main-blue: #0044cc; --reset-red: #cc0000; }
        body { font-family: 'DotGothic16', sans-serif; background: #000; color: #fff; margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        #init-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; color: #0f0; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10000; }
        
        #header { height: 40px; background: #222; display: flex; justify-content: space-around; align-items: center; border-bottom: 2px solid #444; flex-shrink: 0; padding: 0 5px; }
        .head-btn { flex: 1; font-size: 0.55rem; height: 26px; border: 1px solid #fff; color: #fff; cursor: pointer; margin: 0 2px; }
        
        .char-area { height: 30%; display: flex; border-bottom: 1px solid #333; padding: 10px; box-sizing: border-box; position: relative; }
        .cam-part { width: 35%; display: flex; align-items: center; justify-content: center; }
        .cam-frame { width: 90px; height: 90px; border: 2px solid #555; background: #111; overflow: hidden; position: relative; border-radius: 8px; }
        .cam-active { border-color: var(--p-color); box-shadow: 0 0 10px var(--p-color); }
        video { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; }
        
        .info-part { width: 65%; display: flex; flex-direction: column; padding-left: 10px; justify-content: center; }
        .visual-card { width: 100%; height: 75px; border: 2px solid #fff; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #111; position: relative; border-radius: 4px; }
        .stat-text { font-size: 0.65rem; color: #ccc; margin-top: 2px; line-height: 1.2; }
        .bar-container { width: 100%; margin-top: 4px; }
        .bar-bg { width: 100%; height: 8px; background: #222; border: 1px solid #666; overflow: hidden; }
        .bar-fill { height: 100%; width: 0%; transition: width 0.4s ease-out; }
        
        #mid-ui { height: 155px; background: #111; border-top: 2px solid #444; display: flex; flex-direction: column; align-items: center; padding: 5px; flex-shrink: 0; }
        #msg { font-size: 0.75rem; color: #0f0; height: 50px; text-align: center; display: flex; align-items: center; justify-content: center; white-space: pre-wrap; width: 90%; }
        
        .btn-row { display: flex; gap: 6px; width: 95%; justify-content: center; margin-bottom: 6px; }
        button { flex: 1; height: 38px; font-family: 'DotGothic16'; border: 2px solid #fff; color: #fff; background: #444; font-size: 0.65rem; cursor: pointer; }
        button:disabled { opacity: 0.25; }

        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 100; display: none; flex-direction: column; align-items: center; padding: 20px; box-sizing: border-box; }
        .scroll-list { width: 100%; overflow-y: auto; display: flex; flex-direction: column; align-items: center; gap: 10px; }
        
        .shake { animation: shake-anim 0.3s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake-anim { 10%, 90% { transform: translate3d(-2px, 0, 0); } 20%, 80% { transform: translate3d(3px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-6px, 0, 0); } }
    </style>
</head>
<body>

<div id="init-overlay">
    <h1 style="margin-bottom:10px;">MYTH SCANNER 6.2</h1>
    <div id="init-msg">SYSTEM INITIALIZING...</div>
    <button id="start-btn" onclick="startGame()" style="display:none; margin-top:20px; padding:15px 40px; background:var(--main-blue); border-radius:8px; border:none; color:white;">LINK START</button>
</div>

<div id="header">
    <button onclick="if(confirm('RESET?')){localStorage.clear();location.reload();}" class="head-btn" style="background:var(--reset-red);">RESET</button>
    <button onclick="openLibrary()" class="head-btn" style="background:#555;">COLLECTION</button>
    <button id="sp-btn" onclick="openSkillMenu()" class="head-btn" style="background:var(--magic-purple);">SKILL UP (0)</button>
</div>

<div class="char-area" id="p-area">
    <div class="cam-part"><div class="cam-frame"><video id="pv" autoplay playsinline muted></video></div></div>
    <div class="info-part">
        <div class="visual-card">
            <div id="p-elem" style="position:absolute; top:2px; left:5px;"></div>
            <div id="p-rare" style="position:absolute; top:2px; right:5px; font-size:0.5rem; background:#fff; color:#000; padding:1px 3px;">-</div>
            <div id="p-sym" style="font-size:1.8rem;">‚öîÔ∏è</div>
            <div id="p-name" style="font-size:0.55rem;">WEAPON READY</div>
        </div>
        <div class="stat-text">LV:<span id="p-lv">1</span> HP:<span id="p-hp-cur">1000</span>/<span id="p-hp-max">1000</span></div>
        <div class="bar-container"><div class="bar-bg"><div id="p-fill" class="bar-fill" style="background:var(--p-color); width:100%"></div></div></div>
    </div>
</div>

<div id="mid-ui">
    <div id="msg">INITIALIZING SYSTEM...</div>
    <div class="btn-row">
        <button id="scan-btn" onclick="handleScan()" disabled style="background:var(--main-blue); flex:1.5;">SCAN</button>
        <button id="atk-btn" onclick="handleAttack()" disabled style="background:#aa0000; flex:1.5;">ATTACK</button>
    </div>
    <div class="btn-row">
        <button id="magic-btn" onclick="openMagicMenu()" disabled style="background:var(--magic-purple);">MAGIC</button>
        <button id="item-open-btn" onclick="openItemMenu()" disabled style="background:#008844;">ITEM</button>
        <button id="esc-btn" onclick="handleEscape()" disabled style="background:#555;">ESCAPE</button>
    </div>
</div>

<div class="char-area" id="e-area">
    <div class="cam-part"><div class="cam-frame"><video id="ev" autoplay playsinline muted></video></div></div>
    <div class="info-part">
        <div class="visual-card">
            <div id="e-elem" style="position:absolute; top:2px; left:5px;"></div>
            <div id="e-rare" style="position:absolute; top:2px; right:5px; font-size:0.5rem; background:#fff; color:#000; padding:1px 3px;">-</div>
            <div id="e-sym" style="font-size:1.8rem;">?</div>
            <div id="e-name" style="font-size:0.55rem;">???</div>
        </div>
        <div class="stat-text">HP:<span id="e-hp-cur">0</span>/<span id="e-hp-max">0</span></div>
        <div class="bar-container"><div class="bar-bg"><div id="e-fill" class="bar-fill" style="background:var(--e-color);"></div></div></div>
    </div>
</div>

<div id="magic-overlay" class="overlay"><h2>MAGIC</h2><div id="magic-list" class="scroll-list"></div><button onclick="closeOverlay()" style="margin-top:20px; background:var(--close-btn);">CLOSE</button></div>
<div id="item-overlay" class="overlay"><h2>ITEMS</h2><div id="item-list" class="scroll-list"></div><button onclick="closeOverlay()" style="margin-top:20px; background:var(--close-btn);">CLOSE</button></div>
<div id="skill-overlay" class="overlay"><h2>SKILL UP</h2><div id="skill-points-display"></div><div id="skill-list" class="scroll-list"></div><button onclick="closeOverlay()" style="margin-top:20px; background:var(--close-btn);">CLOSE</button></div>
<div id="bonus-overlay" class="overlay"><h2>VICTORY!</h2><div class="cam-frame" style="width:150px; height:150px; margin:20px;"><video id="bv" autoplay playsinline muted></video></div><button id="get-item-btn" onclick="getBonusItem()" style="background:var(--gold); color:#000; font-weight:bold; padding:20px;">SCAN FOR LOOT</button></div>

<script>
// --- Data ---
const DB_WEAPON = ["ÈåÜ„Å≥„ÅüÁü≠Ââ£","ÈâÑ„ÅÆÂâ£","ÂêçÂàÄÊ≠£ÂÆó","„É¨„Éº„É¥„Ç°„ÉÜ„Ç§„É≥","ÊòüÁ†ï„Åç„ÅÆÊßå"];
const DB_MONSTER = ["ÈáéËâØÁä¨","„ÅØ„Åê„Çå„É°„Çø„É´","Âú∞ÁçÑ„ÅÆÈñÄÁï™","Âè§„ÅÆÈ≠îÈæç","ËôöÁÑ°„ÅÆÁéã"];
const DB_ITEM_FULL = {
    200: {name:"ÈùûÂ∏∏È£ü", rare:"NORMAL", type:"HP RECOVERY", val:100, mode:"fix"},
    201: {name:"„Éë„É≥", rare:"NORMAL", type:"HP RECOVERY", val:200, mode:"fix"},
    202: {name:"Áº∂Ë©∞", rare:"NORMAL", type:"HP RECOVERY", val:300, mode:"fix"},
    203: {name:"Êñ∞ÈÆÆÈáéËèú", rare:"NORMAL", type:"HP RECOVERY", val:400, mode:"fix"},
    204: {name:"Êó¨„ÅÆÈáéËèú", rare:"NORMAL", type:"HP RECOVERY", val:500, mode:"fix"},
    205: {name:"ÊûúÂÆü", rare:"ELITE", type:"HP RECOVERY", val:600, mode:"fix"},
    206: {name:"È´òÁ¥öÊûúÂÆü", rare:"ELITE", type:"HP RECOVERY", val:700, mode:"fix"},
    207: {name:"È™®‰ªò„ÅçËÇâ", rare:"ELITE", type:"HP RECOVERY", val:800, mode:"fix"},
    208: {name:"È™®‰ªò„ÅçËÇâÔºàÂ§ßÔºâ", rare:"ELITE", type:"HP RECOVERY", val:900, mode:"fix"},
    209: {name:"Êê∫Â∏Ø„Éï„É´„Ç≥„Éº„Çπ", rare:"ELITE", type:"HP RECOVERY", val:1000, mode:"fix"},
    210: {name:"ËªüËÜè", rare:"NORMAL", type:"HP RECOVERY", val:0.1, mode:"pct"},
    211: {name:"„Ç®„Éä„Ç∏„Éº„Éâ„É™„É≥„ÇØ", rare:"NORMAL", type:"HP RECOVERY", val:0.2, mode:"pct"},
    212: {name:"Ê†ÑÈ§ä„Éâ„É™„É≥„ÇØ", rare:"NORMAL", type:"HP RECOVERY", val:0.3, mode:"pct"},
    213: {name:"ÂÇ∑Ëñ¨", rare:"NORMAL", type:"HP RECOVERY", val:0.4, mode:"pct"},
    214: {name:"È´òÁ¥öÂÇ∑Ëñ¨", rare:"NORMAL", type:"HP RECOVERY", val:0.5, mode:"pct"},
    215: {name:"„Éù„Éº„Ç∑„Éß„É≥", rare:"ELITE", type:"HP RECOVERY", val:0.6, mode:"pct"},
    216: {name:"„Éè„Ç§„Éù„Éº„Ç∑„Éß„É≥", rare:"ELITE", type:"HP RECOVERY", val:0.7, mode:"pct"},
    217: {name:"„Ç®„ÇØ„Çπ„Éù„Éº„Ç∑„Éß„É≥", rare:"ELITE", type:"HP RECOVERY", val:0.8, mode:"pct"},
    218: {name:"ËÅñÊ∞¥", rare:"LEGEND", type:"HP RECOVERY", val:0.9, mode:"pct"},
    219: {name:"Á•ûÊßò„ÅÆÈõ´", rare:"LEGEND", type:"HP RECOVERY", val:1.0, mode:"pct"},
    220: {name:"ÊùæÊòé", rare:"NORMAL", type:"ELEMENTAL ATTACK", elem:"üî•", val:0.1},
    221: {name:"Ê∞¥È¢®Ëàπ", rare:"NORMAL", type:"ELEMENTAL ATTACK", elem:"üíß", val:0.1},
    222: {name:"Â£ä„Çå„ÅüÊ©üÊ¢∞", rare:"NORMAL", type:"ELEMENTAL ATTACK", elem:"‚ö°", val:0.1},
    223: {name:"Ëî¶", rare:"NORMAL", type:"ELEMENTAL ATTACK", elem:"üåø", val:0.1},
    224: {name:"ÁÅ´ÁÇéÁì∂", rare:"NORMAL", type:"ELEMENTAL ATTACK", elem:"üî•", val:0.2},
    225: {name:"Ê∞¥ÈâÑÁ†≤", rare:"NORMAL", type:"ELEMENTAL ATTACK", elem:"üíß", val:0.2},
    226: {name:"„Éì„É™„Éì„É™„Éû„Ç∑„É≥", rare:"NORMAL", type:"ELEMENTAL ATTACK", elem:"‚ö°", val:0.2},
    227: {name:"ËçäÊ£ò", rare:"NORMAL", type:"ELEMENTAL ATTACK", elem:"üåø", val:0.2},
    228: {name:"ÊâãÊ¶¥Âºæ", rare:"NORMAL", type:"ELEMENTAL ATTACK", elem:"üî•", val:0.3},
    229: {name:"ÊîæÊ∞¥„Éõ„Éº„Çπ", rare:"NORMAL", type:"ELEMENTAL ATTACK", elem:"üíß", val:0.3},
    230: {name:"ÈõªÊ∞ó„Ç∑„Éß„ÉÉ„ÇØ", rare:"NORMAL", type:"ELEMENTAL ATTACK", elem:"‚ö°", val:0.3},
    231: {name:"ÊúâÊØíÊ§çÁâ©", rare:"NORMAL", type:"ELEMENTAL ATTACK", elem:"üåø", val:0.3},
    232: {name:"ÁÅ´ÁÇéÊîæÂ∞ÑÂô®", rare:"ELITE", type:"ELEMENTAL ATTACK", elem:"üî•", val:0.4},
    233: {name:"È´òÂúßÊ¥óÊµÑÊ©ü", rare:"ELITE", type:"ELEMENTAL ATTACK", elem:"üíß", val:0.4},
    234: {name:"„Çπ„Çø„É≥„Ç¨„É≥", rare:"ELITE", type:"ELEMENTAL ATTACK", elem:"‚ö°", val:0.4},
    235: {name:"È£üËô´Ê§çÁâ©", rare:"ELITE", type:"ELEMENTAL ATTACK", elem:"üåø", val:0.4},
    236: {name:"ÁàÜÂºæ", rare:"LEGEND", type:"ELEMENTAL ATTACK", elem:"üî•", val:0.5},
    237: {name:"„Ç¶„Ç©„Éº„Çø„Éº„Ç´„ÉÉ„Çø„Éº", rare:"LEGEND", type:"ELEMENTAL ATTACK", elem:"üíß", val:0.5},
    238: {name:"„Ç®„É¨„Ç≠„ÉÜ„É´", rare:"LEGEND", type:"ELEMENTAL ATTACK", elem:"‚ö°", val:0.5},
    239: {name:"Âæ°Á•ûÊú®„ÅÆÊûù", rare:"LEGEND", type:"ELEMENTAL ATTACK", elem:"üåø", val:0.5},
    240: {name:"È¢®ÈÇ™„Ç¶„Ç§„É´„Çπ", rare:"NORMAL", type:"DEBUFF_DEF", val:0.1},
    241: {name:"„Çµ„É≥„Éó„É´ÁóÖÂéüËèå", rare:"NORMAL", type:"DEBUFF_DEF", val:0.2},
    242: {name:"‰∫∫Â∑•„Ç¶„Ç§„É´„Çπ", rare:"NORMAL", type:"DEBUFF_DEF", val:0.3},
    243: {name:"„Ç§„É≥„Éï„É´„Ç®„É≥„Ç∂", rare:"ELITE", type:"DEBUFF_DEF", val:0.4},
    244: {name:"Êú™Áü•„ÅÆ„Ç¶„Ç§„É´„Çπ", rare:"LEGEND", type:"DEBUFF_DEF", val:0.5},
    245: {name:"„Ç™„É´„Ç¥„Éº„É´", rare:"NORMAL", type:"DEBUFF_ATK", val:0.1},
    246: {name:"ÂÆâÁú†Êûï", rare:"NORMAL", type:"DEBUFF_ATK", val:0.2},
    247: {name:"„ÇÑ„ÇãÊ∞ó„Ç™„Éï„Çπ„Ç§„ÉÉ„ÉÅ", rare:"NORMAL", type:"DEBUFF_ATK", val:0.3},
    248: {name:"‰∏ñÁïåË™¨Êïô„ÉÜ„Éº„Éó", rare:"ELITE", type:"DEBUFF_ATK", val:0.4},
    249: {name:"ËÉ∏Á≥ûÊò†ÂÉèÈõÜ", rare:"LEGEND", type:"DEBUFF_ATK", val:0.5},
    250: {name:"Ê§çÁâ©Á≥ª„Éó„É≠„ÉÜ„Ç§„É≥", rare:"NORMAL", type:"BUFF_DEF", val:0.1},
    251: {name:"ÂãïÁâ©Á≥ª„Éó„É≠„ÉÜ„Ç§„É≥", rare:"NORMAL", type:"BUFF_DEF", val:0.2},
    252: {name:"Á≠ãËÇâÂ¢óÂº∑Ââ§", rare:"NORMAL", type:"BUFF_DEF", val:0.3},
    253: {name:"Á≠ãËÇâÂ¢óÂº∑Ââ§", rare:"ELITE", type:"BUFF_DEF", val:0.4},
    254: {name:"ÂêàÊ≥ï„Éâ„É©„ÉÉ„Ç∞", rare:"LEGEND", type:"BUFF_DEF", val:0.5},
    255: {name:"Ê§çÁâ©Á≥ª„Éó„É≠„ÉÜ„Ç§„É≥", rare:"NORMAL", type:"BUFF_ATK", val:0.1},
    256: {name:"ÂãïÁâ©Á≥ª„Éó„É≠„ÉÜ„Ç§„É≥", rare:"NORMAL", type:"BUFF_ATK", val:0.2},
    257: {name:"Á≠ãËÇâÂ¢óÂº∑Ââ§", rare:"NORMAL", type:"BUFF_ATK", val:0.3},
    258: {name:"Á≠ãËÇâÂ¢óÂº∑Ââ§", rare:"ELITE", type:"BUFF_ATK", val:0.4},
    259: {name:"ÂêàÊ≥ï„Éâ„É©„ÉÉ„Ç∞", rare:"LEGEND", type:"BUFF_ATK", val:0.5},
    260: {name:"ÁÖôÁéâ", rare:"NORMAL", type:"ESCAPE", eff:"escape"},
    261: {name:"Âπ∏ÈÅã„ÅÆÁ£ÅÁü≥", rare:"LEGEND", type:"LUCKY ITEM", eff:"none"},
    262: {name:"‰∏çÊÄùË≠∞„Å™Á†ÇÊôÇË®à", rare:"LEGEND", type:"TIME LOOP", eff:"extra"},
    263: {name:"„Çæ„Éº„É≥„ÅÆÂøÉÂæó", rare:"ELITE", type:"ATK FLAG", eff:"m_rec"}, 
    264: {name:"„Éú„ÇØ„Çµ„Éº„Ç∑„É•„Éº„Ç∫", rare:"ELITE", type:"DFE FLAG", eff:"atk_up"},
    265: {name:"Ëµ§„ÅÑ„Éû„É≥„Éà", rare:"ELITE", type:"ATTRIBUTE CHANGE", eff:"fire_change"},
    266: {name:"Èùí„ÅÑËÖïËº™", rare:"ELITE", type:"ATTRIBUTE CHANGE", eff:"water_change"},
    267: {name:"ÈªÑËâ≤„ÅÆ„Éî„Ç¢„Çπ", rare:"ELITE", type:"ATTRIBUTE CHANGE", eff:"elec_change"},
    268: {name:"Á∑ë„ÅÆÊåáËº™", rare:"ELITE", type:"ATTRIBUTE CHANGE", val:10, eff:"leaf_change"},
    269: {name:"Ëôπ„ÅÆ„Åã„Åë„Çâ", rare:"LEGEND", type:"ATTRIBUTE CHANGE", eff:"all_change"},
    270: {name:"Áô∫ÁÅ´ÁáÉÊñô", rare:"ELITE", type:"FIELD CHANGE", elem:"üî•"},
    271: {name:"Èõ®Èõ≤Áô∫ÁîüÊ©ü", rare:"ELITE", type:"FIELD CHANGE", elem:"üíß"},
    272: {name:"Á£ÅÂ†¥Áô∫ÁîüË£ÖÁΩÆ", rare:"ELITE", type:"FIELD CHANGE", elem:"‚ö°"},
    273: {name:"Ë∂ÖÊàêÈï∑‰øÉÈÄ≤Ââ§", rare:"ELITE", type:"FIELD CHANGE", elem:"üåø"},
    274: {name:"ÊØíÈáù", rare:"NORMAL", type:"POISON", eff:"instant"},
    275: {name:"„ÇÆ„É£„É≥„Éñ„É©„Éº„ÅÆ„Çµ„Ç§„Ç≥„É≠", rare:"ELITE", type:"DICE", eff:"gamble"},
    276: {name:"„Éö„É≥„Ç≠", rare:"NORMAL", type:"PAINT", eff:"paint"},
    277: {name:"Ë¶öÊÇü„ÅÆ„Çπ„Çπ„É°", rare:"ELITE", type:"ATK ONLY", eff:"atk_sac"},
    278: {name:"‰∫Ä„ÅÆÁî≤ÁæÖ", rare:"ELITE", type:"DFE ONLY", eff:"def_sac"},
    279: {name:"ÁΩ†", rare:"NORMAL", type:"TRAP ITEM", eff:"trap"},
    280: {name:"Âè§„Å≥„Åü„É©„É≥„Éó", rare:"LEGEND", type:"ARTIFACT"},
    281: {name:"‰Ωï„Åã„ÅÆÁ•ûÊßò„ÅÆÂÉè", rare:"LEGEND", type:"ARTIFACT"},
    282: {name:"Ë™∞„Åã„ÅÆÊó•Ë®ò", rare:"LEGEND", type:"ARTIFACT"},
    283: {name:"Êµ∑Ë≥ä„ÅÆÈäÄË≤®", rare:"LEGEND", type:"ARTIFACT"},
    284: {name:"Êõ∏„Åë„Å™„ÅÑ‰∏áÂπ¥Á≠Ü", rare:"NORMAL", type:"ARTIFACT"},
    285: {name:"Êù±Ê¥ã„ÅÆÊ∞¥Â¢®Áîª", rare:"NORMAL", type:"ARTIFACT"},
    286: {name:"Ë£∏„ÅÆÁéãÊßò„ÅÆÊúç", rare:"ELITE", type:"ARTIFACT"},
    287: {name:"Áõ∏ÂØæÊÄßÁêÜË´ñÂéüÊú¨ÔºàÂÜôÔºâ", rare:"ELITE", type:"ARTIFACT"},
    288: {name:"Èôê„Çä„Å™„ÅèÁúüÂÜÜ„Å´Ëøë„ÅÑÁü≥", rare:"LEGEND", type:"ARTIFACT"},
    289: {name:"ÂÜÜÂë®ÁéáÊúÄÂæå„ÅÆÊï∞Â≠ó", rare:"ELITE", type:"ARTIFACT"},
    290: {name:"Ë™∞„ÇÇÁü•„Çâ„Å™„ÅÑÁâ©Ë™û", rare:"LEGEND", type:"ARTIFACT"},
    291: {name:"Êº¢„ÅÆÊµ™Êº´", rare:"LEGEND", type:"ARTIFACT"},
    292: {name:"Âè§‰ª£„ÅÆ„Éá„Ç∏„Çø„É´ÊôÇË®à", rare:"ELITE", type:"ARTIFACT"},
    293: {name:"ÂÅΩÂÖ∏", rare:"ELITE", type:"ARTIFACT"},
    294: {name:"„Çµ„É≥„Çø„ÅÆÈ´≠", rare:"NORMAL", type:"ARTIFACT"},
    295: {name:"„Çµ„É≥„Çø„ÅÆÈ´≠ÔºàÊú¨Áâ©Ôºâ", rare:"LEGEND", type:"ARTIFACT"},
    296: {name:"Â§©‰Ωø„ÅÆ„Çè„Å£„Åã", rare:"LEGEND", type:"ARTIFACT"},
    297: {name:"Èæç„ÅÆÁ≥û", rare:"LEGEND", type:"ARTIFACT"},
    298: {name:"Áü≥", rare:"NORMAL", type:"STONE"},
    299: {name:"ËÅñÊõ∏", rare:"LEGEND", type:"BIBLE", eff:"bible"}
};

const ELEMENTS = { "üî•": "üåø", "üåø": "‚ö°", "‚ö°": "üíß", "üíß": "üî•" };
const MAGIC_INFO = {
    H: { n: "„Éí„Éº„É´", s: "‚ú®" }, F: { n: "„Éï„Ç°„Ç§„Ç¢", s: "üî•" }, W: { n: "„Ç¶„Ç©„Éº„Çø„Éº", s: "üíß" },
    L: { n: "„É©„Ç§„Éà„Éã„É≥„Ç∞", s: "‚ö°" }, G: { n: "„Ç¨„Ç§„Ç¢", s: "üåø" }, K: { n: "„Ç´„Éº„Çπ", s: "üíÄ" },
    B: { n: "„Éñ„É¨„Ç§„ÇØ", s: "‚öîÔ∏è" }, R: { n: "„Éñ„É¨„Ç§„Éñ", s: "‚úä" }, S: { n: "„Ç∑„Éº„É´", s: "üõ°Ô∏è" }
};

// --- Variables ---
let lv=1, exp=0, php=1000, pMax=1000, patk=120, pdef=60, pelem="üî•", inventory=[], skillPoints=0;
let magicLv = {H:1, F:0, W:0, L:0, G:0, B:0, K:0, S:0, R:0};
let net, mode="W", ehp=0, eMax=0, eatk=0, edef=0, eelem="", stream=null;

// Êà¶Èóò‰∏≠„ÅÆÁä∂ÊÖãÁÆ°ÁêÜ
let hasUsedItemThisTurn = false; // „Ç¢„Ç§„ÉÜ„É†1„Çø„Éº„É≥1ÂõûÂà∂ÈôêÁî®
let magicCommandUsed = false;    // È≠îÊ≥ï„Ç≥„Éû„É≥„ÉâÂ∞ÅÂç∞Áî®
let isSureHit = false; 
let isPerfectEvasion = false; 
let trapTimer = 0;

// Êóß„Éê„Éº„Ç∏„Éß„É≥„ÅÆÂêçÊÆãÔºàÂÄãÂà•Âà∂Èôê„Çí‰Ωø„Çè„Å™„ÅÑ„Å™„ÇâÂâäÈô§OKÔºâ
let magicUsedThisBattle = {H:false,F:false,W:false,L:false,G:false,B:false,K:false,S:false,R:false};

let library = JSON.parse(localStorage.getItem('myth_v6_lib')) || { W: {}, M: {}, I: {} };

// --- Core Logic ---
async function init() {
    const saved = JSON.parse(localStorage.getItem('myth_v6_save')) || {};
    if(saved.lv) { lv=saved.lv; exp=saved.exp; pMax=saved.pMax; magicLv=saved.magicLv; skillPoints=saved.skillPoints; inventory=saved.inventory; }
    php = pMax;
    updateUI();
    try {
        net = await mobilenet.load();
        document.getElementById('init-msg').innerText = "SYSTEM READY";
        document.getElementById('start-btn').style.display = 'block';
    } catch(e) { alert("AI Load Error"); }
}

async function startGame() {
    await switchCamera('P');
    document.getElementById('init-overlay').style.display = 'none';
    document.getElementById('scan-btn').disabled = false;
    document.getElementById('msg').innerText = "Ê≠¶Âô®„Çí„Çπ„Ç≠„É£„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ";
}

async function switchCamera(target) {
    if(stream) stream.getTracks().forEach(t => t.stop());
    const vId = {P:'pv', E:'ev', B:'bv'}[target];
    const video = document.getElementById(vId);
    if(!video) return;
    stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
    video.srcObject = stream;
    video.style.display = 'block';
}

async function handleScanSuccess(label) {
    if (mode === "W") {
        // Ê≠¶Âô®„Çπ„Ç≠„É£„É≥
        setPlayerWeapon(label);
        mode = "E"; // Ê¨°„ÅØÊïµ„Çπ„Ç≠„É£„É≥
        document.getElementById('scan-btn').innerText = "ENEMY SCAN";
        alert("Ê≠¶Âô®„ÇíÁôªÈå≤„Åó„Åæ„Åó„Åü„ÄÇÊ¨°„ÅØÊïµ„Çí„Çπ„Ç≠„É£„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");

    } else if (mode === "E") {
        // Êïµ„Çπ„Ç≠„É£„É≥
        setEnemy(label);
        mode = "B"; // Êà¶ÈóòÈñãÂßã
        startBattle();

    } else if (mode === "I") {
        // „Ç¢„Ç§„ÉÜ„É†„Çπ„Ç≠„É£„É≥ÔºàÂãùÂà©ÂæåÔºâ
        getBonusItem(); // ÂÖà„Åª„Å©‰ΩúÊàê„Åó„Åü„É¨„Ç¢Â∫¶ÊäΩÈÅ∏Ê©üËÉΩ‰ªò„Åç„ÅÆÈñ¢Êï∞
        // getBonusItem„ÅÆ‰∏≠„ÅßÊúÄÁµÇÁöÑ„Å´ resetBattle() „ÅåÂëº„Å∞„Çå mode="W" „Å´Êàª„Çã
    }
}

function handleAttack() {
    setBattleBtns(true);
    let isHit = isSureHit || Math.random() > 0.15;
    if(isHit) {
        applyShake();
        const bonus = ELEMENTS[pelem] === eelem ? 1.5 : 1.0;
        let dmg = Math.floor(Math.max(50, (patk * bonus) - (edef * 0.2)));
        if(isSureHit) dmg = Math.floor(dmg * 1.5);
        ehp = Math.max(0, ehp - dmg);
        document.getElementById('msg').innerText = `üí• ${dmg}„ÉÄ„É°„Éº„Ç∏ÔºÅ`;
    } else {
        document.getElementById('msg').innerText = "üí® „Éü„ÇπÔºÅ";
    }
    isSureHit = false;
    updateUI();
    setTimeout(() => { if(ehp <= 0) showBonus(); else enemyTurn(); }, 1000);
}

function enemyTurn() {
    // ÁΩ†„ÅÆÁä∂ÊÖã„ÉÅ„Çß„ÉÉ„ÇØ
    if(trapTimer > 0) { 
        trapTimer--; 
        if(Math.random() < 0.5) { 
            document.getElementById('msg').innerText = "ÁΩ†„Å´„Åã„Åã„Å£„Å¶„ÅÑ„ÇãÔºÅ"; 
            setTimeout(()=>setBattleBtns(false), 1000); 
            return; 
        } 
    }

    document.getElementById('msg').innerText = "Êïµ„ÅÆÊîªÊíÉÔºÅ";
    
    setTimeout(() => {
        // ÂõûÈÅø„ÅÆÂà§ÂÆö
        if(isPerfectEvasion) { 
            document.getElementById('msg').innerText = "üí® ÂõûÈÅøÔºÅ"; 
            isPerfectEvasion = false; 
            setBattleBtns(false); 
            return; 
        }

        applyShake();
        let dmg = Math.floor(Math.max(30, eatk - (pdef * 0.2)));
        php = Math.max(0, php - dmg);
        document.getElementById('msg').innerText = `‚ö†Ô∏è ${dmg}„ÅÆ„ÉÄ„É°„Éº„Ç∏ÔºÅ`;
        updateUI();

        // ÊïóÂåó„ÅãÁ∂öË°å„Åã„ÅÆÂà§ÂÆö
        if(php <= 0) { 
            playerDeath(); // ÊïóÂåóÂá¶ÁêÜ„Å∏ÔºàHPÂÖ®Âø´„É™„Çª„ÉÉ„ÉàÔºâ
        } else { 
            setBattleBtns(false); // „Éó„É¨„Ç§„É§„Éº„ÅÆ„Çø„Éº„É≥„Å´Êàª„Åô
        }
    }, 1000);
}

// --- Menu Systems ---
function openMagicMenu() {
    const list = document.getElementById('magic-list'); list.innerHTML = "";
    for(let k in magicLv) {
        if(magicLv[k] > 0) {
            const b = document.createElement('button');
            b.innerHTML = `${MAGIC_INFO[k].s} ${MAGIC_INFO[k].n} (Lv.${magicLv[k]}) ${magicUsedThisBattle[k]?'[Á©∫]':''}`;
            b.disabled = magicUsedThisBattle[k];
            b.onclick = () => castMagic(k);
            list.appendChild(b);
        }
    }
    document.getElementById('magic-overlay').style.display = 'flex';
}

// --- È≠îÊ≥ï„Ç∑„Çπ„ÉÜ„É†Ôºà‰øÆÊ≠£ÁâàÔºâ ---
function castMagic(type) {
    // È≠îÊ≥ï„ÇíÁô∫Âãï„Åó„Åü„Çâ„ÄÅ„Åì„ÅÆÊà¶Èóò‰∏≠„ÄåMAGIC„Éú„Çø„É≥„ÄçËá™‰Ωì„ÇíÂ∞ÅÂç∞„Åô„Çã„Éï„É©„Ç∞„ÇíÁ´ã„Å¶„Çã
    magicCommandUsed = true; 
    
    const mlv = magicLv[type];
    const info = MAGIC_INFO[type];
    let msg = `${info.s} ${info.n} Lv.${mlv}ÔºÅ\n`;
    
    // „É°„Éã„É•„Éº„ÇíÈñâ„Åò„Çã
    document.getElementById('magic-overlay').style.display = 'none';

    // ÂäπÊûúÂá¶ÁêÜ
    if (type === 'H') {
        let heal = Math.floor(pMax * 0.3);
        php = Math.min(pMax, php + heal);
        msg += `HP„Åå ${heal} ÂõûÂæ©ÔºÅ`;
    } else {
        applyShake();
        let dmg = mlv * 100;
        ehp = Math.max(0, ehp - dmg);
        msg += `${dmg} „ÉÄ„É°„Éº„Ç∏ÔºÅ`;
    }

    document.getElementById('msg').innerText = msg;
    updateUI();

    // È≠îÊ≥ï‰ΩøÁî®Âæå„ÅØÂç≥Â∫ß„Å´„Éú„Çø„É≥„ÇíÁÑ°ÂäπÂåñ
    setBattleBtns(true);

    setTimeout(() => {
        if (ehp <= 0) showBonus();
        else enemyTurn();
    }, 1500);
}

function openItemMenu() {
    const list = document.getElementById('item-list'); list.innerHTML = "";
    inventory.forEach((gid, i) => {
        const itm = DB_ITEM_FULL[gid] || {name:"‰∏çÊòé„Å™Áü≥", rare:"NORMAL"};
        const b = document.createElement('button');
        b.innerHTML = `[${itm.rare}] ${itm.name}`;
        b.onclick = () => { if(!hasUsedItemThisTurn) { useItem(gid, i); } else { alert("1„Çø„Éº„É≥1Âõû„Åæ„Åß„Åß„Åô"); } };
        list.appendChild(b);
    });
    document.getElementById('item-overlay').style.display = 'flex';
}

function useItem(gid, idx) {
    const itm = DB_ITEM_FULL[gid];
    if(itm && itm.type === "HP RECOVERY") php = Math.min(pMax, php + itm.val);
    inventory.splice(idx, 1);
    hasUsedItemThisTurn = true;
    document.getElementById('item-overlay').style.display = 'none';
    document.getElementById('msg').innerText = `${itm?itm.name:'„Ç¢„Ç§„ÉÜ„É†'}„Çí‰ΩøÁî®„Åó„ÅüÔºÅ`;
    updateUI();
    if(ehp <= 0) showBonus();
}

function openSkillMenu() {
    document.getElementById('skill-points-display').innerText = `„Éù„Ç§„É≥„Éà: ${skillPoints}`;
    const list = document.getElementById('skill-list'); list.innerHTML = "";
    for(let k in magicLv) {
        const b = document.createElement('button');
        const cost = magicLv[k] + 1;
        b.innerHTML = `${MAGIC_INFO[k].n} Lv.${magicLv[k]} -> ${magicLv[k]+1} (Ê∂àË≤ª:${cost})`;
        b.onclick = () => { if(skillPoints >= cost) { skillPoints -= cost; magicLv[k]++; save(); openSkillMenu(); updateUI(); } };
        list.appendChild(b);
    }
    document.getElementById('skill-overlay').style.display = 'flex';
}

function updateUI() {
    document.getElementById('p-lv').innerText = lv;
    document.getElementById('p-hp-cur').innerText = php;
    document.getElementById('p-hp-max').innerText = pMax;
    document.getElementById('p-fill').style.width = (php/pMax*100) + "%";
    
    document.getElementById('e-hp-cur').innerText = ehp;
    document.getElementById('e-hp-max').innerText = eMax;
    document.getElementById('e-fill').style.width = eMax > 0 ? (ehp/eMax*100) + "%" : "0%";
    
    document.getElementById('sp-btn').innerText = `SKILL UP (${skillPoints})`;

    // „Ç¢„Ç§„ÉÜ„É†ÂèéÈõÜÁéá„ÅÆË®àÁÆó
    const total = Object.keys(DB_ITEM_FULL).length;
    const collected = Object.keys(library.I || {}).length;
    const percent = total > 0 ? Math.floor((collected / total) * 100) : 0;

    // „É°„ÉÉ„Çª„Éº„Ç∏Ê¨Ñ„ÅÆÊú´Â∞æ„Å´„ÄÅÈáçË§á„Åó„Å™„ÅÑ„Çà„ÅÜ„Å´ÂèéÈõÜÁéá„ÇíË°®Á§∫
    const msgEl = document.getElementById('msg');
    // „Åô„Åß„Å´ÂèéÈõÜÁéá„ÅåÊõ∏„ÅÑ„Å¶„ÅÇ„ÇãÂ†¥Âêà„ÅØ„ÄÅ‰∏ÄÊó¶„Åù„Çå‰ª•Ââç„ÅÆ„ÉÜ„Ç≠„Çπ„Éà„Å†„ÅëÂèñ„ÇäÂá∫„Åô
    let baseMsg = msgEl.innerText.split("\n(„Ç¢„Ç§„ÉÜ„É†ÂèéÈõÜÁéá")[0];
    msgEl.innerText = baseMsg + `\n(„Ç¢„Ç§„ÉÜ„É†ÂèéÈõÜÁéá: ${percent}%)`;
}
// --- „Éú„Çø„É≥Âà∂Âæ°Ôºà‰øÆÊ≠£ÁâàÔºâ ---
let magicCommandUsed = false; // Êà¶Èóò„Åî„Å®„Å´ÁÆ°ÁêÜ„Åô„Çã„Éï„É©„Ç∞

function setBattleBtns(dis) {
    document.getElementById('atk-btn').disabled = dis;
    document.getElementById('item-open-btn').disabled = dis;
    document.getElementById('esc-btn').disabled = dis;
    
    // È≠îÊ≥ï„Ç≥„Éû„É≥„Éâ„ÅÆÂà∂Âæ°Ôºö
    // dis„ÅåtrueÔºàÊïµ„ÅÆ„Çø„Éº„É≥„Å™„Å©Ôºâ„ÅÆÊôÇ„ÅØÁÑ°Âäπ„ÄÇ
    // dis„ÅåfalseÔºàËá™ÂàÜ„ÅÆ„Çø„Éº„É≥Ôºâ„Åß„ÇÇ„ÄÅÊó¢„Å´È≠îÊ≥ï„Çí‰Ωø„Å£„Å¶„ÅÑ„Çå„Å∞ÁÑ°Âäπ„ÅÆ„Åæ„Åæ„ÄÇ
    const magicBtn = document.getElementById('magic-btn');
    if (magicBtn) {
        magicBtn.disabled = dis || magicCommandUsed;
    }

    if (!dis) hasUsedItemThisTurn = false; 
}

// --- Êà¶Èóò„É™„Çª„ÉÉ„Éà ---
function resetBattle() {
    mode = "W"; // Ê≠¶Âô®„Çπ„Ç≠„É£„É≥„É¢„Éº„Éâ„Å∏Êàª„Çã
    ehp = 0; eMax = 0;
    magicCommandUsed = false; // È≠îÊ≥ïÂ∞ÅÂç∞„ÇíËß£Èô§
    hasUsedItemThisTurn = false;
    
    document.getElementById('scan-btn').disabled = false;
    document.getElementById('scan-btn').innerText = "WEAPON SCAN";
    
    setBattleBtns(true); // „Éê„Éà„É´„Éú„Çø„É≥„ÇíÁÑ°ÂäπÂåñ
    switchCamera('P');   // „Çπ„Ç≠„É£„É≥ÁîªÈù¢„Å∏
    updateUI();
    save();
}

// --- ÂÖ±ÈÄöÂ§âÊï∞Ôºà„ÇÇ„Åó„Ç≥„Éº„Éâ„ÅÆÊúÄÂàù„ÅÆÊñπ„Å´„Å™„ÅÑÂ†¥Âêà„ÅØËøΩÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºâ ---
let library = JSON.parse(localStorage.getItem('myth_v6_lib')) || { W: {}, M: {}, I: {} };

// --- ÂãùÂà©ÊôÇ„ÅÆÂá¶ÁêÜ ---
function showBonus() {
    mode = "I"; 
    document.getElementById('msg').innerText = "ENEMY DEFEATED!\n„Ç¢„Ç§„ÉÜ„É†„Çí„Çπ„Ç≠„É£„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ...";
    
    let gainExp = Math.floor(eMax / 10);
    exp += gainExp;
    if (exp >= lv * 100) {
        lv++;
        exp = 0;
        skillPoints += 2;
        alert("LEVEL UP!");
    }
    
    updateUI();
    save();
    
    setTimeout(() => {
        switchCamera('P'); 
        document.getElementById('scan-btn').innerText = "ITEM SCAN";
    }, 2000);
}

// --- ÊïóÂåóÊôÇ„ÅÆ„É™„Çª„ÉÉ„Éà ---
function playerDeath() {
    alert("ÊïóÂåó„Åó„Åæ„Åó„Åü... HP„ÇíÂõûÂæ©„Åó„Å¶ÊúÄÂàù„Åã„Çâ„ÇÑ„ÇäÁõ¥„Åó„Åæ„Åô„ÄÇ");
    php = pMax; 
    resetBattle(); 
}

// --- „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£ ---
function applyShake() { 
    document.body.classList.add('shake'); 
    setTimeout(() => document.body.classList.remove('shake'), 300); 
    if(navigator.vibrate) navigator.vibrate(100); 
}

function closeOverlay() { 
    document.querySelectorAll('.overlay').forEach(o => o.style.display = 'none'); 
}

function save() { 
    // „Çπ„ÉÜ„Éº„Çø„Çπ„ÅÆ‰øùÂ≠ò
    localStorage.setItem('myth_v6_save', JSON.stringify({lv, exp, pMax, magicLv, skillPoints, inventory})); 
    // Âõ≥Èëë„ÅÆ‰øùÂ≠ò
    localStorage.setItem('myth_v6_lib', JSON.stringify(library)); 
}

function handleEscape() { 
    if(confirm("ÈÄÉ„Åí„Åæ„Åô„ÅãÔºü")) resetBattle(); 
}

// --- „Ç≥„É¨„ÇØ„Ç∑„Éß„É≥ÔºàÂõ≥ÈëëÔºâÈñ¢ÈÄ£ ---
function openLibrary() {
    renderLibrary('W'); 
    document.getElementById('lib-overlay').style.display = 'flex';
}

function renderLibrary(type) {
    const list = document.getElementById('lib-list');
    list.innerHTML = ""; 
    const items = library[type] || {};
    
    if (type === 'I') {
        for (let gid in DB_ITEM_FULL) {
            const data = DB_ITEM_FULL[gid];
            const isUnlocked = items[gid];
            const row = document.createElement('div');
            row.style = "display:flex; justify-content:space-between; padding:8px; border-bottom:1px solid #333; font-size:0.7rem;";
            
            if (isUnlocked) {
                const color = data.rare === 'LEGEND' ? '#ffdf00' : (data.rare === 'ELITE' ? '#00ffff' : '#fff');
                row.innerHTML = `<span style="color:${color}">No.${gid} ${data.name}</span><span style="color:${color}; font-weight:bold;">${data.rare}</span>`;
            } else {
                row.innerHTML = `<span style="color:#444;">No.${gid} ÔºüÔºüÔºüÔºüÔºüÔºü</span><span style="color:#222;">---</span>`;
            }
            list.appendChild(row);
        }
    } else {
        for (let id in items) {
            const data = items[id];
            const row = document.createElement('div');
            row.style = "display:flex; justify-content:space-between; padding:8px; border-bottom:1px solid #333; font-size:0.7rem;";
            row.innerHTML = `<span>${data.e || ''} ${data.t}</span><span style="color:#aaa;">DISCOVERED</span>`;
            list.appendChild(row);
        }
    }
}

// ÂãùÂà©Âæå„ÅÆ„Ç¢„Ç§„ÉÜ„É†Áç≤ÂæóÂá¶ÁêÜ
function getBonusItem() {
    const allGids = Object.keys(DB_ITEM_FULL);
    const getWeight = (rare) => {
        if (rare === "LEGEND") return 5;
        if (rare === "ELITE") return 25;
        return 70;
    };

    let pool = [];
    allGids.forEach(gid => {
        const item = DB_ITEM_FULL[gid];
        const weight = getWeight(item.rare);
        for (let i = 0; i < weight; i++) pool.push(gid);
    });

    const selectedGid = parseInt(pool[Math.floor(Math.random() * pool.length)]);
    const itm = DB_ITEM_FULL[selectedGid];

    if (inventory.length < 8) {
        inventory.push(selectedGid);
        if (!library.I) library.I = {};
        library.I[selectedGid] = { t: itm.name, r: itm.rare, e: "üì¶" };
        alert(`„Äê${itm.rare}„Äë${itm.name} „ÇíÁç≤Âæó„Åó„Åæ„Åó„ÅüÔºÅ`);
    } else {
        alert("ÊåÅ„Å°Áâ©„Åå„ÅÑ„Å£„Å±„ÅÑ„Åß„Åô„Åå„ÄÅÂõ≥Èëë„Å´„ÅØÁôªÈå≤„Åï„Çå„Åæ„Åó„Åü„ÄÇ");
    }
    
    save(); // „Ç¢„Ç§„ÉÜ„É†Áç≤ÂæóÁõ¥Âæå„Å´„Çª„Éº„Éñ
    resetBattle(); 
}

// --- ÂàùÊúüÂåñÂá¶ÁêÜ ---
async function init() {
    // „Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø
    const saved = localStorage.getItem('myth_v6_save');
    if (saved) {
        const d = JSON.parse(saved);
        lv = d.lv; exp = d.exp; pMax = d.pMax; 
        magicLv = d.magicLv; skillPoints = d.skillPoints; inventory = d.inventory;
    }
    php = pMax;

    // AI„ÅÆË™≠„ÅøËæº„ÅøÔºàMobileNetÁ≠â„Åå„ÅÇ„ÇãÂ†¥ÂêàÔºâ
    try {
        if (typeof mobilenet !== 'undefined') {
            net = await mobilenet.load();
        }
    } catch(e) { console.error("AI Load Error", e); }
    
    updateUI();
    document.getElementById('scan-btn').innerText = "WEAPON SCAN";
}

window.onload = init;
</script>
</body>
</html>
