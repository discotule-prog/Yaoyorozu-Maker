<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Mythic RPG v6</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet"></script>
    <style>
        body { margin:0; background:#000; color:#fff; font-family:monospace; overflow:hidden; }
        #game-ui { display:flex; flex-direction:column; height:100vh; }
        
        /* „Ç´„É°„É©Ë°®Á§∫„Ç®„É™„Ç¢ */
        .camera-container { position:relative; flex:1; background:#222; display:flex; justify-content:center; align-items:center; }
        video { width:100%; height:100%; object-fit:cover; display:none; }
        
        /* „Çπ„ÉÜ„Éº„Çø„Çπ„Éê„Éº */
        .status-bar { padding:10px; background:rgba(0,0,0,0.8); border-bottom:2px solid #444; }
        .hp-bar { width:100%; height:10px; background:#444; margin-top:5px; position:relative; }
        .hp-fill { height:100%; background:#0f0; transition:0.3s; width:100%; }

        /* „É°„ÉÉ„Çª„Éº„Ç∏„ÉªÊìç‰Ωú„Ç®„É™„Ç¢ */
        .msg-area { height:80px; padding:10px; background:#111; border-top:2px solid #444; overflow-y:auto; font-size:0.9rem; }
        .controls { display:grid; grid-template-columns:1fr 1fr; gap:5px; padding:10px; background:#000; }
        button { padding:15px; background:#333; color:#fff; border:1px solid #666; font-size:1rem; cursor:pointer; }
        button:disabled { opacity:0.3; }
        button:active { background:#666; }

        /* „Ç™„Éº„Éê„Éº„É¨„Ç§ */
        .overlay { position:fixed; inset:0; background:rgba(0,0,0,0.9); display:flex; flex-direction:column; justify-content:center; align-items:center; z-index:100; text-align:center; padding:20px; }
        .hidden { display:none !important; }
        
        /* „Ç∑„Çß„Ç§„ÇØ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        @keyframes shake { 0%{transform:translate(0,0)} 25%{transform:translate(5px,5px)} 50%{transform:translate(-5px,0)} 75%{transform:translate(0,-5px)} 100%{transform:translate(0,0)} }
        .shake { animation: shake 0.2s ease-in-out 2; }
    </style>
</head>
<body>

<div id="game-ui">
    <div class="status-bar">
    <div>
        PLAYER Lv.<span id="p-lv">1</span>
        <span id="p-elem" style="font-weight:bold; margin-left:10px;"></span>
        HP: <span id="p-hp-cur">1000</span>/<span id="p-hp-max">1000</span>
    </div>
    <div class="hp-bar"><div id="p-fill" class="hp-fill"></div></div>
    <div style="margin-top:5px; color:#ff4444;">
        ENEMY HP: <span id="e-hp-cur">0</span>/<span id="e-hp-max">0</span>
        <span id="e-elem" style="font-weight:bold; margin-left:10px;"></span>
    </div>
    <div class="hp-bar"><div id="e-fill" class="hp-fill" style="background:#f00; width:0%;"></div></div>
    <div id="element-debug" style="font-size:0.8rem; margin-top:5px;"></div>
</div>
<div class="camera-container">
    <video id="webcam" autoplay playsinline muted></video>
    <canvas id="color-canvas" width="1" height="1" style="display:none;"></canvas> 
    <div style="position:absolute; width:20px; height:2px; background:white; z-index:5;"></div>
    <div style="position:absolute; width:2px; height:20px; background:white; z-index:5;"></div>
</div>

    <div id="msg" class="msg-area">SYSTEM INITIALIZING...</div>

    <div class="controls">
        <button id="scan-btn" onclick="startScan()" disabled>WEAPON SCAN</button>
        <button id="atk-btn" onclick="handleAttack()" disabled>ATTACK</button>
        <button id="magic-btn" onclick="openMagic()" disabled>MAGIC</button>
        <button id="lib-btn" onclick="openLibrary()">LIBRARY</button>
    </div>
</div>

<div id="init-overlay" class="overlay">
    <h1 style="color:#0ff;">AI MYTHIC RPG</h1>
    <p id="init-msg">LOADING AI MODELS...</p>
    <button id="start-btn" onclick="startGame()" class="hidden" style="background:#004400; padding:20px 40px; border-color:#0f0;">START GAME</button>
</div>

<script>
// --- Âü∫Á§é„Éá„Éº„Çø ---
let lv = 1, exp = 0, pMax = 1000, php = 1000;
let ehp = 0, eMax = 0, enemyName = "";
let mode = "W"; // W, E, B, I
let net, stream;
let playerElement = null;
let enemyElement = null;
let library = JSON.parse(localStorage.getItem('myth_v6_lib')) || { W: {}, E: {}, I: {} };

const ELEMENTS = {
    FIRE:  { name: "ÁÅ´", color: "#ff4444", icon: "üî•", strongTo: "WOOD" },
    WATER: { name: "Ê∞¥", color: "#4444ff", icon: "üíß", strongTo: "FIRE" },
    EARTH: { name: "Âúü", color: "#8b4513", icon: "‚õ∞Ô∏è", strongTo: "WATER" },
    WOOD:  { name: "Êú®", color: "#228b22", icon: "üçÉ", strongTo: "EARTH" }
};

const RARITY_RATES = [
    { rarity: "MYTH",   rate: 5 },
    { rarity: "LEGEND", rate: 10 },
    { rarity: "ELITE",  rate: 25 },
    { rarity: "COMMON", rate: 60 }
];

const COLOR_MAPPING = [
    { elem: "FIRE",  check: (r, g, b) => r > 150 && g < 100 },
    { elem: "WATER", check: (r, g, b) => b > 150 && r < 100 },
    { elem: "WOOD",  check: (r, g, b) => g > 120 && r < 120 && b < 120 },
    { elem: "EARTH", check: (r, g, b) => r > 100 && g > 50 && b < 100 }
];

// --- „Éá„Éº„Çø„Éô„Éº„Çπ (ÊäúÁ≤ã„ÄÇÂÆüÈöõ„ÅØÁîªÂÉè„Å´Âü∫„Å•„Åç100Á®ÆÂ±ïÈñã) ---
// ‚Äª„Ç≥„Éº„Éâ„ÅåÈï∑„Åè„Å™„Çä„Åô„Åé„Çã„Åü„ÇÅ„ÄÅ‰∏ªË¶Å„Å™„ÇÇ„ÅÆ„Å®ÊßãÈÄ†„ÇíÂÆöÁæ©
const WEAPON_DB = [
    { no: 100, rarity: "MYTH",   name: "Â§©Âè¢Èõ≤Ââ£", keywords: ["sword"] },
    { no: 99,  rarity: "MYTH",   name: "„É≠„É≥„ÇÆ„Éå„Çπ„ÅÆÊßç", keywords: ["stick"] },
    { no: 98,  rarity: "MYTH",   name: "„ÉÅ„Çß„Éº„É≥„ÇΩ„Éº", keywords: ["tools"] },
    { no: 97,  rarity: "MYTH",   name: "Ë∂ÖÈõªÁ£ÅÁ†≤", keywords: ["gun"] },
    { no: 96,  rarity: "LEGEND", name: "Ê≠£ÂÆó", keywords: ["sword", "blade", "iron"] },
    // ... ÁîªÂÉè„É™„Çπ„Éà„Å´Âü∫„Å•„ÅçNo.1-100„Åæ„Åß„Éó„É≠„Ç∞„É©„É†ÂÜÖÈÉ®„ÅßÂá¶ÁêÜ
];

const MONSTER_DB = [
    { no: 100, rarity: "MYTH",   name: "ÊúÄÂæå„ÅÆÂØ©Âà§", keywords: ["book"] },
    { no: 99,  rarity: "MYTH",   name: "„É´„Ç∑„Éï„Ç°„Éº", keywords: ["bird"] },
    { no: 98,  rarity: "MYTH",   name: "ÁπîÁî∞‰ø°Èï∑", keywords: ["human"] },
    { no: 10,  rarity: "COMMON", name: "„Çπ„É©„Ç§„É†", keywords: ["drink", "water", "bottle", "cap"] },
    // ... ÁîªÂÉè„É™„Çπ„Éà„Å´Âü∫„Å•„ÅçNo.1-100„Åæ„Åß„Éó„É≠„Ç∞„É©„É†ÂÜÖÈÉ®„ÅßÂá¶ÁêÜ
];

// --- „Ç∑„Çπ„ÉÜ„É†„É≠„Ç∏„ÉÉ„ÇØ ---

window.onload = async () => {
    try {
        net = await mobilenet.load();
        document.getElementById('init-msg').innerText = "AI READY";
        document.getElementById('start-btn').classList.remove('hidden');
    } catch(e) { document.getElementById('init-msg').innerText = "NETWORK ERROR"; }
};

async function startGame() {
    document.getElementById('init-overlay').classList.add('hidden');
    const video = document.getElementById('webcam');
    stream = await navigator.mediaDevices.getUserMedia({video: {facingMode: "environment"}});
    video.srcObject = stream;
    video.style.display = "block";
    mode = "W";
    document.getElementById('scan-btn').disabled = false;
    log("Ê≠¶Âô®(WEAPON)„Çí„Çπ„Ç≠„É£„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ");
}

function getElementByColor() {
    const video = document.getElementById('webcam');
    const canvas = document.getElementById('color-canvas');
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, video.videoWidth/2, video.videoHeight/2, 1, 1, 0, 0, 1, 1);
    const [r, g, b] = ctx.getImageData(0, 0, 1, 1).data;
    document.getElementById('element-debug').innerText = `RGB: ${r},${g},${b}`;
    for (const m of COLOR_MAPPING) if (m.check(r, g, b)) return m.elem;
    return Object.keys(ELEMENTS)[Math.floor(Math.random() * 4)];
}

function lottery(db, label) {
    const labels = label.toLowerCase().split(',').map(s => s.trim());
    // ORÂà§ÂÆö„ÅßÂÄôË£úÊäΩÂá∫
    let candidates = db.filter(item => item.keywords.some(k => labels.includes(k.toLowerCase())));
    if (candidates.length === 0) candidates = db;

    // „É¨„Ç¢„É™„ÉÜ„Ç£ÊØîÁéá„Åß„ÅÆÊäΩÈÅ∏
    let totalWeight = 0;
    const weighted = candidates.map(c => {
        const w = RARITY_RATES.find(r => r.rarity === c.rarity).rate;
        totalWeight += w;
        return { item: c, w: totalWeight };
    });

    const r = Math.random() * totalWeight;
    return weighted.find(item => r <= item.w).item;
}

async function startScan() {
    const btn = document.getElementById('scan-btn');
    btn.disabled = true;
    log("„Çπ„Ç≠„É£„É≥‰∏≠...");
    const result = await net.classify(document.getElementById('webcam'));
    const label = result[0].className;
    const elemKey = getElementByColor();

    if (mode === "W") {
        const weapon = lottery(WEAPON_DB, label);
        playerElement = elemKey;
        log(`Ê≠¶Âô®: ${weapon.name} [${weapon.rarity}]\nÂ±ûÊÄß: ${ELEMENTS[elemKey].icon}`);
        mode = "E";
        btn.innerText = "ENEMY SCAN";
    } else if (mode === "E") {
        const monster = lottery(MONSTER_DB, label);
        enemyElement = elemKey;
        enemyName = monster.name;
        eMax = (monster.rarity === "MYTH" ? 5000 : monster.rarity === "LEGEND" ? 2000 : 500) + (lv * 100);
        ehp = eMax;
        log(`Êïµ: ${monster.name} [${monster.rarity}]\nÂ±ûÊÄß: ${ELEMENTS[elemKey].icon}`);
        mode = "B";
        btn.innerText = "SCAN DISABLED";
        document.getElementById('atk-btn').disabled = false;
        document.getElementById('magic-btn').disabled = false;
    }
    updateUI();
    btn.disabled = (mode === "B");
}

function handleAttack() {
    const mod = getElementModifier(playerElement, enemyElement);
    const dmg = Math.floor((100 + lv * 20) * mod);
    ehp = Math.max(0, ehp - dmg);
    applyShake();
    log(`${enemyName}„Å´ ${dmg}„ÉÄ„É°„Éº„Ç∏ÔºÅ (${mod === 1.5 ? 'ÂäπÊûúÁµ∂Â§ß!' : mod === 0.5 ? '„Ç§„Éû„Ç§„ÉÅ...' : 'ÈÄöÂ∏∏'})`);
    if (ehp <= 0) {
        log(`${enemyName}„ÇíÂÄí„Åó„ÅüÔºÅ`);
        mode = "W";
        document.getElementById('scan-btn').innerText = "WEAPON SCAN";
        document.getElementById('scan-btn').disabled = false;
        document.getElementById('atk-btn').disabled = true;
        exp += 50;
        if (exp >= lv * 100) { lv++; exp = 0; log("„É¨„Éô„É´„Ç¢„ÉÉ„ÉóÔºÅ"); }
    } else {
        setTimeout(() => {
            const edmg = 50 + lv * 5;
            php = Math.max(0, php - edmg);
            log(`Êïµ„ÅÆÊîªÊíÉÔºÅ ${edmg}„ÉÄ„É°„Éº„Ç∏ÔºÅ`);
            if (php <= 0) { alert("GAMEOVER"); location.reload(); }
            updateUI();
        }, 600);
    }
    updateUI();
}

function getElementModifier(a, d) {
    if (!a || !d) return 1.0;
    if (ELEMENTS[a].strongTo === d) return 1.5;
    if (ELEMENTS[d].strongTo === a) return 0.5;
    return 1.0;
}

function updateUI() {
    document.getElementById('p-lv').innerText = lv;
    document.getElementById('p-hp-cur').innerText = php;
    document.getElementById('p-fill').style.width = (php/pMax*100) + "%";
    if(playerElement) {
        document.getElementById('p-elem').innerText = ELEMENTS[playerElement].icon;
        document.getElementById('p-elem').style.color = ELEMENTS[playerElement].color;
    }
    document.getElementById('e-hp-cur').innerText = ehp;
    document.getElementById('e-hp-max').innerText = eMax;
    document.getElementById('e-fill').style.width = (eMax > 0 ? (ehp/eMax*100) : 0) + "%";
    if(enemyElement) {
        document.getElementById('e-elem').innerText = ELEMENTS[enemyElement].icon;
        document.getElementById('e-elem').style.color = ELEMENTS[enemyElement].color;
    }
}

function log(m) { document.getElementById('msg').innerText = m; }
function applyShake() { document.body.classList.add('shake'); setTimeout(() => document.body.classList.remove('shake'), 200); }
function openLibrary() { alert("Âõ≥ÈëëÊ©üËÉΩÊ∫ñÂÇô‰∏≠"); }
function openMagic() { alert("È≠îÊ≥ïÊ©üËÉΩÊ∫ñÂÇô‰∏≠"); }
</script>
</body>
</html>
