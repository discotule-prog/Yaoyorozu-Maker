<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Mythic RPG v6</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet"></script>
    <style>
        body { margin:0; background:#000; color:#fff; font-family:monospace; overflow:hidden; }
        #game-ui { display:flex; flex-direction:column; height:100vh; }
        
        /* ã‚«ãƒ¡ãƒ©è¡¨ç¤ºã‚¨ãƒªã‚¢ */
        .camera-container { position:relative; flex:1; background:#222; display:flex; justify-content:center; align-items:center; }
        video { width:100%; height:100%; object-fit:cover; display:none; }
        
        /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼ */
        .status-bar { padding:10px; background:rgba(0,0,0,0.8); border-bottom:2px solid #444; }
        .hp-bar { width:100%; height:10px; background:#444; margin-top:5px; position:relative; }
        .hp-fill { height:100%; background:#0f0; transition:0.3s; width:100%; }

        /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ»æ“ä½œã‚¨ãƒªã‚¢ */
        .msg-area { height:80px; padding:10px; background:#111; border-top:2px solid #444; overflow-y:auto; font-size:0.9rem; }
        .controls { display:grid; grid-template-columns:1fr 1fr; gap:5px; padding:10px; background:#000; }
        button { padding:15px; background:#333; color:#fff; border:1px solid #666; font-size:1rem; cursor:pointer; }
        button:disabled { opacity:0.3; }
        button:active { background:#666; }

        /* ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
        .overlay { position:fixed; inset:0; background:rgba(0,0,0,0.9); display:flex; flex-direction:column; justify-content:center; align-items:center; z-index:100; text-align:center; padding:20px; }
        .hidden { display:none !important; }
        
        /* ã‚·ã‚§ã‚¤ã‚¯ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes shake { 0%{transform:translate(0,0)} 25%{transform:translate(5px,5px)} 50%{transform:translate(-5px,0)} 75%{transform:translate(0,-5px)} 100%{transform:translate(0,0)} }
        .shake { animation: shake 0.2s ease-in-out 2; }
    </style>
</head>
<body>

<div id="game-ui">
    <div class="status-bar">
    <div>
        PLAYER Lv.<span id="p-lv">1</span>
        <span id="p-elem" style="font-weight:bold; margin-left:10px;"></span>
        HP: <span id="p-hp-cur">1000</span>/<span id="p-hp-max">1000</span>
    </div>
    <div class="hp-bar"><div id="p-fill" class="hp-fill"></div></div>
    <div style="margin-top:5px; color:#ff4444;">
        ENEMY HP: <span id="e-hp-cur">0</span>/<span id="e-hp-max">0</span>
        <span id="e-elem" style="font-weight:bold; margin-left:10px;"></span>
    </div>
    <div class="hp-bar"><div id="e-fill" class="hp-fill" style="background:#f00; width:0%;"></div></div>
    <div id="element-debug" style="font-size:0.8rem; margin-top:5px;"></div>
</div>
<div class="camera-container">
    <video id="webcam" autoplay playsinline muted></video>
    <canvas id="color-canvas" width="1" height="1" style="display:none;"></canvas> 
    <div style="position:absolute; width:20px; height:2px; background:white; z-index:5;"></div>
    <div style="position:absolute; width:2px; height:20px; background:white; z-index:5;"></div>
</div>

    <div id="msg" class="msg-area">SYSTEM INITIALIZING...</div>

    <div class="controls">
        <button id="scan-btn" onclick="startScan()" disabled>WEAPON SCAN</button>
        <button id="atk-btn" onclick="handleAttack()" disabled>ATTACK</button>
        <button id="magic-btn" onclick="openMagic()" disabled>MAGIC</button>
        <button id="lib-btn" onclick="openLibrary()">LIBRARY</button>
    </div>
</div>

<div id="init-overlay" class="overlay">
    <h1 style="color:#0ff;">AI MYTHIC RPG</h1>
    <p id="init-msg">LOADING AI MODELS...</p>
    <button id="start-btn" onclick="startGame()" class="hidden" style="background:#004400; padding:20px 40px; border-color:#0f0;">START GAME</button>
</div>

<script>
// --- ã‚²ãƒ¼ãƒ å¤‰æ•° ---
// ...ï¼ˆæ—¢å­˜ã® let lv=1, exp=0, ... ãªã©ã®ä¸‹ã«è¿½è¨˜ï¼‰...
let mode = "W"; // W:Weapon, E:Enemy, B:Battle, I:Item

// â˜…è¿½è¨˜ï¼šãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨æ•µã«ä»˜ä¸ã•ã‚Œã‚‹å±æ€§ã‚’ä¿æŒã™ã‚‹å¤‰æ•°
let playerElement = null; 
let enemyElement = null;

// ...ï¼ˆELEMENTSå®šç¾©ã¨getElementModifieré–¢æ•°ã®ä¸‹ã«è¿½è¨˜ï¼‰...

// â˜…è¿½è¨˜ï¼šæ­¦å™¨ãƒªã‚¹ãƒˆã®ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆã«åŸºã¥ãä½œæˆï¼‰
const WEAPON_MASTER_DB = [
    // MYTH (No. 97-100)
    { no: 97, rarity: "MYTH", name: "ãƒ‰ãƒ©ã‚´ãƒ³ã‚ºãƒ­ãƒƒãƒ‰", keywords: ["rod", "stick", "wood", "tool"] },
    { no: 98, rarity: "MYTH", name: "ã‚ªãƒªãƒãƒ«ã‚³ãƒ³ãƒ€ã‚¬ãƒ¼", keywords: ["knife", "blade", "iron", "steel"] },
    { no: 99, rarity: "MYTH", name: "ãƒ­ãƒ³ã‚®ãƒŒã‚¹ã®æ§", keywords: ["spear", "stick", "blade", "iron"] },
    { no: 100, rarity: "MYTH", name: "ã‚¨ã‚¯ã‚¹ã‚«ãƒªãƒãƒ¼", keywords: ["sword", "blade", "iron", "steel"] },
    // LEGEND (No. 81-96)
    { no: 81, rarity: "LEGEND", name: "é›·é³´ã®å‰£", keywords: ["sword", "blade", "iron", "electricity"] },
    // ... (ä»¥ä¸‹ã€LEGEND, ELITE, COMMON å…¨100ç¨®ã‚’ã“ã“ã«å®šç¾©ã—ã¾ã™) ...
    // ...
    // COMMON (No. 1-48)
    { no: 1, rarity: "COMMON", name: "æœ¨ã®æ£’", keywords: ["wood", "branch", "stick"] },
    { no: 48, rarity: "COMMON", name: "æœ¨åˆ€", keywords: ["sword", "wood", "stick", "japan", "blade"] },
];

// â˜…è¿½è¨˜ï¼šãƒ¬ã‚¢ãƒªãƒ†ã‚£ã¨ç¢ºç‡ã®å®šç¾©
const RARITY_RATES = [
    { rarity: "MYTH", rate: 5, start: 0 },   // 5%
    { rarity: "LEGEND", rate: 10, start: 5 }, // 10%
    { rarity: "ELITE", rate: 25, start: 15 }, // 25%
    { rarity: "COMMON", rate: 60, start: 40 }  // 60%
];

// â˜…è¿½è¨˜ï¼šè‰²ã¨å±æ€§ã®å¯¾å¿œè¡¨
const COLOR_MAPPING = [
    { elem: "FIRE", check: (r, g, b) => r > 150 && g < 100 }, // èµ¤ç³»
    { elem: "WATER", check: (r, g, b) => b > 150 && r < 100 }, // é’ç³»
    { elem: "WOOD", check: (r, g, b) => g > 120 && r < 120 && b < 120 }, // ç·‘ç³»
    { elem: "EARTH", check: (r, g, b) => r > 100 && g > 50 && b < 100 } // èŒ¶è‰²ãƒ»é»„åœŸè‰²ç³»
];
let lv=1, exp=0, pMax=1000, php=1000;
let ehp=0, eMax=0, eatk=100, pdef=100;
let net, stream;
let inventory = [];
let library = JSON.parse(localStorage.getItem('myth_v6_lib')) || { W: {}, E: {}, I: {} };
let magicLv = { H:1, F:0, L:0 }; 

// --- 4å±æ€§ï¼ˆ4ã™ãã¿ï¼‰ã®å®šç¾© ---
const ELEMENTS = {
    FIRE:  { name: "ç«", color: "#ff4444", icon: "ğŸ”¥", strongTo: "WOOD" },
    WATER: { name: "æ°´", color: "#4444ff", icon: "ğŸ’§", strongTo: "FIRE" },
    EARTH: { name: "åœŸ", color: "#8b4513", icon: "â›°ï¸", strongTo: "WATER" },
    WOOD:  { name: "æœ¨", color: "#228b22", icon: "ğŸƒ", strongTo: "EARTH" }
};

/**
 * å±æ€§ç›¸æ€§ã«ã‚ˆã‚‹ãƒ€ãƒ¡ãƒ¼ã‚¸å€ç‡ã‚’è¨ˆç®—
 * @param {string} atkElem æ”»æ’ƒå´ã®å±æ€§ã‚­ãƒ¼ (FIRE, WATER, etc.)
 * @param {string} defElem é˜²å¾¡å´ã®å±æ€§ã‚­ãƒ¼
 * @returns {number} ãƒ€ãƒ¡ãƒ¼ã‚¸å€ç‡ (1.5å€ or 0.5å€ or 1.0å€)
 */
function getElementModifier(atkElem, defElem) {
    if (ELEMENTS[atkElem].strongTo === defElem) {
        return 1.5; // æœ‰åˆ©ï¼šãƒ€ãƒ¡ãƒ¼ã‚¸1.5å€
    }
    if (ELEMENTS[defElem].strongTo === atkElem) {
        return 0.5; // ä¸åˆ©ï¼šãƒ€ãƒ¡ãƒ¼ã‚¸0.5å€
    }
    return 1.0; // ç›¸æ€§ãªã—ï¼šç­‰å€
}
// --- åˆæœŸåŒ– ---
window.onload = async () => {
    try {
        // AIãƒ­ãƒ¼ãƒ‰
        net = await mobilenet.load();
        document.getElementById('init-msg').innerText = "AI SYSTEM READY";
        document.getElementById('start-btn').classList.remove('hidden');
        
        // ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿å¾©å…ƒ
        const saved = JSON.parse(localStorage.getItem('myth_v6_save'));
        if(saved) {
            lv=saved.lv; exp=saved.exp; pMax=saved.pMax; php=pMax;
            inventory=saved.inventory; magicLv=saved.magicLv;
        }
        updateUI();
    } catch(e) {
        document.getElementById('init-msg').innerText = "ERROR: Internet Required";
    }
};

async function startGame() {
    document.getElementById('init-overlay').classList.add('hidden');
    await initCamera();
    mode = "W";
    document.getElementById('scan-btn').disabled = false;
    log("æ­¦å™¨ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ãã ã•ã„");
}

async function initCamera() {
    const video = document.getElementById('webcam');
    stream = await navigator.mediaDevices.getUserMedia({video: {facingMode: "environment"}, audio:false});
    video.srcObject = stream;
    video.style.display = "block";
}

// --- ã‚¹ã‚­ãƒ£ãƒ³å‡¦ç† ---
async function startScan() {
    const btn = document.getElementById('scan-btn');
    btn.disabled = true;
    log("ã‚¹ã‚­ãƒ£ãƒ³ä¸­...");
    
    const video = document.getElementById('webcam');
    const result = await net.classify(video);
    const label = result[0].className; // AIãŒèªè­˜ã—ãŸåå‰ (ä¾‹: 'wooden stick, wood')
    
    // â˜…é‡è¦ï¼šè‰²ã§å±æ€§ã‚’æ±ºå®š
    const determinedElement = getElementByColor();
    const elementInfo = ELEMENTS[determinedElement];

    if (mode === "W") {
        // â˜…æ­¦å™¨ã®æŠ½é¸ã‚’å®Ÿè¡Œ
        const discoveredWeapon = lotteryWeapon(label, determinedElement); 
        
        playerElement = discoveredWeapon.element; // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å±æ€§ã‚’æ±ºå®š
        
        log(`æ­¦å™¨æ¤œçŸ¥: ${discoveredWeapon.name} (${discoveredWeapon.rarity})`);
        log(`å±æ€§: ${elementInfo.name}${elementInfo.icon}ã«å¤‰åŒ–ï¼`);

        // å›³é‘‘ç™»éŒ²ï¼ˆå±æ€§ã‚‚ä¿å­˜ï¼‰
        library.W[discoveredWeapon.no] = { 
            name: discoveredWeapon.name, 
            rarity: discoveredWeapon.rarity,
            element: discoveredWeapon.element 
        };
        
        mode = "E";
        btn.innerText = "ENEMY SCAN";
        btn.disabled = false;
    } 
    // ... (ä»¥é™ã® else if (mode === "E") ... ãªã©ã®å‡¦ç†ã¯åŒæ§˜ã«æŠ½é¸ãƒ­ã‚¸ãƒƒã‚¯ã«ç½®ãæ›ãˆã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™)
    
    updateUI();
}

// ... (ä»¥ä¸‹ã€updateUIãªã©ã®æ—¢å­˜ã®é–¢æ•°ãŒç¶šã) ...

// --- ãƒãƒˆãƒ«ãƒ­ã‚¸ãƒƒã‚¯ ---
function handleAttack() {
    let dmg = 100 + (lv * 20);
    ehp = Math.max(0, ehp - dmg);
    applyShake();
    log(`æ”»æ’ƒï¼ ${dmg}ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼`);
    
    if(ehp <= 0) {
        win();
    } else {
        setTimeout(enemyTurn, 800);
    }
    updateUI();
}

function enemyTurn() {
    let dmg = 50 + (lv * 10);
    php = Math.max(0, php - dmg);
    log(`æ•µã®æ”»æ’ƒï¼ ${dmg}ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼`);
    if(php <= 0) {
        alert("æ•—åŒ—ã—ã¾ã—ãŸ...");
        location.reload();
    }
    updateUI();
}

function win() {
    log("å‹åˆ©ï¼ã‚¢ã‚¤ãƒ†ãƒ ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ãã ã•ã„");
    mode = "I";
    document.getElementById('scan-btn').innerText = "ITEM SCAN";
    document.getElementById('scan-btn').disabled = false;
    document.getElementById('atk-btn').disabled = true;
    document.getElementById('magic-btn').disabled = true;
    exp += 50;
    save();
}
/**
 * 1. ã‚«ãƒ¡ãƒ©ã®ä¸­å¤®ãƒ”ã‚¯ã‚»ãƒ«ã‹ã‚‰è‰²ã‚’å–å¾—ã—ã€å±æ€§ã‚’æ±ºå®šã™ã‚‹
 * @returns {string} å±æ€§ã‚­ãƒ¼ (FIRE, WATER, etc.)
 */
function getElementByColor() {
    const video = document.getElementById('webcam');
    const canvas = document.getElementById('color-canvas');
    const ctx = canvas.getContext('2d');

    // ã‚«ãƒ¡ãƒ©ã®ä¸­å¤®éƒ¨åˆ†ã‚’1x1ãƒ”ã‚¯ã‚»ãƒ«ã§ã‚­ãƒ£ãƒ—ãƒãƒ£
    ctx.drawImage(video, video.videoWidth / 2, video.videoHeight / 2, 1, 1, 0, 0, 1, 1);
    const pixelData = ctx.getImageData(0, 0, 1, 1).data;
    const r = pixelData[0], g = pixelData[1], b = pixelData[2];
    
    // UIã«ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’è¡¨ç¤º
    document.getElementById('element-debug').innerHTML = `RGB: (${r}, ${g}, ${b})`;

    // è‰²ãƒãƒƒãƒ”ãƒ³ã‚°ã«åŸºã¥ã„ã¦å±æ€§ã‚’åˆ¤å®š
    for (const mapping of COLOR_MAPPING) {
        if (mapping.check(r, g, b)) {
            return mapping.elem;
        }
    }
    // ã©ã®è‰²ã«ã‚‚å½“ã¦ã¯ã¾ã‚‰ãªã„å ´åˆã¯ãƒ©ãƒ³ãƒ€ãƒ 
    const keys = Object.keys(ELEMENTS);
    return keys[Math.floor(Math.random() * keys.length)];
}


/**
 * 2. æ±ºå®šã—ãŸå±æ€§ã¨AIãƒ©ãƒ™ãƒ«ã‹ã‚‰ã€å€™è£œã‚’æŠ½é¸ã™ã‚‹
 * @param {string} label AIãŒèªè­˜ã—ãŸãƒ©ãƒ™ãƒ«
 * @param {string} determinedElement è‰²ã§æ±ºã¾ã£ãŸå±æ€§
 * @returns {object} å‡ºç¾ã™ã‚‹æ­¦å™¨/ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
 */
function lotteryWeapon(label, determinedElement) {
    const lowerLabel = label.toLowerCase().split(',').map(s => s.trim()); // AIãƒ©ãƒ™ãƒ«ã‚’å°æ–‡å­—ãƒªã‚¹ãƒˆåŒ–

    // 1. ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã™ã‚‹å€™è£œã‚’ã™ã¹ã¦æŠ½å‡º (ORæ¡ä»¶)
    let candidates = WEAPON_MASTER_DB.filter(weapon => {
        // æ­¦å™¨ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆ (ä¾‹: ["knife", "blade", "iron"])
        const weaponKeys = weapon.keywords; 
        
        // AIã®ãƒ©ãƒ™ãƒ«ãƒªã‚¹ãƒˆã®ã©ã‚Œã‹ä¸€ã¤ã§ã‚‚æ­¦å™¨ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«ä¸€è‡´ã™ã‚‹ã‹ï¼Ÿ
        return lowerLabel.some(aiKey => weaponKeys.includes(aiKey));
    });

    if (candidates.length === 0) {
        log("ä¸€è‡´ã™ã‚‹ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ©ãƒ³ãƒ€ãƒ æŠ½é¸ã‚’é–‹å§‹ã—ã¾ã™ã€‚");
        // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ä¸€è‡´ãªã—ã®å ´åˆã€å…¨100ç¨®ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«ãƒ¬ã‚¢ãƒªãƒ†ã‚£æŠ½é¸
        // (ã“ã“ã§ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«å…¨100ç¨®ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ é¸æŠã¨ã—ã¾ã™ - è¦æ”¹å–„)
        candidates = WEAPON_MASTER_DB; 
    }
    
    // 2. å€™è£œã®ä¸­ã‹ã‚‰ã€ãƒ¬ã‚¢ãƒªãƒ†ã‚£ã®ç¢ºç‡ã§æŠ½é¸ã™ã‚‹ï¼ˆã‚¬ãƒãƒ£ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
    let totalRate = 0;
    const weightedCandidates = candidates.map(w => {
        const rateInfo = RARITY_RATES.find(r => r.rarity === w.rarity);
        // åŒã˜ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§è¤‡æ•°ã®ãƒ¬ã‚¢ãƒªãƒ†ã‚£ãŒãƒ’ãƒƒãƒˆã—ãŸå ´åˆã€å…ƒã®ç¢ºç‡ã‚’é‡ã¿ã¨ã—ã¦å†æŠ½é¸ã™ã‚‹
        const weight = rateInfo ? rateInfo.rate : 0; 
        totalRate += weight;
        return { weapon: w, weight: weight };
    });
    
    // 3. æŠ½é¸å®Ÿè¡Œ
    let rand = Math.random() * totalRate;
    let current = 0;
    for (const item of weightedCandidates) {
        current += item.weight;
        if (rand <= current) {
            // æŠ½é¸ã•ã‚ŒãŸæ­¦å™¨ã«ã€è‰²ã§æ±ºã‚ãŸå±æ€§ã‚’ä»˜ä¸ã—ã¦è¿”ã™
            return {
                ...item.weapon,
                element: determinedElement 
            };
        }
    }
    
    // å®‰å…¨ã®ãŸã‚ã€å¤±æ•—ã—ãŸã‚‰COMMONã‚’è¿”ã™
    return { no: 1, rarity: "COMMON", name: "æœ¨ã®æ£’", element: determinedElement };
}
// --- ã‚·ã‚¹ãƒ†ãƒ  ---
function log(m) {
    const el = document.getElementById('msg');
    el.innerText = m;
    // åé›†ç‡è¿½è¨˜
    const total = 10; // ä»®
    const collected = Object.keys(library.I || {}).length;
    el.innerText += `\n(åé›†ç‡: ${Math.floor(collected/total*100)}%)`;
}

function updateUI() {
    document.getElementById('p-lv').innerText = lv;
    document.getElementById('p-hp-cur').innerText = php;
    document.getElementById('p-hp-max').innerText = pMax;
    document.getElementById('p-fill').style.width = (php/pMax*100) + "%";
    document.getElementById('e-hp-cur').innerText = ehp;
    document.getElementById('e-hp-max').innerText = eMax;
    document.getElementById('e-fill').style.width = (ehp/eMax*100) + "%";
}

function save() {
    localStorage.setItem('myth_v6_save', JSON.stringify({lv, exp, pMax, magicLv, inventory}));
    localStorage.setItem('myth_v6_lib', JSON.stringify(library));
}

function applyShake() {
    document.body.classList.add('shake');
    setTimeout(() => document.body.classList.remove('shake'), 200);
}

function openLibrary() {
    alert("å›³é‘‘æ©Ÿèƒ½: é–‹ç™ºä¸­\nç²å¾—ã—ãŸã‚¢ã‚¤ãƒ†ãƒ ã¯å†…éƒ¨ã§ä¿å­˜ã•ã‚Œã¦ã„ã¾ã™ã€‚");
}

function getBonusItem(label) {
    const id = Date.now();
    library.I[id] = { name: label };
    alert(`ã‚¢ã‚¤ãƒ†ãƒ ç²å¾—: ${label}`);
    save();
    location.reload(); // æœ€åˆã‹ã‚‰ï¼ˆæ­¦å™¨ã‚¹ã‚­ãƒ£ãƒ³ï¼‰ã«æˆ»ã‚‹
}
function openMagic() {
    alert("é­”æ³•æ©Ÿèƒ½: é–‹ç™ºä¸­");
}
</script>
</body>
</html>
