<!DOCTYPE html>
<html lang="ja">
<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
 <title>MYTH SCANNER EVO</title>
 <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
 <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet"></script>
 <link href="https://fonts.googleapis.com/css2?family=DotGothic16&display=swap" rel="stylesheet">
 <style>
 :root { --p-color: #00f2ff; --e-color: #ff3c00; }
 body { font-family: 'DotGothic16', sans-serif; background: #000; color: #fff; margin: 0; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
 
 #header-info { height: 35px; background: #222; display: flex; justify-content: space-around; align-items: center; font-size: 0.8rem; border-bottom: 2px solid #444; }

 .area { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; border-bottom: 1px solid #333; }
 .frame { width: 120px; height: 120px; border: 3px solid #fff; background: #111; position: relative; overflow: hidden; }
 
 video { position: absolute; width: 100%; height: 100%; object-fit: cover; z-index: 5; }
 .visual-overlay { position: absolute; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 4.5rem; z-index: 10; display: none; }
 
 /* スキャン成功時のクラス */
 .scanned video { display: none !important; }
 .scanned .visual-overlay { display: flex !important; }

 .label { position: absolute; top: 5px; left: 5px; font-size: 0.6rem; color: #888; z-index: 15; }
 .status-box { text-align: center; width: 100%; z-index: 15; }
 .hp-cont { width: 70%; height: 10px; background: #333; border: 1px solid #fff; margin: 4px auto; }
 .hp-fill { height: 100%; transition: width 0.3s; }
 .val-text { font-size: 0.75rem; color: #ccc; }

 #ui { height: 120px; background: #111; padding: 10px; border-top: 3px solid #fff; z-index: 20; }
 #msg { height: 40px; font-size: 0.8rem; color: #0f0; text-align: center; }
 .btns { display: flex; gap: 10px; height: 50px; }
 button { flex: 1; font-family: 'DotGothic16'; border: 3px solid #fff; color: #fff; font-size: 1rem; background: #444; }

 .overlay-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 100; display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
 .result-title { font-size: 3rem; font-weight: bold; margin-bottom: 10px; }
 
 .shake { animation: s 0.2s; }
 @keyframes s { 0% { transform:translate(4px,4px) } 50% { transform:translate(-4px,-4px) } 100% { transform:translate(0,0) } }
 </style>
</head>
<body>

<div id="header-info">
 <span>LV: <b id="p-lv">1</b></span>
 <span>EXP: <b id="p-exp">0</b>/<b id="p-next">100</b></span>
</div>

<div class="area" id="p-area">
 <div class="label">PLAYER WEAPON</div>
 <div class="frame" id="pf">
 <video id="pv" autoplay playsinline muted></video>
 <div id="pw-icon" class="visual-overlay"> </div>
 </div>
 <div class="status-box">
 <div id="p-name" style="color:yellow; font-size:0.9rem;">SCANNING...</div>
 <div class="val-text">HP: <span id="p-hp-val">1000</span> / ATK: <span id="p-atk-val">0</span> DEF: <span id="p-def-val">0</span></div>
 <div class="hp-cont"><div id="phf" class="hp-fill" style="background:var(--p-color); width:100%"></div></div>
 </div>
</div>

<div class="area" id="e-area">
 <div class="label">ENEMY MONSTER</div>
 <div class="frame" id="ef">
 <video id="ev" autoplay playsinline muted></video>
 <div id="em-icon" class="visual-overlay"> </div>
 </div>
 <div class="status-box">
 <div id="e-name" style="color:red; font-size:0.9rem;">WAITING...</div>
 <div class="val-text">HP: <span id="e-hp-val">1000</span> / ATK: <span id="e-atk-val">0</span> DEF: <span id="e-def-val">0</span></div>
 <div class="hp-cont"><div id="ehf" class="hp-fill" style="background:var(--e-color); width:100%"></div></div>
 </div>
</div>

<div id="ui">
 <div id="msg">武器をスキャンしてください</div>
 <div class="btns">
 <button id="scan-btn" onclick="scan()">SCAN</button>
 <button id="atk-btn" disabled onclick="attack()">ATTACK!</button>
 </div>
</div>

<div id="result-screen" class="overlay-screen">
 <div id="result-title" class="result-title"></div>
 <div id="result-msg" style="margin-bottom:20px;"></div>
 <button onclick="resetGame()" style="width:200px; height:50px; background:#0044cc;">NEXT SCAN</button>
</div>

<script>
 let net, mode = "W", lv = 1, exp = 0, nextExp = 100;
 let php = 1000, maxPhp = 1000, ehp = 1000, maxEhp = 1000;
 let patk=0, pdef=0, eatk=0, edef=0;

 const db = {
 weapons: [
 { r: "COMMON", n: ["アイアンソード", "木の棒", "弓"], i: " ", b: 80 },
 { r: "RARE", n: ["ファイヤソード", "雷光の杖"], i: " ", b: 180 },
 { r: "SUPER RARE", n: ["エクスカリバー", "聖盾"], i: " ", b: 350 },
 { r: "MYTHICAL", n: ["神槍グングニル", "ラグナロク"], i: " ", b: 700 }
 ],
 monsters: [
 { r: "COMMON", n: ["スライム", "ゴブリン"], i: " ", b: 60 },
 { r: "RARE", n: ["ドラゴン", "ゴーレム"], i: " ", b: 150 },
 { r: "SUPER RARE", n: ["キマイラ", "死神"], i: " ", b: 300 },
 { r: "MYTHICAL", n: ["魔王", "邪神"], i: " ", b: 600 }
 ]
 };

 async function init() {
 net = await mobilenet.load();
 startCamera();
 }

 async function startCamera() {
 const stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
 document.getElementById('pv').srcObject = stream;
 document.getElementById('ev').srcObject = stream;
 }

 async function scan() {
 const r = await net.classify(document.getElementById('pv'));
 // ランダム性を出すため、名前の長さ＋現在のミリ秒を使用
 const seed = (r[0].className.length + Date.now()) % 100;
 let rarityIdx = seed < 70 ? 0 : seed < 90 ? 1 : seed < 99 ? 2 : 3;

 if (mode === "W") {
 const data = db.weapons[rarityIdx];
 const name = data.n[seed % data.n.length];
 patk = data.b + (seed * 2) + (lv * 5);
 pdef = Math.floor(data.b / 2) + lv;
 
 document.getElementById('p-name').innerText = `[${data.r}] ${name}`;
 document.getElementById('pw-icon').innerText = data.i;
 document.getElementById('p-atk-val').innerText = patk;
 document.getElementById('p-def-val').innerText = pdef;
 document.getElementById('pf').classList.add('scanned');
 
 mode = "M";
 document.getElementById('msg').innerText = "敵をスキャンしてください";
 } else if (mode === "M") {
 const data = db.monsters[rarityIdx];
 const name = data.n[seed % data.n.length];
 eatk = data.b + (seed * 2) + (lv * 5);
 edef = Math.floor(data.b / 2) + lv;
 maxEhp = 800 + (lv * 100) + seed;
 ehp = maxEhp;

 document.getElementById('e-name').innerText = `[${data.r}] ${name}`;
 document.getElementById('em-icon').innerText = data.i;
 document.getElementById('e-atk-val').innerText = eatk;
 document.getElementById('e-def-val').innerText = edef;
 document.getElementById('ef').classList.add('scanned');

 document.getElementById('atk-btn').disabled = false;
 document.getElementById('scan-btn').disabled = true;
 document.getElementById('msg').innerText = "バトル開始！";
 updateUI();
 }
 }

 function attack() {
 // Player's turn
 document.getElementById('ef').classList.add('shake');
 let d = Math.max(30, patk - Math.floor(edef/2));
 ehp -= d;
 
 setTimeout(() => {
 document.getElementById('ef').classList.remove('shake');
 if(ehp <= 0) { finish(true); } 
 else {
 // Enemy's turn
 document.getElementById('pf').classList.add('shake');
 let ed = Math.max(30, eatk - Math.floor(pdef/2));
 php -= ed;
 updateUI();
 setTimeout(() => document.getElementById('pf').classList.remove('shake'), 200);
 if(php <= 0) finish(false);
 }
 updateUI();
 }, 400);
 }

 function finish(isWin) {
 const screen = document.getElementById('result-screen');
 const title = document.getElementById('result-title');
 const rMsg = document.getElementById('result-msg');
 screen.style.display = "flex";

 if(isWin) {
 title.innerText = "WIN!"; title.style.color = "yellow";
 exp += 50; 
 if(exp >= nextExp) { lv++; exp = 0; nextExp += 50; }
 php = Math.min(maxPhp, php + Math.floor(maxPhp * 0.5));
 rMsg.innerText = "経験値を獲得し、HPが回復した！";
 } else {
 title.innerText = "GAME OVER"; title.style.color = "red";
 lv = Math.max(1, lv - 5);
 php = maxPhp; // 敗北時は全快リセット
 rMsg.innerText = "レベルが5低下した。武器を再スキャンしてください。";
 }
 updateUI();
 }

 function resetGame() {
 mode = "W";
 document.getElementById('pf').classList.remove('scanned');
 document.getElementById('ef').classList.remove('scanned');
 document.getElementById('scan-btn').disabled = false;
 document.getElementById('atk-btn').disabled = true;
 document.getElementById('result-screen').style.display = "none";
 document.getElementById('msg').innerText = "武器をスキャンしてください";
 document.getElementById('p-name').innerText = "SCANNING...";
 document.getElementById('e-name').innerText = "WAITING...";
 ehp = 1000;
 updateUI();
 }

 function updateUI() {
 document.getElementById('phf').style.width = (php/maxPhp*100) + "%";
 document.getElementById('ehf').style.width = (ehp/maxEhp*100) + "%";
 document.getElementById('p-hp-val').innerText = Math.max(0, php);
 document.getElementById('e-hp-val').innerText = Math.max(0, ehp);
 document.getElementById('p-lv').innerText = lv;
 document.getElementById('p-exp').innerText = exp;
 document.getElementById('p-next').innerText = nextExp;
 }

 init();
</script>
</body>
</html>
