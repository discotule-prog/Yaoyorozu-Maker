<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MYTH SCANNER 6.1</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet"></script>
    <link href="https://fonts.googleapis.com/css2?family=DotGothic16&display=swap" rel="stylesheet">
    <style>
        :root { --p-color: #00f2ff; --e-color: #ff3c00; --exp-color: #32ff32; --gold: #ffd700; --magic-purple: #9d4edd; --close-btn: #880000; --main-blue: #0044cc; --reset-red: #cc0000; }
        body { font-family: 'DotGothic16', sans-serif; background: #000; color: #fff; margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        #header { height: 40px; background: #222; display: flex; justify-content: space-around; align-items: center; border-bottom: 2px solid #444; flex-shrink: 0; padding: 0 5px; }
        .head-btn { flex: 1; font-size: 0.55rem; height: 26px; border: 1px solid #fff; color: #fff; cursor: pointer; margin: 0 2px; white-space: nowrap; }
        .char-area { height: 30%; display: flex; border-bottom: 1px solid #333; padding: 10px; box-sizing: border-box; }
        .cam-part { width: 35%; display: flex; align-items: center; justify-content: center; }
        .cam-frame { width: 90px; height: 90px; border: 2px solid #555; background: #111; overflow: hidden; position: relative; border-radius: 8px; }
        video, canvas { width: 100%; height: 100%; object-fit: cover; }
        .info-part { width: 65%; display: flex; flex-direction: column; padding-left: 10px; justify-content: center; }
        .visual-card { width: 100%; height: 75px; border: 2px solid #fff; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #111; position: relative; border-radius: 4px; overflow: hidden; }
        .stat-text { font-size: 0.65rem; color: #ccc; margin-top: 2px; line-height: 1.2; }
        .bar-container { width: 100%; margin-top: 4px; }
        .bar-bg { width: 100%; height: 8px; background: #222; border: 1px solid #666; position: relative; overflow: hidden; }
        .bar-fill { height: 100%; width: 0%; transition: width 0.4s ease-out; }
        .rarity-tag { position: absolute; top: 2px; right: 2px; font-size: 0.5rem; padding: 1px 3px; background: #fff; color: #000; font-weight: bold; }
        .elem-tag { position: absolute; top: 2px; left: 2px; font-size: 0.7rem; }
        #mid-ui { height: 155px; background: #111; border-top: 2px solid #444; display: flex; flex-direction: column; align-items: center; padding: 5px; flex-shrink: 0; justify-content: center; }
        #msg { font-size: 0.75rem; color: #0f0; height: 40px; text-align: center; display: flex; align-items: center; padding: 0 10px; line-height: 1.2; white-space: pre-wrap; }
        .btn-row { display: flex; gap: 6px; width: 95%; justify-content: center; margin-bottom: 6px; }
        button { flex: 1; height: 38px; font-family: 'DotGothic16'; border: 2px solid #fff; color: #fff; background: #444; font-size: 0.65rem; cursor: pointer; }
        button:disabled { opacity: 0.25; cursor: default; }
        
        /* „Çπ„Ç≠„É£„É≥ÊºîÂá∫Áî® */
        .scan-flash { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #fff; opacity: 0; pointer-events: none; z-index: 10; }
        .flash-active { animation: flash-anim 0.4s ease-out; }
        @keyframes flash-anim { 0% { opacity: 1; } 100% { opacity: 0; } }
        .glow-active { border-color: var(--p-color); box-shadow: 0 0 10px var(--p-color); }

        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 100; display: none; flex-direction: column; align-items: center; padding: 15px; box-sizing: border-box; }
        .ov-btn-red { background: var(--close-btn) !important; width: 95% !important; margin-top: 15px; flex:none; height:40px; border:none; color:#fff; }
    </style>
</head>
<body>
    <div id="init-overlay">
        <div style="font-size:1.5rem; margin-bottom:10px;">MYTH SCANNER 6.1</div>
        <div id="init-msg" style="font-size:0.8rem; margin-bottom:20px;">INITIALIZING...</div>
        <button id="start-btn" onclick="startGame()" style="display:none; padding:15px 40px; font-family:'DotGothic16'; background:#0044cc; color:white; border:2px solid white; font-size:1.2rem; border-radius:8px; cursor:pointer;">START GAME</button>
    </div>

    <div id="header">
        <button onclick="location.reload();" class="head-btn" style="background:var(--reset-red);">RESET</button>
        <button class="head-btn" style="background:#555;">COLLECTION</button>
        <button id="skill-menu-btn" class="head-btn" style="background:var(--magic-purple);">SKILL UP (0)</button>
    </div>

    <div class="char-area" id="p-area">
        <div class="cam-part">
            <div class="cam-frame" id="p-cam-box">
                <video id="p-video" autoplay playsinline muted></video>
                <canvas id="p-canvas" style="display:none;"></canvas>
                <div class="scan-flash" id="p-flash"></div>
            </div>
        </div>
        <div class="info-part">
            <div id="p-card" class="visual-card">
                <div id="p-rare" class="rarity-tag">-</div>
                <div id="p-elem" class="elem-tag"></div>
                <div id="p-sym" style="font-size:1.8rem; color:#333;">?</div>
                <div id="p-name" style="font-size:0.55rem; text-align:center;">SCANNER READY</div>
            </div>
            <div class="stat-text">HP:<span id="p-hp-cur">1000</span>/<span id="p-hp-max">1000</span></div>
            <div class="bar-container"><div class="bar-bg"><div id="p-fill" class="bar-fill" style="background:var(--p-color); width:100%"></div></div></div>
        </div>
    </div>

    <div id="mid-ui">
        <div id="msg">INITIALIZING...</div>
        <div class="btn-row">
            <button id="scan-btn" onclick="handleScan()" disabled style="background:#0044cc; flex: 1.5;">SCAN</button>
            <button id="atk-btn" onclick="handleAttack()" disabled style="background:#aa0000; flex: 1.5;">ATTACK</button>
        </div>
        <div class="btn-row">
            <button id="esc-btn" onclick="handleEscape()" disabled style="background:#555;">ESCAPE</button>
        </div>
    </div>

    <div class="char-area" id="e-area">
        <div class="cam-part">
            <div class="cam-frame" id="e-cam-box">
                <video id="e-video" autoplay playsinline muted style="display:none;"></video>
                <canvas id="e-canvas" style="display:none;"></canvas>
                <div class="scan-flash" id="e-flash"></div>
            </div>
        </div>
        <div class="info-part">
            <div id="e-card" class="visual-card">
                <div id="e-rare" class="rarity-tag">-</div>
                <div id="e-elem" class="elem-tag"></div>
                <div id="e-sym" style="font-size:1.8rem; color:#333;">?</div>
                <div id="e-name" style="font-size:0.55rem; text-align:center;">???</div>
            </div>
            <div class="stat-text">HP:<span id="e-hp-cur">0</span>/<span id="e-hp-max">0</span></div>
            <div class="bar-container"><div class="bar-bg"><div id="e-fill" class="bar-fill" style="background:var(--e-color);"></div></div></div>
        </div>
    </div>

<script>
let net;
let hp=1000, maxHp=1000, myAtk=10, myDef=10;
let enemyHp = 0, enemyMaxHp = 0;
let gamePhase = "EQUIP"; 
let isMyTurn = true;
let currentStream = null;

const DB_ITEM_FULL = {
    "n01214153": { name: "„ÉÜ„Çπ„Éà„ÅÆÂâ£", rarity: "N", hp: 100, atk: 10, def: 5, elem: "üî•", sym: "üó°Ô∏è" },
    "mouse": { name: "‰ºùË™¨„ÅÆ„Éû„Ç¶„Çπ", rarity: "SSR", hp: 1500, atk: 50, def: 30, elem: "üíß", sym: "üñ±Ô∏è" },
    "coffeemug": { name: "‰ºùË™¨„ÅÆ„Éû„Ç∞„Ç´„ÉÉ„Éó", rarity: "SSR", hp: 1500, atk: 50, def: 30, elem: "üíß", sym: "‚òï" }
};

async function init() {
    const msgBox = document.getElementById('init-msg');
    try {
        net = await mobilenet.load();
        msgBox.innerText = "READY!";
        document.getElementById('start-btn').style.display = 'block';
    } catch(e) { msgBox.innerText = "LOAD ERROR"; }
}

async function startGame() {
    document.getElementById('init-overlay').style.display = 'none';
    resetToEquip();
}

async function startCamera(videoId) {
    if (currentStream) currentStream.getTracks().forEach(t => t.stop());
    try {
        currentStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
        const video = document.getElementById(videoId);
        video.srcObject = currentStream;
        video.style.display = "block";
    } catch (e) { alert("Camera Error"); }
}

function captureScan(side) {
    const video = document.getElementById(`${side}-video`);
    const canvas = document.getElementById(`${side}-canvas`);
    const flash = document.getElementById(`${side}-flash`);
    const box = document.getElementById(`${side}-cam-box`);
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    canvas.getContext('2d').drawImage(video, 0, 0);
    video.style.display = 'none';
    canvas.style.display = 'block';
    flash.classList.add('flash-active');
    box.classList.add('glow-active');
    setTimeout(() => flash.classList.remove('flash-active'), 500);
    if (currentStream) { currentStream.getTracks().forEach(t => t.stop()); currentStream = null; }
}

async function handleScan() {
    if (gamePhase === "BATTLE" || !net) return;
    const msg = document.getElementById('msg');
    const targetVideo = (gamePhase === "EQUIP") ? document.getElementById('p-video') : document.getElementById('e-video');
    msg.innerText = "Ëß£Êûê‰∏≠... üîç";
    try {
        const results = await net.classify(targetVideo);
        const detId = results[0].className.split(',')[0].toLowerCase().replace(/\s+/g, '');
        if (gamePhase === "EQUIP") {
            if (DB_ITEM_FULL[detId]) {
                const item = DB_ITEM_FULL[detId];
                document.getElementById('p-name').innerText = item.name;
                hp = item.hp; maxHp = item.hp; myAtk = item.atk; myDef = item.def;
                updateBattleUI(); captureScan('p');
                gamePhase = "SEARCH";
                msg.innerText = `${item.name} Ë£ÖÂÇôÔºÅ\nÊïµ„Çí„Çπ„Ç≠„É£„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`;
                setTimeout(() => startCamera('e-video'), 1000);
            } else { msg.innerText = "Ê≠¶Âô®„Çí„Çπ„Ç≠„É£„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ"; }
        } else if (gamePhase === "SEARCH") {
            if (!DB_ITEM_FULL[detId]) {
                captureScan('e'); spawnEnemy(results[0].className);
                gamePhase = "BATTLE";
            } else { msg.innerText = "„Åù„Çå„ÅØË£ÖÂÇôÂìÅ„Åß„ÅôÔºÅÊïµ„ÇíÊé¢„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ"; }
        }
    } catch (e) { msg.innerText = "„Ç®„É©„ÉºÁô∫Áîü"; }
}

function spawnEnemy(name) {
    const eName = name.split(',')[0].toUpperCase();
    document.getElementById('e-name').innerText = eName;
    enemyMaxHp = 500; enemyHp = 500;
    updateBattleUI();
    document.getElementById('msg').innerText = `${eName} Âá∫ÁèæÔºÅ`;
    document.getElementById('atk-btn').disabled = false;
    document.getElementById('scan-btn').disabled = true;
}

function handleAttack() {
    if (!isMyTurn || enemyHp <= 0) return;
    isMyTurn = false;
    enemyHp -= myAtk; updateBattleUI();
    document.getElementById('msg').innerText = "ÊîªÊíÉÔºÅ";
    if (enemyHp <= 0) { setTimeout(() => { alert("ÂãùÂà©ÔºÅ"); resetToEquip(); }, 1000); }
    else { setTimeout(enemyTurn, 1000); }
}

function enemyTurn() {
    hp -= 10; updateBattleUI();
    document.getElementById('msg').innerText = "Êïµ„ÅÆÊîªÊíÉÔºÅ";
    isMyTurn = true;
}

function updateBattleUI() {
    document.getElementById('p-hp-cur').innerText = hp;
    document.getElementById('p-fill').style.width = (hp/maxHp)*100 + "%";
    document.getElementById('e-hp-cur').innerText = enemyHp;
    document.getElementById('e-fill').style.width = (enemyHp/500)*100 + "%";
}

function resetToEquip() {
    gamePhase = "EQUIP";
    document.getElementById('p-video').style.display = 'block';
    document.getElementById('p-canvas').style.display = 'none';
    document.getElementById('e-video').style.display = 'none';
    document.getElementById('e-canvas').style.display = 'none';
    document.getElementById('p-cam-box').classList.remove('glow-active');
    document.getElementById('e-cam-box').classList.remove('glow-active');
    document.getElementById('scan-btn').disabled = false;
    document.getElementById('atk-btn').disabled = true;
    startCamera('p-video');
    document.getElementById('msg').innerText = "Ê≠¶Âô®„Çí„Çπ„Ç≠„É£„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ";
}

window.onload = init;
</script>
</body>
</html>
