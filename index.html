<!DOCTYPE html>
<html lang="ja">
<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <title>MONSTER & WEAPON SCANNER</title>
 <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
 <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet"></script>
 <link href="https://fonts.googleapis.com/css2?family=DotGothic16&family=Share+Tech+Mono&display=swap" rel="stylesheet">
 <style>
 :root { --p-color: #00ff00; --e-color: #ff0000; }
 body { font-family: 'DotGothic16', sans-serif; background: #1a0f00; color: #fff; margin: 0; display: flex; justify-content: center; overflow: hidden; }
 #game-container { width: 100vw; max-width: 450px; height: 100vh; background: #000; border: 4px solid #444; display: flex; flex-direction: column; }
 
 .battle-area { flex: 1; position: relative; border: 2px solid #333; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: background 0.5s; }
 #player-area { background: linear-gradient(180deg, #001a00, #000); }
 #enemy-area { background: linear-gradient(0deg, #1a0000, #000); }

 .unit-label { position: absolute; top: 5px; left: 10px; font-size: 0.7rem; color: #888; z-index: 10; letter-spacing: 1px; }
 
 /* イラスト表示エリア */
 .visual-frame { width: 160px; height: 160px; border: 3px solid #fff; background: #111; position: relative; overflow: hidden; box-shadow: 0 0 15px rgba(255,255,255,0.2); }
 video { width: 100%; height: 100%; object-fit: cover; }
 .generated-img { width: 100%; height: 100%; object-fit: cover; image-rendering: pixelated; display: none; }

 /* ステータス */
 .stat-box { width: 85%; margin-top: 8px; }
 .hp-bar { height: 8px; background: #333; width: 100%; margin: 4px 0; border: 1px solid #fff; }
 .hp-fill { height: 100%; transition: width 0.3s; }
 #p-hp-fill { background: var(--p-color); box-shadow: 0 0 10px var(--p-color); }
 #e-hp-fill { background: var(--e-color); box-shadow: 0 0 10px var(--e-color); }

 /* UI */
 #ui-panel { height: 160px; background: #111; border-top: 4px solid #fff; padding: 12px; display: flex; flex-direction: column; }
 #msg-log { flex: 1; font-size: 0.8rem; color: #0f0; line-height: 1.4; border-left: 2px solid #0f0; padding-left: 10px; }
 .btn-group { display: flex; gap: 8px; margin-top: 10px; }
 button { flex: 1; padding: 12px; font-family: 'DotGothic16'; font-size: 0.9rem; border: 3px solid #fff; cursor: pointer; color: #fff; transition: 0.1s; }
 #scan-btn { background: #0044cc; }
 #atk-btn { background: #aa0000; }
 button:active { transform: scale(0.95); }
 button:disabled { background: #222; color: #555; border-color: #444; }

 .shake { animation: shake 0.3s; }
 @keyframes shake { 0%, 100% { transform: translate(0,0); } 25% { transform: translate(4px,4px); } 50% { transform: translate(-4px,-4px); } 75% { transform: translate(4px,-4px); } }
 </style>
</head>
<body>

<div id="game-container">
 <div class="battle-area" id="player-area">
 <div class="unit-label">PLAYER WEAPON</div>
 <div class="visual-frame" id="p-frame">
 <video id="webcam" autoplay playsinline muted></video>
 <img id="p-img" class="generated-img" src="" />
 </div>
 <div class="stat-box">
 <div style="font-size:0.8rem; color:yellow;">WEAPON: <span id="p-name">NONE</span></div>
 <div class="hp-bar"><div id="p-hp-fill" class="hp-fill" style="width:100%"></div></div>
 </div>
 </div>

 <div class="battle-area" id="enemy-area">
 <div class="unit-label">ENEMY MONSTER</div>
 <div class="visual-frame" id="e-frame">
 <img id="e-img" class="generated-img" style="display:block; opacity: 0.3;" src="https://source.unsplash.com/featured/?robot,pixel" />
 </div>
 <div class="stat-box">
 <div style="font-size:0.8rem; color:red;">MONSTER: <span id="e-name">WAITING...</span></div>
 <div class="hp-bar"><div id="e-hp-fill" class="hp-fill" style="width:100%"></div></div>
 </div>
 </div>

 <div id="ui-panel">
 <div id="msg-log">1. SCAN YOUR WEAPON!</div>
 <div class="btn-group">
 <button id="scan-btn">SCAN</button>
 <button id="atk-btn" disabled>ATTACK!</button>
 </div>
 </div>
</div>

<script>
 let net;
 let mode = "WEAPON"; // WEAPON -> MONSTER -> BATTLE
 let player = { hp: 1000, maxHp: 1000, atk: 50 };
 let enemy = { hp: 1000, maxHp: 1000, atk: 60 };
 
 const video = document.getElementById('webcam');
 const log = document.getElementById('msg-log');

 async function init() {
 net = await mobilenet.load();
 const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
 video.srcObject = stream;
 }

 async function generateVisual(keyword, targetImgId) {
 const img = document.getElementById(targetImgId);
 // UnsplashのAPIを利用して、キーワードに基づいた画像をランダム取得
 const url = `https://source.unsplash.com/160x160/?${keyword},object`;
 img.src = url;
 img.style.display = "block";
 img.style.opacity = "1";
 }

 document.getElementById('scan-btn').onclick = async () => {
 const result = await net.classify(video);
 const name = result[0].className.split(',')[0].toUpperCase();
 
 if (mode === "WEAPON") {
 document.getElementById('p-name').innerText = name;
 await generateVisual(name, "p-img");
 video.style.display = "none";
 log.innerText = `WEAPON CREATED: ${name}!\nNEXT: SCAN ENEMY MONSTER!`;
 mode = "MONSTER";
 } else if (mode === "MONSTER") {
 document.getElementById('e-name').innerText = name;
 await generateVisual(name, "e-img");
 log.innerText = `MONSTER BORN: ${name}!\nBATTLE START!`;
 document.getElementById('atk-btn').disabled = false;
 document.getElementById('scan-btn').disabled = true;
 mode = "BATTLE";
 }
 };

 document.getElementById('atk-btn').onclick = () => {
 // Player Attack
 document.getElementById('enemy-area').classList.add('shake');
 enemy.hp -= player.atk + Math.floor(Math.random() * 20);
 
 // Enemy Counter
 setTimeout(() => {
 document.getElementById('enemy-area').classList.remove('shake');
 document.getElementById('player-area').classList.add('shake');
 player.hp -= enemy.atk + Math.floor(Math.random() * 20);
 updateUI();
 setTimeout(() => document.getElementById('player-area').classList.remove('shake'), 300);
 }, 500);
 
 updateUI();
 log.innerText = "EXCHANGING BLOWS!!";
 if(player.hp <= 0 || enemy.hp <= 0) {
 log.innerText = player.hp > 0 ? "VICTORY!" : "DEFEAT...";
 document.getElementById('atk-btn').disabled = true;
 }
 };

 function updateUI() {
 document.getElementById('p-hp-fill').style.width = (player.hp / player.maxHp * 100) + "%";
 document.getElementById('e-hp-fill').style.width = (enemy.hp / enemy.maxHp * 100) + "%";
 }

 init();
</script>
</body>
</html>
