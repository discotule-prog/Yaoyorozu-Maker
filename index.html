<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MYTH SCANNER 4.21 - STABLE CAMERA</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet"></script>
    <link href="https://fonts.googleapis.com/css2?family=DotGothic16&display=swap" rel="stylesheet">
    <style>
        /* ...スタイル設定は以前と同じため省略（視認性のために維持）... */
        :root { --p-color: #00f2ff; --e-color: #ff3c00; --exp-color: #32ff32; --gold: #ffd700; }
        body { font-family: 'DotGothic16', sans-serif; background: #000; color: #fff; margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        #header { height: 40px; background: #222; display: flex; justify-content: center; align-items: center; border-bottom: 2px solid #444; flex-shrink: 0; }
        .lib-btn { width: 50%; font-size: 0.6rem; height: 24px; background: #555; border: 1px solid #fff; color: #fff; cursor: pointer; }
        .char-area { height: 32%; display: flex; border-bottom: 1px solid #333; padding: 10px; box-sizing: border-box; }
        .cam-part { width: 35%; display: flex; align-items: center; justify-content: center; }
        .cam-frame { width: 90px; height: 90px; border: 2px solid #555; background: #111; overflow: hidden; position: relative; border-radius: 8px; }
        video { width: 100%; height: 100%; object-fit: cover; display: none; }
        .cam-active video { display: block !important; border-color: #0f0; }
        .info-part { width: 65%; display: flex; flex-direction: column; padding-left: 10px; justify-content: center; }
        .visual-card { width: 100%; height: 80px; border: 2px solid #fff; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #111; position: relative; border-radius: 4px; overflow: hidden; }
        .visual-card img { width: 60px; height: 60px; object-fit: contain; }
        #mid-ui { height: 140px; background: #111; border-top: 2px solid #444; display: flex; flex-direction: column; align-items: center; padding: 5px; flex-shrink: 0; }
        #msg { font-size: 0.8rem; color: #0f0; height: 45px; text-align: center; display: flex; align-items: center; padding: 0 10px; line-height: 1.2; white-space: pre-wrap; }
        .btn-row { display: flex; gap: 5px; width: 95%; justify-content: center; margin-bottom: 5px; }
        button { flex: 1; height: 40px; font-family: 'DotGothic16'; border: 2px solid #fff; color: #fff; background: #444; font-size: 0.75rem; cursor: pointer; }
        .bar-bg { width: 100%; height: 8px; background: #222; border: 1px solid #666; position: relative; overflow: hidden; }
        .bar-fill { height: 100%; width: 0%; transition: width 0.4s ease-out; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 100; display: none; flex-direction: column; align-items: center; padding: 15px; box-sizing: border-box; }
        .q-mark { font-size: 3rem; color: #333; }
    </style>
</head>
<body>

<div id="header"><button onclick="openLibrary()" class="lib-btn">COLLECTION / RESET</button></div>

<div class="char-area" id="p-area">
    <div class="cam-part"><div class="cam-frame"><video id="pv" autoplay playsinline muted></video></div></div>
    <div class="info-part">
        <div id="p-card" class="visual-card">
            <div id="p-rare" class="rarity-tag">-</div>
            <div id="p-elem" class="elem-tag"></div>
            <div id="p-sym" class="q-mark">?</div>
            <div id="p-name" style="font-size:0.6rem; text-align:center;">SCANNER READY</div>
        </div>
        <div class="stat-text">LV:<span id="p-lv">1</span> HP:<span id="p-hp-cur">1000</span>/<span id="p-hp-max">1000</span></div>
        <div class="bar-container"><div class="bar-bg"><div id="p-fill" class="bar-fill" style="background:var(--p-color); width:100%"></div></div></div>
    </div>
</div>

<div id="mid-ui">
    <div id="msg">カメラの準備中...</div>
    <div class="btn-row">
        <button id="scan-btn" onclick="handleScan()" disabled>LOADING AI...</button>
        <button id="atk-btn" onclick="handleAttack()" disabled style="background:#aa0000">ATTACK</button>
    </div>
</div>

<div class="char-area" id="e-area">
    <div class="cam-part"><div class="cam-frame"><video id="ev" autoplay playsinline muted></video></div></div>
    <div class="info-part">
        <div id="e-card" class="visual-card">
            <div id="e-rare" class="rarity-tag">-</div>
            <div id="e-elem" class="elem-tag"></div>
            <div id="e-sym" class="q-mark">?</div>
            <div id="e-name" style="font-size:0.6rem; text-align:center;">???</div>
        </div>
        <div class="stat-text">HP:<span id="e-hp-cur">0</span>/<span id="e-hp-max">0</span></div>
        <div class="bar-container"><div class="bar-bg"><div id="e-fill" class="bar-fill" style="background:var(--e-color);"></div></div></div>
    </div>
</div>

<script>
    // --- カテゴリー別アイコンURL ---
    const ICON_DATA = {
        W: {
            "剣": "https://via.placeholder.com/100/ff3300/ffffff?text=SWORD",
            "槍": "https://via.placeholder.com/100/00cc99/ffffff?text=SPEAR",
            "斧": "https://via.placeholder.com/100/ff6600/ffffff?text=AXE",
            "弓": "https://via.placeholder.com/100/66cc33/ffffff?text=BOW",
            "杖": "https://via.placeholder.com/100/ff00ff/ffffff?text=WAND",
            "短剣": "https://via.placeholder.com/100/777777/ffffff?text=DAGGER",
            "盾": "https://via.placeholder.com/100/ccaa00/ffffff?text=SHIELD"
        },
        M: {
            "スライム": "https://via.placeholder.com/100/44ccff/ffffff?text=SLIME",
            "鳥": "https://via.placeholder.com/100/3366ff/ffffff?text=BIRD",
            "ゾンビ": "https://via.placeholder.com/100/9900cc/ffffff?text=UNDEAD",
            "ハチ": "https://via.placeholder.com/100/ccff00/000000?text=INSECT",
            "ドラゴン": "https://via.placeholder.com/100/333333/ffffff?text=DRAGON",
            "オオカミ": "https://via.placeholder.com/100/aa6600/ffffff?text=BEAST",
            "まどうし": "https://via.placeholder.com/100/4400aa/ffffff?text=WIZARD"
        }
    };

    function getIconUrl(type, name) {
        const pool = ICON_DATA[type];
        if(type === 'W') {
            if(/剣/.test(name)) return pool["剣"];
            if(/槍/.test(name)) return pool["槍"];
            if(/斧/.test(name)) return pool["斧"];
            if(/弓/.test(name)) return pool["弓"];
            if(/杖|ステッキ/.test(name)) return pool["杖"];
            if(/短剣|ナイフ/.test(name)) return pool["短剣"];
            if(/盾/.test(name)) return pool["盾"];
        } else {
            if(/スライム/.test(name)) return pool["スライム"];
            if(/すずめ|タカ|鳥/.test(name)) return pool["鳥"];
            if(/がいこつ|ゾンビ|ドラキュラ/.test(name)) return pool["ゾンビ"];
            if(/むし|ハチ|クワガタ/.test(name)) return pool["ハチ"];
            if(/ドラゴン|トカゲ|竜/.test(name)) return pool["ドラゴン"];
            if(/ネコ|イヌ|ライオン|オオカミ/.test(name)) return pool["オオカミ"];
            if(/まほうつかい|まどうし|だいまどう/.test(name)) return pool["まどうし"];
        }
        return "https://via.placeholder.com/100/444444/ffffff?text=NONE";
    }

    let net, stream = null, mode = "W";

    async function init() {
        document.getElementById('msg').innerText = "AI読込中...";
        try {
            net = await mobilenet.load();
            document.getElementById('scan-btn').disabled = false;
            document.getElementById('scan-btn').innerText = "SCAN START";
            document.getElementById('msg').innerText = "武器をスキャンしてください";
            await switchCamera('P');
        } catch (e) {
            document.getElementById('msg').innerText = "AIエラー: " + e.message;
        }
    }

    // --- 強化版カメラ起動関数 ---
    async function switchCamera(target) {
        if(stream) {
            stream.getTracks().forEach(t => t.stop());
            stream = null;
        }
        
        if(target === 'OFF') {
            document.querySelectorAll('.cam-frame').forEach(f => f.classList.remove('cam-active'));
            return;
        }

        const vId = {P: 'pv', E: 'ev'}[target];
        const videoElement = document.getElementById(vId);

        const constraints = {
            video: {
                facingMode: "environment", // 外カメラ
                width: { ideal: 640 },
                height: { ideal: 640 }
            },
            audio: false
        };

        try {
            stream = await navigator.mediaDevices.getUserMedia(constraints);
            videoElement.srcObject = stream;
            
            // iOS対策: playsinline とあわせて明示的に play() を呼ぶ
            videoElement.onloadedmetadata = () => {
                videoElement.play();
                document.querySelectorAll('.cam-frame').forEach(f => f.classList.remove('cam-active'));
                videoElement.parentElement.classList.add('cam-active');
            };
        } catch (e) {
            let errorMsg = "カメラ起動失敗: ";
            if(e.name === "NotAllowedError") errorMsg += "権限を許可してください";
            else if(e.name === "NotFoundError") errorMsg += "カメラが見つかりません";
            else errorMsg += e.name;
            document.getElementById('msg').innerText = errorMsg;
        }
    }

    async function handleScan() {
        const vid = mode === "W" ? document.getElementById('pv') : document.getElementById('ev');
        let id = Math.floor(Math.random() * 100);
        let aiLabel = "UNKNOWN";

        try {
            const r = await net.classify(vid);
            aiLabel = r[0].className.split(',')[0].toUpperCase();
            id = Math.floor(r[0].probability * 100);
        } catch(e) {}

        if(mode === "W") {
            const name = "鉄の剣"; // テスト用固定名。本来はDB_WEAPON[id]
            const icon = getIconUrl('W', name);
            updateCardUI('p', "NORMAL", `<img src="${icon}">`, name);
            mode = "M";
            await switchCamera('E');
            document.getElementById('msg').innerText = "次はモンスターをスキャン！";
        } else {
            const name = "ドラゴン"; 
            const icon = getIconUrl('M', name);
            updateCardUI('e', "BOSS", `<img src="${icon}">`, name);
            document.getElementById('scan-btn').disabled = true;
            document.getElementById('atk-btn').disabled = false;
            document.getElementById('msg').innerText = "バトル開始！";
        }
    }

    function updateCardUI(side, rare, html, name) {
        document.getElementById(`${side}-rare`).innerText = rare;
        document.getElementById(`${side}-sym`).innerHTML = html;
        document.getElementById(`${side}-sym`).style.fontSize = "1rem";
        document.getElementById(`${side}-name`).innerText = name;
    }

    window.onload = init;
</script>
</body>
</html>
