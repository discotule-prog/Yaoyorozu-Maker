<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MYTH SCANNER 6.2 - FULL INTEGRATED</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet"></script>
    <link href="https://fonts.googleapis.com/css2?family=DotGothic16&display=swap" rel="stylesheet">
    <style>
        :root { --p-color: #00f2ff; --e-color: #ff3c00; --exp-color: #32ff32; --gold: #ffd700; --magic-purple: #9d4edd; --close-btn: #880000; --main-blue: #0044cc; --reset-red: #cc0000; }
        body { font-family: 'DotGothic16', sans-serif; background: #000; color: #fff; margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        #init-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; color: #0f0; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10000; }
        
        #header { height: 40px; background: #222; display: flex; justify-content: space-around; align-items: center; border-bottom: 2px solid #444; flex-shrink: 0; padding: 0 5px; }
        .head-btn { flex: 1; font-size: 0.55rem; height: 26px; border: 1px solid #fff; color: #fff; cursor: pointer; margin: 0 2px; }
        
        .char-area { height: 30%; display: flex; border-bottom: 1px solid #333; padding: 10px; box-sizing: border-box; position: relative; }
        .cam-part { width: 35%; display: flex; align-items: center; justify-content: center; }
        .cam-frame { width: 90px; height: 90px; border: 2px solid #555; background: #111; overflow: hidden; position: relative; border-radius: 8px; }
        .cam-active { border-color: var(--p-color); box-shadow: 0 0 10px var(--p-color); }
        video { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; }
        
        .info-part { width: 65%; display: flex; flex-direction: column; padding-left: 10px; justify-content: center; }
        .visual-card { width: 100%; height: 75px; border: 2px solid #fff; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #111; position: relative; border-radius: 4px; }
        .stat-text { font-size: 0.65rem; color: #ccc; margin-top: 2px; line-height: 1.2; }
        .bar-container { width: 100%; margin-top: 4px; }
        .bar-bg { width: 100%; height: 8px; background: #222; border: 1px solid #666; overflow: hidden; }
        .bar-fill { height: 100%; width: 0%; transition: width 0.4s ease-out; }
        
        #mid-ui { height: 155px; background: #111; border-top: 2px solid #444; display: flex; flex-direction: column; align-items: center; padding: 5px; flex-shrink: 0; }
        #msg { font-size: 0.75rem; color: #0f0; height: 50px; text-align: center; display: flex; align-items: center; justify-content: center; white-space: pre-wrap; width: 90%; }
        
        .btn-row { display: flex; gap: 6px; width: 95%; justify-content: center; margin-bottom: 6px; }
        button { flex: 1; height: 38px; font-family: 'DotGothic16'; border: 2px solid #fff; color: #fff; background: #444; font-size: 0.65rem; cursor: pointer; }
        button:disabled { opacity: 0.25; }

        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 100; display: none; flex-direction: column; align-items: center; padding: 20px; box-sizing: border-box; }
        .scroll-list { width: 100%; overflow-y: auto; display: flex; flex-direction: column; align-items: center; gap: 10px; }
        
        .shake { animation: shake-anim 0.3s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake-anim { 10%, 90% { transform: translate3d(-2px, 0, 0); } 20%, 80% { transform: translate3d(3px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-6px, 0, 0); } }
    </style>
</head>
<body>

<div id="init-overlay">
    <h1 style="margin-bottom:10px;">MYTH SCANNER 6.2</h1>
    <div id="init-msg">SYSTEM INITIALIZING...</div>
    <button id="start-btn" onclick="startGame()" style="display:none; margin-top:20px; padding:15px 40px; background:var(--main-blue); border-radius:8px; border:none; color:white;">LINK START</button>
</div>

<div id="header">
    <button onclick="if(confirm('RESET?')){localStorage.clear();location.reload();}" class="head-btn" style="background:var(--reset-red);">RESET</button>
    <button onclick="openLibrary()" class="head-btn" style="background:#555;">COLLECTION</button>
    <button id="sp-btn" onclick="openSkillMenu()" class="head-btn" style="background:var(--magic-purple);">SKILL UP (0)</button>
</div>

<div class="char-area" id="p-area">
    <div class="cam-part"><div class="cam-frame"><video id="pv" autoplay playsinline muted></video></div></div>
    <div class="info-part">
        <div class="visual-card">
            <div id="p-elem" style="position:absolute; top:2px; left:5px;"></div>
            <div id="p-rare" style="position:absolute; top:2px; right:5px; font-size:0.5rem; background:#fff; color:#000; padding:1px 3px;">-</div>
            <div id="p-sym" style="font-size:1.8rem;">âš”ï¸</div>
            <div id="p-name" style="font-size:0.55rem;">WEAPON READY</div>
        </div>
        <div class="stat-text">LV:<span id="p-lv">1</span> HP:<span id="p-hp-cur">1000</span>/<span id="p-hp-max">1000</span></div>
        <div class="bar-container"><div class="bar-bg"><div id="p-fill" class="bar-fill" style="background:var(--p-color); width:100%"></div></div></div>
    </div>
</div>

<div id="mid-ui">
    <div id="msg">INITIALIZING SYSTEM...</div>
    <div class="btn-row">
        <button id="scan-btn" onclick="handleScan()" disabled style="background:var(--main-blue); flex:1.5;">SCAN</button>
        <button id="atk-btn" onclick="handleAttack()" disabled style="background:#aa0000; flex:1.5;">ATTACK</button>
    </div>
    <div class="btn-row">
        <button id="magic-btn" onclick="openMagicMenu()" disabled style="background:var(--magic-purple);">MAGIC</button>
        <button id="item-open-btn" onclick="openItemMenu()" disabled style="background:#008844;">ITEM</button>
        <button id="esc-btn" onclick="handleEscape()" disabled style="background:#555;">ESCAPE</button>
    </div>
</div>

<div class="char-area" id="e-area">
    <div class="cam-part"><div class="cam-frame"><video id="ev" autoplay playsinline muted></video></div></div>
    <div class="info-part">
        <div class="visual-card">
            <div id="e-elem" style="position:absolute; top:2px; left:5px;"></div>
            <div id="e-rare" style="position:absolute; top:2px; right:5px; font-size:0.5rem; background:#fff; color:#000; padding:1px 3px;">-</div>
            <div id="e-sym" style="font-size:1.8rem;">?</div>
            <div id="e-name" style="font-size:0.55rem;">???</div>
        </div>
        <div class="stat-text">HP:<span id="e-hp-cur">0</span>/<span id="e-hp-max">0</span></div>
        <div class="bar-container"><div class="bar-bg"><div id="e-fill" class="bar-fill" style="background:var(--e-color);"></div></div></div>
    </div>
</div>

<div id="magic-overlay" class="overlay"><h2>MAGIC</h2><div id="magic-list" class="scroll-list"></div><button onclick="closeOverlay()" style="margin-top:20px; background:var(--close-btn);">CLOSE</button></div>
<div id="item-overlay" class="overlay"><h2>ITEMS</h2><div id="item-list" class="scroll-list"></div><button onclick="closeOverlay()" style="margin-top:20px; background:var(--close-btn);">CLOSE</button></div>
<div id="skill-overlay" class="overlay"><h2>SKILL UP</h2><div id="skill-points-display"></div><div id="skill-list" class="scroll-list"></div><button onclick="closeOverlay()" style="margin-top:20px; background:var(--close-btn);">CLOSE</button></div>
<div id="bonus-overlay" class="overlay"><h2>VICTORY!</h2><div class="cam-frame" style="width:150px; height:150px; margin:20px;"><video id="bv" autoplay playsinline muted></video></div><button id="get-item-btn" onclick="getBonusItem()" style="background:var(--gold); color:#000; font-weight:bold; padding:20px;">SCAN FOR LOOT</button></div>

<script>
// --- Data ---
const DB_WEAPON = ["éŒ†ã³ãŸçŸ­å‰£","é‰„ã®å‰£","ååˆ€æ­£å®—","ãƒ¬ãƒ¼ãƒ´ã‚¡ãƒ†ã‚¤ãƒ³","æ˜Ÿç •ãã®æ§Œ"];
const DB_MONSTER = ["é‡è‰¯çŠ¬","ã¯ãã‚Œãƒ¡ã‚¿ãƒ«","åœ°ç„ã®é–€ç•ª","å¤ã®é­”é¾","è™šç„¡ã®ç‹"];
const DB_ITEM_FULL = {
    200: {name:"éå¸¸é£Ÿ", rare:"NORMAL", type:"HP RECOVERY", val:100, mode:"fix"},
    201: {name:"ãƒ‘ãƒ³", rare:"NORMAL", type:"HP RECOVERY", val:200, mode:"fix"},
    202: {name:"ç¼¶è©°", rare:"NORMAL", type:"HP RECOVERY", val:300, mode:"fix"},
    203: {name:"æ–°é®®é‡èœ", rare:"NORMAL", type:"HP RECOVERY", val:400, mode:"fix"},
    204: {name:"æ—¬ã®é‡èœ", rare:"NORMAL", type:"HP RECOVERY", val:500, mode:"fix"},
    205: {name:"æœå®Ÿ", rare:"ELITE", type:"HP RECOVERY", val:600, mode:"fix"},
    206: {name:"é«˜ç´šæœå®Ÿ", rare:"ELITE", type:"HP RECOVERY", val:700, mode:"fix"},
    207: {name:"éª¨ä»˜ãè‚‰", rare:"ELITE", type:"HP RECOVERY", val:800, mode:"fix"},
    208: {name:"éª¨ä»˜ãè‚‰ï¼ˆå¤§ï¼‰", rare:"ELITE", type:"HP RECOVERY", val:900, mode:"fix"},
    209: {name:"æºå¸¯ãƒ•ãƒ«ã‚³ãƒ¼ã‚¹", rare:"ELITE", type:"HP RECOVERY", val:1000, mode:"fix"},
    210: {name:"è»Ÿè†", rare:"NORMAL", type:"HP RECOVERY", val:0.1, mode:"pct"},
    211: {name:"ã‚¨ãƒŠã‚¸ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯", rare:"NORMAL", type:"HP RECOVERY", val:0.2, mode:"pct"},
    212: {name:"æ „é¤Šãƒ‰ãƒªãƒ³ã‚¯", rare:"NORMAL", type:"HP RECOVERY", val:0.3, mode:"pct"},
    213: {name:"å‚·è–¬", rare:"NORMAL", type:"HP RECOVERY", val:0.4, mode:"pct"},
    214: {name:"é«˜ç´šå‚·è–¬", rare:"NORMAL", type:"HP RECOVERY", val:0.5, mode:"pct"},
    215: {name:"ãƒãƒ¼ã‚·ãƒ§ãƒ³", rare:"ELITE", type:"HP RECOVERY", val:0.6, mode:"pct"},
    216: {name:"ãƒã‚¤ãƒãƒ¼ã‚·ãƒ§ãƒ³", rare:"ELITE", type:"HP RECOVERY", val:0.7, mode:"pct"},
    217: {name:"ã‚¨ã‚¯ã‚¹ãƒãƒ¼ã‚·ãƒ§ãƒ³", rare:"ELITE", type:"HP RECOVERY", val:0.8, mode:"pct"},
    218: {name:"è–æ°´", rare:"LEGEND", type:"HP RECOVERY", val:0.9, mode:"pct"},
    219: {name:"ç¥æ§˜ã®é›«", rare:"LEGEND", type:"HP RECOVERY", val:1.0, mode:"pct"},
    220: {name:"æ¾æ˜", rare:"NORMAL", type:"ELEMENTAL ATTACK", elem:"ğŸ”¥", val:0.1},
    221: {name:"æ°´é¢¨èˆ¹", rare:"NORMAL", type:"ELEMENTAL ATTACK", elem:"ğŸ’§", val:0.1},
    222: {name:"å£Šã‚ŒãŸæ©Ÿæ¢°", rare:"NORMAL", type:"ELEMENTAL ATTACK", elem:"âš¡", val:0.1},
    223: {name:"è”¦", rare:"NORMAL", type:"ELEMENTAL ATTACK", elem:"ğŸŒ¿", val:0.1},
    224: {name:"ç«ç‚ç“¶", rare:"NORMAL", type:"ELEMENTAL ATTACK", elem:"ğŸ”¥", val:0.2},
    225: {name:"æ°´é‰„ç ²", rare:"NORMAL", type:"ELEMENTAL ATTACK", elem:"ğŸ’§", val:0.2},
    226: {name:"ãƒ“ãƒªãƒ“ãƒªãƒã‚·ãƒ³", rare:"NORMAL", type:"ELEMENTAL ATTACK", elem:"âš¡", val:0.2},
    227: {name:"èŠæ£˜", rare:"NORMAL", type:"ELEMENTAL ATTACK", elem:"ğŸŒ¿", val:0.2},
    228: {name:"æ‰‹æ¦´å¼¾", rare:"NORMAL", type:"ELEMENTAL ATTACK", elem:"ğŸ”¥", val:0.3},
    229: {name:"æ”¾æ°´ãƒ›ãƒ¼ã‚¹", rare:"NORMAL", type:"ELEMENTAL ATTACK", elem:"ğŸ’§", val:0.3},
    230: {name:"é›»æ°—ã‚·ãƒ§ãƒƒã‚¯", rare:"NORMAL", type:"ELEMENTAL ATTACK", elem:"âš¡", val:0.3},
    231: {name:"æœ‰æ¯’æ¤ç‰©", rare:"NORMAL", type:"ELEMENTAL ATTACK", elem:"ğŸŒ¿", val:0.3},
    232: {name:"ç«ç‚æ”¾å°„å™¨", rare:"ELITE", type:"ELEMENTAL ATTACK", elem:"ğŸ”¥", val:0.4},
    233: {name:"é«˜åœ§æ´—æµ„æ©Ÿ", rare:"ELITE", type:"ELEMENTAL ATTACK", elem:"ğŸ’§", val:0.4},
    234: {name:"ã‚¹ã‚¿ãƒ³ã‚¬ãƒ³", rare:"ELITE", type:"ELEMENTAL ATTACK", elem:"âš¡", val:0.4},
    235: {name:"é£Ÿè™«æ¤ç‰©", rare:"ELITE", type:"ELEMENTAL ATTACK", elem:"ğŸŒ¿", val:0.4},
    236: {name:"çˆ†å¼¾", rare:"LEGEND", type:"ELEMENTAL ATTACK", elem:"ğŸ”¥", val:0.5},
    237: {name:"ã‚¦ã‚©ãƒ¼ã‚¿ãƒ¼ã‚«ãƒƒã‚¿ãƒ¼", rare:"LEGEND", type:"ELEMENTAL ATTACK", elem:"ğŸ’§", val:0.5},
    238: {name:"ã‚¨ãƒ¬ã‚­ãƒ†ãƒ«", rare:"LEGEND", type:"ELEMENTAL ATTACK", elem:"âš¡", val:0.5},
    239: {name:"å¾¡ç¥æœ¨ã®æ", rare:"LEGEND", type:"ELEMENTAL ATTACK", elem:"ğŸŒ¿", val:0.5},
    240: {name:"é¢¨é‚ªã‚¦ã‚¤ãƒ«ã‚¹", rare:"NORMAL", type:"DEBUFF_DEF", val:0.1},
    241: {name:"ã‚µãƒ³ãƒ—ãƒ«ç—…åŸèŒ", rare:"NORMAL", type:"DEBUFF_DEF", val:0.2},
    242: {name:"äººå·¥ã‚¦ã‚¤ãƒ«ã‚¹", rare:"NORMAL", type:"DEBUFF_DEF", val:0.3},
    243: {name:"ã‚¤ãƒ³ãƒ•ãƒ«ã‚¨ãƒ³ã‚¶", rare:"ELITE", type:"DEBUFF_DEF", val:0.4},
    244: {name:"æœªçŸ¥ã®ã‚¦ã‚¤ãƒ«ã‚¹", rare:"LEGEND", type:"DEBUFF_DEF", val:0.5},
    245: {name:"ã‚ªãƒ«ã‚´ãƒ¼ãƒ«", rare:"NORMAL", type:"DEBUFF_ATK", val:0.1},
    246: {name:"å®‰çœ æ•", rare:"NORMAL", type:"DEBUFF_ATK", val:0.2},
    247: {name:"ã‚„ã‚‹æ°—ã‚ªãƒ•ã‚¹ã‚¤ãƒƒãƒ", rare:"NORMAL", type:"DEBUFF_ATK", val:0.3},
    248: {name:"ä¸–ç•Œèª¬æ•™ãƒ†ãƒ¼ãƒ—", rare:"ELITE", type:"DEBUFF_ATK", val:0.4},
    249: {name:"èƒ¸ç³æ˜ åƒé›†", rare:"LEGEND", type:"DEBUFF_ATK", val:0.5},
    250: {name:"æ¤ç‰©ç³»ãƒ—ãƒ­ãƒ†ã‚¤ãƒ³", rare:"NORMAL", type:"BUFF_DEF", val:0.1},
    251: {name:"å‹•ç‰©ç³»ãƒ—ãƒ­ãƒ†ã‚¤ãƒ³", rare:"NORMAL", type:"BUFF_DEF", val:0.2},
    252: {name:"ç­‹è‚‰å¢—å¼·å‰¤", rare:"NORMAL", type:"BUFF_DEF", val:0.3},
    253: {name:"ç­‹è‚‰å¢—å¼·å‰¤", rare:"ELITE", type:"BUFF_DEF", val:0.4},
    254: {name:"åˆæ³•ãƒ‰ãƒ©ãƒƒã‚°", rare:"LEGEND", type:"BUFF_DEF", val:0.5},
    255: {name:"æ¤ç‰©ç³»ãƒ—ãƒ­ãƒ†ã‚¤ãƒ³", rare:"NORMAL", type:"BUFF_ATK", val:0.1},
    256: {name:"å‹•ç‰©ç³»ãƒ—ãƒ­ãƒ†ã‚¤ãƒ³", rare:"NORMAL", type:"BUFF_ATK", val:0.2},
    257: {name:"ç­‹è‚‰å¢—å¼·å‰¤", rare:"NORMAL", type:"BUFF_ATK", val:0.3},
    258: {name:"ç­‹è‚‰å¢—å¼·å‰¤", rare:"ELITE", type:"BUFF_ATK", val:0.4},
    259: {name:"åˆæ³•ãƒ‰ãƒ©ãƒƒã‚°", rare:"LEGEND", type:"BUFF_ATK", val:0.5},
    260: {name:"ç…™ç‰", rare:"NORMAL", type:"ESCAPE", eff:"escape"},
    261: {name:"å¹¸é‹ã®ç£çŸ³", rare:"LEGEND", type:"LUCKY ITEM", eff:"none"},
    262: {name:"ä¸æ€è­°ãªç ‚æ™‚è¨ˆ", rare:"LEGEND", type:"TIME LOOP", eff:"extra"},
    263: {name:"ã‚¾ãƒ¼ãƒ³ã®å¿ƒå¾—", rare:"ELITE", type:"ATK FLAG", eff:"m_rec"}, 
    264: {name:"ãƒœã‚¯ã‚µãƒ¼ã‚·ãƒ¥ãƒ¼ã‚º", rare:"ELITE", type:"DFE FLAG", eff:"atk_up"},
    265: {name:"èµ¤ã„ãƒãƒ³ãƒˆ", rare:"ELITE", type:"ATTRIBUTE CHANGE", eff:"fire_change"},
    266: {name:"é’ã„è…•è¼ª", rare:"ELITE", type:"ATTRIBUTE CHANGE", eff:"water_change"},
    267: {name:"é»„è‰²ã®ãƒ”ã‚¢ã‚¹", rare:"ELITE", type:"ATTRIBUTE CHANGE", eff:"elec_change"},
    268: {name:"ç·‘ã®æŒ‡è¼ª", rare:"ELITE", type:"ATTRIBUTE CHANGE", val:10, eff:"leaf_change"},
    269: {name:"è™¹ã®ã‹ã‘ã‚‰", rare:"LEGEND", type:"ATTRIBUTE CHANGE", eff:"all_change"},
    270: {name:"ç™ºç«ç‡ƒæ–™", rare:"ELITE", type:"FIELD CHANGE", elem:"ğŸ”¥"},
    271: {name:"é›¨é›²ç™ºç”Ÿæ©Ÿ", rare:"ELITE", type:"FIELD CHANGE", elem:"ğŸ’§"},
    272: {name:"ç£å ´ç™ºç”Ÿè£…ç½®", rare:"ELITE", type:"FIELD CHANGE", elem:"âš¡"},
    273: {name:"è¶…æˆé•·ä¿ƒé€²å‰¤", rare:"ELITE", type:"FIELD CHANGE", elem:"ğŸŒ¿"},
    274: {name:"æ¯’é‡", rare:"NORMAL", type:"POISON", eff:"instant"},
    275: {name:"ã‚®ãƒ£ãƒ³ãƒ–ãƒ©ãƒ¼ã®ã‚µã‚¤ã‚³ãƒ­", rare:"ELITE", type:"DICE", eff:"gamble"},
    276: {name:"ãƒšãƒ³ã‚­", rare:"NORMAL", type:"PAINT", eff:"paint"},
    277: {name:"è¦šæ‚Ÿã®ã‚¹ã‚¹ãƒ¡", rare:"ELITE", type:"ATK ONLY", eff:"atk_sac"},
    278: {name:"äº€ã®ç”²ç¾…", rare:"ELITE", type:"DFE ONLY", eff:"def_sac"},
    279: {name:"ç½ ", rare:"NORMAL", type:"TRAP ITEM", eff:"trap"},
    280: {name:"å¤ã³ãŸãƒ©ãƒ³ãƒ—", rare:"LEGEND", type:"ARTIFACT"},
    281: {name:"ä½•ã‹ã®ç¥æ§˜ã®åƒ", rare:"LEGEND", type:"ARTIFACT"},
    282: {name:"èª°ã‹ã®æ—¥è¨˜", rare:"LEGEND", type:"ARTIFACT"},
    283: {name:"æµ·è³Šã®éŠ€è²¨", rare:"LEGEND", type:"ARTIFACT"},
    284: {name:"æ›¸ã‘ãªã„ä¸‡å¹´ç­†", rare:"NORMAL", type:"ARTIFACT"},
    285: {name:"æ±æ´‹ã®æ°´å¢¨ç”»", rare:"NORMAL", type:"ARTIFACT"},
    286: {name:"è£¸ã®ç‹æ§˜ã®æœ", rare:"ELITE", type:"ARTIFACT"},
    287: {name:"ç›¸å¯¾æ€§ç†è«–åŸæœ¬ï¼ˆå†™ï¼‰", rare:"ELITE", type:"ARTIFACT"},
    288: {name:"é™ã‚ŠãªãçœŸå††ã«è¿‘ã„çŸ³", rare:"LEGEND", type:"ARTIFACT"},
    289: {name:"å††å‘¨ç‡æœ€å¾Œã®æ•°å­—", rare:"ELITE", type:"ARTIFACT"},
    290: {name:"èª°ã‚‚çŸ¥ã‚‰ãªã„ç‰©èª", rare:"LEGEND", type:"ARTIFACT"},
    291: {name:"æ¼¢ã®æµªæ¼«", rare:"LEGEND", type:"ARTIFACT"},
    292: {name:"å¤ä»£ã®ãƒ‡ã‚¸ã‚¿ãƒ«æ™‚è¨ˆ", rare:"ELITE", type:"ARTIFACT"},
    293: {name:"å½å…¸", rare:"ELITE", type:"ARTIFACT"},
    294: {name:"ã‚µãƒ³ã‚¿ã®é«­", rare:"NORMAL", type:"ARTIFACT"},
    295: {name:"ã‚µãƒ³ã‚¿ã®é«­ï¼ˆæœ¬ç‰©ï¼‰", rare:"LEGEND", type:"ARTIFACT"},
    296: {name:"å¤©ä½¿ã®ã‚ã£ã‹", rare:"LEGEND", type:"ARTIFACT"},
    297: {name:"é¾ã®ç³", rare:"LEGEND", type:"ARTIFACT"},
    298: {name:"çŸ³", rare:"NORMAL", type:"STONE"},
    299: {name:"è–æ›¸", rare:"LEGEND", type:"BIBLE", eff:"bible"}
};

const ELEMENTS = { "ğŸ”¥": "ğŸŒ¿", "ğŸŒ¿": "âš¡", "âš¡": "ğŸ’§", "ğŸ’§": "ğŸ”¥" };
const MAGIC_INFO = {
    H: { n: "ãƒ’ãƒ¼ãƒ«", s: "âœ¨" }, F: { n: "ãƒ•ã‚¡ã‚¤ã‚¢", s: "ğŸ”¥" }, W: { n: "ã‚¦ã‚©ãƒ¼ã‚¿ãƒ¼", s: "ğŸ’§" },
    L: { n: "ãƒ©ã‚¤ãƒˆãƒ‹ãƒ³ã‚°", s: "âš¡" }, G: { n: "ã‚¬ã‚¤ã‚¢", s: "ğŸŒ¿" }, K: { n: "ã‚«ãƒ¼ã‚¹", s: "ğŸ’€" },
    B: { n: "ãƒ–ãƒ¬ã‚¤ã‚¯", s: "âš”ï¸" }, R: { n: "ãƒ–ãƒ¬ã‚¤ãƒ–", s: "âœŠ" }, S: { n: "ã‚·ãƒ¼ãƒ«", s: "ğŸ›¡ï¸" }
};

// --- Variables ---
let lv=1, exp=0, php=1000, pMax=1000, patk=120, pdef=60, pelem="ğŸ”¥", inventory=[], skillPoints=0;
let magicLv = {H:1, F:0, W:0, L:0, G:0, B:0, K:0, S:0, R:0};
let net, mode="W", ehp=0, eMax=0, eatk=0, edef=0, eelem="", stream=null;

// æˆ¦é—˜ä¸­ã®çŠ¶æ…‹ç®¡ç†
let hasUsedItemThisTurn = false; // ã‚¢ã‚¤ãƒ†ãƒ 1ã‚¿ãƒ¼ãƒ³1å›åˆ¶é™ç”¨
let magicCommandUsed = false;    // é­”æ³•ã‚³ãƒãƒ³ãƒ‰å°å°ç”¨
let isSureHit = false; 
let isPerfectEvasion = false; 
let trapTimer = 0;

// æ—§ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®åæ®‹ï¼ˆå€‹åˆ¥åˆ¶é™ã‚’ä½¿ã‚ãªã„ãªã‚‰å‰Šé™¤OKï¼‰
let magicUsedThisBattle = {H:false,F:false,W:false,L:false,G:false,B:false,K:false,S:false,R:false};

let library = JSON.parse(localStorage.getItem('myth_v6_lib')) || { W: {}, M: {}, I: {} };

// --- Core Logic ---
async function init() {
    const saved = JSON.parse(localStorage.getItem('myth_v6_save')) || {};
    if(saved.lv) { lv=saved.lv; exp=saved.exp; pMax=saved.pMax; magicLv=saved.magicLv; skillPoints=saved.skillPoints; inventory=saved.inventory; }
    php = pMax;
    updateUI();
    try {
        net = await mobilenet.load();
        document.getElementById('init-msg').innerText = "SYSTEM READY";
        document.getElementById('start-btn').style.display = 'block';
    } catch(e) { alert("AI Load Error"); }
}

async function startGame() {
    await switchCamera('P');
    document.getElementById('init-overlay').style.display = 'none';
    document.getElementById('scan-btn').disabled = false;
    document.getElementById('msg').innerText = "æ­¦å™¨ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ãã ã•ã„";
}

async function switchCamera(target) {
    if(stream) stream.getTracks().forEach(t => t.stop());
    const vId = {P:'pv', E:'ev', B:'bv'}[target];
    const video = document.getElementById(vId);
    if(!video) return;
    stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
    video.srcObject = stream;
    video.style.display = 'block';
}

async function handleScan() {
    const vid = mode === "W" ? document.getElementById('pv') : document.getElementById('ev');
    applyShake();
    let id = Math.floor(Math.random() * 100);
    try { const r = await net.classify(vid); id = (r[0].className.length * 7) % 100; } catch(e){}
    
    const rare = id >= 90 ? "LEGEND" : id >= 60 ? "ELITE" : "NORMAL";
    const typeId = id % 4;
    const elemList = ["ğŸ”¥", "ğŸ’§", "âš¡", "ğŸŒ¿"];

    if(mode === "W") {
        pelem = elemList[typeId];
        const name = DB_WEAPON[id % DB_WEAPON.length];
        updateCardUI('p', "âš”ï¸", name, pelem, rare);
        library.W[id] = { t: name, e: pelem, r: rare };
        mode = "E";
        await switchCamera('E');
        document.getElementById('msg').innerText = "ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã‚’æ¢ã—ã¦ã„ã¾ã™...";
    } else {
        eelem = elemList[typeId];
        eMax = Math.floor(800 * (1 + lv*0.1)); ehp = eMax;
        eatk = Math.floor(80 * (1 + lv*0.1)); edef = Math.floor(40 * (1 + lv*0.1));
        const name = DB_MONSTER[id % DB_MONSTER.length];
        updateCardUI('e', "ğŸ‘¾", name, eelem, rare);
        library.M[id+100] = { t: name, e: eelem, r: rare };
        setBattleBtns(false);
        document.getElementById('scan-btn').disabled = true;
        document.getElementById('msg').innerText = "ãƒãƒˆãƒ«é–‹å§‹ï¼";
    }
    updateUI();
    save();
}

function handleAttack() {
    setBattleBtns(true);
    let isHit = isSureHit || Math.random() > 0.15;
    if(isHit) {
        applyShake();
        const bonus = ELEMENTS[pelem] === eelem ? 1.5 : 1.0;
        let dmg = Math.floor(Math.max(50, (patk * bonus) - (edef * 0.2)));
        if(isSureHit) dmg = Math.floor(dmg * 1.5);
        ehp = Math.max(0, ehp - dmg);
        document.getElementById('msg').innerText = `ğŸ’¥ ${dmg}ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼`;
    } else {
        document.getElementById('msg').innerText = "ğŸ’¨ ãƒŸã‚¹ï¼";
    }
    isSureHit = false;
    updateUI();
    setTimeout(() => { if(ehp <= 0) showBonus(); else enemyTurn(); }, 1000);
}

function enemyTurn() {
    if(trapTimer > 0) { trapTimer--; if(Math.random() < 0.5) { document.getElementById('msg').innerText = "ç½ ã«ã‹ã‹ã£ã¦ã„ã‚‹ï¼"; setTimeout(()=>setBattleBtns(false), 1000); return; } }
    document.getElementById('msg').innerText = "æ•µã®æ”»æ’ƒï¼";
    setTimeout(() => {
        if(isPerfectEvasion) { document.getElementById('msg').innerText = "ğŸ’¨ å›é¿ï¼"; isPerfectEvasion=false; setBattleBtns(false); return; }
        applyShake();
        let dmg = Math.floor(Math.max(30, eatk - (pdef * 0.2)));
        php = Math.max(0, php - dmg);
        document.getElementById('msg').innerText = `âš ï¸ ${dmg}ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼`;
        updateUI();
        if(php <= 0) { alert("æ•—åŒ—..."); resetBattle(); } else { setBattleBtns(false); }
    }, 1000);
}

// --- Menu Systems ---
function openMagicMenu() {
    const list = document.getElementById('magic-list'); list.innerHTML = "";
    for(let k in magicLv) {
        if(magicLv[k] > 0) {
            const b = document.createElement('button');
            b.innerHTML = `${MAGIC_INFO[k].s} ${MAGIC_INFO[k].n} (Lv.${magicLv[k]}) ${magicUsedThisBattle[k]?'[ç©º]':''}`;
            b.disabled = magicUsedThisBattle[k];
            b.onclick = () => castMagic(k);
            list.appendChild(b);
        }
    }
    document.getElementById('magic-overlay').style.display = 'flex';
}

// --- é­”æ³•ã‚·ã‚¹ãƒ†ãƒ ï¼ˆä¿®æ­£ç‰ˆï¼‰ ---
function castMagic(type) {
    // é­”æ³•ã‚’ç™ºå‹•ã—ãŸã‚‰ã€ã“ã®æˆ¦é—˜ä¸­ã€ŒMAGICãƒœã‚¿ãƒ³ã€è‡ªä½“ã‚’å°å°ã™ã‚‹ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹
    magicCommandUsed = true; 
    
    const mlv = magicLv[type];
    const info = MAGIC_INFO[type];
    let msg = `${info.s} ${info.n} Lv.${mlv}ï¼\n`;
    
    // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹
    document.getElementById('magic-overlay').style.display = 'none';

    // åŠ¹æœå‡¦ç†
    if (type === 'H') {
        let heal = Math.floor(pMax * 0.3);
        php = Math.min(pMax, php + heal);
        msg += `HPãŒ ${heal} å›å¾©ï¼`;
    } else {
        applyShake();
        let dmg = mlv * 100;
        ehp = Math.max(0, ehp - dmg);
        msg += `${dmg} ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼`;
    }

    document.getElementById('msg').innerText = msg;
    updateUI();

    // é­”æ³•ä½¿ç”¨å¾Œã¯å³åº§ã«ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
    setBattleBtns(true);

    setTimeout(() => {
        if (ehp <= 0) showBonus();
        else enemyTurn();
    }, 1500);
}

function openItemMenu() {
    const list = document.getElementById('item-list'); list.innerHTML = "";
    inventory.forEach((gid, i) => {
        const itm = DB_ITEM_FULL[gid] || {name:"ä¸æ˜ãªçŸ³", rare:"NORMAL"};
        const b = document.createElement('button');
        b.innerHTML = `[${itm.rare}] ${itm.name}`;
        b.onclick = () => { if(!hasUsedItemThisTurn) { useItem(gid, i); } else { alert("1ã‚¿ãƒ¼ãƒ³1å›ã¾ã§ã§ã™"); } };
        list.appendChild(b);
    });
    document.getElementById('item-overlay').style.display = 'flex';
}

function useItem(gid, idx) {
    const itm = DB_ITEM_FULL[gid];
    if(itm && itm.type === "HP RECOVERY") php = Math.min(pMax, php + itm.val);
    inventory.splice(idx, 1);
    hasUsedItemThisTurn = true;
    document.getElementById('item-overlay').style.display = 'none';
    document.getElementById('msg').innerText = `${itm?itm.name:'ã‚¢ã‚¤ãƒ†ãƒ '}ã‚’ä½¿ç”¨ã—ãŸï¼`;
    updateUI();
    if(ehp <= 0) showBonus();
}

function openSkillMenu() {
    document.getElementById('skill-points-display').innerText = `ãƒã‚¤ãƒ³ãƒˆ: ${skillPoints}`;
    const list = document.getElementById('skill-list'); list.innerHTML = "";
    for(let k in magicLv) {
        const b = document.createElement('button');
        const cost = magicLv[k] + 1;
        b.innerHTML = `${MAGIC_INFO[k].n} Lv.${magicLv[k]} -> ${magicLv[k]+1} (æ¶ˆè²»:${cost})`;
        b.onclick = () => { if(skillPoints >= cost) { skillPoints -= cost; magicLv[k]++; save(); openSkillMenu(); updateUI(); } };
        list.appendChild(b);
    }
    document.getElementById('skill-overlay').style.display = 'flex';
}

// --- Utils ---
function updateUI() {
    document.getElementById('p-lv').innerText = lv;
    document.getElementById('p-hp-cur').innerText = php;
    document.getElementById('p-hp-max').innerText = pMax;
    document.getElementById('p-fill').style.width = (php/pMax*100) + "%";
    document.getElementById('e-hp-cur').innerText = ehp;
    document.getElementById('e-hp-max').innerText = eMax;
    document.getElementById('e-fill').style.width = eMax > 0 ? (ehp/eMax*100) + "%" : "0%";
    document.getElementById('sp-btn').innerText = `SKILL UP (${skillPoints})`;
}
function updateCardUI(side, sym, name, elem, rare) {
    document.getElementById(`${side}-sym`).innerText = sym;
    document.getElementById(`${side}-name`).innerText = name;
    document.getElementById(`${side}-elem`).innerText = elem;
    document.getElementById(`${side}-rare`).innerText = rare;
}
// --- ãƒœã‚¿ãƒ³åˆ¶å¾¡ï¼ˆä¿®æ­£ç‰ˆï¼‰ ---
let magicCommandUsed = false; // æˆ¦é—˜ã”ã¨ã«ç®¡ç†ã™ã‚‹ãƒ•ãƒ©ã‚°

function setBattleBtns(dis) {
    document.getElementById('atk-btn').disabled = dis;
    document.getElementById('item-open-btn').disabled = dis;
    document.getElementById('esc-btn').disabled = dis;
    
    // é­”æ³•ã‚³ãƒãƒ³ãƒ‰ã®åˆ¶å¾¡ï¼š
    // disãŒtrueï¼ˆæ•µã®ã‚¿ãƒ¼ãƒ³ãªã©ï¼‰ã®æ™‚ã¯ç„¡åŠ¹ã€‚
    // disãŒfalseï¼ˆè‡ªåˆ†ã®ã‚¿ãƒ¼ãƒ³ï¼‰ã§ã‚‚ã€æ—¢ã«é­”æ³•ã‚’ä½¿ã£ã¦ã„ã‚Œã°ç„¡åŠ¹ã®ã¾ã¾ã€‚
    const magicBtn = document.getElementById('magic-btn');
    if (magicBtn) {
        magicBtn.disabled = dis || magicCommandUsed;
    }

    if (!dis) hasUsedItemThisTurn = false; 
}

// --- æˆ¦é—˜ãƒªã‚»ãƒƒãƒˆï¼ˆä¿®æ­£ç‰ˆï¼‰ ---
function resetBattle() {
    mode = "W"; ehp = 0; eMax = 0;
    magicCommandUsed = false; // æ–°ã—ã„æˆ¦é—˜ã§ã¯é­”æ³•ã‚³ãƒãƒ³ãƒ‰ã‚’è§£ç¦
    document.getElementById('scan-btn').disabled = false;
    setBattleBtns(true);
    switchCamera('P');
    updateUI();
    save();
}
function applyShake() { document.body.classList.add('shake'); setTimeout(() => document.body.classList.remove('shake'), 300); if(navigator.vibrate) navigator.vibrate(100); }
function closeOverlay() { document.querySelectorAll('.overlay').forEach(o => o.style.display = 'none'); }
function save() { localStorage.setItem('myth_v6_save', JSON.stringify({lv, exp, pMax, magicLv, skillPoints, inventory})); localStorage.setItem('myth_v6_lib', JSON.stringify(library)); }
function handleEscape() { if(confirm("é€ƒã’ã¾ã™ã‹ï¼Ÿ")) resetBattle(); }

function showBonus() {
    skillPoints += 1; lv++; pMax += 100; php = pMax;
    document.getElementById('bonus-overlay').style.display = 'flex';
    switchCamera('B');
}
// --- å‹åˆ©æ™‚ã®å‡¦ç† ---
function showBonus() {
    mode = "I"; // ãƒ¢ãƒ¼ãƒ‰ã‚’ã‚¢ã‚¤ãƒ†ãƒ ã‚¹ã‚­ãƒ£ãƒ³(Item scan)ã«å¤‰æ›´
    document.getElementById('msg').innerText = "ENEMY DEFEATED!\nã‚¢ã‚¤ãƒ†ãƒ ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ãã ã•ã„...";
    
    // çµŒé¨“å€¤ç²å¾— (ä¾‹: ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã®HPã«åŸºã¥ã„ãŸçµŒé¨“å€¤)
    let gainExp = Math.floor(eMax / 10);
    exp += gainExp;
    if (exp >= lv * 100) {
        lv++;
        exp = 0;
        skillPoints += 2;
        alert("LEVEL UP!");
    }
    
    updateUI();
    save();
    
    // ãƒãƒˆãƒ«UIã‚’é–‰ã˜ã¦ã‚¹ã‚­ãƒ£ãƒ³ç”»é¢ï¼ˆã‚¢ã‚¤ãƒ†ãƒ ç”¨ï¼‰ã¸
    // å®Ÿéš›ã«ã¯ã‚¹ã‚­ãƒ£ãƒ³ãƒœã‚¿ãƒ³ã‚’ã€Œã‚¢ã‚¤ãƒ†ãƒ ã‚¹ã‚­ãƒ£ãƒ³ã€ã¨ã—ã¦æ©Ÿèƒ½ã•ã›ã‚‹
    setTimeout(() => {
        switchCamera('P'); // ã‚¹ã‚­ãƒ£ãƒ³ç”»é¢ã«æˆ»ã‚‹
        document.getElementById('scan-btn').innerText = "ITEM SCAN";
    }, 2000);
}

// --- æ•—åŒ—æ™‚ã®ãƒªã‚»ãƒƒãƒˆ ---
function playerDeath() {
    alert("æ•—åŒ—ã—ã¾ã—ãŸ... HPã‚’å›å¾©ã—ã¦æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã—ã¾ã™ã€‚");
    php = pMax; // HPå…¨å›å¾©
    // ã‚¢ã‚¤ãƒ†ãƒ ãƒ»çµŒé¨“å€¤ã®ç²å¾—ã¯ãªã—
    resetBattle(); // å†…éƒ¨ãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦æ­¦å™¨ã‚¹ã‚­ãƒ£ãƒ³(W)ãƒ¢ãƒ¼ãƒ‰ã¸
}

function resetBattle() {
    mode="W"; ehp=0; eMax=0;
    magicUsedThisBattle = {H:false,F:false,W:false,L:false,G:false,B:false,K:false,S:false,R:false};
    document.getElementById('scan-btn').disabled = false;
    setBattleBtns(true);
    switchCamera('P');
    updateUI();
    save();
}

window.onload = init;
</script>
</body>
</html>
