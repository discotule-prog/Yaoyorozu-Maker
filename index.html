<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MYTH SCANNER AI</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet"></script>
    <link href="https://fonts.googleapis.com/css2?family=DotGothic16&display=swap" rel="stylesheet">
    <style>
        :root { --p-color: #00f2ff; --e-color: #ff3c00; }
        body { font-family: 'DotGothic16', sans-serif; background: #000; color: #fff; margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        #header { height: 45px; background: #222; display: flex; justify-content: space-around; align-items: center; font-size: 0.8rem; border-bottom: 2px solid #444; }
        .char-area { height: 32%; display: flex; border-bottom: 1px solid #333; padding: 10px; box-sizing: border-box; }
        .cam-part { width: 40%; display: flex; align-items: center; justify-content: center; }
        .cam-frame { width: 100px; height: 100px; border: 2px solid #555; background: #111; overflow: hidden; position: relative; border-radius: 8px; }
        video { width: 100%; height: 100%; object-fit: cover; display: none; }
        .cam-active video { display: block; border-color: #0f0; }
        .info-part { width: 60%; display: flex; flex-direction: column; padding-left: 15px; justify-content: center; }
        .visual-card { width: 100%; height: 85px; border: 2px solid #fff; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #111; position: relative; border-radius: 4px; }
        .stat-text { font-size: 0.75rem; color: #ccc; margin-top: 5px; line-height: 1.3; }
        .hp-bar-bg { width: 100%; height: 10px; background: #333; border: 1px solid #fff; margin-top: 5px; }
        .hp-bar-fill { height: 100%; transition: width 0.3s; }
        #mid-ui { height: 150px; background: #111; border-top: 2px solid #444; display: flex; flex-direction: column; align-items: center; padding: 10px; }
        #msg { font-size: 0.8rem; color: #0f0; height: 40px; text-align: center; display: flex; align-items: center; padding: 0 10px; }
        .btn-row { display: flex; gap: 8px; width: 100%; justify-content: center; }
        button { flex: 1; max-width: 100px; height: 42px; font-family: 'DotGothic16'; border: 2px solid #fff; color: #fff; background: #444; font-size: 0.8rem; cursor: pointer; }
        button:disabled { opacity: 0.3; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 100; display: none; flex-direction: column; align-items: center; padding: 20px; box-sizing: border-box; overflow-y: auto; }
        #item-container, #lib-container { width: 100%; display: flex; flex-direction: column; gap: 8px; }
        .item-list-btn, .lib-item { width: 100%; background: #222; border: 1px solid #555; color: #fff; padding: 12px; text-align: left; font-family: 'DotGothic16'; font-size: 0.8rem; box-sizing: border-box; }
        .item-list-btn.selected { border: 2px solid gold; background: #332200; }
        .elem-badge { position: absolute; bottom: 4px; right: 4px; font-size: 1.2rem; }
        .close-btn { width: 150px; height: 40px; margin-top: 20px; background: #555; }
    </style>
</head>
<body>

<div id="header">
    <span>LV:<b id="p-lv">1</b> <b id="inv-count">0/5</b></span>
    <button onclick="showLibrary()" style="width:100px; height:30px; background:#444;">LIBRARY</button>
</div>

<div class="char-area" id="p-area">
    <div class="cam-part" id="p-cam-box"><div class="cam-frame"><video id="pv" autoplay playsinline muted></video></div></div>
    <div class="info-part">
        <div id="p-card" class="visual-card">
            <div id="p-rare" style="position:absolute; top:2px; right:4px; font-size:0.6rem; background:#fff; color:#000; padding:1px 4px;">-</div>
            <div id="p-sym" style="font-size:2.5rem;">‚öîÔ∏è</div>
            <div id="p-name" style="font-size:0.7rem; text-align:center; padding:0 5px;">READY</div>
            <div id="p-elem" class="elem-badge"></div>
        </div>
        <div class="stat-text">HP: <span id="p-hp-cur">1000</span>/<span id="p-hp-max">1000</span><br>ATK: <span id="p-atk-val">0</span> DEF: <span id="p-def-val">0</span></div>
        <div class="hp-bar-bg"><div id="p-fill" class="hp-bar-fill" style="background:var(--p-color); width:100%"></div></div>
    </div>
</div>

<div id="mid-ui">
    <div id="msg">Ê≠¶Âô®„Çí„Çπ„Ç≠„É£„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>
    <div class="btn-row">
        <button id="scan-btn" onclick="handleScan()" style="background:#0044cc">SCAN</button>
        <button id="atk-btn" onclick="handleAttack()" disabled style="background:#aa0000">ATTACK</button>
        <button id="item-open-btn" onclick="openItemMenu()" disabled style="background:#008844">ITEM</button>
    </div>
</div>

<div class="char-area" id="e-area">
    <div class="cam-part" id="e-cam-box"><div class="cam-frame"><video id="ev" autoplay playsinline muted></video></div></div>
    <div class="info-part">
        <div id="e-card" class="visual-card">
            <div id="e-rare" style="position:absolute; top:2px; right:4px; font-size:0.6rem; background:#fff; color:#000; padding:1px 4px;">-</div>
            <div id="e-sym" style="font-size:2.5rem;">üëæ</div>
            <div id="e-name" style="font-size:0.7rem; text-align:center; padding:0 5px;">???</div>
            <div id="e-elem" class="elem-badge"></div>
        </div>
        <div class="stat-text">HP: <span id="e-hp-cur">0</span>/<span id="e-hp-max">0</span><br>ATK: <span id="e-atk-val">0</span> DEF: <span id="e-def-val">0</span></div>
        <div class="hp-bar-bg"><div id="e-fill" class="hp-bar-fill" style="background:var(--e-color); width:0%"></div></div>
    </div>
</div>

<div id="item-menu" class="overlay">
    <h2 id="item-title">ITEMS</h2>
    <div id="item-container"></div>
    <div style="display:flex; gap:10px; width:100%;">
        <button id="craft-btn" onclick="toggleCraftMode()" style="background:gold; color:#000;">CRAFT</button>
        <button class="close-btn" onclick="closeOverlay('item-menu')">CLOSE</button>
    </div>
</div>

<div id="lib-screen" class="overlay">
    <h2>LIBRARY</h2>
    <div id="lib-container"></div>
    <button class="close-btn" onclick="closeOverlay('lib-screen')">CLOSE</button>
</div>

<div id="bonus-screen" class="overlay">
    <h2 style="color:gold;">BONUS SCAN</h2>
    <div class="cam-frame" style="width:160px; height:160px;" id="b-cam-box"><video id="bv" autoplay playsinline muted></video></div>
    <button onclick="getBonusItem()" style="background:#0044cc; width:100%; margin-top:20px;">AI GET ITEM</button>
</div>

<div id="res-screen" class="overlay" style="justify-content:center;">
    <h1 id="res-title"></h1>
    <p id="res-msg"></p>
    <button onclick="closeResult()" style="width:100%; height:50px; background:#0044cc;">NEXT</button>
</div>

<script>
    let net, mode="W", lv=1, exp=0, nextExp=100, php=1000, pMax=1000, ehp=0, eMax=0;
    let patk=0, pdef=0, eatk=0, edef=0, stream=null, pElem="‚ö™", eElem="‚ö™";
    let buffAtk=0, buffDef=0, buffEAtkMul=1, buffEDefMul=1, shieldActive=false, doubleAtkActive=false;
    let inventory = [], isCraftMode=false, craftSelection=[];
    let library = JSON.parse(localStorage.getItem('myth_lib_v1')) || { weapons: 0, monsters: 0, highestAtk: 0 };

    const wSuffix = ["„ÅÆÂâ£","„ÅÆÊßç","„ÅÆÊùñ","„ÅÆÂºì","„ÅÆÈéå","„ÅÆÁõæ"];
    const mSuffix = ["„ÅÆÈ≠îÁç£","„ÅÆÁ≤æÈúä","„ÅÆÂ∑®‰∫∫","„ÅÆÂΩ±","„ÅÆÈ®éÂ£´"];

    function getMaxInv() { return 5 + Math.floor(lv / 5); }

    async function init() {
        net = await mobilenet.load();
        switchCamera('P');
        updateUI();
    }

    async function switchCamera(target) {
        if(stream) stream.getTracks().forEach(t => t.stop());
        const vId = {P:'pv', E:'ev', B:'bv'}[target];
        const bId = {P:'p-cam-box', E:'e-cam-box', B:'b-cam-box'}[target];
        stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
        document.getElementById(vId).srcObject = stream;
        ['p-cam-box','e-cam-box','b-cam-box'].forEach(b=>document.getElementById(b).classList.remove('cam-active'));
        document.getElementById(bId).classList.add('cam-active');
    }

    function analyzeElement(name) {
        const n = name.toLowerCase();
        if(n.match(/fire|red|light|lamp|match|sun|hot|power/)) return "üî•";
        if(n.match(/water|blue|bottle|cup|sea|ice|river/)) return "üíß";
        if(n.match(/plant|green|leaf|tree|grass|fruit|food|vegetable/)) return "üåø";
        return "‚ö™";
    }

    async function handleScan() {
        const vid = mode==="W" ? document.getElementById('pv') : document.getElementById('ev');
        const r = await net.classify(vid);
        const aiName = r[0].className.split(',')[0].trim();
        const prob = r[0].probability;
        const rareIdx = prob > 0.4 ? 3 : prob > 0.2 ? 2 : prob > 0.1 ? 1 : 0;
        const rarity = ["COMMON","RARE","SUPER","MYTHIC"][rareIdx];
        const boost = 1 + (lv-1)*0.05;

        if(mode==="W") {
            const fullName = aiName.toUpperCase() + wSuffix[Math.floor(Math.random()*wSuffix.length)];
            patk = Math.floor((120 + rareIdx*80) * boost);
            pdef = Math.floor((60 + rareIdx*40) * boost);
            pElem = analyzeElement(aiName);
            php = Math.min(pMax, php + pMax*0.4);
            updateCard('p', rarity, "‚öîÔ∏è", fullName, pElem);
            library.weapons++;
            if(patk > library.highestAtk) library.highestAtk = patk;
            mode="M"; switchCamera('E');
            document.getElementById('msg').innerText = "Ê¨°„ÅØ„É¢„É≥„Çπ„Çø„Éº„Çí„Çπ„Ç≠„É£„É≥ÔºÅ";
        } else {
            const fullName = aiName.toUpperCase() + mSuffix[Math.floor(Math.random()*mSuffix.length)];
            eMax = Math.floor((800 + rareIdx*500) * boost); ehp = eMax;
            eatk = Math.floor((110 + rareIdx*70) * boost);
            edef = Math.floor((50 + rareIdx*40) * boost);
            eElem = analyzeElement(aiName);
            updateCard('e', rarity, "üëæ", fullName, eElem);
            library.monsters++;
            document.getElementById('atk-btn').disabled = false;
            document.getElementById('item-open-btn').disabled = false;
            document.getElementById('scan-btn').disabled = true;
            document.getElementById('msg').innerText = "BATTLE START!";
        }
        saveLib();
        updateUI();
    }

    function updateCard(side, rare, sym, name, elem) {
        document.getElementById(`${side}-rare`).innerText = rare;
        document.getElementById(`${side}-sym`).innerText = sym;
        document.getElementById(`${side}-name`).innerText = name;
        document.getElementById(`${side}-elem`).innerText = elem;
        const color = side==='p' ? "#224466" : "#662222";
        document.getElementById(`${side}-card`).style.background = `radial-gradient(circle, ${color}, #000)`;
    }

    function handleAttack() {
        const hit = () => {
            let d = Math.max(20, (patk+buffAtk) - (edef*buffEDefMul/2));
            d *= getElemBonus(pElem, eElem);
            if(Math.random()<0.1) d *= 2;
            ehp -= Math.floor(d);
            document.getElementById('e-area').classList.add('shake');
            setTimeout(()=>document.getElementById('e-area').classList.remove('shake'), 200);
        };
        hit(); 
        if(doubleAtkActive && ehp > 0) setTimeout(hit, 300);
        setTimeout(() => { if(ehp <= 0) showBonus(); else enemyTurn(); }, 500);
    }

    function enemyTurn() {
        if(shieldActive) {
            document.getElementById('msg').innerText = "ÊîªÊíÉ„ÇíÈò≤„ÅÑ„Å†ÔºÅ";
            if(shieldActive==="mirror") ehp -= eMax*0.1;
            shieldActive = false;
        } else {
            let d = Math.max(15, (eatk*buffEAtkMul) - (pdef+buffDef)/2);
            php -= Math.floor(d * getElemBonus(eElem, pElem));
        }
        document.getElementById('p-area').classList.add('shake');
        setTimeout(()=>document.getElementById('p-area').classList.remove('shake'), 200);
        updateUI();
        if(php <= 0) finish(false);
    }

    function getElemBonus(a, d) {
        if(a==="‚ö™"||d==="‚ö™") return 1;
        if((a==="üî•"&&d==="üåø")||(a==="üíß"&&d==="üî•")||(a==="üåø"&&d==="üíß")) return 1.5;
        if((a==="üî•"&&d==="üíß")||(a==="üíß"&&d==="üåø")||(a==="üåø"&&d==="üî•")) return 0.7;
        return 1;
    }

    async function getBonusItem() {
        const r = await net.classify(document.getElementById('bv'));
        const n = r[0].className.toLowerCase();
        let type = "ORB";
        if(n.match(/bottle|cup|liquid|pill/)) type="HE";
        else if(n.match(/sharp|pen|knife|scissors/)) type="KILL";
        else if(n.match(/phone|remote|hand|shoe/)) type="DOUBLE";
        else {
            const types = ["HE","DM","AT","DF","SHIELD","DOUBLE","KILL","ORB"];
            type = types[Math.floor(Math.random()*types.length)];
        }
        const names = {HE:"„Éù„Éº„Ç∑„Éß„É≥", DM:"ÁàÜÂºæ", AT:"Âäõ„ÅÆËñ¨", DF:"ÂÆà„Çä„ÅÆËñ¨", SHIELD:"ËÅñ„Å™„ÇãÁõæ", DOUBLE:"ÁñæÈ¢®„ÅÆÈù¥", KILL:"„Éá„ÉÉ„Éâ„É™„Éº„Ç∑„Éß„ÉÉ„Éà", ORB:"„Ç™„Éº„Éñ"};
        const itm = { n: names[type], t: type, i: {HE:"üß™",DM:"üí•",SHIELD:"üõ°Ô∏è",DOUBLE:"üëü",KILL:"üíÄ",ORB:"üîÆ"}[type]||"üì¶" };
        
        if(inventory.length < getMaxInv()) {
            inventory.push(itm);
            document.getElementById('bonus-screen').style.display='none';
            finish(true);
        } else {
            alert("„Éê„ÉÉ„Ç∞Ê∫ÄÊùØÔºÅÂÖ•„ÇåÊõø„Åà„Çã„Ç¢„Ç§„ÉÜ„É†„ÇíÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑ„ÄÇ");
            openItemMenu(); 
        }
    }

    function openItemMenu() {
        isCraftMode = false; craftSelection = [];
        renderItems();
        document.getElementById('item-menu').style.display='flex';
    }

    function toggleCraftMode() {
        isCraftMode = !isCraftMode; craftSelection = [];
        document.getElementById('item-title').innerText = isCraftMode ? "ÂêàÊàêÔºö2„Å§ÈÅ∏Êäû" : "ITEMS";
        renderItems();
    }

    function renderItems() {
        const c = document.getElementById('item-container'); c.innerHTML = "";
        inventory.forEach((itm, i) => {
            const b = document.createElement('button');
            b.className = "item-list-btn" + (craftSelection.includes(i) ? " selected" : "");
            b.innerHTML = `${itm.i} ${itm.n}`;
            b.onclick = () => isCraftMode ? selectCraft(i) : useItem(i);
            c.appendChild(b);
        });
    }

    function selectCraft(i) {
        if(craftSelection.includes(i)) craftSelection = craftSelection.filter(x=>x!==i);
        else if(craftSelection.length<2) craftSelection.push(i);
        if(craftSelection.length===2) {
            const types = [inventory[craftSelection[0]].t, inventory[craftSelection[1]].t];
            let res = {n:"„Ç®„É™„ÇØ„Çµ„Éº", t:"ELIXIR", i:"üíé"};
            if(types.includes("ORB") && types.includes("HE")) res = {n:"Ë∂Ö„Éù„Éº„Ç∑„Éß„É≥", t:"HE", i:"üß™"};
            const h=Math.max(...craftSelection), l=Math.min(...craftSelection);
            inventory.splice(h,1); inventory.splice(l,1); inventory.push(res);
            toggleCraftMode();
        } else renderItems();
    }

    function useItem(i) {
        const itm = inventory[i];
        if(itm.t==="ORB") { showOrbMenu(i); return; }
        if(itm.t==="HE") php = Math.min(pMax, php + pMax*0.5);
        if(itm.t==="KILL") ehp = 0;
        if(itm.t==="SHIELD") shieldActive = true;
        inventory.splice(i, 1);
        closeOverlay('item-menu'); updateUI();
        if(ehp<=0) showBonus();
    }

    function showOrbMenu(idx) {
        const c = document.getElementById('item-container'); c.innerHTML = "<p>Â±ûÊÄß„ÇíÈÅ∏Êäû</p>";
        [{s:"üî•",n:"ÁÅ´"},{s:"üíß",n:"Ê∞¥"},{s:"üåø",n:"Ëçâ"}].forEach(el => {
            const b = document.createElement('button'); b.className = "item-list-btn"; b.innerText = el.n + "Â±ûÊÄß„Å´Â§â„Åà„Çã";
            b.onclick = () => { pElem=el.s; document.getElementById('p-elem').innerText=pElem; inventory.splice(idx,1); closeOverlay('item-menu'); updateUI(); };
            c.appendChild(b);
        });
    }

    function showLibrary() {
        const c = document.getElementById('lib-container');
        c.innerHTML = `
            <div class="lib-item">Á∑è„Çπ„Ç≠„É£„É≥Ê≠¶Âô®Êï∞: ${library.weapons}</div>
            <div class="lib-item">ÈÅ≠ÈÅá„É¢„É≥„Çπ„Çø„ÉºÊï∞: ${library.monsters}</div>
            <div class="lib-item">ÊúÄÈ´òÊîªÊíÉÂäõ: ${library.highestAtk}</div>
            <div class="lib-item">ÁèæÂú®„Ç¢„Ç§„ÉÜ„É†Êû†: ${getMaxInv()}</div>
        `;
        document.getElementById('lib-screen').style.display = 'flex';
    }

    function showBonus() { document.getElementById('bonus-screen').style.display='flex'; switchCamera('B'); }
    function closeOverlay(id) { document.getElementById(id).style.display='none'; }
    function finish(win) {
        document.getElementById('res-screen').style.display='flex';
        if(win) { exp+=50; if(exp>=nextExp){ lv++; exp=0; nextExp+=50; pMax=Math.floor(1000*(1+(lv-1)*0.1)); } document.getElementById('res-title').innerText="VICTORY"; }
        else { lv=Math.max(1,lv-1); inventory=[]; php=pMax; document.getElementById('res-title').innerText="DEFEAT"; }
        updateUI();
    }
    function closeResult() { document.getElementById('res-screen').style.display='none'; mode="W"; buffAtk=0; buffDef=0; buffEAtkMul=1; buffEDefMul=1; shieldActive=false; doubleAtkActive=false; document.getElementById('atk-btn').disabled=true; document.getElementById('scan-btn').disabled=false; switchCamera('P'); updateUI(); }

    function updateUI() {
        document.getElementById('p-lv').innerText = lv;
        document.getElementById('p-exp').innerText = exp;
        document.getElementById('inv-count').innerText = `${inventory.length}/${getMaxInv()}`;
        document.getElementById('p-hp-cur').innerText = Math.floor(php);
        document.getElementById('p-hp-max').innerText = pMax;
        document.getElementById('p-fill').style.width = (php/pMax*100)+"%";
        document.getElementById('e-hp-cur').innerText = Math.floor(ehp);
        document.getElementById('e-hp-max').innerText = eMax;
        document.getElementById('e-fill').style.width = (eMax>0 ? (ehp/eMax*100) : 0)+"%";
        document.getElementById('p-atk-val').innerText = patk + buffAtk;
    }
    function saveLib() { localStorage.setItem('myth_lib_v1', JSON.stringify(library)); }

    init();
</script>
</body>
</html>
