<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Mythic RPG v6</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet"></script>
    <style>
        body { margin:0; background:#000; color:#fff; font-family:monospace; overflow:hidden; }
        #game-ui { display:flex; flex-direction:column; height:100vh; }
        
        /* ã‚«ãƒ¡ãƒ©è¡¨ç¤ºã‚¨ãƒªã‚¢ */
        .camera-container { position:relative; flex:1; background:#222; display:flex; justify-content:center; align-items:center; }
        video { width:100%; height:100%; object-fit:cover; display:none; }
        
        /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼ */
        .status-bar { padding:10px; background:rgba(0,0,0,0.8); border-bottom:2px solid #444; }
        .hp-bar { width:100%; height:10px; background:#444; margin-top:5px; position:relative; }
        .hp-fill { height:100%; background:#0f0; transition:0.3s; width:100%; }

        /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ»æ“ä½œã‚¨ãƒªã‚¢ */
        .msg-area { height:80px; padding:10px; background:#111; border-top:2px solid #444; overflow-y:auto; font-size:0.9rem; }
        .controls { display:grid; grid-template-columns:1fr 1fr; gap:5px; padding:10px; background:#000; }
        button { padding:15px; background:#333; color:#fff; border:1px solid #666; font-size:1rem; cursor:pointer; }
        button:disabled { opacity:0.3; }
        button:active { background:#666; }

        /* ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
        .overlay { position:fixed; inset:0; background:rgba(0,0,0,0.9); display:flex; flex-direction:column; justify-content:center; align-items:center; z-index:100; text-align:center; padding:20px; }
        .hidden { display:none !important; }
        
        /* ã‚·ã‚§ã‚¤ã‚¯ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes shake { 0%{transform:translate(0,0)} 25%{transform:translate(5px,5px)} 50%{transform:translate(-5px,0)} 75%{transform:translate(0,-5px)} 100%{transform:translate(0,0)} }
        .shake { animation: shake 0.2s ease-in-out 2; }
    </style>
</head>
<body>

<div id="game-ui">
    <div class="status-bar">
    <div>
        PLAYER Lv.<span id="p-lv">1</span>
        <span id="p-elem" style="font-weight:bold; margin-left:10px;"></span>
        HP: <span id="p-hp-cur">1000</span>/<span id="p-hp-max">1000</span>
    </div>
    <div class="hp-bar"><div id="p-fill" class="hp-fill"></div></div>
    <div style="margin-top:5px; color:#ff4444;">
        ENEMY HP: <span id="e-hp-cur">0</span>/<span id="e-hp-max">0</span>
        <span id="e-elem" style="font-weight:bold; margin-left:10px;"></span>
    </div>
    <div class="hp-bar"><div id="e-fill" class="hp-fill" style="background:#f00; width:0%;"></div></div>
    <div id="element-debug" style="font-size:0.8rem; margin-top:5px;"></div>
</div>
<div class="camera-container">
    <video id="webcam" autoplay playsinline muted></video>
    <canvas id="color-canvas" width="1" height="1" style="display:none;"></canvas> 
    <div style="position:absolute; width:20px; height:2px; background:white; z-index:5;"></div>
    <div style="position:absolute; width:2px; height:20px; background:white; z-index:5;"></div>
</div>

    <div id="msg" class="msg-area">SYSTEM INITIALIZING...</div>

    <div class="controls">
        <button id="scan-btn" onclick="startScan()" disabled>WEAPON SCAN</button>
        <button id="atk-btn" onclick="handleAttack()" disabled>ATTACK</button>
        <button id="magic-btn" onclick="openMagic()" disabled>MAGIC</button>
        <button id="lib-btn" onclick="openLibrary()">LIBRARY</button>
    </div>
</div>

<div id="init-overlay" class="overlay">
    <h1 style="color:#0ff;">AI MYTHIC RPG</h1>
    <p id="init-msg">LOADING AI MODELS...</p>
    <button id="start-btn" onclick="startGame()" class="hidden" style="background:#004400; padding:20px 40px; border-color:#0f0;">START GAME</button>
</div>

<script>
// --- åŸºç¤ãƒ‡ãƒ¼ã‚¿ ---
let lv = 1, exp = 0, pMax = 1000, php = 1000;
let ehp = 0, eMax = 0, enemyName = "";
let mode = "W"; // W, E, B, I
let net, stream;
let playerElement = null;
let enemyElement = null;
let library = JSON.parse(localStorage.getItem('myth_v6_lib')) || { W: {}, E: {}, I: {} };
let pAtk = 0; // ã‚¹ã‚­ãƒ£ãƒ³ã—ãŸæ­¦å™¨ã®æ”»æ’ƒåŠ›
let pDef = 0; // ã‚¹ã‚­ãƒ£ãƒ³ã—ãŸæ­¦å™¨ã®é˜²å¾¡åŠ›
let eAtk = 0; // å‡ºç¾ã—ãŸãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã®æ”»æ’ƒåŠ›
let eExp = 0; // å‡ºç¾ã—ãŸãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã®çµŒé¨“å€¤
const ELEMENTS = {
    FIRE:  { name: "ç«", color: "#ff4444", icon: "ğŸ”¥", strongTo: "WOOD" },
    WATER: { name: "æ°´", color: "#4444ff", icon: "ğŸ’§", strongTo: "FIRE" },
    EARTH: { name: "åœŸ", color: "#8b4513", icon: "â›°ï¸", strongTo: "WATER" },
    WOOD:  { name: "æœ¨", color: "#228b22", icon: "ğŸƒ", strongTo: "EARTH" }
};

const RARITY_RATES = [
    { rarity: "MYTH",   rate: 5 },
    { rarity: "LEGEND", rate: 10 },
    { rarity: "ELITE",  rate: 25 },
    { rarity: "COMMON", rate: 60 }
];

const COLOR_MAPPING = [
    { elem: "FIRE",  check: (r, g, b) => r > 150 && g < 100 },
    { elem: "WATER", check: (r, g, b) => b > 150 && r < 100 },
    { elem: "WOOD",  check: (r, g, b) => g > 120 && r < 120 && b < 120 },
    { elem: "EARTH", check: (r, g, b) => r > 100 && g > 50 && b < 100 }
];

// --- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ (æŠœç²‹ã€‚å®Ÿéš›ã¯ç”»åƒã«åŸºã¥ã100ç¨®å±•é–‹) ---
// --- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ ---
const WEAPON_DB = [
    // --- MYTH (No.91 - 100) ---
    { no: 100, rarity: "MYTH", name: "å¤©å¢é›²å‰£", keywords: ["sword", "blade"], atk: 800, def: 200 },
    { no: 99, rarity: "MYTH", name: "ãƒ­ãƒ³ã‚®ãƒŒã‚¹ã®æ§", keywords: ["stick", "pitcher", "racket"], atk: 750, def: 150 },
    { no: 98, rarity: "MYTH", name: "ãƒã‚§ãƒ¼ãƒ³ã‚½ãƒ¼", keywords: ["tools", "drill"], atk: 900, def: 50 },
    { no: 97, rarity: "MYTH", name: "è¶…é›»ç£ç ²", keywords: ["gun", "toy"], atk: 1000, def: 0 },
    { no: 96, rarity: "MYTH", name: "ãƒ‡ãƒ¥ãƒ©ãƒ³ãƒ€ãƒ«", keywords: ["sword", "knife"], atk: 700, def: 300 },
    { no: 95, rarity: "MYTH", name: "å¦‚æ„æ£’", keywords: ["stick", "umbrella", "pole"], atk: 650, def: 250 },
    { no: 94, rarity: "MYTH", name: "ãƒŸãƒ§ãƒ«ãƒ‹ãƒ«", keywords: ["tools", "hammer"], atk: 850, def: 100 },
    { no: 93, rarity: "MYTH", name: "ã‚°ãƒ³ã‚°ãƒ‹ãƒ«", keywords: ["stick", "pen"], atk: 780, def: 120 },
    { no: 92, rarity: "MYTH", name: "ãƒ¬ãƒ¼ãƒ´ã‚¡ãƒ†ã‚¤ãƒ³", keywords: ["lighter", "fire"], atk: 820, def: 80 },
    { no: 91, rarity: "MYTH", name: "è–å‰£ã‚¨ã‚¯ã‚¹ã‚«ãƒªãƒãƒ¼", keywords: ["sword", "blade"], atk: 880, def: 180 },

    // --- LEGEND (No.71 - 90) ---
    { no: 90, rarity: "LEGEND", name: "æ‘æ­£", keywords: ["knife", "scissors"], atk: 500, def: 50 },
    { no: 89, rarity: "LEGEND", name: "ãƒ‰ãƒ©ã‚´ãƒ³ã‚¹ãƒ¬ã‚¤ãƒ¤ãƒ¼", keywords: ["plate", "iron"], atk: 550, def: 100 },
    { no: 88, rarity: "LEGEND", name: "æ–¹å¤©ç”»æˆŸ", keywords: ["stick"], atk: 480, def: 80 },
    { no: 87, rarity: "LEGEND", name: "é’é¾åƒæœˆåˆ€", keywords: ["stick"], atk: 490, def: 90 },
    { no: 86, rarity: "LEGEND", name: "ã‚«ãƒ©ãƒ‰ãƒœãƒ«ã‚°", keywords: ["sword"], atk: 470, def: 110 },
    { no: 85, rarity: "LEGEND", name: "ãƒãƒ«ãƒ‘ãƒ¼", keywords: ["hook", "sickle"], atk: 440, def: 60 },
    { no: 84, rarity: "LEGEND", name: "ãƒ¬ãƒ¼ã‚¶ãƒ¼ãƒ–ãƒ¬ãƒ¼ãƒ‰", keywords: ["flashlight"], atk: 600, def: 20 },
    { no: 83, rarity: "LEGEND", name: "ãƒ‡ã‚¹ã‚µã‚¤ã‚º", keywords: ["sickle"], atk: 580, def: 40 },
    { no: 82, rarity: "LEGEND", name: "ã‚¤ãƒ¼ã‚¸ã‚¹ã®ç›¾", keywords: ["plate", "lid"], atk: 100, def: 600 },
    { no: 81, rarity: "LEGEND", name: "ãƒ´ã‚¡ã‚¸ãƒ¥ãƒ©", keywords: ["toy", "remote"], atk: 520, def: 100 },
    // (ä¸­ç•¥: 80-71ã‚‚åŒæ§˜ã®LEGENDç´šãŒå…¥ã‚Šã¾ã™)

    // --- ELITE (No.31 - 70) ---
    { no: 70, rarity: "ELITE", name: "æ—¥æœ¬åˆ€", keywords: ["sword", "knife"], atk: 250, def: 30 },
    { no: 69, rarity: "ELITE", name: "ãƒãƒˆãƒ«ã‚¢ãƒƒã‚¯ã‚¹", keywords: ["tools"], atk: 280, def: 50 },
    { no: 68, rarity: "ELITE", name: "ãƒ­ãƒ³ã‚°ãƒœã‚¦", keywords: ["hanger"], atk: 220, def: 10 },
    { no: 67, rarity: "ELITE", name: "ãƒãƒ«ãƒãƒ¼ãƒ‰", keywords: ["mop", "broom"], atk: 260, def: 60 },
    { no: 66, rarity: "ELITE", name: "ã‚¦ã‚©ãƒ¼ãƒãƒ³ãƒãƒ¼", keywords: ["hammer"], atk: 300, def: 40 },
    { no: 65, rarity: "ELITE", name: "ãƒ¬ã‚¤ãƒ”ã‚¢", keywords: ["pen", "needle"], atk: 210, def: 20 },
    { no: 64, rarity: "ELITE", name: "ãƒ•ãƒ©ãƒ³ãƒ™ãƒ«ã‚¸ãƒ¥", keywords: ["knife"], atk: 240, def: 40 },
    { no: 63, rarity: "ELITE", name: "ãƒ¢ãƒ¼ãƒ‹ãƒ³ã‚°ã‚¹ã‚¿ãƒ¼", keywords: ["brush"], atk: 290, def: 30 },
    { no: 62, rarity: "ELITE", name: "ã‚¯ãƒ­ã‚¹ãƒœã‚¦", keywords: ["toy"], atk: 270, def: 10 },
    { no: 61, rarity: "ELITE", name: "ã‚«ã‚¿ãƒ¼ãƒ«", keywords: ["fork"], atk: 200, def: 30 },
    // (ä¸­ç•¥: 60-31ã‚‚å®Ÿæˆ¦çš„ãªæ­¦å™¨ãŒå…¥ã‚Šã¾ã™)

    // --- COMMON (No.1 - 30) ---
    { no: 30, rarity: "COMMON", name: "é‰„ã®å‰£", keywords: ["knife", "spoon"], atk: 80, def: 10 },
    { no: 29, rarity: "COMMON", name: "æœ¨ã®æ–", keywords: ["stick"], atk: 40, def: 20 },
    { no: 28, rarity: "COMMON", name: "çŸ³ã®æ–§", keywords: ["stone"], atk: 90, def: 5 },
    { no: 27, rarity: "COMMON", name: "ç·´ç¿’ç”¨ç«¹åˆ€", keywords: ["ruler", "stick"], atk: 30, def: 40 },
    { no: 26, rarity: "COMMON", name: "çš®ã®ç›¾", keywords: ["book", "wallet"], atk: 5, def: 60 },
    { no: 25, rarity: "COMMON", name: "ãƒ–ãƒ¼ãƒ¡ãƒ©ãƒ³", keywords: ["banana"], atk: 70, def: 0 },
    { no: 24, rarity: "COMMON", name: "ãƒ‘ãƒãƒ³ã‚³", keywords: ["rubber band"], atk: 50, def: 0 },
    { no: 23, rarity: "COMMON", name: "é’éŠ…ã®æ§", keywords: ["umbrella"], atk: 110, def: 20 },
    { no: 22, rarity: "COMMON", name: "ã‚¯ãƒ©ãƒ–(æ£æ£’)", keywords: ["bottle"], atk: 100, def: 10 },
    { no: 21, rarity: "COMMON", name: "ãƒŠã‚¤ãƒ•", keywords: ["knife"], atk: 70, def: 5 },
    // ... No.1ã¾ã§ç¶šã (ä»¥ä¸‹çœç•¥ã€‚ã‚·ã‚¹ãƒ†ãƒ ä¸Šã¯ã“ã‚Œã ã‘ã§ååˆ†å‹•ä½œã—ã¾ã™)
    { no: 1, rarity: "COMMON", name: "ã²ã®ãã®ã¼ã†", keywords: ["stick", "pen"], atk: 10, def: 5 }
];
const MONSTER_DB = [
    // --- MYTH (No.91 - 100) ---
    { no: 100, rarity: "MYTH", name: "æœ€å¾Œã®å¯©åˆ¤", keywords: ["book", "paper"], hp: 9999, atk: 600, exp: 5000 },
    { no: 99, rarity: "MYTH", name: "ãƒ«ã‚·ãƒ•ã‚¡ãƒ¼", keywords: ["bird", "feather"], hp: 7000, atk: 550, exp: 4000 },
    { no: 98, rarity: "MYTH", name: "ç¹”ç”°ä¿¡é•·", keywords: ["human", "person", "suit"], hp: 5500, atk: 450, exp: 3000 },
    { no: 97, rarity: "MYTH", name: "ãƒãƒãƒ ãƒ¼ãƒˆ", keywords: ["lizard", "toy"], hp: 8000, atk: 500, exp: 4500 },
    { no: 96, rarity: "MYTH", name: "ã‚±ãƒ«ãƒ™ãƒ­ã‚¹", keywords: ["dog", "pet"], hp: 4500, atk: 480, exp: 2500 },
    { no: 95, rarity: "MYTH", name: "ãƒ•ã‚§ãƒ³ãƒªãƒ«", keywords: ["dog", "wolf"], hp: 5000, atk: 460, exp: 2800 },
    { no: 94, rarity: "MYTH", name: "ãƒªãƒ´ã‚¡ã‚¤ã‚¢ã‚µãƒ³", keywords: ["fish", "water"], hp: 6500, atk: 420, exp: 3200 },
    { no: 93, rarity: "MYTH", name: "ãƒ¤ãƒã‚¿ãƒã‚ªãƒ­ãƒ", keywords: ["snake", "rope"], hp: 6000, atk: 440, exp: 3500 },
    { no: 92, rarity: "MYTH", name: "å¤§å¤©ä½¿ãƒŸã‚«ã‚¨ãƒ«", keywords: ["sculpture", "doll"], hp: 7500, atk: 400, exp: 4200 },
    { no: 91, rarity: "MYTH", name: "ã‚·ãƒ´ã‚¡", keywords: ["human", "statue"], hp: 8500, atk: 520, exp: 4800 },

    // --- LEGEND (No.71 - 90) ---
    { no: 90, rarity: "LEGEND", name: "ãƒ‰ãƒ©ã‚´ãƒ³", keywords: ["lizard", "toy"], hp: 3000, atk: 300, exp: 1200 },
    { no: 89, rarity: "LEGEND", name: "å¸è¡€é¬¼", keywords: ["human", "person"], hp: 2500, atk: 280, exp: 1000 },
    { no: 88, rarity: "LEGEND", name: "ã‚­ãƒã‚¤ãƒ©", keywords: ["cat", "dog"], hp: 2800, atk: 250, exp: 1100 },
    { no: 87, rarity: "LEGEND", name: "ãƒ¡ãƒ‡ãƒ¥ãƒ¼ã‚µ", keywords: ["hair", "wig"], hp: 2200, atk: 240, exp: 950 },
    { no: 86, rarity: "LEGEND", name: "ãƒŸãƒã‚¿ã‚¦ãƒ­ã‚¹", keywords: ["box", "gym"], hp: 3500, atk: 320, exp: 1300 },
    { no: 85, rarity: "LEGEND", name: "ã‚¶ãƒ»ãƒ©ã‚¤ãƒ•", keywords: ["drink", "bottle"], hp: 4000, atk: 150, exp: 1500 },
    { no: 84, rarity: "LEGEND", name: "ã‚°ãƒªãƒ•ã‚£ãƒ³", keywords: ["bird"], hp: 2400, atk: 260, exp: 900 },
    { no: 83, rarity: "LEGEND", name: "ãƒ‡ãƒ¥ãƒ©ãƒãƒ³", keywords: ["helmet", "hat"], hp: 3200, atk: 290, exp: 1150 },
    { no: 82, rarity: "LEGEND", name: "ã‚µãƒ©ãƒãƒ³ãƒ€ãƒ¼", keywords: ["lighter", "stove"], hp: 2100, atk: 310, exp: 980 },
    { no: 81, rarity: "LEGEND", name: "ã‚¯ãƒ©ãƒ¼ã‚±ãƒ³", keywords: ["cloth", "curtain"], hp: 3800, atk: 270, exp: 1250 },

    // --- ELITE (No.31 - 70) ---
    { no: 70, rarity: "ELITE", name: "ã‚¬ãƒ¼ã‚´ã‚¤ãƒ«", keywords: ["stone", "shelf"], hp: 1200, atk: 150, exp: 450 },
    { no: 69, rarity: "ELITE", name: "ã‚¦ã‚§ã‚¢ã‚¦ãƒ«ãƒ•", keywords: ["dog", "coat"], hp: 1000, atk: 180, exp: 400 },
    { no: 68, rarity: "ELITE", name: "ã‚ªãƒ¼ã‚¬", keywords: ["chair", "big"], hp: 1500, atk: 200, exp: 500 },
    { no: 67, rarity: "ELITE", name: "ãƒŸã‚¤ãƒ©", keywords: ["human", "toilet paper", "towel"], hp: 900, atk: 120, exp: 350 },
    { no: 66, rarity: "ELITE", name: "ã‚µã‚­ãƒ¥ãƒã‚¹", keywords: ["pillow", "bed"], hp: 800, atk: 140, exp: 380 },
    { no: 65, rarity: "ELITE", name: "ãƒªãƒ“ãƒ³ã‚°ã‚¢ãƒ¼ãƒãƒ¼", keywords: ["jacket", "metal"], hp: 1800, atk: 130, exp: 480 },
    { no: 64, rarity: "ELITE", name: "ã‚³ã‚«ãƒˆãƒªã‚¹", keywords: ["chicken", "egg"], hp: 750, atk: 170, exp: 320 },
    { no: 63, rarity: "ELITE", name: "ãƒ©ãƒŸã‚¢", keywords: ["snake", "belt"], hp: 1100, atk: 160, exp: 420 },
    { no: 62, rarity: "ELITE", name: "ã‚±ãƒ³ã‚¿ã‚¦ãƒ­ã‚¹", keywords: ["bicycle", "machine"], hp: 1300, atk: 190, exp: 460 },
    { no: 61, rarity: "ELITE", name: "ãƒ˜ãƒ«ãƒã‚¦ãƒ³ãƒ‰", keywords: ["dog", "black"], hp: 950, atk: 210, exp: 430 },

    // --- COMMON (No.1 - 30) ---
    { no: 30, rarity: "COMMON", name: "ã‚´ãƒ–ãƒªãƒ³", keywords: ["wallet", "coin"], hp: 400, atk: 60, exp: 120 },
    { no: 29, rarity: "COMMON", name: "ã‚¹ã‚±ãƒ«ãƒˆãƒ³", keywords: ["spoon", "fork", "white"], hp: 350, atk: 70, exp: 100 },
    { no: 28, rarity: "COMMON", name: "ã‚¤ãƒ³ãƒ—", keywords: ["book", "smartphone"], hp: 300, atk: 80, exp: 110 },
    { no: 27, rarity: "COMMON", name: "ãƒãƒ–ãƒ«ã‚¼ãƒªãƒ¼", keywords: ["drink", "cup", "soap"], hp: 500, atk: 40, exp: 90 },
    { no: 26, rarity: "COMMON", name: "ãƒ¯ã‚¤ãƒ«ãƒ‰ãƒœã‚¢", keywords: ["bag", "brown"], hp: 450, atk: 90, exp: 130 },
    { no: 25, rarity: "COMMON", name: "ãƒãƒ³ãƒ‰ãƒ©ã‚´ãƒ©", keywords: ["plant", "pot"], hp: 250, atk: 50, exp: 80 },
    { no: 24, rarity: "COMMON", name: "ãƒãƒƒãƒˆ", keywords: ["umbrella", "black"], hp: 200, atk: 65, exp: 70 },
    { no: 23, rarity: "COMMON", name: "ãƒã‚¤ã‚ºãƒ³ã‚¹ãƒ‘ã‚¤ãƒ€ãƒ¼", keywords: ["mouse", "black"], hp: 220, atk: 100, exp: 150 },
    { no: 10, rarity: "COMMON", name: "ã‚¹ãƒ©ã‚¤ãƒ ", keywords: ["drink", "water", "bottle", "cap", "blue"], hp: 150, atk: 30, exp: 50 },
    { no: 1, rarity: "COMMON", name: "ãƒ©ãƒƒãƒˆ", keywords: ["mouse", "cheese"], hp: 100, atk: 20, exp: 30 }
];

// --- ã‚·ã‚¹ãƒ†ãƒ ãƒ­ã‚¸ãƒƒã‚¯ ---

window.onload = async () => {
    try {
        net = await mobilenet.load();
        document.getElementById('init-msg').innerText = "AI READY";
        document.getElementById('start-btn').classList.remove('hidden');
    } catch(e) { document.getElementById('init-msg').innerText = "NETWORK ERROR"; }
};

async function startGame() {
    document.getElementById('init-overlay').classList.add('hidden');
    const video = document.getElementById('webcam');
    stream = await navigator.mediaDevices.getUserMedia({video: {facingMode: "environment"}});
    video.srcObject = stream;
    video.style.display = "block";
    mode = "W";
    document.getElementById('scan-btn').disabled = false;
    log("æ­¦å™¨(WEAPON)ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ãã ã•ã„");
}

function getElementByColor() {
    const video = document.getElementById('webcam');
    const canvas = document.getElementById('color-canvas');
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, video.videoWidth/2, video.videoHeight/2, 1, 1, 0, 0, 1, 1);
    const [r, g, b] = ctx.getImageData(0, 0, 1, 1).data;
    document.getElementById('element-debug').innerText = `RGB: ${r},${g},${b}`;
    for (const m of COLOR_MAPPING) if (m.check(r, g, b)) return m.elem;
    return Object.keys(ELEMENTS)[Math.floor(Math.random() * 4)];
}

function lottery(db, label) {
    const labels = label.toLowerCase().split(',').map(s => s.trim());
    // ORåˆ¤å®šã§å€™è£œæŠ½å‡º
    let candidates = db.filter(item => item.keywords.some(k => labels.includes(k.toLowerCase())));
    if (candidates.length === 0) candidates = db;

    // ãƒ¬ã‚¢ãƒªãƒ†ã‚£æ¯”ç‡ã§ã®æŠ½é¸
    let totalWeight = 0;
    const weighted = candidates.map(c => {
        const w = RARITY_RATES.find(r => r.rarity === c.rarity).rate;
        totalWeight += w;
        return { item: c, w: totalWeight };
    });

    const r = Math.random() * totalWeight;
    return weighted.find(item => r <= item.w).item;
}

async function startScan() {
    const btn = document.getElementById('scan-btn');
    btn.disabled = true;
    log("ã‚¹ã‚­ãƒ£ãƒ³ä¸­...");
    const result = await net.classify(document.getElementById('webcam'));
    const label = result[0].className;
    const elemKey = getElementByColor();

    if (mode === "W") {
        const weapon = lottery(WEAPON_DB, label);
        playerElement = elemKey;
        pAtk = weapon.atk; 
        pDef = weapon.def; 
        log(`æ­¦å™¨: ${weapon.name} [ATK:${pAtk}]\nå±æ€§: ${ELEMENTS[elemKey].icon}`);
        mode = "E";
        btn.innerText = "ENEMY SCAN";
        btn.disabled = false; // æ¬¡ã®ã‚¹ã‚­ãƒ£ãƒ³ã®ãŸã‚ã«ãƒœã‚¿ãƒ³ã‚’æˆ»ã™
    } else if (mode === "E") {
        const monster = lottery(MONSTER_DB, label);
        enemyElement = elemKey;
        enemyName = monster.name;
        eMax = monster.hp; 
        ehp = eMax;
        eAtk = monster.atk; 
        eExp = monster.exp; 
        log(`æ•µ: ${monster.name} [HP:${eMax}]\nå±æ€§: ${ELEMENTS[elemKey].icon}`);
        
        // â˜…ã“ã“ãŒé‡è¦ï¼šãƒãƒˆãƒ«ãƒ¢ãƒ¼ãƒ‰ã¸åˆ‡ã‚Šæ›¿ãˆ
        mode = "B"; 
        btn.innerText = "SCAN DISABLED";
        document.getElementById('atk-btn').disabled = false;
        document.getElementById('magic-btn').disabled = false;
    }
updateUI();
    // ãƒœã‚¿ãƒ³ã®ç„¡åŠ¹åŒ–åˆ¤å®šã‚’é–¢æ•°å†…ã«å…¥ã‚Œã‚‹
    btn.disabled = (mode === "B"); 
}

function handleAttack() {
    const mod = getElementModifier(playerElement, enemyElement);
    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ”»æ’ƒåŠ›(pAtk)ã¨ãƒ¬ãƒ™ãƒ«ãƒœãƒ¼ãƒŠã‚¹ã‚’ä½¿ç”¨
    const dmg = Math.floor((pAtk + lv * 10) * mod);
    ehp = Math.max(0, ehp - dmg);
    applyShake();
    
    log(`${enemyName}ã« ${dmg}ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼ (${mod === 1.5 ? 'åŠ¹æœçµ¶å¤§!' : mod === 0.5 ? 'ã‚¤ãƒã‚¤ãƒ...' : 'é€šå¸¸'})`);

    if (ehp <= 0) {
        log(`${enemyName}ã‚’å€’ã—ãŸï¼`);
        mode = "W";
        document.getElementById('scan-btn').innerText = "WEAPON SCAN";
        document.getElementById('scan-btn').disabled = false;
        document.getElementById('atk-btn').disabled = true;
        
        // çµŒé¨“å€¤ã‚’åŠ ç®—ã—ã€ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—åˆ¤å®š
        exp += eExp; 
        if (exp >= lv * 100) { 
            lv++; 
            exp = 0; 
            pMax += 200; // ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ã§æœ€å¤§HPä¸Šæ˜‡
            php = pMax;  // HPå…¨å›å¾©
            log(`ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ï¼ Lv.${lv} æœ€å¤§HPãŒä¸Šæ˜‡ã—ã¾ã—ãŸï¼`); 
        }
    } else {
        // æ•µã®ã‚¿ãƒ¼ãƒ³
        setTimeout(() => {
            // è¨ˆç®—å¼: æ•µã®æ”»æ’ƒåŠ›(eAtk) - ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®é˜²å¾¡åŠ›(pDef) (æœ€ä½10ãƒ€ãƒ¡ãƒ¼ã‚¸)
            const edmg = Math.max(10, eAtk - pDef); 
            php = Math.max(0, php - edmg);
            log(`æ•µã®æ”»æ’ƒï¼ ${edmg}ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼`);
            if (php <= 0) { alert("GAMEOVER"); location.reload(); }
            updateUI();
        }, 600);
    }
    updateUI();
}
    function getElementModifier(a, d) {
    if (!a || !d) return 1.0;
    if (ELEMENTS[a].strongTo === d) return 1.5;
    if (ELEMENTS[d].strongTo === a) return 0.5;
    return 1.0;
}

function updateUI() {
    document.getElementById('p-lv').innerText = lv;
    document.getElementById('p-hp-cur').innerText = php;
    document.getElementById('p-fill').style.width = (php/pMax*100) + "%";
    if(playerElement) {
        document.getElementById('p-elem').innerText = ELEMENTS[playerElement].icon;
        document.getElementById('p-elem').style.color = ELEMENTS[playerElement].color;
    }
    document.getElementById('e-hp-cur').innerText = ehp;
    document.getElementById('e-hp-max').innerText = eMax;
    document.getElementById('e-fill').style.width = (eMax > 0 ? (ehp/eMax*100) : 0) + "%";
    if(enemyElement) {
        document.getElementById('e-elem').innerText = ELEMENTS[enemyElement].icon;
        document.getElementById('e-elem').style.color = ELEMENTS[enemyElement].color;
    }
}

function log(m) { document.getElementById('msg').innerText = m; }
function applyShake() { document.body.classList.add('shake'); setTimeout(() => document.body.classList.remove('shake'), 200); }
function openLibrary() { alert("å›³é‘‘æ©Ÿèƒ½æº–å‚™ä¸­"); }
function openMagic() { alert("é­”æ³•æ©Ÿèƒ½æº–å‚™ä¸­"); }
</script>
</body>
</html>
