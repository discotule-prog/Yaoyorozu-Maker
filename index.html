<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MYTH SCANNER 4.21 - ICON FIX</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet"></script>
    <link href="https://fonts.googleapis.com/css2?family=DotGothic16&display=swap" rel="stylesheet">
    <style>
        /* ã‚¹ã‚¿ã‚¤ãƒ«è¨­å®šï¼ˆãƒ™ãƒ¼ã‚¹ã‚’ç¶­æŒã—ã¤ã¤ç”»åƒè¡¨ç¤ºã‚’æœ€é©åŒ–ï¼‰ */
        :root { --p-color: #00f2ff; --e-color: #ff3c00; --exp-color: #32ff32; --gold: #ffd700; }
        body { font-family: 'DotGothic16', sans-serif; background: #000; color: #fff; margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        #header { height: 40px; background: #222; display: flex; justify-content: center; align-items: center; border-bottom: 2px solid #444; flex-shrink: 0; }
        .lib-btn { width: 50%; font-size: 0.6rem; height: 24px; background: #555; border: 1px solid #fff; color: #fff; cursor: pointer; }
        .char-area { height: 32%; display: flex; border-bottom: 1px solid #333; padding: 10px; box-sizing: border-box; }
        .cam-part { width: 35%; display: flex; align-items: center; justify-content: center; }
        .cam-frame { width: 90px; height: 90px; border: 2px solid #555; background: #111; overflow: hidden; position: relative; border-radius: 8px; }
        video { width: 100%; height: 100%; object-fit: cover; display: none; }
        .cam-active video { display: block !important; border-color: #0f0; }
        .info-part { width: 65%; display: flex; flex-direction: column; padding-left: 10px; justify-content: center; }
        .visual-card { width: 100%; height: 80px; border: 2px solid #fff; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #111; position: relative; border-radius: 4px; overflow: hidden; }
        
        /* ã‚¢ã‚¤ã‚³ãƒ³ç”»åƒè¡¨ç¤ºã®ä¿®æ­£ */
        .visual-card img, .slot-icon img { width: 50px; height: 50px; object-fit: contain; image-rendering: pixelated; }
        .slot-icon { margin-bottom: 2px; }

        .stat-text { font-size: 0.65rem; color: #ccc; margin-top: 2px; line-height: 1.2; }
        .bar-bg { width: 100%; height: 8px; background: #222; border: 1px solid #666; position: relative; overflow: hidden; }
        .bar-fill { height: 100%; width: 0%; transition: width 0.4s ease-out; }
        .rarity-tag { position: absolute; top: 2px; right: 2px; font-size: 0.5rem; padding: 1px 3px; background: #fff; color: #000; font-weight: bold; }
        .elem-tag { position: absolute; top: 2px; left: 2px; font-size: 0.7rem; }
        #mid-ui { height: 140px; background: #111; border-top: 2px solid #444; display: flex; flex-direction: column; align-items: center; padding: 5px; flex-shrink: 0; }
        #msg { font-size: 0.75rem; color: #0f0; height: 45px; text-align: center; display: flex; align-items: center; padding: 0 10px; line-height: 1.2; white-space: pre-wrap; }
        .btn-row { display: flex; gap: 5px; width: 95%; justify-content: center; margin-bottom: 5px; }
        button { flex: 1; height: 40px; font-family: 'DotGothic16'; border: 2px solid #fff; color: #fff; background: #444; font-size: 0.75rem; cursor: pointer; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 100; display: none; flex-direction: column; align-items: center; padding: 15px; box-sizing: border-box; }
        .lib-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; width: 100%; max-height: 60vh; overflow-y: auto; padding: 10px; box-sizing: border-box; }
        .lib-slot { min-height: 80px; background: #222; border: 1px solid #444; border-radius: 4px; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 5px; text-align: center; position: relative; }
        .slot-content { font-size: 0.5rem; color: #555; word-break: break-all; }
        .lib-slot.found .slot-content { color: #fff; }
        .q-mark { font-size: 3rem; color: #333; animation: blink 2s infinite; }
        @keyframes blink { 0%,100% {opacity:1} 50% {opacity:0.3} }
    </style>
</head>
<body>

<div id="header"><button onclick="openLibrary()" class="lib-btn">COLLECTION / RESET</button></div>

<div class="char-area" id="p-area">
    <div class="cam-part"><div class="cam-frame"><video id="pv" autoplay playsinline muted></video></div></div>
    <div class="info-part">
        <div id="p-card" class="visual-card">
            <div id="p-rare" class="rarity-tag">-</div>
            <div id="p-elem" class="elem-tag"></div>
            <div id="p-sym" class="q-mark">?</div>
            <div id="p-name" style="font-size:0.6rem; text-align:center;">SCANNER READY</div>
        </div>
        <div class="stat-text">LV:<span id="p-lv">1</span> HP:<span id="p-hp-cur">1000</span>/<span id="p-hp-max">1000</span></div>
        <div class="bar-bg"><div id="p-fill" class="bar-fill" style="background:var(--p-color); width:100%"></div></div>
    </div>
</div>

<div id="mid-ui">
    <div id="msg">INITIALIZING...</div>
    <div class="btn-row">
        <button id="scan-btn" onclick="handleScan()" disabled>LOADING...</button>
        <button id="atk-btn" onclick="handleAttack()" disabled style="background:#aa0000">ATTACK</button>
    </div>
</div>

<div class="char-area" id="e-area">
    <div class="cam-part"><div class="cam-frame"><video id="ev" autoplay playsinline muted></video></div></div>
    <div class="info-part">
        <div id="e-card" class="visual-card">
            <div id="e-rare" class="rarity-tag">-</div>
            <div id="e-elem" class="elem-tag"></div>
            <div id="e-sym" class="q-mark">?</div>
            <div id="e-name" style="font-size:0.6rem; text-align:center;">???</div>
        </div>
        <div class="stat-text">HP:<span id="e-hp-cur">0</span>/<span id="e-hp-max">0</span></div>
        <div class="bar-bg"><div id="e-fill" class="bar-fill" style="background:var(--e-color);"></div></div>
    </div>
</div>

<div id="lib-overlay" class="overlay">
    <h2>COLLECTION</h2>
    <div style="display:flex; gap:5px; margin-bottom:10px;"><button onclick="renderLib('W')">WEAPON</button><button onclick="renderLib('M')">MONSTER</button></div>
    <div id="lib-grid" class="lib-grid"></div>
    <button onclick="document.getElementById('lib-overlay').style.display='none'" style="margin-top:10px;">CLOSE</button>
</div>

<script>
    const DB_WEAPON = ["éŒ†ã³ãŸçŸ­å‰£","æ£’åˆ‡ã‚Œ","é‰„ã®ãƒ¤ã‚¹ãƒª","ç·´ç¿’ç”¨ã®å‰£","çš®ã®ãƒ ãƒ","çŸ³ã®ç¤«","ç²—æœ«ãªå¼“","é‰„ã®æ£’","è–ªå‰²ã‚Šæ–§","ç©´ã®ç©ºã„ãŸç›¾","ãƒ–ãƒ­ãƒ³ã‚ºãƒŠã‚¤ãƒ•","é‰„ã®çˆª","ãƒ©ãƒ³ã‚¹","è­¦æ£’","æœ¨åˆ€","çŸ³ã®ãƒ¡ã‚¤ã‚¹","æŠ•ã’ãƒŠã‚¤ãƒ•","é‰„ã®é‡","å…µå£«ã®å‰£","å¤ã„ãƒãƒ«ãƒãƒ¼ãƒ‰","é‹¼é‰„ã®é•·å‰£","å‡¦åˆ‘äººã®æ–§","éŠ€ã®ãƒ¬ã‚¤ãƒ”ã‚¢","å‰›å¼“","æ¼†é»’ã®çŸ­åˆ€","ç†Ÿç·´ã®æˆ¦æ§Œ","çŒ›ç£ã®ç‰™","æŠœåˆ€æ–ã®åˆ€","æš—æ®ºè€…ã®é‡","é–ƒå…‰ã®ãƒ€ã‚¬ãƒ¼","å®ˆè­·è€…ã®å¤§ç›¾","ã‚¹ãƒŠã‚¤ãƒ‘ãƒ¼ãƒ©ã‚¤ãƒ•ãƒ«","é¨å£«ã®ãƒ©ãƒ³ã‚¹","åå­—æ§","ä¸‰ç¯€æ£","ãƒ•ãƒ©ãƒ³ãƒ™ãƒ«ã‚¸ãƒ¥","é­”æ³•ã®æ–","ä¸‰å‰çŸ›","é»„é‡‘ã®æ§Œ","ã‚«ãƒˆãƒ©ã‚¹","ãƒã‚¹ã‚¿ãƒ¼ã‚½ãƒ¼ãƒ‰","ãƒŸã‚¹ãƒªãƒ«ã®å°å¤ªåˆ€","å‡çµã®é­”å¼“","çˆ†ç‚ã®æ–§","ç¨²å¦»ã®åˆºå‰£","ç«œæ®ºã—ã®å¤ªåˆ€","å¹»å½±ã®åŒå‰£","å²©æ–­ã¡ã®å·¨æ–§","ç²¾éœŠã®æ–","ç ´é‚ªã®å¼“","å®ˆè­·ç¥ã®æ§","æ¯’è›‡ã®å°¾","å¸è¡€ã®ç‰™","æ˜Ÿå±‘ã®ãƒ¡ã‚¤ã‚¹","éœ‡å‹•ã®ãƒãƒ³ãƒãƒ¼","è’¼å¤©ã®å‰£","çƒˆé¢¨ã®éŒ","æ–­ç½ªã®é–","è³¢è€…ã®è¾å…¸","æ·±æµ·ã®ãƒãƒ³ãƒˆ","ãƒ•ãƒ¬ã‚¤ãƒ ã‚¿ãƒ³","ãƒŸãƒ§ãƒ«ãƒ‹ãƒ«","ãƒˆãƒ©ã‚¤ãƒ‡ãƒ³ãƒˆ","ã‚¬ã‚¤ã‚¢ãƒãƒ³ãƒãƒ¼","å††æœˆåˆ€","ã‚¯ãƒ¬ã‚¤ãƒ¢ã‚¢","å·¨äººã®é‰„çƒ","ãƒ•ãƒ¬ã‚¤ãƒ«","ç´°å‰£","é­”æ§","è–é¨å£«ã®ç›¾","é»’é‡‘ã®æ£æ£’","å‘ªã„ã®å‘ªç¬¦","ç…‰ç„ã®éŒ","æ¥µå…‰ã®çŸ¢","ç¥é€Ÿã®ãƒ€ã‚¬ãƒ¼","ä¸å£Šã®ç± æ‰‹","é£›é¾ã®é­”ç¬›","æ··æ²Œã®æ–","è™šç©ºã®é¡","é­”å‰£ã‚°ãƒ©ãƒ ","è–å‰£ã‚¨ã‚¯ã‚¹ã‚«ãƒªãƒãƒ¼","ç«œæ§ã‚²ã‚¤ãƒœãƒ«ã‚°","è–æ§ãƒ­ãƒ³ã‚®ãƒŒã‚¹","å¤©ç¾½ã€…æ–¬","æ‘æ­£","ç¥å¼“ã‚¢ãƒ«ãƒ†ãƒŸã‚¹","ãƒ¢ãƒ¼ãƒ‹ãƒ³ã‚°ã‚¹ã‚¿ãƒ¼","ã‚¢ãƒ­ãƒ³ãƒ€ã‚¤ãƒˆ","ãƒ‡ãƒ¥ãƒ©ãƒ³ãƒ€ãƒ«","å¦–åˆ€æ­£å®—","éœŠåˆ€ä¸ƒæ”¯åˆ€","é­”å°æ›¸ã‚¢ãƒ«ãƒãƒ‡ãƒ«","ç ´æ»…ã®çˆª","çµ¶å½±","ç©¶æ¥µç¥å‰£ã‚¼ãƒã‚¹","æ™‚ç©ºè²«é€šç¥æ§","çœŸç†ã®é­”å°æ ¸","å¤©åœ°å´©å£Šã®çµ‚æ§Œ","é»™ç¤ºéŒ²ã®ç¥ç›¾"];
    const DB_MONSTER = ["ã‚¹ãƒ©ã‚¤ãƒ ","ã‚´ãƒ–ãƒªãƒ³","ã‚¹ã‚±ãƒ«ãƒˆãƒ³","é‡è‰¯çŠ¬","å·¨å¤§ã‚¯ãƒ¢","ã‚¦ã‚£ã‚¹ãƒ—","ã‚³ãƒãƒ«ãƒˆ","å¤§ãƒã‚ºãƒŸ","ã‚¾ãƒ³ãƒ“","ãƒãƒƒãƒˆ","æ³¥äººå½¢","å‡¶æš´ãªé¶","è¿·ã„é­‚","å¯„ç”Ÿè™«","å½±","æµ®éŠã™ã‚‹ç›®ç‰","æ¯’èœ‚","è…ã£ãŸæ¨¹æœ¨","çŸ³ã®ãƒˆã‚«ã‚²","ã¯ãã‚Œãƒ¡ã‚¿ãƒ«","ã‚ªãƒ¼ã‚¯","ãƒ‡ã‚¹ãƒŠã‚¤ãƒˆ","ã‚±ãƒ«ãƒ™ãƒ­ã‚¹","ã‚­ãƒã‚¤ãƒ©","ãƒŸãƒŸãƒƒã‚¯","ã‚¬ãƒ¼ã‚´ã‚¤ãƒ«","ãƒªãƒ“ãƒ³ã‚°ã‚¢ãƒ¼ãƒãƒ¼","ã‚¦ã‚§ã‚¢ã‚¦ãƒ«ãƒ•","ãƒãƒ³ã‚·ãƒ¼","ã‚°ãƒ¼ãƒ«","ã‚µã‚­ãƒ¥ãƒã‚¹","ã‚¤ãƒ³ãƒ—","ãƒãƒ¼ãƒ”ãƒ¼","ãƒ©ãƒŸã‚¢","ã‚±ãƒ³ã‚¿ã‚¦ãƒ­ã‚¹","ãƒŸãƒã‚¿ã‚¦ãƒ­ã‚¹","ãƒãƒ³ãƒ†ã‚£ã‚³ã‚¢","ã‚³ã‚«ãƒˆãƒªã‚¹","ã‚µãƒ©ãƒãƒ³ãƒ€ãƒ¼","ã‚¦ãƒ³ãƒ‡ã‚£ãƒ¼ãƒ","ãƒ¬ãƒƒãƒ‰ãƒ‰ãƒ©ã‚´ãƒ³","ãƒ´ã‚¡ãƒ³ãƒ‘ã‚¤ã‚¢","é¦–ãªã—é¨å£«","ãƒ‡ãƒ¼ãƒ¢ãƒ³","ã‚´ãƒ¼ãƒ¬ãƒ ","ã‚°ãƒªãƒ•ã‚©ãƒ³","ãƒã‚¸ãƒªã‚¹ã‚¯","ãƒ’ãƒ¥ãƒ‰ãƒ©","ã‚¯ãƒ©ãƒ¼ã‚±ãƒ³","ãƒ•ã‚§ãƒ‹ãƒƒã‚¯ã‚¹","å·¨å¤§ãªç™¾è¶³","å‘ªã„ã®éºå½±","ç ‚æ¼ ã®é­”äºº","é›ªå¥³","é›·ç£","é—‡ã®å¸ç¥­","æ­»éœŠä½¿ã„","æ²¼ã®æ€ªç‰©","è¿·å®®ã®ç•ªäºº","å²©çŸ³å·¨äºº","å¤é¾","ç½å„ã®åŒ–èº«","ã‚¢ãƒ¼ã‚¯ãƒ‡ãƒ¼ãƒ¢ãƒ³","å •å¤©ä½¿","ãƒªãƒƒãƒ","ãƒ‡ãƒ¼ãƒ¢ãƒ³ãƒ­ãƒ¼ãƒ‰","åŒé ­ã®å·¨ç£","ãƒ¤ãƒã‚¿ãƒã‚ªãƒ­ãƒ","ã‚¤ãƒ•ãƒªãƒ¼ãƒˆ","ã‚·ãƒ´ã‚¡","ãƒ©ãƒ ã‚¦","ã‚¿ã‚¤ã‚¿ãƒ³","ã‚¬ãƒ«ãƒ¼ãƒ€","ãƒªãƒ´ã‚¡ã‚¤ã‚¢ã‚µãƒ³","ã‚«ã‚ªã‚¹","ãƒ¡ãƒ‰ã‚¥ãƒ¼ã‚µ","ã‚­ãƒ¥ã‚¯ãƒ­ãƒ—ã‚¹","ãƒ™ãƒ’ãƒ¼ãƒ¢ã‚¹","ã‚¹ãƒ•ã‚£ãƒ³ã‚¯ã‚¹","å®ˆè­·åƒ","ç¥ç«œ","å‰µä¸–ã®å·¨ç¥","ç†¾å¤©ä½¿","å†¥ç‹ãƒãƒ‡ã‚¹","ç ´å£Šç¥ã‚·ãƒ´ã‚¡","å¤§å¤©ä½¿ãƒŸã‚«ã‚¨ãƒ«","å¦–ç‹ç‰è—»å‰","å…«å’«çƒ","éº’éºŸ","é³³å‡°","ç™½è™","ç„æ­¦","æœ±é›€","é’é¾","é­”ç‹ã‚µã‚¿ãƒ³","å¥ˆè½ã®æ”¯é…è€…","çµ‚ç„‰ã‚’å–°ã‚‰ã†è€…","è™šç„¡ã®ç‰¹ç•°ç‚¹","é»™ç¤ºéŒ²ã®é»’ç«œ","å‰µä¸–ã®çˆ¶"];

    // ã‚¢ã‚¤ã‚³ãƒ³URLå®šç¾©ï¼ˆPlaceholderã§ãƒ†ã‚¹ãƒˆï¼‰
    const ICON_POOL = {
        W: {
            "å‰£": "https://via.placeholder.com/100/ff3300/ffffff?text=SWORD",
            "ç›¾": "https://via.placeholder.com/100/ccaa00/ffffff?text=SHIELD",
            "æ–": "https://via.placeholder.com/100/ff00ff/ffffff?text=WAND",
            "å¼“": "https://via.placeholder.com/100/66cc33/ffffff?text=BOW"
        },
        M: {
            "ã‚¹ãƒ©ã‚¤ãƒ ": "https://via.placeholder.com/100/44ccff/ffffff?text=SLIME",
            "ãƒ‰ãƒ©ã‚´ãƒ³": "https://via.placeholder.com/100/333333/ffffff?text=DRAGON",
            "ã‚¢ãƒ³ãƒ‡ãƒƒãƒ‰": "https://via.placeholder.com/100/9900cc/ffffff?text=UNDEAD",
            "é³¥": "https://via.placeholder.com/100/3366ff/ffffff?text=BIRD"
        }
    };

    // --- å¼·åŒ–ã•ã‚ŒãŸã‚¢ã‚¤ã‚³ãƒ³åˆ¤å®šã‚¨ãƒ³ã‚¸ãƒ³ ---
    function getAutoIcon(type, name) {
        if (!name) return "?";
        const n = name.toLowerCase();
        const pool = ICON_POOL[type];

        if (type === 'W') {
            if (/å‰£|åˆ€|ã‚½ãƒ¼ãƒ‰|ãƒ–ãƒ¬ãƒ¼ãƒ‰|ãƒŠã‚¤ãƒ•|ãƒ€ã‚¬ãƒ¼|ãƒ¤ã‚¹ãƒª|çˆª|ãƒ©ãƒ³ã‚¹|æ£æ£’|æ£’|ãƒ ãƒ|æ–§/.test(n)) 
                return `<img src="${pool["å‰£"]}" alt="weapon">`;
            if (/ç›¾|ç± æ‰‹|ã‚¬ãƒ¼ãƒ‰/.test(n)) 
                return `<img src="${pool["ç›¾"]}" alt="shield">`;
            if (/æ–|æ›¸|è¾å…¸|ã‚¹ãƒ†ãƒƒã‚­|ãƒ­ãƒƒãƒ‰|ç¬›|é¡|ç¬¦/.test(n)) 
                return `<img src="${pool["æ–"]}" alt="magic">`;
            if (/å¼“|ãƒ©ã‚¤ãƒ•ãƒ«|çŸ¢/.test(n)) 
                return `<img src="${pool["å¼“"]}" alt="bow">`;
            return "âš”ï¸"; 
        } else {
            if (/ã‚¹ãƒ©ã‚¤ãƒ |æ³¥|äººå½¢|èœ˜è››|ã‚¯ãƒ¢|ç›®ç‰|èœ‚|æ¨¹æœ¨|è™«|ç™¾è¶³|ã‚´ãƒ¼ãƒ¬ãƒ /.test(n)) 
                return `<img src="${pool["ã‚¹ãƒ©ã‚¤ãƒ "]}" alt="slime">`;
            if (/ãƒ‰ãƒ©ã‚´ãƒ³|ç«œ|ãƒˆã‚«ã‚²|ã‚­ãƒã‚¤ãƒ©|ãƒŸãƒã‚¿ã‚¦ãƒ­ã‚¹|ã‚°ãƒªãƒ•ã‚©ãƒ³|ãƒã‚¸ãƒªã‚¹ã‚¯|ãƒ’ãƒ¥ãƒ‰ãƒ©|ã‚¯ãƒ©ãƒ¼ã‚±ãƒ³|ãƒ•ã‚§ãƒ‹ãƒƒã‚¯ã‚¹|ãƒ™ãƒ’ãƒ¼ãƒ¢ã‚¹|ã‚ªãƒ­ãƒ/.test(n)) 
                return `<img src="${pool["ãƒ‰ãƒ©ã‚´ãƒ³"]}" alt="dragon">`;
            if (/ã‚¾ãƒ³ãƒ“|ã‚¹ã‚±ãƒ«ãƒˆãƒ³|äº¡è€…|ãƒªãƒƒãƒ|å¹½éœŠ|ãƒ‡ã‚¹|ãƒŠã‚¤ãƒˆ|éª¨|éª¸|é¦–ãªã—|ãƒ‡ãƒ¼ãƒ¢ãƒ³|é­”ç‹|æ‚ªé­”|å •å¤©ä½¿/.test(n)) 
                return `<img src="${pool["ã‚¢ãƒ³ãƒ‡ãƒƒãƒ‰"]}" alt="undead">`;
            if (/é³¥|ãƒãƒ”|é¶|é›€|ã‚¿ã‚«|ã‚«ãƒ©ã‚¹|è™è |ãƒãƒƒãƒˆ/.test(n)) 
                return `<img src="${pool["é³¥"]}" alt="bird">`;
            return "ğŸ‘¾"; 
        }
    }

    let net, mode="W", stream=null;
    let library = JSON.parse(localStorage.getItem('myth_v4_final')) || { W: {}, M: {} };

    async function init() {
        document.getElementById('msg').innerText = "AI LOADING...";
        try {
            net = await mobilenet.load();
            document.getElementById('scan-btn').disabled = false;
            document.getElementById('scan-btn').innerText = "SCAN START";
            document.getElementById('msg').innerText = "æ­¦å™¨ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ãã ã•ã„";
            await switchCamera('P');
        } catch (e) { document.getElementById('msg').innerText = "ERROR: " + e.message; }
    }

    async function switchCamera(target) {
        if(stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }
        if(target === 'OFF') { document.querySelectorAll('.cam-frame').forEach(f=>f.classList.remove('cam-active')); return; }
        const vId = {P:'pv', E:'ev'}[target];
        try {
            stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
            const v = document.getElementById(vId);
            v.srcObject = stream;
            v.onloadedmetadata = () => {
                v.play();
                document.querySelectorAll('.cam-frame').forEach(f=>f.classList.remove('cam-active'));
                v.parentElement.classList.add('cam-active');
            };
        } catch(e) { document.getElementById('msg').innerText = "CAMERA ERROR"; }
    }

    async function handleScan() {
        const vid = mode==="W" ? document.getElementById('pv') : document.getElementById('ev');
        let id, aiName = "UNKNOWN";
        try { 
            const r = await net.classify(vid); 
            aiName = r[0].className.split(',')[0].toUpperCase(); 
            id = Math.floor(r[0].probability * 100); 
        } catch (e) { id = Math.floor(Math.random() * 100); }

        const rare = id >= 90 ? "MYTH" : id >= 50 ? "ELITE" : "NORMAL";

        if(mode==="W") {
            const base = DB_WEAPON[id] || DB_WEAPON[0];
            const iconHtml = getAutoIcon('W', base); // ã“ã“ã§ã‚¢ã‚¤ã‚³ãƒ³æ±ºå®š
            updateCardUI('p', rare, iconHtml, `${aiName}ã®${base}`);
            library.W[id] = {t: base, r: rare};
            mode="M"; await switchCamera('E');
            document.getElementById('msg').innerText = `ã€${base}ã€‘ã‚’è£…å‚™ã—ã¾ã—ãŸï¼\næ¬¡ã¯ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã‚’ã‚¹ã‚­ãƒ£ãƒ³ï¼`;
        } else {
            const base = DB_MONSTER[id] || DB_MONSTER[0];
            const iconHtml = getAutoIcon('M', base); // ã“ã“ã§ã‚¢ã‚¤ã‚³ãƒ³æ±ºå®š
            updateCardUI('e', rare, iconHtml, `${aiName}ã®${base}`);
            library.M[id+100] = {t: base, r: rare};
            await switchCamera('OFF');
            document.getElementById('atk-btn').disabled = false;
            document.getElementById('scan-btn').disabled = true;
            document.getElementById('msg').innerText = `é‡ç”Ÿã®ã€${base}ã€‘ãŒç¾ã‚ŒãŸï¼`;
        }
        localStorage.setItem('myth_v4_final', JSON.stringify(library));
    }

    function updateCardUI(side, rare, symHtml, name) {
        document.getElementById(`${side}-rare`).innerText = rare;
        const s = document.getElementById(`${side}-sym`);
        s.innerHTML = symHtml; 
        s.className = ""; s.style.fontSize = "1rem"; // ç”»åƒæ™‚ã¯ã‚µã‚¤ã‚ºèª¿æ•´
        document.getElementById(`${side}-name`).innerText = name;
    }

    function renderLib(type) {
        const grid = document.getElementById('lib-grid'); grid.innerHTML = "";
        const offset = type === 'W' ? 0 : 100;
        const dataSrc = type === 'W' ? DB_WEAPON : DB_MONSTER;
        
        for(let i=0; i<dataSrc.length; i++) {
            const id = offset + i;
            const data = library[type][id];
            const slot = document.createElement('div');
            slot.className = "lib-slot" + (data ? " found" : "");
            
            // å›³é‘‘ç”¨ã‚¢ã‚¤ã‚³ãƒ³è¡¨ç¤º
            const iconDiv = document.createElement('div');
            iconDiv.className = "slot-icon";
            iconDiv.innerHTML = data ? getAutoIcon(type, data.t) : "?";
            
            const content = document.createElement('div');
            content.className = "slot-content";
            content.innerText = data ? data.t : `No.${id}`;
            
            slot.appendChild(iconDiv);
            slot.appendChild(content);
            grid.appendChild(slot);
        }
        document.getElementById('lib-overlay').style.display='flex';
    }

    function openLibrary() { renderLib('W'); }
    window.onload = init;
</script>
</body>
</html>
