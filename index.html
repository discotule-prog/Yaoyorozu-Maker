<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MYTH SCANNER 6.1 - CSV DATA SYNC</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet"></script>
    <link href="https://fonts.googleapis.com/css2?family=DotGothic16&display=swap" rel="stylesheet">
    <style>
        :root { --p-color: #00f2ff; --e-color: #ff3c00; --exp-color: #32ff32; --gold: #ffd700; --magic-purple: #9d4edd; --close-btn: #880000; --main-blue: #0044cc; --reset-red: #cc0000; }
        body { font-family: 'DotGothic16', sans-serif; background: #000; color: #fff; margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        #header { height: 40px; background: #222; display: flex; justify-content: space-around; align-items: center; border-bottom: 2px solid #444; flex-shrink: 0; padding: 0 5px; }
        .head-btn { flex: 1; font-size: 0.55rem; height: 26px; border: 1px solid #fff; color: #fff; cursor: pointer; margin: 0 2px; white-space: nowrap; }
        .char-area { height: 30%; display: flex; border-bottom: 1px solid #333; padding: 10px; box-sizing: border-box; }
        .cam-part { width: 35%; display: flex; align-items: center; justify-content: center; }
        .cam-frame { width: 90px; height: 90px; border: 2px solid #555; background: #111; overflow: hidden; position: relative; border-radius: 8px; }
        video { width: 100%; height: 100%; object-fit: cover; display: none; }
        .cam-active video { display: block !important; border-color: #0f0; }
        .info-part { width: 65%; display: flex; flex-direction: column; padding-left: 10px; justify-content: center; }
        .visual-card { width: 100%; height: 75px; border: 2px solid #fff; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #111; position: relative; border-radius: 4px; overflow: hidden; }
        .stat-text { font-size: 0.65rem; color: #ccc; margin-top: 2px; line-height: 1.2; }
        .bar-container { width: 100%; margin-top: 4px; }
        .bar-bg { width: 100%; height: 8px; background: #222; border: 1px solid #666; position: relative; overflow: hidden; }
        .bar-fill { height: 100%; width: 0%; transition: width 0.4s ease-out; }
        .rarity-tag { position: absolute; top: 2px; right: 2px; font-size: 0.5rem; padding: 1px 3px; background: #fff; color: #000; font-weight: bold; }
        .elem-tag { position: absolute; top: 2px; left: 2px; font-size: 0.7rem; }
        #mid-ui { height: 155px; background: #111; border-top: 2px solid #444; display: flex; flex-direction: column; align-items: center; padding: 5px; flex-shrink: 0; justify-content: center; }
        #msg { font-size: 0.75rem; color: #0f0; height: 40px; text-align: center; display: flex; align-items: center; padding: 0 10px; line-height: 1.2; white-space: pre-wrap; }
        .btn-row { display: flex; gap: 6px; width: 95%; justify-content: center; margin-bottom: 6px; }
        button { flex: 1; height: 38px; font-family: 'DotGothic16'; border: 2px solid #fff; color: #fff; background: #444; font-size: 0.65rem; cursor: pointer; }
        button:disabled { opacity: 0.25; cursor: default; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 100; display: none; flex-direction: column; align-items: center; padding: 15px; box-sizing: border-box; }
        .ov-btn-red { background: var(--close-btn) !important; width: 95% !important; margin-top: 15px; flex:none; height:40px; border:none; color:#fff; }
        .lib-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; width: 100%; max-height: 60vh; overflow-y: auto; padding: 10px; }
        .lib-slot { min-height: 60px; background: #222; border: 1px solid #444; display: flex; align-items: center; justify-content: center; padding: 4px; text-align: center; font-size: 0.55rem; cursor: pointer; }
        .lib-slot.found { border-color: var(--p-color); background: #333; color: #fff; }
        #detail-pop { position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:#111; border:2px solid var(--p-color); padding:20px; z-index:200; width:75%; display:none; border-radius:12px; }
        .det-row { display: flex; justify-content: space-between; border-bottom: 1px solid #333; padding: 8px 0; font-size: 0.8rem; }
    </style>
</head>
<body>
    <div id="init-overlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:#000; color:#0f0; display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:10000;">
        <div style="font-size:1.5rem; margin-bottom:10px;">MYTH SCANNER 6.1</div>
        <div id="init-msg" style="font-size:0.8rem;">INITIALIZING...</div>
    </div>

<div id="header">
    <button onclick="if(confirm('ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')){localStorage.clear();location.reload();}" class="head-btn" style="background:var(--reset-red);">RESET</button>
    <button onclick="openLibrary()" class="head-btn" style="background:#555;">COLLECTION</button>
    <button id="skill-menu-btn" onclick="openSkillMenu()" class="head-btn" style="background:var(--magic-purple);">SKILL UP (0)</button>
</div>

<div class="char-area" id="p-area">
    <div class="cam-part"><div class="cam-frame"><video id="pv" autoplay playsinline muted></video></div></div>
    <div class="info-part">
        <div id="p-card" class="visual-card">
            <div id="p-rare" class="rarity-tag">-</div>
            <div id="p-elem" class="elem-tag"></div>
            <div id="p-sym" style="font-size:1.8rem; color:#333;">?</div>
            <div id="p-name" style="font-size:0.55rem; text-align:center;">SCANNER READY</div>
        </div>
        <div class="stat-text">LV:<span id="p-lv">1</span> HP:<span id="p-hp-cur">1000</span>/<span id="p-hp-max">1000</span><br>ATK:<span id="p-atk-val">0</span> DEF:<span id="p-def-val">0</span></div>
        <div class="bar-container"><div class="bar-bg"><div id="p-fill" class="bar-fill" style="background:var(--p-color); width:100%"></div></div></div>
        <div class="bar-container">
            <div style="display:flex; justify-content:space-between; font-size:0.5rem; color:var(--exp-color);"><span>EXP</span><span id="exp-text">0 / 30</span></div>
            <div class="bar-bg" style="height:5px;"><div id="exp-fill" class="bar-fill" style="background:var(--exp-color);"></div></div>
        </div>
    </div>
</div>

<div id="mid-ui">
    <div id="msg">INITIALIZING...</div>
    <div class="btn-row">
        <button id="scan-btn" onclick="handleScan()" disabled style="background:#0044cc; flex: 1.5;">SCAN</button>
        <button id="atk-btn" onclick="handleAttack()" disabled style="background:#aa0000; flex: 1.5;">ATTACK</button>
    </div>
    <div class="btn-row">
        <button id="magic-btn" onclick="openMagicMenu()" disabled style="background:var(--magic-purple);">MAGIC</button>
        <button id="item-open-btn" onclick="openItemMenu()" disabled style="background:#008844;">ITEM</button>
        <button id="esc-btn" onclick="handleEscape()" disabled style="background:#555;">ESCAPE</button>
    </div>
</div>

<div class="char-area" id="e-area">
    <div class="cam-part"><div class="cam-frame"><video id="ev" autoplay playsinline muted></video></div></div>
    <div class="info-part">
        <div id="e-card" class="visual-card">
            <div id="e-rare" class="rarity-tag">-</div>
            <div id="e-elem" class="elem-tag"></div>
            <div id="e-sym" style="font-size:1.8rem; color:#333;">?</div>
            <div id="e-name" style="font-size:0.55rem; text-align:center;">???</div>
        </div>
        <div class="stat-text">HP:<span id="e-hp-cur">0</span>/<span id="e-hp-max">0</span><br>ATK:<span id="e-atk-val">0</span> DEF:<span id="e-def-val">0</span></div>
        <div class="bar-container"><div class="bar-bg"><div id="e-fill" class="bar-fill" style="background:var(--e-color);"></div></div></div>
    </div>
</div>

<div id="magic-overlay" class="overlay">
    <h2 style="color:var(--magic-purple);">MAGIC SELECT</h2>
    <div id="magic-list" style="width:100%; display:flex; flex-direction:column; align-items:center;"></div>
    <button class="ov-btn-red" onclick="document.getElementById('magic-overlay').style.display='none'">CLOSE</button>
</div>
<div id="skill-overlay" class="overlay">
    <h2 style="color:var(--gold);">SKILL CUSTOMIZE</h2>
    <div id="skill-points-display" style="color:#fff; margin-bottom:15px; font-size:1.1rem;">POINTS: 0</div>
    <div id="skill-list" style="width:100%; display:flex; flex-direction:column; align-items:center; max-height: 60vh; overflow-y: auto;"></div>
    <button class="ov-btn-red" onclick="document.getElementById('skill-overlay').style.display='none'">CLOSE</button>
</div>
<div id="lib-overlay" class="overlay">
    <h2>COLLECTION</h2>
    <div style="display:flex; gap:5px; margin-bottom:5px;">
        <button onclick="renderLib('W')">WEAPON</button>
        <button onclick="renderLib('M')">MONSTER</button>
        <button onclick="renderLib('I')">ITEM</button>
    </div>
    <div id="lib-grid" class="lib-grid"></div>
    <button class="ov-btn-red" onclick="document.getElementById('lib-overlay').style.display='none'">CLOSE</button>
</div>
<div id="detail-pop">
    <h3 id="det-name" style="color:var(--p-color); margin-top:0;">NAME</h3>
    <div class="det-row"><span style="color:#aaa;">RARE</span><span id="det-rare"></span></div>
    <div class="det-row"><span id="det-sub-label" style="color:#aaa;">TYPE</span><span id="det-sub-value"></span></div>
    <button class="ov-btn-red" onclick="document.getElementById('detail-pop').style.display='none'">CLOSE</button>
</div>
<div id="item-overlay" class="overlay">
    <h2>BAG</h2>
    <div id="item-list" style="width:100%; display:flex; flex-direction:column; align-items:center; max-height: 60vh; overflow-y: auto;"></div>
    <button class="ov-btn-red" onclick="document.getElementById('item-overlay').style.display='none'">CLOSE</button>
</div>
<div id="res-screen" class="overlay" style="justify-content:center;">
    <h1 id="res-title" style="font-size:3rem; margin:0;"></h1>
    <div id="res-stats" style="background:#222; padding:15px; border:2px solid #fff; margin:10px 0; width:85%; font-size:0.75rem; text-align:center;"></div>
    <button style="background:var(--main-blue); width:95%; height:40px; border:none; color:#fff;" onclick="closeResult()">CONTINUE</button>
</div>
<div id="bonus-overlay" class="overlay">
    <h2 style="color:var(--gold);">ITEM SCAN</h2>
    <div class="cam-frame" style="width:150px; height:150px;"><video id="bv" autoplay playsinline muted></video></div>
    <button id="get-item-btn" style="background:var(--main-blue); width:95%; height:40px; border:none; color:#fff; margin-top:20px;" onclick="getBonusItem()">GET ITEM</button>
</div>

<script>
const DB_WEAPON = ["éŒ†ã³ãŸçŸ­å‰£","æ£’åˆ‡ã‚Œ","ç·´ç¿’ç”¨ã®å‰£","çš®ã®ãƒ ãƒ","ãƒ–ãƒ­ãƒ³ã‚ºãƒŠã‚¤ãƒ•","é‰„ã®çˆª","ãƒ©ãƒ³ã‚¹","æœ¨åˆ€","å…µå£«ã®å‰£","é‹¼é‰„ã®é•·å‰£","éŠ€ã®ãƒ¬ã‚¤ãƒ”ã‚¢","å‰›å¼“","æ¼†é»’ã®çŸ­åˆ€","å®ˆè­·è€…ã®å¤§ç›¾","é­”æ³•ã®æ–","ä¸‰å‰çŸ›","é»„é‡‘ã®æ§Œ","ãƒŸã‚¹ãƒªãƒ«ã®å°å¤ªåˆ€","ç«œæ®ºã—ã®å¤ªåˆ€","ç²¾éœŠã®æ–","è–å‰£ã‚¨ã‚¯ã‚¹ã‚«ãƒªãƒãƒ¼","é­”å‰£ã‚°ãƒ©ãƒ "];
    const DB_MONSTER = ["ã‚¹ãƒ©ã‚¤ãƒ ","ã‚´ãƒ–ãƒªãƒ³","ã‚¹ã‚±ãƒ«ãƒˆãƒ³","é‡è‰¯çŠ¬","å·¨å¤§ã‚¯ãƒ¢","ã‚¦ã‚£ã‚¹ãƒ—","ã‚¾ãƒ³ãƒ“","ã‚ªãƒ¼ã‚¯","ãƒ‡ã‚¹ãƒŠã‚¤ãƒˆ","ã‚±ãƒ«ãƒ™ãƒ­ã‚¹","ã‚­ãƒã‚¤ãƒ©","ãƒŸãƒŸãƒƒã‚¯","ãƒ‡ãƒ¼ãƒ¢ãƒ³","ã‚´ãƒ¼ãƒ¬ãƒ ","ãƒ’ãƒ¥ãƒ‰ãƒ©","ã‚¯ãƒ©ãƒ¼ã‚±ãƒ³","ãƒ•ã‚§ãƒ‹ãƒƒã‚¯ã‚¹","å¤é¾","é­”ç‹ã‚µã‚¿ãƒ³"];

    const DB_ITEM_FULL = {
        200: {name:"éå¸¸é£Ÿ", rare:"NORMAL", type:"HP RECOVERY", val:100, mode:"fix"},
        201: {name:"ãƒ‘ãƒ³", rare:"NORMAL", type:"HP RECOVERY", val:200, mode:"fix"},
        202: {name:"ç¼¶è©°", rare:"NORMAL", type:"HP RECOVERY", val:300, mode:"fix"},
        203: {name:"æ–°é®®é‡èœ", rare:"NORMAL", type:"HP RECOVERY", val:400, mode:"fix"},
        204: {name:"æ—¬ã®é‡èœ", rare:"NORMAL", type:"HP RECOVERY", val:500, mode:"fix"},
        205: {name:"æœå®Ÿ", rare:"ELITE", type:"HP RECOVERY", val:600, mode:"fix"},
        206: {name:"é«˜ç´šæœå®Ÿ", rare:"ELITE", type:"HP RECOVERY", val:700, mode:"fix"},
        207: {name:"éª¨ä»˜ãè‚‰", rare:"ELITE", type:"HP RECOVERY", val:800, mode:"fix"},
        208: {name:"éª¨ä»˜ãè‚‰ï¼ˆå¤§ï¼‰", rare:"ELITE", type:"HP RECOVERY", val:900, mode:"fix"},
        209: {name:"æºå¸¯ãƒ•ãƒ«ã‚³ãƒ¼ã‚¹", rare:"ELITE", type:"HP RECOVERY", val:1000, mode:"fix"},
        210: {name:"è»Ÿè†", rare:"NORMAL", type:"HP RECOVERY", val:0.1, mode:"pct"},
        211: {name:"ã‚¨ãƒŠã‚¸ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯", rare:"NORMAL", type:"HP RECOVERY", val:0.2, mode:"pct"},
        212: {name:"æ „é¤Šãƒ‰ãƒªãƒ³ã‚¯", rare:"NORMAL", type:"HP RECOVERY", val:0.3, mode:"pct"},
        213: {name:"å‚·è–¬", rare:"NORMAL", type:"HP RECOVERY", val:0.4, mode:"pct"},
        214: {name:"é«˜ç´šå‚·è–¬", rare:"NORMAL", type:"HP RECOVERY", val:0.5, mode:"pct"},
        215: {name:"ãƒãƒ¼ã‚·ãƒ§ãƒ³", rare:"ELITE", type:"HP RECOVERY", val:0.6, mode:"pct"},
        216: {name:"ãƒã‚¤ãƒãƒ¼ã‚·ãƒ§ãƒ³", rare:"ELITE", type:"HP RECOVERY", val:0.7, mode:"pct"},
        217: {name:"ã‚¨ã‚¯ã‚¹ãƒãƒ¼ã‚·ãƒ§ãƒ³", rare:"ELITE", type:"HP RECOVERY", val:0.8, mode:"pct"},
        218: {name:"è–æ°´", rare:"LEGEND", type:"HP RECOVERY", val:0.9, mode:"pct"},
        219: {name:"ç¥æ§˜ã®é›«", rare:"LEGEND", type:"HP RECOVERY", val:1.0, mode:"pct"},
        220: {name:"æ¾æ˜", rare:"NORMAL", type:"ELEMENTAL ATTACK", elem:"ğŸ”¥", val:0.1},
        221: {name:"æ°´é¢¨èˆ¹", rare:"NORMAL", type:"ELEMENTAL ATTACK", elem:"ğŸ’§", val:0.1},
        222: {name:"å£Šã‚ŒãŸæ©Ÿæ¢°", rare:"NORMAL", type:"ELEMENTAL ATTACK", elem:"âš¡", val:0.1},
        223: {name:"è”¦", rare:"NORMAL", type:"ELEMENTAL ATTACK", elem:"ğŸŒ¿", val:0.1},
        224: {name:"ç«ç‚ç“¶", rare:"NORMAL", type:"ELEMENTAL ATTACK", elem:"ğŸ”¥", val:0.2},
        225: {name:"æ°´é‰„ç ²", rare:"NORMAL", type:"ELEMENTAL ATTACK", elem:"ğŸ’§", val:0.2},
        226: {name:"ãƒ“ãƒªãƒ“ãƒªãƒã‚·ãƒ³", rare:"NORMAL", type:"ELEMENTAL ATTACK", elem:"âš¡", val:0.2},
        227: {name:"èŠæ£˜", rare:"NORMAL", type:"ELEMENTAL ATTACK", elem:"ğŸŒ¿", val:0.2},
        228: {name:"æ‰‹æ¦´å¼¾", rare:"NORMAL", type:"ELEMENTAL ATTACK", elem:"ğŸ”¥", val:0.3},
        229: {name:"æ”¾æ°´ãƒ›ãƒ¼ã‚¹", rare:"NORMAL", type:"ELEMENTAL ATTACK", elem:"ğŸ’§", val:0.3},
        230: {name:"é›»æ°—ã‚·ãƒ§ãƒƒã‚¯", rare:"NORMAL", type:"ELEMENTAL ATTACK", elem:"âš¡", val:0.3},
        231: {name:"æœ‰æ¯’æ¤ç‰©", rare:"NORMAL", type:"ELEMENTAL ATTACK", elem:"ğŸŒ¿", val:0.3},
        232: {name:"ç«ç‚æ”¾å°„å™¨", rare:"ELITE", type:"ELEMENTAL ATTACK", elem:"ğŸ”¥", val:0.4},
        233: {name:"é«˜åœ§æ´—æµ„æ©Ÿ", rare:"ELITE", type:"ELEMENTAL ATTACK", elem:"ğŸ’§", val:0.4},
        234: {name:"ã‚¹ã‚¿ãƒ³ã‚¬ãƒ³", rare:"ELITE", type:"ELEMENTAL ATTACK", elem:"âš¡", val:0.4},
        235: {name:"é£Ÿè™«æ¤ç‰©", rare:"ELITE", type:"ELEMENTAL ATTACK", elem:"ğŸŒ¿", val:0.4},
        236: {name:"çˆ†å¼¾", rare:"LEGEND", type:"ELEMENTAL ATTACK", elem:"ğŸ”¥", val:0.5},
        237: {name:"ã‚¦ã‚©ãƒ¼ã‚¿ãƒ¼ã‚«ãƒƒã‚¿ãƒ¼", rare:"LEGEND", type:"ELEMENTAL ATTACK", elem:"ğŸ’§", val:0.5},
        238: {name:"ã‚¨ãƒ¬ã‚­ãƒ†ãƒ«", rare:"LEGEND", type:"ELEMENTAL ATTACK", elem:"âš¡", val:0.5},
        239: {name:"å¾¡ç¥æœ¨ã®æ", rare:"LEGEND", type:"ELEMENTAL ATTACK", elem:"ğŸŒ¿", val:0.5},
        240: {name:"é¢¨é‚ªã‚¦ã‚¤ãƒ«ã‚¹", rare:"NORMAL", type:"DEBUFF_DEF", val:0.1},
        241: {name:"ã‚µãƒ³ãƒ—ãƒ«ç—…åŸèŒ", rare:"NORMAL", type:"DEBUFF_DEF", val:0.2},
        242: {name:"äººå·¥ã‚¦ã‚¤ãƒ«ã‚¹", rare:"NORMAL", type:"DEBUFF_DEF", val:0.3},
        243: {name:"ã‚¤ãƒ³ãƒ•ãƒ«ã‚¨ãƒ³ã‚¶", rare:"ELITE", type:"DEBUFF_DEF", val:0.4},
        244: {name:"æœªçŸ¥ã®ã‚¦ã‚¤ãƒ«ã‚¹", rare:"LEGEND", type:"DEBUFF_DEF", val:0.5},
        245: {name:"ã‚ªãƒ«ã‚´ãƒ¼ãƒ«", rare:"NORMAL", type:"DEBUFF_ATK", val:0.1},
        246: {name:"å®‰çœ æ•", rare:"NORMAL", type:"DEBUFF_ATK", val:0.2},
        247: {name:"ã‚„ã‚‹æ°—ã‚ªãƒ•ã‚¹ã‚¤ãƒƒãƒ", rare:"NORMAL", type:"DEBUFF_ATK", val:0.3},
        248: {name:"ä¸–ç•Œèª¬æ•™ãƒ†ãƒ¼ãƒ—", rare:"ELITE", type:"DEBUFF_ATK", val:0.4},
        249: {name:"èƒ¸ç³æ˜ åƒé›†", rare:"LEGEND", type:"DEBUFF_ATK", val:0.5},
        250: {name:"æ¤ç‰©ç³»ãƒ—ãƒ­ãƒ†ã‚¤ãƒ³", rare:"NORMAL", type:"BUFF_DEF", val:0.1},
        251: {name:"å‹•ç‰©ç³»ãƒ—ãƒ­ãƒ†ã‚¤ãƒ³", rare:"NORMAL", type:"BUFF_DEF", val:0.2},
        252: {name:"ç­‹è‚‰å¢—å¼·å‰¤", rare:"NORMAL", type:"BUFF_DEF", val:0.3},
        253: {name:"ç­‹è‚‰å¢—å¼·å‰¤", rare:"ELITE", type:"BUFF_DEF", val:0.4},
        254: {name:"åˆæ³•ãƒ‰ãƒ©ãƒƒã‚°", rare:"LEGEND", type:"BUFF_DEF", val:0.5},
        255: {name:"æ¤ç‰©ç³»ãƒ—ãƒ­ãƒ†ã‚¤ãƒ³", rare:"NORMAL", type:"BUFF_ATK", val:0.1},
        256: {name:"å‹•ç‰©ç³»ãƒ—ãƒ­ãƒ†ã‚¤ãƒ³", rare:"NORMAL", type:"BUFF_ATK", val:0.2},
        257: {name:"ç­‹è‚‰å¢—å¼·å‰¤", rare:"NORMAL", type:"BUFF_ATK", val:0.3},
        258: {name:"ç­‹è‚‰å¢—å¼·å‰¤", rare:"ELITE", type:"BUFF_ATK", val:0.4},
        259: {name:"åˆæ³•ãƒ‰ãƒ©ãƒƒã‚°", rare:"LEGEND", type:"BUFF_ATK", val:0.5},
        260: {name:"ç…™ç‰", rare:"NORMAL", type:"ESCAPE", eff:"escape"},
        261: {name:"å¹¸é‹ã®ç£çŸ³", rare:"LEGEND", type:"LUCKY ITEM", eff:"none"},
        262: {name:"ä¸æ€è­°ãªç ‚æ™‚è¨ˆ", rare:"LEGEND", type:"TIME LOOP", eff:"extra"},
        263: {name:"ã‚¾ãƒ¼ãƒ³ã®å¿ƒå¾—", rare:"ELITE", type:"ATK FLAG", eff:"m_rec"}, 
        264: {name:"ãƒœã‚¯ã‚µãƒ¼ã‚·ãƒ¥ãƒ¼ã‚º", rare:"ELITE", type:"DFE FLAG", eff:"atk_up"},
        265: {name:"èµ¤ã„ãƒãƒ³ãƒˆ", rare:"ELITE", type:"ATTRIBUTE CHANGE", eff:"fire_change"},
        266: {name:"é’ã„è…•è¼ª", rare:"ELITE", type:"ATTRIBUTE CHANGE", eff:"water_change"},
        267: {name:"é»„è‰²ã®ãƒ”ã‚¢ã‚¹", rare:"ELITE", type:"ATTRIBUTE CHANGE", eff:"elec_change"},
        268: {name:"ç·‘ã®æŒ‡è¼ª", rare:"ELITE", type:"ATTRIBUTE CHANGE", val:10, eff:"leaf_change"},
        269: {name:"è™¹ã®ã‹ã‘ã‚‰", rare:"LEGEND", type:"ATTRIBUTE CHANGE", eff:"all_change"},
        270: {name:"ç™ºç«ç‡ƒæ–™", rare:"ELITE", type:"FIELD CHANGE", elem:"ğŸ”¥"},
        271: {name:"é›¨é›²ç™ºç”Ÿæ©Ÿ", rare:"ELITE", type:"FIELD CHANGE", elem:"ğŸ’§"},
        272: {name:"ç£å ´ç™ºç”Ÿè£…ç½®", rare:"ELITE", type:"FIELD CHANGE", elem:"âš¡"},
        273: {name:"è¶…æˆé•·ä¿ƒé€²å‰¤", rare:"ELITE", type:"FIELD CHANGE", elem:"ğŸŒ¿"},
        274: {name:"æ¯’é‡", rare:"NORMAL", type:"POISON", eff:"instant"},
        275: {name:"ã‚®ãƒ£ãƒ³ãƒ–ãƒ©ãƒ¼ã®ã‚µã‚¤ã‚³ãƒ­", rare:"ELITE", type:"DICE", eff:"gamble"},
        276: {name:"ãƒšãƒ³ã‚­", rare:"NORMAL", type:"PAINT", eff:"paint"},
        277: {name:"è¦šæ‚Ÿã®ã‚¹ã‚¹ãƒ¡", rare:"ELITE", type:"ATK ONLY", eff:"atk_sac"},
        278: {name:"äº€ã®ç”²ç¾…", rare:"ELITE", type:"DFE ONLY", eff:"def_sac"},
        279: {name:"ç½ ", rare:"NORMAL", type:"TRAP ITEM", eff:"trap"},
        280: {name:"å¤ã³ãŸãƒ©ãƒ³ãƒ—", rare:"LEGEND", type:"ARTIFACT"},
        281: {name:"ä½•ã‹ã®ç¥æ§˜ã®åƒ", rare:"LEGEND", type:"ARTIFACT"},
        282: {name:"èª°ã‹ã®æ—¥è¨˜", rare:"LEGEND", type:"ARTIFACT"},
        283: {name:"æµ·è³Šã®éŠ€è²¨", rare:"LEGEND", type:"ARTIFACT"},
        284: {name:"æ›¸ã‘ãªã„ä¸‡å¹´ç­†", rare:"NORMAL", type:"ARTIFACT"},
        285: {name:"æ±æ´‹ã®æ°´å¢¨ç”»", rare:"NORMAL", type:"ARTIFACT"},
        286: {name:"è£¸ã®ç‹æ§˜ã®æœ", rare:"ELITE", type:"ARTIFACT"},
        287: {name:"ç›¸å¯¾æ€§ç†è«–åŸæœ¬ï¼ˆå†™ï¼‰", rare:"ELITE", type:"ARTIFACT"},
        288: {name:"é™ã‚ŠãªãçœŸå††ã«è¿‘ã„çŸ³", rare:"LEGEND", type:"ARTIFACT"},
        289: {name:"å††å‘¨ç‡æœ€å¾Œã®æ•°å­—", rare:"ELITE", type:"ARTIFACT"},
        290: {name:"èª°ã‚‚çŸ¥ã‚‰ãªã„ç‰©èª", rare:"LEGEND", type:"ARTIFACT"},
        291: {name:"æ¼¢ã®æµªæ¼«", rare:"LEGEND", type:"ARTIFACT"},
        292: {name:"å¤ä»£ã®ãƒ‡ã‚¸ã‚¿ãƒ«æ™‚è¨ˆ", rare:"ELITE", type:"ARTIFACT"},
        293: {name:"å½å…¸", rare:"ELITE", type:"ARTIFACT"},
        294: {name:"ã‚µãƒ³ã‚¿ã®é«­", rare:"NORMAL", type:"ARTIFACT"},
        295: {name:"ã‚µãƒ³ã‚¿ã®é«­ï¼ˆæœ¬ç‰©ï¼‰", rare:"LEGEND", type:"ARTIFACT"},
        296: {name:"å¤©ä½¿ã®ã‚ã£ã‹", rare:"LEGEND", type:"ARTIFACT"},
        297: {name:"é¾ã®ç³", rare:"LEGEND", type:"ARTIFACT"},
        298: {name:"çŸ³", rare:"NORMAL", type:"STONE"},
        299: {name:"è–æ›¸", rare:"LEGEND", type:"BIBLE", eff:"bible"}
    };

    const ELEMENTS = { "ğŸ”¥": "ğŸŒ¿", "ğŸŒ¿": "âš¡", "âš¡": "ğŸ’§", "ğŸ’§": "ğŸ”¥" };
    const MAGIC_INFO = { H:{n:"HEAL",s:"âœ¨"},F:{n:"FIRE",s:"ğŸ”¥"},W:{n:"AQUA",s:"ğŸ’§"},L:{n:"ELEC",s:"âš¡"},G:{n:"LEAF",s:"ğŸŒ¿"},B:{n:"BRAK",s:"ğŸ›¡ï¸â¬‡ï¸"},K:{n:"WEAK",s:"âš”ï¸â¬‡ï¸"},S:{n:"SEAL",s:"ğŸ›¡ï¸â¬†ï¸"},R:{n:"BRAV",s:"âš”ï¸â¬†ï¸"} };

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    let lv=1, exp=0, php=1000, pMax=1000, patk=0, pdef=0, pelem="", inventory=[], skillPoints=0;
    let magicLv = {H:1, F:0, W:0, L:0, G:0, B:0, K:0, S:0, R:0};
    let net, mode="W", ehp=0, eMax=0, eatk=0, edef=0, eelem="", isLucky=false, isSureHit=false, isPerfectEvasion=false;
    let fieldEffect = null, trapTimer = 0;
    let library = JSON.parse(localStorage.getItem('myth_v6_lib')) || { W: {}, M: {}, I: {} };

    // åˆæœŸåŒ–é–¢æ•°
    async function init() {
        console.log("System Initializing...");
        const saved = JSON.parse(localStorage.getItem('myth_v6_save'));
        
        if(saved) {
            lv = saved.lv || 1; 
            exp = saved.exp || 0; 
            pMax = saved.pMax || 1000; 
            magicLv = saved.magicLv || {H:1, F:0, W:0, L:0, G:0, B:0, K:0, S:0, R:0};
            skillPoints = saved.skillPoints || 0;
            inventory = saved.inventory || []; 
            php = pMax;
        }

        try { 
            updateUI();
            document.getElementById('init-msg').innerText = "LOADING AI MODEL...";
            net = await mobilenet.load(); 
            document.getElementById('scan-btn').disabled = false; 
            document.getElementById('msg').innerText = "æ­¦å™¨ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ãã ã•ã„"; 
            switchCamera('P'); 
        } catch (e) { 
            console.error("Init Error:", e);
            document.getElementById('msg').innerText = "AI ERROR: " + e.message; 
        } finally {
            const overlay = document.getElementById('init-overlay');
            if (overlay) overlay.style.display = 'none';
        }
    }
    } catch (e) { 
        console.error("Initialization Error:", e);
        document.getElementById('msg').innerText = "AI ERROR: ãƒ¢ãƒ‡ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚"; 
    } finally {
        // 4. ã€æœ€é‡è¦ã€‘æˆåŠŸã—ã¦ã‚‚å¤±æ•—ã—ã¦ã‚‚ã€æœ€å¾Œã«é»’ã„ç”»é¢ã‚’æ¶ˆã™ï¼
        console.log("Cleaning up overlay...");
        const overlay = document.getElementById('init-overlay');
        if (overlay) {
            overlay.style.display = 'none';
        }
    }
}
    try { 
        // AIãƒ¢ãƒ‡ãƒ«ã®ãƒ­ãƒ¼ãƒ‰
        net = await mobilenet.load(); 
        document.getElementById('scan-btn').disabled = false; 
        document.getElementById('msg').innerText = "æ­¦å™¨ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ãã ã•ã„"; 
        
        switchCamera('P'); 
        updateUI();

        // â˜…ã“ã“ãŒé‡è¦ï¼â˜… 
        // æº–å‚™ãŒçµ‚ã‚ã£ãŸã‚‰ã€ŒINITIALIZING...ã€ã®ç”»é¢ã‚’æ¶ˆã™
        if (document.getElementById('init-overlay')) {
            document.getElementById('init-overlay').style.display = 'none';
        }

    } catch (e) { 
        console.error(e);
        document.getElementById('msg').innerText = "AI ERROR: " + e.message; 
        // ã‚¨ãƒ©ãƒ¼ãŒèµ·ãã¦ã‚‚ã€ã¨ã‚Šã‚ãˆãšç”»é¢ã‚’æ¶ˆã•ãªã„ã¨ä½•ã‚‚æ“ä½œã§ããªã„ã®ã§æ¶ˆã™
        if (document.getElementById('init-overlay')) {
            document.getElementById('init-overlay').style.display = 'none';
        }
    }
}
    async function switchCamera(target) {
        if(stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }
        if(target === 'OFF') { document.querySelectorAll('.cam-frame').forEach(f=>f.classList.remove('cam-active')); return; }
        const vId = {P:'pv', E:'ev', B:'bv'}[target];
        try {
            stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
            document.getElementById(vId).srcObject = stream;
            document.querySelectorAll('.cam-frame').forEach(f=>f.classList.remove('cam-active'));
            document.getElementById(vId).parentElement.classList.add('cam-active');
        } catch(e) { console.error(e); }
    }

   async function handleScan() {
    const vid = mode === "W" ? document.getElementById('pv') : document.getElementById('ev');
    let id;
    try {
        const r = await net.classify(vid);
        id = Math.floor(r[0].probability * 100);
    } catch (e) {
        id = Math.floor(Math.random() * 100);
    }

    const rare = id >= 90 ? "LEGEND" : id >= 50 ? "ELITE" : "NORMAL";

    if (mode === "W") {
        // æ­¦å™¨ã‚¹ã‚­ãƒ£ãƒ³æ™‚
        pelem = ["ğŸ”¥", "ğŸ’§", "âš¡", "ğŸŒ¿"][id % 4];
        patk = Math.floor(120 * (1 + (lv * 0.1)));
        pdef = Math.floor(60 * (1 + (lv * 0.1)));
        const dbName = DB_WEAPON[id % DB_WEAPON.length];
        updateCardUI('p', "âš”ï¸", dbName, pelem, rare);
        library.W[id] = { t: dbName, e: pelem, r: rare };
        mode = "M";
        switchCamera('E');
        document.getElementById('msg').innerText = `è£…å‚™ï¼š${dbName}\næ¬¡ã¯ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã ï¼`;
    } else {
        // ãƒ¢ã‚¹ã‚¿ãƒ¼ã‚¹ã‚­ãƒ£ãƒ³æ™‚ï¼ˆãƒãƒˆãƒ«é–‹å§‹ç›´å‰ï¼‰
        eelem = ["ğŸ”¥", "ğŸ’§", "âš¡", "ğŸŒ¿"][id % 4];
        eMax = Math.floor(700 * (1 + (lv * 0.1)));
        ehp = eMax;
        eatk = Math.floor(80 * (1 + (lv * 0.1)));
        edef = Math.floor(40 * (1 + (lv * 0.1)));
        const dbName = DB_MONSTER[id % DB_MONSTER.length];
        updateCardUI('e', "ğŸ‘¾", dbName, eelem, rare);
        library.M[id + 100] = { t: dbName, e: eelem, r: rare };

        // â˜…ã“ã“ã§ã€Œç ‚æ™‚è¨ˆã€ç”¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ï¼
        startHP = php;
        startAtk = patk;
        startDef = pdef;
        startEHP = eMax;

        switchCamera('OFF');
        setBattleBtns(false);
        document.getElementById('scan-btn').disabled = true;
        document.getElementById('msg').innerText = "ãƒãƒˆãƒ«é–‹å§‹ï¼";
    }
    save();
    updateUI();
    }

function handleAttack() {
    setBattleBtns(true); 
    let msg = "";
    
    // 1. å‘½ä¸­åˆ¤å®šï¼ˆå¿…ä¸­ãƒ•ãƒ©ã‚°ã¾ãŸã¯85%ã®ç¢ºç‡ã§å‘½ä¸­ï¼‰
    let isHit = isSureHit || Math.random() > 0.15;

    if (isHit) {
        // 2. ãƒ€ãƒ¡ãƒ¼ã‚¸è¨ˆç®—ï¼ˆå¼±ç‚¹ãªã‚‰1.5å€ï¼‰
        let dmg = Math.floor(Math.max(50, (patk * (ELEMENTS[pelem]===eelem?1.5:1)) - (edef*0.2)));
        
        if (isSureHit) {
            dmg = Math.floor(dmg * 1.5); // å¿…ä¸­æ™‚ã¯ã•ã‚‰ã«1.5å€
            msg = `ğŸ¯ å¿…ä¸­ï¼æ€¥æ‰€ã‚’æ‰ãˆãŸï¼ ${dmg} ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼`;
        } else {
            msg = `ğŸ’¥ ${dmg} ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼`;
        }
        
        // 3. æ•µHPã‚’æ¸›ã‚‰ã™ï¼ˆ0ä»¥ä¸‹ã«ã¯ã—ãªã„ï¼‰
        ehp = Math.max(0, ehp - dmg);
    } else {
        msg = "ğŸ’¨ æ”»æ’ƒã¯ã‹ã‚ã•ã‚ŒãŸï¼";
    }

    // 4. ãƒ•ãƒ©ã‚°ã®ãƒªã‚»ãƒƒãƒˆã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
    isSureHit = false; 
    document.getElementById('msg').innerText = msg;
    
    // 5. UIæ›´æ–°ï¼ˆãƒãƒ¼ã‚’å‹•ã‹ã™ï¼‰
    updateUI();

    // 6. æ¬¡ã®ã‚¿ãƒ¼ãƒ³ã¸ã®ç§»è¡Œï¼ˆ1ç§’å¾…æ©Ÿï¼‰
    setTimeout(() => {
        if (ehp <= 0) {
            showBonus(); // æ•µãŒæ­»ã‚“ã ã‚‰å‹åˆ©å‡¦ç†ã¸
        } else {
            enemyTurn(); // æ•µãŒç”Ÿãã¦ã„ãŸã‚‰æ•µã®åæ’ƒã¸
        }
    }, 1000);
}
    

function enemyTurn() {
    // 1. ç½ ï¼ˆãƒˆãƒ©ãƒƒãƒ—ï¼‰ã®åˆ¤å®š
    if (trapTimer > 0) {
        trapTimer--; // ç½ ã®æ®‹ã‚Šã‚¿ãƒ¼ãƒ³ã‚’æ¸›ã‚‰ã™
        if (Math.random() < 0.5) { // 50%ã§æ‹˜æŸæˆåŠŸ
            document.getElementById('msg').innerText = "æ•µã¯ç½ ã«ã‹ã‹ã£ã¦å‹•ã‘ãªã„ï¼";
            setTimeout(() => { 
                document.getElementById('msg').innerText = "ã‚ãªãŸã®ã‚¿ãƒ¼ãƒ³"; 
                setBattleBtns(false); 
            }, 1000);
            return; // ç½ ã«ã‹ã‹ã£ãŸã‚‰ã“ã“ã§æ”»æ’ƒçµ‚äº†
        }
    }

    document.getElementById('msg').innerText = "æ•µã®æ”»æ’ƒï¼";

    setTimeout(() => {
        // 2. å®Œå…¨å›é¿ï¼ˆãƒœã‚¯ã‚µãƒ¼ã‚·ãƒ¥ãƒ¼ã‚ºï¼‰ã®åˆ¤å®š
        if (isPerfectEvasion) {
            document.getElementById('msg').innerText = "ğŸ’¨ ãƒœã‚¯ã‚µãƒ¼ã‚·ãƒ¥ãƒ¼ã‚ºã§è¯éº—ã«å›é¿ï¼";
            isPerfectEvasion = false; // ãƒ•ãƒ©ã‚°ã‚’æ¶ˆè²»

            setTimeout(() => { 
                document.getElementById('msg').innerText = "ã‚ãªãŸã®ã‚¿ãƒ¼ãƒ³"; 
                setBattleBtns(false); 
            }, 1000);
            return; // å›é¿ã—ãŸã‚‰ã“ã“ã§ãƒ€ãƒ¡ãƒ¼ã‚¸å‡¦ç†ã‚’é£›ã°ã—ã¦çµ‚äº†
        }

        // 3. é€šå¸¸ã®ãƒ€ãƒ¡ãƒ¼ã‚¸è¨ˆç®—
        let dmg = Math.floor(Math.max(40, eatk - (pdef * 0.2))); 
        php -= dmg;
        document.getElementById('msg').innerText = `âš ï¸ ${dmg} ãƒ€ãƒ¡ãƒ¼ã‚¸å—ã‘ãŸï¼`;
        
        updateUI(); // HPãƒãƒ¼ãªã©ã®è¡¨ç¤ºã‚’æ›´æ–°

        setTimeout(() => { 
            if (php <= 0) {
                finish(false); // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ­»äº¡
            } else { 
                document.getElementById('msg').innerText = "ã‚ãªãŸã®ã‚¿ãƒ¼ãƒ³"; 
                setBattleBtns(false); 
            } 
        }, 1000);
    }, 1000);
}

 function useItem(gid, idx) {
    const item = DB_ITEM_FULL[gid]; 
    let msg = `${item.name}ã‚’ä½¿ç”¨ï¼\n`;
    document.getElementById('item-overlay').style.display = 'none';

    // --- 1. HPå›å¾© ---
    if (item.type === "HP RECOVERY") {
        let r = item.mode === "fix" ? item.val : Math.floor(pMax * item.val);
        php = Math.min(pMax, php + r);
        msg += `HPãŒ ${r} å›å¾©ã—ãŸï¼`;

    // --- 2. å±æ€§æ”»æ’ƒ ---
    } else if (item.type === "ELEMENTAL ATTACK") {
        let baseDmg = Math.floor(eMax * item.val); 
        let multiplier = 1.0;
        if (ELEMENTS[item.elem] === eelem) { multiplier *= 1.5; msg += "å¼±ç‚¹ã‚’çªã„ãŸï¼ "; }
        if (fieldEffect === item.elem) { multiplier *= 1.5; msg += "ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®åŠ è­·ï¼ "; }
        let finalDmg = Math.floor(baseDmg * multiplier);
        ehp = Math.max(0, ehp - finalDmg);
        msg += `${finalDmg} ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼`;

    // --- 3. ãƒ‡ãƒãƒ• ---
    } else if (item.type === "DEBUFF_DEF") {
        let r = Math.floor(edef * item.val);
        edef -= r; msg += `æ•µã®é˜²å¾¡åŠ›ãŒ ${r} ä¸‹ãŒã£ãŸï¼`;
    } else if (item.type === "DEBUFF_ATK") {
        let r = Math.floor(eatk * item.val);
        eatk -= r; msg += `æ•µã®æ”»æ’ƒåŠ›ãŒ ${r} ä¸‹ãŒã£ãŸï¼`;

    // --- 4. ãƒãƒ• ---
    } else if (item.type === "BUFF_DEF") {
        let b = Math.max(10, Math.floor(pdef * item.val));
        pdef += b; msg += `é˜²å¾¡åŠ›ãŒ ${b} ä¸ŠãŒã£ãŸï¼`;
    } else if (item.type === "BUFF_ATK") {
        let b = Math.max(20, Math.floor(patk * item.val));
        patk += b; msg += `æ”»æ’ƒåŠ›ãŒ ${b} ä¸ŠãŒã£ãŸï¼`;

    // --- 5. ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å¤‰æ›´ ---
    } else if (item.type === "FIELD CHANGE") {
        fieldEffect = item.elem;
        msg += `å‘¨å›²ãŒ${item.elem}ã®ã‚¨ãƒãƒ«ã‚®ãƒ¼ã§æº€ãŸã•ã‚ŒãŸï¼\n${item.elem}å±æ€§ã®å¨åŠ›ãŒã‚¢ãƒƒãƒ—ï¼`;

    // --- 6. ç‰¹æ®Šãƒ»ã‚®ãƒ£ãƒ³ãƒ–ãƒ«ç³» ---
    } else if (item.type === "POISON") {
        if (Math.random() < 0.1) { ehp = 0; msg += "æ€¥æ‰€ã‚’è²«ã„ãŸï¼å³æ­»ï¼"; } 
        else { msg += "åŠ¹æœãŒãªã‹ã£ãŸâ€¦"; }
    } else if (item.type === "DICE") {
        if (Math.random() < 0.5) { 
            let d = Math.floor(ehp / 2); ehp -= d; msg += `æˆåŠŸï¼æ•µHPã‚’åŠåˆ†å‰Šã£ãŸï¼`;
        } else { 
            let d = Math.floor(php / 2); php -= d; msg += `å¤±æ•—ï¼è‡ªåˆ†HPãŒåŠåˆ†ã«ãªã£ãŸï¼`;
        }
    } else if (item.type === "PAINT") {
        const others = ["ğŸ”¥", "ğŸ’§", "âš¡", "ğŸŒ¿"].filter(e => e !== eelem);
        eelem = others[Math.floor(Math.random() * others.length)];
        msg += `ãƒã‚·ãƒ£ãƒƒï¼æ•µã®å±æ€§ãŒ ${eelem} ã«å¡—ã‚Šæ›¿ãˆã‚‰ã‚ŒãŸï¼`;
    } else if (item.type === "ATK ONLY") {
        patk += pdef; pdef = 0; msg += "é˜²å¾¡ã‚’å…¨ã¦æ¨ã¦ã€æ”»æ’ƒã«å…¨ã¦ã‚’æ§ã’ãŸï¼";
    } else if (item.type === "DFE ONLY") {
        pdef += patk; patk = 0; msg += "æ”»æ’ƒã‚’æ¨ã¦ã¦ã€é‰„å£ã®å®ˆã‚Šã«å…¥ã£ãŸï¼";
    } else if (item.type === "TRAP ITEM") {
        trapTimer = 3; msg += "åœ°é¢ã«ç½ ã‚’è¨­ç½®ã—ãŸï¼\n3ã‚¿ãƒ¼ãƒ³ã®é–“ã€æ•µã¯å‹•ãã«ãããªã‚‹ï¼";

    // --- 7. è„±å‡º ---
    } else if (item.type === "ESCAPE") {
        msg += "ç…™ç‰ã‚’ä½¿ç”¨ã—ãŸï¼";
        document.getElementById('msg').innerText = msg;
        inventory.splice(idx, 1);
        save();
        setTimeout(() => {
            let keepHP = php; resetBattle(); php = keepHP;
            updateUI(); alert("é€ƒã’åˆ‡ã£ãŸï¼");
        }, 1000);
        return; 

    // --- 8. ç‰¹æ®ŠåŠ¹æœ ---
    } else if (item.type === "TIME LOOP") {
        if (typeof startHP !== 'undefined') {
            php = startHP; patk = startAtk; pdef = startDef; ehp = startEHP;
            canUseMagic = true; fieldEffect = null;
            msg += "æ™‚é–“ãŒå·»ãæˆ»ã£ãŸï¼\næˆ¦é—˜é–‹å§‹æ™‚ã®çŠ¶æ…‹ã«å¾©å…ƒï¼";
        } else { msg += "æ™‚é–“ã®æµã‚ŒãŒä¸å®‰å®šã§å¤±æ•—ã—ãŸâ€¦"; }
    } else if (item.type === "ATK FLAG") {
        if (item.eff === "m_rec") { isSureHit = true; msg += "æ¥µé™ã®é›†ä¸­çŠ¶æ…‹ã«å…¥ã£ãŸï¼\næ¬¡ã®æ”»æ’ƒã¯å¿…ãšå‘½ä¸­ã™ã‚‹ï¼"; }
    } else if (item.type === "DFE FLAG") {
        if (item.eff === "atk_up") { isPerfectEvasion = true; msg += "ãƒ•ãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãŒè»½ããªã£ãŸï¼\næ¬¡ã®æ•µã®æ”»æ’ƒã‚’å®Œå…¨ã«å›é¿ã™ã‚‹ï¼"; }
    } else if (item.type === "ATTRIBUTE CHANGE") {
        if (item.eff === "fire_change") { pelem = "ğŸ”¥"; msg += "è‡ªåˆ†ã®å±æ€§ãŒ ç«(ğŸ”¥) ã«ãªã£ãŸï¼"; }
        else if (item.eff === "water_change") { pelem = "ğŸ’§"; msg += "è‡ªåˆ†ã®å±æ€§ãŒ æ°´(ğŸ’§) ã«ãªã£ãŸï¼"; }
        else if (item.eff === "elec_change") { pelem = "âš¡"; msg += "è‡ªåˆ†ã®å±æ€§ãŒ é›·(âš¡) ã«ãªã£ãŸï¼"; }
        else if (item.eff === "leaf_change") { pelem = "ğŸŒ¿"; msg += "è‡ªåˆ†ã®å±æ€§ãŒ è‰(ğŸŒ¿) ã«ãªã£ãŸï¼"; }
        else if (item.eff === "all_change") {
            for(let s in ELEMENTS) { if(ELEMENTS[s] === eelem) { pelem = s; break; } }
            msg += "è™¹ã®ã‹ã‘ã‚‰ãŒè¼ã„ãŸï¼\næ•µã®å¼±ç‚¹ã‚’çªãå±æ€§ã«å¤‰åŒ–ï¼";
        } else if (item.eff === "BIBLE" || item.eff === "bible") { // å¤§æ–‡å­—å°æ–‡å­—ä¸¡å¯¾å¿œ
            php = pMax; ehp = 1; msg += "ç¥ã®å¥‡è·¡ãŒèµ·ããŸï¼\nè‡ªåˆ†ã‚’ç™’ã‚„ã—ã€æ•µã‚’è¿½ã„è©°ã‚ãŸï¼";
        }

    // --- 9. ãã®ä»– ---
    } else if (item.type === "LUCKY ITEM") {
        isLucky = true; msg += "é‹æ°—ãŒæœ€é«˜æ½®ã«é”ã—ãŸï¼\nçµŒé¨“å€¤ãŒ5å€ã«ãªã‚‹ï¼";
    } else if (item.type === "ARTIFACT") {
        msg += "ä½¿ç”¨ã—ãŸãŒä½•ã‚‚èµ·ããªã‹ã£ãŸã€‚";
    } else if (item.type === "STONE") {
        if (Math.random() < 0.01) { ehp = 0; msg += "çŸ³ãŒè„³å¹¹ã‚’ç›´æ’ƒï¼å³æ­»ï¼"; }
        else { ehp = Math.max(0, ehp - 10); msg += "çŸ³ã‚’æŠ•ã’ãŸï¼ 10 ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼"; }
    }

    // --- å…±é€šçµ‚äº†å‡¦ç† ---
    document.getElementById('msg').innerText = msg;
    inventory.splice(idx, 1);
    save();
    updateUI();

    if (ehp <= 0) setTimeout(showBonus, 1000);
    else setTimeout(enemyTurn, 1000);
} // â† ã“ã“ã§ function useItem ãŒçµ‚äº†ã—ã¦ã„ã¾ã™ã€‚

       

    function openItemMenu() {
        const list = document.getElementById('item-list'); list.innerHTML = "";
        inventory.forEach((gid, i) => {
            const itm = DB_ITEM_FULL[gid]; const btn = document.createElement('button');
            btn.style.cssText = "width:90%; margin-bottom:10px; padding:12px; background:#222; border:1px solid #444; flex:none; height:auto;";
            btn.innerHTML = `<span style="color:${itm.rare==='LEGEND'?'var(--gold)':itm.rare==='ELITE'?'var(--p-color)':'#fff'}">[${itm.rare}]</span><br>${itm.name}`;
            btn.onclick = () => useItem(gid, i); list.appendChild(btn);
        });
        document.getElementById('item-overlay').style.display = 'flex';
    }

    function getBonusItem() {
        document.getElementById('get-item-btn').disabled = true;
        let roll = Math.random(); let target = roll > 0.95 ? "LEGEND" : roll > 0.70 ? "ELITE" : "NORMAL";
        const pool = Object.keys(DB_ITEM_FULL).filter(id => DB_ITEM_FULL[id].rare === target);
        const gid = parseInt(pool[Math.floor(Math.random() * pool.length)]);
        library.I[gid] = { t: DB_ITEM_FULL[gid].name, r: target };
        if(inventory.length < 8) inventory.push(gid);
        alert(`GET: ${DB_ITEM_FULL[gid].name}`); resetBattle(); save();
        document.getElementById('bonus-overlay').style.display = 'none';
        document.getElementById('get-item-btn').disabled = false;
    }

    function openLibrary() { document.getElementById('lib-overlay').style.display='flex'; renderLib('W'); }
   function renderLib(type) {
    const grid = document.getElementById('lib-grid'); 
    grid.innerHTML = "";
    const offset = type==='W' ? 0 : type==='M' ? 100 : 200;
    const max = type==='I' ? 100 : type==='M' ? 19 : 22;

    for(let i=0; i<max; i++){
        const gid = offset + i; 
        const data = library[type][gid];
        const slot = document.createElement('div'); 
        slot.className = "lib-slot" + (data ? " found" : "");
        
        // å›³é‘‘ã«åå‰ã¾ãŸã¯ç•ªå·ã‚’è¡¨ç¤º
        slot.innerText = data ? data.t : "No." + gid;

        if (data) {
            slot.onclick = () => {
                document.getElementById('det-name').innerText = data.t;
                document.getElementById('det-rare').innerText = data.r;
                document.getElementById('det-sub-label').innerText = type === 'I' ? "TYPE" : "ELEMENT";
                document.getElementById('det-sub-value').innerText = type === 'I' ? (DB_ITEM_FULL[gid] ? DB_ITEM_FULL[gid].type : "-") : data.e;
                document.getElementById('detail-pop').style.display = 'block';
            };
        }
        grid.appendChild(slot);
    }
}

// å‹åˆ©æ™‚ã®ãƒœãƒ¼ãƒŠã‚¹æ¼”å‡ºé–‹å§‹
function showBonus() {
    setBattleBtns(true);
    let baseExp = lv * 20;
    if (isLucky) { baseExp *= 5; isLucky = false; }
    exp += baseExp;
    
    let msg = `VICTORY!\nç²å¾—çµŒé¨“å€¤: ${baseExp}`;
    let nextExp = lv * 100;
    
    if (exp >= nextExp) {
        lv++; 
        exp -= nextExp; 
        skillPoints += 1; // â˜…2ã‹ã‚‰1ã¸å¤‰æ›´
        pMax += 100; 
        php = pMax;
        msg += `\nLEVEL UP! -> LV.${lv}\nã‚¹ã‚­ãƒ«ãƒã‚¤ãƒ³ãƒˆã‚’ 1 ç²å¾—ï¼`;
    }
    
    alert(msg);
    document.getElementById('bonus-overlay').style.display = 'flex';
    switchCamera('B');
}

// ãƒãƒˆãƒ«çµ‚äº†å¾Œã®å®Œå…¨ãƒªã‚»ãƒƒãƒˆ
function resetBattle() {
    mode = "W";
    ehp = 0; eMax = 0;
    fieldEffect = null;
    trapTimer = 0;
    isLucky = false;
    isSureHit = false;
    isPerfectEvasion = false;
    document.getElementById('scan-btn').disabled = false;
    setBattleBtns(true);
    switchCamera('P');
    document.getElementById('msg').innerText = "æ¬¡ã®æ­¦å™¨ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ãã ã•ã„";
    save();
    updateUI();
}

function finish(win) {
    if (!win) {
        alert("GAME OVER... æ­¦å™¨ã‚¹ã‚­ãƒ£ãƒ³ã‹ã‚‰ã‚„ã‚Šç›´ã—ã§ã™ã€‚");
        php = pMax; // å¾©æ´»
        resetBattle();
    }
}

function handleEscape() {
    if (confirm("é€ƒã’ã¾ã™ã‹ï¼Ÿï¼ˆHPã¯ãã®ã¾ã¾ã€æ­¦å™¨ã‹ã‚‰ã‚„ã‚Šç›´ã—ï¼‰")) {
        resetBattle();
    }
}

function save() {
    const data = { lv, exp, pMax, magicLv, skillPoints, inventory };
    localStorage.setItem('myth_v6_save', JSON.stringify(data));
    localStorage.setItem('myth_v6_lib', JSON.stringify(library));
}

function updateUI() {
    document.getElementById('p-lv').innerText = lv;
    document.getElementById('p-hp-cur').innerText = php;
    document.getElementById('p-hp-max').innerText = pMax;
    document.getElementById('p-atk-val').innerText = patk;
    document.getElementById('p-def-val').innerText = pdef;
    document.getElementById('p-fill').style.width = (php / pMax * 100) + "%";
    
    let nextExp = lv * 100;
    document.getElementById('exp-text').innerText = `${exp} / ${nextExp}`;
    document.getElementById('exp-fill').style.width = (exp / nextExp * 100) + "%";
    document.getElementById('skill-menu-btn').innerText = `SKILL UP (${skillPoints})`;

    document.getElementById('e-hp-cur').innerText = ehp;
    document.getElementById('e-hp-max').innerText = eMax;
    document.getElementById('e-atk-val').innerText = eatk;
    document.getElementById('e-def-val').innerText = edef;
    document.getElementById('e-fill').style.width = eMax > 0 ? (ehp / eMax * 100) + "%" : "0%";
}

function updateCardUI(side, sym, name, elem, rare) {
    document.getElementById(`${side}-sym`).innerText = sym;
    document.getElementById(`${side}-name`).innerText = name;
    document.getElementById(`${side}-elem`).innerText = elem;
    document.getElementById(`${side}-rare`).innerText = rare;
}

function setBattleBtns(disabled) {
    document.getElementById('atk-btn').disabled = disabled;
    document.getElementById('magic-btn').disabled = disabled;
    document.getElementById('item-open-btn').disabled = disabled;
    document.getElementById('esc-btn').disabled = disabled;
}

// é­”æ³•ã®ç™ºå‹•
function castMagic(type) {
    const mlv = magicLv[type];
    const info = MAGIC_INFO[type];
    let msg = `${info.s} ${info.n} Lv.${mlv} ã‚’å”±ãˆãŸï¼\n`;
    document.getElementById('magic-overlay').style.display = 'none';

    // å±æ€§ã‚¢ã‚¤ã‚³ãƒ³ã®å®šç¾©
    const magElem = (type==='F'?'ğŸ”¥':type==='W'?'ğŸ’§':type==='L'?'âš¡':type==='G'?'ğŸŒ¿':null);

    if (type === 'H') {
        // ãƒ’ãƒ¼ãƒ«ã¯å›ºå®šå€¤ã¾ãŸã¯æœ€å¤§HPã®å‰²åˆ
        let heal = mlv * 200;
        php = Math.min(pMax, php + heal);
        msg += `HPãŒ ${heal} å›å¾©ã—ãŸï¼`;
    } 
    else if (magElem) {
        // 1. åŸºç¤ãƒ€ãƒ¡ãƒ¼ã‚¸ç‡ã®è¨ˆç®— (Lv1=10%, Lv2=20%...)
        let baseRate = mlv * 0.1;
        let finalDmg = 0;

        // 2. ç›¸æ€§åˆ¤å®š
        if (magElem === eelem) {
            // åŒã˜å±æ€§ï¼šç„¡åŠ¹
            finalDmg = 0;
            msg += "åŠ¹æœãŒãªã„ï¼ãƒ€ãƒ¡ãƒ¼ã‚¸ 0ï¼";
        } 
        else if (ELEMENTS[magElem] === eelem) {
            // æœ‰åˆ©ãªå±æ€§ï¼š1.5å€ãƒ€ãƒ¡ãƒ¼ã‚¸
            finalDmg = Math.floor(eMax * (baseRate * 1.5));
            ehp = Math.max(0, ehp - finalDmg);
            msg += `å¼±ç‚¹ã‚’çªã„ãŸï¼è¶…å¼·åŠ›ãª ${finalDmg} ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼`;
        } 
        else if (ELEMENTS[eelem] === magElem) {
            // ä¸åˆ©ãªå±æ€§ï¼š1.5å€å›å¾©ï¼ˆç›¸æ‰‹ã®å¼±ç‚¹ã®é€†ï¼‰
            let healAmount = Math.floor(eMax * (baseRate * 1.5));
            ehp = Math.min(eMax, ehp + healAmount);
            msg += `å±æ€§ãŒæœ€æ‚ªã ï¼æ•µã®HPã‚’ ${healAmount} å›å¾©ã•ã›ã¦ã—ã¾ã£ãŸï¼`;
        } 
        else {
            // ç­‰å€ï¼ˆç«â†’é›·ãªã©ï¼‰ï¼šãã®ã¾ã¾
            finalDmg = Math.floor(eMax * baseRate);
            ehp = Math.max(0, ehp - finalDmg);
            msg += `æ•µã®HPã‚’ ${finalDmg} å‰Šã£ãŸï¼`;
        }
    }

    document.getElementById('msg').innerText = msg;
    updateUI();
    
    // æ•µã®æ­»äº¡åˆ¤å®š
    if (ehp <= 0) setTimeout(showBonus, 1000);
    else setTimeout(enemyTurn, 1000);
}

// é­”æ³•ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¡¨ç¤º
function openMagicMenu() {
    const list = document.getElementById('magic-list');
    list.innerHTML = "";
    for (let key in magicLv) {
        if (magicLv[key] > 0) {
            const btn = document.createElement('button');
            btn.style.cssText = "width:90%; margin-bottom:10px; padding:15px; background:var(--magic-purple); flex:none; height:auto;";
            btn.innerHTML = `${MAGIC_INFO[key].s} ${MAGIC_INFO[key].n} (Lv.${magicLv[key]})`;
            btn.onclick = () => castMagic(key);
            list.appendChild(btn);
        }
    }
    if (list.innerHTML === "") list.innerHTML = "å”±ãˆã‚‰ã‚Œã‚‹é­”æ³•ãŒã‚ã‚Šã¾ã›ã‚“";
    document.getElementById('magic-overlay').style.display = 'flex';
}

// ã‚¹ã‚­ãƒ«ã‚¢ãƒƒãƒ—ç”»é¢
function openSkillMenu() {
    document.getElementById('skill-points-display').innerText = `POINTS: ${skillPoints}`;
    const list = document.getElementById('skill-list');
    list.innerHTML = "";
    for (let key in magicLv) {
        const currentLv = magicLv[key];
        const nextLv = currentLv + 1;
        const cost = nextLv; 
        const btn = document.createElement('button');
        btn.style.cssText = "width:90%; margin-bottom:10px; padding:10px; background:#333; flex:none; height:auto; text-align:left; display:flex; justify-content:space-between; align-items:center; border: 1px solid #555;";
        const canAfford = skillPoints >= cost;
        const costColor = canAfford ? "var(--gold)" : "#888";
        btn.innerHTML = `<span>${MAGIC_INFO[key].s} ${MAGIC_INFO[key].n} [Lv.${currentLv} â†’ ${nextLv}]</span>
                         <span style="background:${costColor}; color:#000; padding:2px 8px; border-radius:4px; font-size:0.7rem;">COST: ${cost}pt</span>`;
        btn.onclick = () => {
            if (canAfford) {
                if (confirm(`${MAGIC_INFO[key].n} ã‚’Lv.${nextLv}ã«ã—ã¾ã™ã‹ï¼Ÿ(${cost}ptæ¶ˆè²»)`)) {
                    skillPoints -= cost;
                    magicLv[key] = nextLv;
                    save();
                    openSkillMenu();
                    updateUI();
                }
            } else {
                alert(`ãƒã‚¤ãƒ³ãƒˆãŒè¶³ã‚Šã¾ã›ã‚“`);
            }
        };
        list.appendChild(btn);
    }
    document.getElementById('skill-overlay').style.display = 'flex';
}

// ã‚·ã‚¹ãƒ†ãƒ å…±é€š
function updateUI() {
    document.getElementById('p-lv').innerText = lv;
    document.getElementById('p-hp-cur').innerText = php;
    document.getElementById('p-hp-max').innerText = pMax;
    document.getElementById('p-atk-val').innerText = patk;
    document.getElementById('p-def-val').innerText = pdef;
    document.getElementById('p-fill').style.width = `${(php/pMax)*100}%`;
    let nextExp = lv * 100;
    document.getElementById('exp-text').innerText = `${exp} / ${nextExp}`;
    document.getElementById('exp-fill').style.width = `${(exp/nextExp)*100}%`;
    document.getElementById('e-hp-cur').innerText = ehp;
    document.getElementById('e-hp-max').innerText = eMax;
    document.getElementById('e-atk-val').innerText = eatk;
    document.getElementById('e-def-val').innerText = edef;
    document.getElementById('e-fill').style.width = eMax > 0 ? `${(ehp/eMax)*100}%` : "0%";
    document.getElementById('skill-menu-btn').innerText = `SKILL UP (${skillPoints})`;
}

function save() {
    const data = { lv, exp, pMax, magicLv, skillPoints, inventory };
    localStorage.setItem('myth_v6_save', JSON.stringify(data));
    localStorage.setItem('myth_v6_lib', JSON.stringify(library));
}

function setBattleBtns(dis) {
    document.getElementById('atk-btn').disabled = dis;
    document.getElementById('magic-btn').disabled = dis;
    document.getElementById('item-open-btn').disabled = dis;
    document.getElementById('esc-btn').disabled = dis;
}

function resetBattle() {
    mode = "W";
    ehp = 0; eMax = 0;
    document.getElementById('e-name').innerText = "???";
    document.getElementById('e-sym').innerText = "?";
    document.getElementById('scan-btn').disabled = false;
    setBattleBtns(true);
    document.getElementById('bonus-overlay').style.display = 'none';
    document.getElementById('msg').innerText = "æ­¦å™¨ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ãã ã•ã„";
    switchCamera('P');
    updateUI();
}
// å‹åˆ©æ™‚ã®ãƒœãƒ¼ãƒŠã‚¹ç”»é¢è¡¨ç¤º
function showBonus() {
    // çµŒé¨“å€¤è¨ˆç®—ï¼ˆLv100å¿…è¦ä»•æ§˜ã«åˆã‚ã›ã‚‹ãªã‚‰ã“ã“ã‚‚èª¿æ•´ï¼‰
    let gainExp = isLucky ? 50 : 10;
    exp += gainExp;
    
    let nextExp = lv * 100;
    if(exp >= nextExp) {
        exp -= nextExp;
        lv++;
        skillPoints += 3;
        pMax += 100;
        php = pMax;
        alert("LEVEL UP!");
    }
    
    // UIã‚’æœ€æ–°ã«ã—ã¦ã‹ã‚‰ãƒœãƒ¼ãƒŠã‚¹ç”»é¢ã¸
    updateUI();
    document.getElementById('bonus-overlay').style.display = 'flex';
    switchCamera('B'); // ãƒœãƒ¼ãƒŠã‚¹ã‚¹ã‚­ãƒ£ãƒ³ç”¨ã«ã‚«ãƒ¡ãƒ©åˆ‡ã‚Šæ›¿ãˆ
    document.getElementById('msg').innerText = "æ•µã‚’å€’ã—ãŸï¼ã‚¢ã‚¤ãƒ†ãƒ ã‚¹ã‚­ãƒ£ãƒ³ï¼";
}

// æœ€å¾Œã«ã‚²ãƒ¼ãƒ ã‚’èµ·å‹•ã•ã›ã‚‹å‘½ä»¤
init();
