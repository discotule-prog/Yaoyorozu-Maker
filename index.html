<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MYTH SCANNER 2.5 -GRAND-</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet"></script>
    <link href="https://fonts.googleapis.com/css2?family=DotGothic16&display=swap" rel="stylesheet">
    <style>
        :root { --p-color: #00f2ff; --e-color: #ff3c00; --gold: #ffd700; }
        body { font-family: 'DotGothic16', sans-serif; background: #000; color: #fff; margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* Header */
        #header { height: 40px; background: #222; display: flex; justify-content: space-between; align-items: center; padding: 0 15px; font-size: 0.8rem; border-bottom: 2px solid #444; }
        .lib-btn { font-size: 0.6rem; padding: 2px 8px; height: 24px; background: #555; border: 1px solid #fff; color: #fff; cursor: pointer; }

        /* Character Areas */
        .char-area { height: 32%; display: flex; border-bottom: 1px solid #333; padding: 10px; box-sizing: border-box; }
        .cam-part { width: 35%; display: flex; align-items: center; justify-content: center; }
        .cam-frame { width: 90px; height: 90px; border: 2px solid #555; background: #111; overflow: hidden; position: relative; border-radius: 8px; }
        video { width: 100%; height: 100%; object-fit: cover; display: none; }
        .cam-active video { display: block; border-color: #0f0; }
        
        .info-part { width: 65%; display: flex; flex-direction: column; padding-left: 10px; justify-content: center; }
        .visual-card { width: 100%; height: 80px; border: 2px solid #fff; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #111; position: relative; border-radius: 4px; overflow: hidden; }
        .stat-text { font-size: 0.7rem; color: #ccc; margin-top: 4px; }
        .hp-bar-bg { width: 100%; height: 8px; background: #333; border: 1px solid #fff; margin-top: 4px; }
        .hp-bar-fill { height: 100%; transition: width 0.3s; }
        .rarity-tag { position: absolute; top: 2px; right: 2px; font-size: 0.5rem; padding: 1px 3px; background: #fff; color: #000; }
        .elem-tag { position: absolute; top: 2px; left: 2px; font-size: 0.7rem; }

        /* UI Middle */
        #mid-ui { height: 140px; background: #111; border-top: 2px solid #444; display: flex; flex-direction: column; align-items: center; padding: 5px; }
        #msg { font-size: 0.8rem; color: #0f0; height: 35px; text-align: center; display: flex; align-items: center; padding: 0 5px; line-height: 1.2; }
        .btn-row { display: flex; gap: 5px; width: 95%; justify-content: center; }
        button { flex: 1; height: 40px; font-family: 'DotGothic16'; border: 2px solid #fff; color: #fff; background: #444; font-size: 0.75rem; cursor: pointer; }

        /* Overlays */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 100; display: none; flex-direction: column; align-items: center; padding: 15px; box-sizing: border-box; }
        .lib-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 4px; width: 100%; max-height: 60vh; overflow-y: auto; padding: 5px; background: #111; border: 1px solid #444; }
        .lib-slot { aspect-ratio: 1/1; background: #222; border: 1px solid #444; font-size: 0.5rem; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #444; text-align: center; position: relative; }
        .lib-slot.found { color: #fff; border-color: #aaa; }
        .lib-slot.rare { border-color: var(--gold); background: #332200; }

        .detail-pop { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #222; border: 3px solid var(--gold); padding: 20px; z-index: 200; width: 80%; text-align: center; display: none; box-shadow: 0 0 20px #000; border-radius: 10px; }

        .shake { animation: s 0.2s; }
        @keyframes s { 0%,100%{transform:translateX(0)} 25%{transform:translateX(5px)} 75%{transform:translateX(-5px)} }
    </style>
</head>
<body>

<div id="header">
    <span id="bag-status">BAG: 0/5</span>
    <button onclick="openLibrary()" class="lib-btn">COLLECTION</button>
</div>

<div class="char-area" id="p-area">
    <div class="cam-part" id="p-cam-box"><div class="cam-frame"><video id="pv" autoplay playsinline muted></video></div></div>
    <div class="info-part">
        <div id="p-card" class="visual-card">
            <div id="p-rare" class="rarity-tag">-</div>
            <div id="p-elem" class="elem-tag"></div>
            <div id="p-sym" style="font-size:2rem;">‚öîÔ∏è</div>
            <div id="p-name" style="font-size:0.6rem; text-align:center;">SCANNER READY</div>
        </div>
        <div class="stat-text">LV:<span id="p-lv">1</span> HP:<span id="p-hp-cur">1000</span>/<span id="p-hp-max">1000</span><br>ATK:<span id="p-atk-val">0</span> DEF:<span id="p-def-val">50</span></div>
        <div class="hp-bar-bg"><div id="p-fill" class="hp-bar-fill" style="background:var(--p-color); width:100%"></div></div>
    </div>
</div>

<div id="mid-ui">
    <div id="msg">Ê≠¶Âô®„Çí„Çπ„Ç≠„É£„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>
    <div class="btn-row">
        <button id="scan-btn" onclick="handleScan()" style="background:#0044cc">SCAN</button>
        <button id="atk-btn" onclick="handleAttack()" disabled style="background:#aa0000">ATTACK</button>
        <button id="item-open-btn" onclick="openItemMenu()" disabled style="background:#008844">ITEM</button>
    </div>
</div>

<div class="char-area" id="e-area">
    <div class="cam-part" id="e-cam-box"><div class="cam-frame"><video id="ev" autoplay playsinline muted></video></div></div>
    <div class="info-part">
        <div id="e-card" class="visual-card">
            <div id="e-rare" class="rarity-tag">-</div>
            <div id="e-elem" class="elem-tag"></div>
            <div id="e-sym" style="font-size:2rem;">üëæ</div>
            <div id="e-name" style="font-size:0.6rem; text-align:center;">???</div>
        </div>
        <div class="stat-text">HP:<span id="e-hp-cur">0</span>/<span id="e-hp-max">0</span><br>ATK:<span id="e-atk-val">0</span> DEF:<span id="e-def-val">0</span></div>
        <div class="hp-bar-bg"><div id="e-fill" class="hp-bar-fill" style="background:var(--e-color); width:0%"></div></div>
    </div>
</div>

<div id="lib-overlay" class="overlay">
    <h2 style="margin:5px 0;">COLLECTION</h2>
    <div id="lib-tabs" style="display:flex; gap:5px; margin-bottom:10px;">
        <button onclick="renderLib('W')">WEAPON</button>
        <button onclick="renderLib('M')">MONSTER</button>
        <button onclick="renderLib('I')">ITEM</button>
    </div>
    <div id="lib-grid" class="lib-grid"></div>
    <button onclick="closeOverlay('lib-overlay')" style="margin-top:10px; width:100px;">CLOSE</button>
</div>

<div id="item-overlay" class="overlay">
    <h2>BAG</h2>
    <div id="item-list" style="width:100%;"></div>
    <button onclick="closeOverlay('item-overlay')" style="margin-top:10px; width:100px;">CLOSE</button>
</div>

<div id="bonus-overlay" class="overlay">
    <h2 style="color:var(--gold);">ITEM SCAN</h2>
    <div class="cam-frame" style="width:150px; height:150px;" id="b-cam-box"><video id="bv" autoplay playsinline muted></video></div>
    <button onclick="getBonusItem()" style="background:#0044cc; width:100%; margin-top:20px;">SCAN ITEM</button>
</div>

<div id="res-screen" class="overlay" style="justify-content:center;">
    <h1 id="res-title"></h1>
    <p id="res-desc" style="text-align:center;"></p>
    <button onclick="closeResult()" style="width:200px; height:50px; background:#0044cc;">NEXT BATTLE</button>
</div>

<div id="detail-pop" class="detail-pop">
    <h3 id="det-name">ITEM NAME</h3>
    <p id="det-desc">EFFECT DESCRIPTION</p>
    <button onclick="closeDetail()" style="width:100px;">CLOSE</button>
</div>

<script>
    const WEAPON_TYPES = ["ÈâÑ„ÅÆÂâ£", "È®éÂ£´„ÅÆÊßç", "Á´ú„ÅÆÁâô", "Ë≥¢ËÄÖ„ÅÆÊùñ", "È≠îÂ∞éÊõ∏", "Á†¥ÂüéÊßå", "Èö†„ÅóÂàÄ", "ËÅñ„Å™„ÇãÁõæ", "Ê≠ªÁ•û„ÅÆÈéå", "Á•ûÂâ£"];
    const MONSTER_RACES = ["„Çπ„É©„Ç§„É†", "„Ç¥„Éñ„É™„É≥", "„Ç™„Éº„ÇØ", "„Çπ„Ç±„É´„Éà„É≥", "Âê∏Ë°ÄÈ¨º", "Ê≠ªÁ•û", "„Ç±„É´„Éô„É≠„Çπ", "„Éâ„É©„Ç¥„É≥", "È≠îÁéã", "„Éê„Éè„É†„Éº„Éà"];
    const ITEM_NAMES = ["Ëñ¨Ëçâ", "„Éù„Éº„Ç∑„Éß„É≥", "„Ç®„É™„ÇØ„Çµ„Éº", "Âäõ„ÅÆÁ®Æ", "ÁàÜÂºæ", "ÊôÇ„ÅÆÁ†ÇÊôÇË®à", "Â±ûÊÄß„Ç™„Éº„Éñ", "Ë≥¢ËÄÖ„ÅÆÁü≥"];
    const ELEMENTS = { "üî•": "üåø", "üåø": "‚ö°", "‚ö°": "üíß", "üíß": "üî•" };
    const ITEM_EFFECTS = {
        "HE": "„ÄêÂõûÂæ©„Äë‰ΩøÁî®„Åô„Çã„Å®ÊúÄÂ§ßHP„ÅÆ50%„ÇíÂõûÂæ©„Åô„Çã„ÄÇ",
        "SPEC": "„ÄêÂÆàË≠∑„Äë‰ΩøÁî®„Åô„Çã„Å®Ê¨°„ÅÆÊïµ„ÅÆÊîªÊíÉ„ÇíÂÆåÂÖ®„Å´ÁÑ°ÂäπÂåñ„Åô„Çã„ÄÇ"
    };

    let net, mode="W", lv=1, exp=0, php=1000, pMax=1000, ehp=0, eMax=0;
    let patk=0, pdef=50, eatk=0, edef=0, pelem="", eelem="", stream=null, shieldActive=false;
    let inventory = [], library = JSON.parse(localStorage.getItem('myth_grand_final_v1')) || { W: {}, M: {}, I: {} };

    async function init() {
        net = await mobilenet.load();
        switchCamera('P');
        updateUI();
    }

    function getElem(str) {
        const s = str.length;
        return ["üî•", "üíß", "‚ö°", "üåø"][s % 4];
    }

    async function switchCamera(target) {
        if(stream) stream.getTracks().forEach(t => t.stop());
        const vId = {P:'pv', E:'ev', B:'bv'}[target];
        const bId = {P:'p-cam-box', E:'e-cam-box', B:'b-cam-box'}[target];
        try {
            stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
            document.getElementById(vId).srcObject = stream;
            ['p-cam-box','e-cam-box','b-cam-box'].forEach(b=>document.getElementById(b).classList.remove('cam-active'));
            document.getElementById(bId).classList.add('cam-active');
        } catch(e) { console.error("Camera Access Denied"); }
    }

    async function handleScan() {
        const vid = mode==="W" ? document.getElementById('pv') : document.getElementById('ev');
        const r = await net.classify(vid);
        const aiName = r[0].className.split(',')[0].toUpperCase();
        const prob = r[0].probability;
        const boost = 1 + (lv-1)*0.1;

        if(mode==="W") {
            const id = Math.floor(prob * 100);
            const rare = id > 95 ? "M" : id > 80 ? "SR" : id > 50 ? "R" : "C";
            const baseType = WEAPON_TYPES[Math.floor(id/10)];
            pelem = getElem(aiName);
            patk = Math.floor((100 + id) * (rare==="M"?3:rare==="SR"?2:rare==="R"?1.5:1) * boost);
            pdef = Math.floor((30 + id/2) * boost);
            
            updateCardUI('p', rare, "‚öîÔ∏è", `${aiName}„ÅÆ${baseType}`, pelem);
            library.W[id] = {t: baseType, r: rare, e: pelem};
            mode="M"; switchCamera('E');
            document.getElementById('msg').innerText = "Ê¨°„ÅØ„É¢„É≥„Çπ„Çø„Éº„Çí„Çπ„Ç≠„É£„É≥ÔºÅ";
        } else {
            const id = 100 + Math.floor(prob * 100);
            const rare = id > 195 ? "M" : id > 180 ? "SR" : id > 150 ? "R" : "C";
            const baseRace = MONSTER_RACES[Math.floor((id-100)/10)];
            eelem = getElem(aiName);
            const mult = (rare==="M"?4:rare==="SR"?2.5:rare==="R"?1.5:1);
            eMax = Math.floor((800 + (id-100)*10) * mult * boost);
            ehp = eMax; eatk = Math.floor((80 + (id-100)) * boost); edef = Math.floor((20 + (id-100)/2) * boost);
            
            updateCardUI('e', rare, "üëæ", `${aiName}„ÅÆ${baseRace}`, eelem);
            library.M[id] = {t: baseRace, r: rare, e: eelem};
            document.getElementById('atk-btn').disabled = false;
            document.getElementById('item-open-btn').disabled = false;
            document.getElementById('scan-btn').disabled = true;
            document.getElementById('msg').innerText = "BATTLE START!";
        }
        save(); updateUI();
    }

    function updateCardUI(side, rare, sym, name, elem) {
        document.getElementById(`${side}-rare`).innerText = rare;
        document.getElementById(`${side}-sym`).innerText = sym;
        document.getElementById(`${side}-name`).innerText = name;
        document.getElementById(`${side}-elem`).innerText = elem;
        const colors = {M:'gold', SR:'magenta', R:'cyan', C:'white'};
        document.getElementById(`${side}-card`).style.borderColor = colors[rare] || 'white';
    }

    function handleAttack() {
        let mult = (ELEMENTS[pelem] === eelem) ? 1.5 : (ELEMENTS[eelem] === pelem) ? 0.5 : 1.0;
        let d = Math.max(30, (patk * mult) - edef/2);
        ehp -= Math.floor(d);
        document.getElementById('e-area').classList.add('shake');
        document.getElementById('msg').innerText = mult > 1 ? "ÂäπÊûú„ÅØÊäúÁæ§„Å†ÔºÅ" : mult < 1 ? "ÂäπÊûú„ÅØ„ÅÑ„Åæ„Å≤„Å®„Å§..." : "„Éó„É¨„Ç§„É§„Éº„ÅÆÊîªÊíÉÔºÅ";
        updateUI();
        setTimeout(() => {
            document.getElementById('e-area').classList.remove('shake');
            if(ehp <= 0) showBonus(); else enemyTurn();
        }, 600);
    }

    function enemyTurn() {
        setTimeout(() => {
            let mult = (ELEMENTS[eelem] === pelem) ? 1.5 : (ELEMENTS[pelem] === eelem) ? 0.5 : 1.0;
            let d = shieldActive ? 0 : Math.max(20, (eatk * mult) - pdef/2);
            shieldActive = false;
            php -= Math.floor(d);
            document.getElementById('p-area').classList.add('shake');
            document.getElementById('msg').innerText = "Êïµ„ÅÆÊîªÊíÉÔºÅ";
            updateUI();
            setTimeout(() => {
                document.getElementById('p-area').classList.remove('shake');
                if(php <= 0) finish(false);
            }, 400);
        }, 500);
    }

    async function getBonusItem() {
        const r = await net.classify(document.getElementById('bv'));
        const prob = r[0].probability;
        const id = 200 + Math.floor(prob * 100);
        const rare = id > 290 ? "M" : id > 270 ? "SR" : id > 240 ? "R" : "C";
        const baseItem = ITEM_NAMES[Math.floor((id-200)/12.5)] || "‰∏çÊÄùË≠∞„Å™Ëñ¨";
        const type = id > 280 ? "SPEC" : "HE";
        inventory.push({ n: `${r[0].className.split(',')[0].toUpperCase()}„ÅÆ${baseItem}`, r: rare, t: type });
        library.I[id] = {t: baseItem, r: rare, et: type};
        save();
        document.getElementById('bonus-overlay').style.display='none';
        finish(true);
    }

    function finish(win) {
        document.getElementById('res-screen').style.display='flex';
        const title = document.getElementById('res-title');
        const desc = document.getElementById('res-desc');
        if(win) {
            title.innerText = "VICTORY"; title.style.color = "var(--p-color)";
            exp += 50; if(exp >= 100){ lv++; exp=0; pMax += 200; php = pMax; }
            desc.innerText = "„Ç¢„Ç§„ÉÜ„É†„ÇíÁç≤Âæó„Åó„Åæ„Åó„ÅüÔºÅ";
        } else {
            title.innerText = "DEFEAT"; title.style.color = "var(--e-color)";
            lv = Math.max(1, lv - 3); pMax = 1000 + (lv-1)*200;
            for(let i=0; i<3; i++) deleteRandomCollection();
            desc.innerText = "LV„Åå3‰Ωé‰∏ã„Åó„ÄÅ„Ç≥„É¨„ÇØ„Ç∑„Éß„É≥„Çí3„Å§Â§±„Å£„Åü...";
        }
        save(); updateUI();
    }

    function deleteRandomCollection() {
        const valid = [];
        ['W', 'M', 'I'].forEach(t => Object.keys(library[t]).forEach(k => valid.push({t, k})));
        if(valid.length > 0) { const target = valid[Math.floor(Math.random()*valid.length)]; delete library[target.t][target.k]; }
    }

    function closeResult() {
        const isDefeat = document.getElementById('res-title').innerText === "DEFEAT";
        php = isDefeat ? pMax : Math.min(pMax, php + Math.floor(pMax * 0.5));
        mode="W"; ehp = 0; eMax = 0; updateCardUI('e', '-', 'üëæ', '???', '');
        document.getElementById('msg').innerText = "Ê≠¶Âô®„Çí„Çπ„Ç≠„É£„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ";
        document.getElementById('atk-btn').disabled = true; document.getElementById('scan-btn').disabled = false;
        document.getElementById('res-screen').style.display='none';
        switchCamera('P'); updateUI();
    }

    function openLibrary() { renderLib('W'); document.getElementById('lib-overlay').style.display='flex'; }
    function renderLib(type) {
        const grid = document.getElementById('lib-grid'); grid.innerHTML = "";
        const offset = {W:0, M:100, I:200}[type];
        for(let i=0; i<100; i++) {
            const id = offset + i; const data = library[type][id];
            const slot = document.createElement('div');
            slot.className = "lib-slot" + (data ? " found" : "") + (data && data.r==='M' ? " rare" : "");
            if(data) slot.onclick = () => showDetail(data, type);
            slot.innerHTML = data ? `<span class="elem-tag" style="left:2px; top:2px;">${data.e||""}</span><span style="color:gold;">${data.r}</span><br>${data.t}` : `No.${id}`;
            grid.appendChild(slot);
        }
    }

    function showDetail(data, type) {
        document.getElementById('det-name').innerText = `[${data.r}] ${data.t}`;
        document.getElementById('det-desc').innerText = type === 'I' ? (ITEM_EFFECTS[data.et] || ITEM_EFFECTS["HE"]) : `Â±ûÊÄß: ${data.e || "„Å™„Åó"}\n„Çπ„Ç≠„É£„É≥„ÅßÁô∫Ë¶ã„Åï„Çå„Åü„Éá„Éº„Çø„Åß„Åô„ÄÇ`;
        document.getElementById('detail-pop').style.display = 'block';
    }

    function openItemMenu() {
        const list = document.getElementById('item-list'); list.innerHTML = "";
        inventory.forEach((itm, i) => {
            const b = document.createElement('button'); b.style.width = "100%"; b.style.marginBottom = "5px";
            b.innerHTML = `[${itm.r}] ${itm.n}`;
            b.onclick = () => {
                if(itm.t === "HE") php = Math.min(pMax, php + pMax*0.5);
                if(itm.t === "SPEC") shieldActive = true;
                inventory.splice(i, 1); closeOverlay('item-overlay'); updateUI();
            };
            list.appendChild(b);
        });
        document.getElementById('item-overlay').style.display='flex';
    }

    function updateUI() {
        document.getElementById('p-lv').innerText = lv;
        document.getElementById('bag-status').innerText = `BAG: ${inventory.length}/${5 + Math.floor(lv/5)}`;
        document.getElementById('p-hp-cur').innerText = Math.max(0, Math.floor(php));
        document.getElementById('p-hp-max').innerText = pMax;
        document.getElementById('p-fill').style.width = (php/pMax*100) + "%";
        document.getElementById('e-hp-cur').innerText = Math.max(0, Math.floor(ehp));
        document.getElementById('e-hp-max').innerText = eMax;
        document.getElementById('e-fill').style.width = (eMax>0 ? (ehp/eMax*100) : 0) + "%";
        document.getElementById('p-atk-val').innerText = patk; document.getElementById('p-def-val').innerText = pdef;
        document.getElementById('e-atk-val').innerText = eatk; document.getElementById('e-def-val').innerText = edef;
    }

    function showBonus() { document.getElementById('bonus-overlay').style.display='flex'; switchCamera('B'); }
    function closeOverlay(id) { document.getElementById(id).style.display='none'; }
    function closeDetail() { document.getElementById('detail-pop').style.display = 'none'; }
    function save() { localStorage.setItem('myth_grand_final_v1', JSON.stringify(library)); }

    init();
</script>
</body>
</html>
